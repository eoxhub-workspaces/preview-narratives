const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chunks/raw.DxtaBMev.js","assets/chunks/basedecoder.B2c5_Eok.js","assets/chunks/lzw.BikwkTY2.js","assets/chunks/jpeg.CbvpOiPg.js","assets/chunks/deflate.B4_27dB1.js","assets/chunks/pako.esm.BkaqWuDM.js","assets/chunks/packbits.D6Qr5eNi.js","assets/chunks/lerc.DAuOJrWD.js","assets/chunks/commonjsHelpers.Cpj98o6Y.js","assets/chunks/WMTS.BonjY2Cp.js","assets/chunks/framework.BUpHk5hx.js","assets/chunks/webimage.CU41Mh7j.js"])))=>i.map(i=>d[i]);
var Th=Object.defineProperty;var wh=(n,e,t)=>e in n?Th(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var fe=(n,e,t)=>wh(n,typeof e!="symbol"?e+"":e,t);import{bz as vh,ap as et,aQ as ye,bA as Sh,bB as Ge,bC as Rh,bD as Ah,aY as Jn,bE as gs,av as Tn,au as kr,at as Ai,n as cr,ar as It,aq as ft,bF as Pi,bG as Q,bH as K,bI as V,bJ as Ws,bK as ei,bL as Ph,bM as Lh,bN as Zt,bO as ti,ab as jl,bP as ie,bQ as I,bR as ce,bS as we,bT as at,bU as zr,bV as Ht,bW as fn,bX as Xl,bY as ri,bZ as ni,b_ as H,b$ as S,c0 as $,c1 as Li,c2 as Ie,c3 as We,c4 as Zs,c5 as Hl,c6 as ii,c7 as nr,c8 as Ih,c9 as Wl,p as Mt,a8 as dt,ca as be,as as Ch,cb as Fh,ax as Kt,aa as _a,cc as Oh,cd as it,ce as Rt,ag as Ys,aN as Mh,aM as Nh,cf as si,cg as Dh,ch as dn,ci as Uh,cj as Bh,am as Zl,bj as oi,ck as ya,bi as Zn,cl as xa,by as ai,G as sr,an as Ii,h as Gh,cm as kh,cn as zh,co as Pt,a3 as pn,a2 as Ci,cp as Yt,cq as Yn,ac as Or,x as Ve,o as Le,cr as Mr,cs as Pr,ct as $h,a0 as _e,D as Yl,K as $e,q as qs,cu as Vh,T as jh,E as Ke,cv as ue,cw as Ks,cx as mt,cy as Xh,cz as Qs,cA as ms,cB as _s,cC as Qt,cD as Hh,cE as ys,R as qi,cF as Wh,cG as xs,cH as ql,cI as Zh,cJ as wr,cK as Yh,cL as Ea,cM as qh,cN as Js,cO as Kh,aE as Kl,U as kt,cP as wn,cQ as Qh,cR as Jh,cS as ge,cT as Fi,cU as gn,cV as tt,cW as hr,cX as pr,cY as ef,cZ as se,c_ as Ql,be as tf,c$ as rf,d0 as Jl,d1 as eu,d2 as nf,d3 as sf,v as mn,e as of,bg as vn,l as Ut,aB as Wt,d4 as af,Z as Jt,H as Oi,aG as eo,u as li,d5 as tu,d6 as or,d7 as lf,d8 as uf,br as ru,d9 as _t,da as cf,db as hf,a9 as to,dc as ff,B as nu,dd as df,bf as pf,ak as Es,bh as ba,de as gf,df as mf,dg as _f,dh as yf,di as xf,bb as ro,bl as gr,dj as mr,dk as Ef,dl as bf,t as Tf,dm as Ki,dn as _n,dp as Mi,dq as wf,aF as vf,S as Sf,dr as Ta,ds as wa,b3 as $r,aZ as _r,a_ as no,dt as $t,bu as io,du as iu,dv as Rf,dw as Af,aR as Pf,b9 as so,bd as Lf,a7 as If,aT as bs,b6 as su,b7 as ui,b8 as Cf,dx as ou,ba as Ff,b4 as Of,b5 as Ts,aL as au,aP as Mf,aO as Nf,dy as oo,dz as va,ah as Df,aj as Uf,dA as ws,dB as lu,dC as Sa,dD as Ra,dE as ci,dF as uu,dG as Bf,dH as cu,L as Gf,dI as ao,dJ as kf,dK as zf,dL as $f,dM as Vf,dN as jf,dO as Xf,dP as Hf,bt as Wf,aC as Zf,dQ as Yf,s as qf,dR as Kf,dS as Qf}from"./WMTS.BonjY2Cp.js";import{g as Ni,c as lr}from"./commonjsHelpers.Cpj98o6Y.js";import{a4 as tr}from"./framework.BUpHk5hx.js";const Jf={Point:nd,LineString:id,Polygon:ld,MultiPoint:od,MultiLineString:sd,MultiPolygon:ad},ed={Point:ud,LineString:cd,Polygon:hd,MultiPoint:dd,MultiLineString:fd,MultiPolygon:pd};class td extends vh{constructor(e){e=e||{},super(),this.geometryName_=e.geometryName}readFeatureFromObject(e,t,r){const i=e,s=Aa(i.geometry,t),o=new et;if(this.geometryName_&&o.setGeometryName(this.geometryName_),o.setGeometry(s),i.attributes){o.setProperties(i.attributes,!0);const a=i.attributes[r];a!==void 0&&o.setId(a)}return o}readFeaturesFromObject(e,t){if(t=t||{},e.features){const r=e,i=[],s=r.features;for(let o=0,a=s.length;o<a;++o)i.push(this.readFeatureFromObject(s[o],t,e.objectIdFieldName));return i}return[this.readFeatureFromObject(e,t)]}readGeometryFromObject(e,t){return Aa(e,t)}readProjectionFromObject(e){if(e.spatialReference&&e.spatialReference.wkid!==void 0){const r=e.spatialReference.wkid;return ye("EPSG:"+r)}return null}writeGeometryObject(e,t){return Pa(e,this.adaptOptions(t))}writeFeatureObject(e,t){t=this.adaptOptions(t);const r={};if(!e.hasProperties())return r.attributes={},r;const i=e.getProperties(),s=e.getGeometry();if(s){r.geometry=Pa(s,t);const o=t&&(t.dataProjection||t.featureProjection);o&&(r.geometry.spatialReference={wkid:Number(ye(o).getCode().split(":").pop())}),delete i[e.getGeometryName()]}return Sh(i)?r.attributes={}:r.attributes=i,r}writeFeaturesObject(e,t){t=this.adaptOptions(t);const r=[];for(let i=0,s=e.length;i<s;++i)r.push(this.writeFeatureObject(e[i],t));return{features:r}}}function Aa(n,e){if(!n)return null;let t;if(typeof n.x=="number"&&typeof n.y=="number")t="Point";else if(n.points)t="MultiPoint";else if(n.paths)n.paths.length===1?t="LineString":t="MultiLineString";else if(n.rings){const i=n,s=Vr(i),o=rd(i.rings,s);o.length===1?(t="Polygon",n=Object.assign({},n,{rings:o[0]})):(t="MultiPolygon",n=Object.assign({},n,{rings:o}))}const r=Jf[t];return Ge(r(n),!1,e)}function rd(n,e){const t=[],r=[],i=[];let s,o;for(s=0,o=n.length;s<o;++s)t.length=0,Rh(t,0,n[s],e.length),Ah(t,0,t.length,e.length)?r.push([n[s]]):i.push(n[s]);for(;i.length;){const a=i.shift();let l=!1;for(s=r.length-1;s>=0;s--){const u=r[s][0];if(Jn(new gs(u).getExtent(),new gs(a).getExtent())){r[s].push(a),l=!0;break}}l||r.push([a.reverse()])}return r}function nd(n){let e;return n.m!==void 0&&n.z!==void 0?e=new ft([n.x,n.y,n.z,n.m],"XYZM"):n.z!==void 0?e=new ft([n.x,n.y,n.z],"XYZ"):n.m!==void 0?e=new ft([n.x,n.y,n.m],"XYM"):e=new ft([n.x,n.y]),e}function id(n){const e=Vr(n);return new It(n.paths[0],e)}function sd(n){const e=Vr(n);return new kr(n.paths,e)}function Vr(n){let e="XY";return n.hasZ===!0&&n.hasM===!0?e="XYZM":n.hasZ===!0?e="XYZ":n.hasM===!0&&(e="XYM"),e}function od(n){const e=Vr(n);return new Ai(n.points,e)}function ad(n){const e=Vr(n);return new Tn(n.rings,e)}function ld(n){const e=Vr(n);return new cr(n.rings,e)}function ud(n,e){const t=n.getCoordinates();let r;const i=n.getLayout();if(i==="XYZ")r={x:t[0],y:t[1],z:t[2]};else if(i==="XYM")r={x:t[0],y:t[1],m:t[2]};else if(i==="XYZM")r={x:t[0],y:t[1],z:t[2],m:t[3]};else if(i==="XY")r={x:t[0],y:t[1]};else throw new Error("Invalid geometry layout");return r}function Sn(n){const e=n.getLayout();return{hasZ:e==="XYZ"||e==="XYZM",hasM:e==="XYM"||e==="XYZM"}}function cd(n,e){const t=Sn(n);return{hasZ:t.hasZ,hasM:t.hasM,paths:[n.getCoordinates()]}}function hd(n,e){const t=Sn(n);return{hasZ:t.hasZ,hasM:t.hasM,rings:n.getCoordinates(!1)}}function fd(n,e){const t=Sn(n);return{hasZ:t.hasZ,hasM:t.hasM,paths:n.getCoordinates()}}function dd(n,e){const t=Sn(n);return{hasZ:t.hasZ,hasM:t.hasM,points:n.getCoordinates()}}function pd(n,e){const t=Sn(n),r=n.getCoordinates(!1),i=[];for(let s=0;s<r.length;s++)for(let o=r[s].length-1;o>=0;o--)i.push(r[s][o]);return{hasZ:t.hasZ,hasM:t.hasM,rings:i}}function Pa(n,e){const t=ed[n.getType()];return t(Ge(n,!0,e),e)}const Gt="http://www.opengis.net/gml",gd=/^\s*$/;class Z extends Pi{constructor(e){super(),e=e||{},this.featureType=e.featureType,this.featureNS=e.featureNS,this.srsName=e.srsName,this.schemaLocation="",this.FEATURE_COLLECTION_PARSERS={},this.FEATURE_COLLECTION_PARSERS[this.namespace]={featureMember:K(this.readFeaturesInternal),featureMembers:Q(this.readFeaturesInternal)},this.supportedMediaTypes=["application/gml+xml"]}readFeaturesInternal(e,t){const r=e.localName;let i=null;if(r=="FeatureCollection")i=V([],this.FEATURE_COLLECTION_PARSERS,e,t,this);else if(r=="featureMembers"||r=="featureMember"||r=="member"){const s=t[0];let o=s.featureType,a=s.featureNS;const l="p",u="p0";if(!o&&e.childNodes){o=[],a={};for(let d=0,g=e.childNodes.length;d<g;++d){const p=e.childNodes[d];if(p.nodeType===1){const _=p.nodeName.split(":").pop();if(!o.includes(_)){let x="",T=0;const E=p.namespaceURI;for(const w in a){if(a[w]===E){x=w;break}++T}x||(x=l+T,a[x]=E),o.push(x+":"+_)}}}r!="featureMember"&&(s.featureType=o,s.featureNS=a)}if(typeof a=="string"){const d=a;a={},a[u]=d}const f={},c=Array.isArray(o)?o:[o];for(const d in a){const g={};for(let p=0,_=c.length;p<_;++p)(c[p].includes(":")?c[p].split(":")[0]:u)===d&&(g[c[p].split(":").pop()]=r=="featureMembers"?K(this.readFeatureElement,this):Q(this.readFeatureElement,this));f[a[d]]=g}r=="featureMember"||r=="member"?i=V(void 0,f,e,t):i=V([],f,e,t)}return i===null&&(i=[]),i}readGeometryOrExtent(e,t){const r=t[0];return r.srsName=e.firstElementChild.getAttribute("srsName"),r.srsDimension=e.firstElementChild.getAttribute("srsDimension"),V(null,this.GEOMETRY_PARSERS,e,t,this)}readExtentElement(e,t){const r=t[0],i=this.readGeometryOrExtent(e,t);return i?Ws(i,r):void 0}readGeometryElement(e,t){const r=t[0],i=this.readGeometryOrExtent(e,t);return i?Ge(i,!1,r):void 0}readFeatureElementInternal(e,t,r){let i;const s={};for(let l=e.firstElementChild;l;l=l.nextElementSibling){let u;const f=l.localName;l.childNodes.length===0||l.childNodes.length===1&&(l.firstChild.nodeType===3||l.firstChild.nodeType===4)?(u=ei(l,!1),gd.test(u)&&(u=void 0)):(r&&(u=f==="boundedBy"?this.readExtentElement(l,t):this.readGeometryElement(l,t)),u?f!=="boundedBy"&&(i=f):u=this.readFeatureElementInternal(l,t,!1));const c=l.attributes.length;if(c>0&&!(u instanceof Ph)){u={_content_:u};for(let d=0;d<c;d++){const g=l.attributes[d].name;u[g]=l.attributes[d].value}}s[f]?(s[f]instanceof Array||(s[f]=[s[f]]),s[f].push(u)):s[f]=u}if(!r)return s;const o=new et(s);i&&o.setGeometryName(i);const a=e.getAttribute("fid")||Lh(e,this.namespace,"id");return a&&o.setId(a),o}readFeatureElement(e,t){return this.readFeatureElementInternal(e,t,!0)}readPoint(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new ft(r,"XYZ")}readMultiPoint(e,t){const r=V([],this.MULTIPOINT_PARSERS,e,t,this);if(r)return new Ai(r)}readMultiLineString(e,t){const r=V([],this.MULTILINESTRING_PARSERS,e,t,this);if(r)return new kr(r)}readMultiPolygon(e,t){const r=V([],this.MULTIPOLYGON_PARSERS,e,t,this);if(r)return new Tn(r)}pointMemberParser(e,t){Zt(this.POINTMEMBER_PARSERS,e,t,this)}lineStringMemberParser(e,t){Zt(this.LINESTRINGMEMBER_PARSERS,e,t,this)}polygonMemberParser(e,t){Zt(this.POLYGONMEMBER_PARSERS,e,t,this)}readLineString(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new It(r,"XYZ")}readFlatLinearRing(e,t){const r=V(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this);if(r)return r}readLinearRing(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new gs(r,"XYZ")}readPolygon(e,t){const r=V([null],this.FLAT_LINEAR_RINGS_PARSERS,e,t,this);if(r&&r[0]){const i=r[0],s=[i.length];let o,a;for(o=1,a=r.length;o<a;++o)ti(i,r[o]),s.push(i.length);return new cr(i,"XYZ",s)}}readFlatCoordinatesFromNode(e,t){return V(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this)}readGeometryFromNode(e,t){const r=this.readGeometryElement(e,[this.getReadOptions(e,t||{})]);return r||null}readFeaturesFromNode(e,t){const r={featureType:this.featureType,featureNS:this.featureNS};return r&&Object.assign(r,this.getReadOptions(e,t)),this.readFeaturesInternal(e,[r])||[]}readProjectionFromNode(e){return ye(this.srsName?this.srsName:e.firstElementChild.getAttribute("srsName"))}}Z.prototype.namespace=Gt;Z.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{}};Z.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{}};Z.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{}};Z.prototype.MULTIPOINT_PARSERS={"http://www.opengis.net/gml":{pointMember:K(Z.prototype.pointMemberParser),pointMembers:K(Z.prototype.pointMemberParser)}};Z.prototype.MULTILINESTRING_PARSERS={"http://www.opengis.net/gml":{lineStringMember:K(Z.prototype.lineStringMemberParser),lineStringMembers:K(Z.prototype.lineStringMemberParser)}};Z.prototype.MULTIPOLYGON_PARSERS={"http://www.opengis.net/gml":{polygonMember:K(Z.prototype.polygonMemberParser),polygonMembers:K(Z.prototype.polygonMemberParser)}};Z.prototype.POINTMEMBER_PARSERS={"http://www.opengis.net/gml":{Point:K(Z.prototype.readFlatCoordinatesFromNode)}};Z.prototype.LINESTRINGMEMBER_PARSERS={"http://www.opengis.net/gml":{LineString:K(Z.prototype.readLineString)}};Z.prototype.POLYGONMEMBER_PARSERS={"http://www.opengis.net/gml":{Polygon:K(Z.prototype.readPolygon)}};Z.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:Q(Z.prototype.readFlatLinearRing)}};const md=Gt+" http://schemas.opengis.net/gml/2.1.2/feature.xsd",_d={MultiLineString:"lineStringMember",MultiCurve:"curveMember",MultiPolygon:"polygonMember",MultiSurface:"surfaceMember"};class le extends Z{constructor(e){e=e||{},super(e),this.FEATURE_COLLECTION_PARSERS[Gt].featureMember=K(this.readFeaturesInternal),this.schemaLocation=e.schemaLocation?e.schemaLocation:md}readFlatCoordinates(e,t){const r=ei(e,!1).replace(/^\s*|\s*$/g,""),s=t[0].srsName;let o="enu";if(s){const u=ye(s);u&&(o=u.getAxisOrientation())}const a=r.trim().split(/\s+/),l=[];for(let u=0,f=a.length;u<f;u++){const c=a[u].split(/,+/),d=parseFloat(c[0]),g=parseFloat(c[1]),p=c.length===3?parseFloat(c[2]):0;o.startsWith("en")?l.push(d,g,p):l.push(g,d,p)}return l}readBox(e,t){const r=V([null],this.BOX_PARSERS_,e,t,this);return jl(r[1][0],r[1][1],r[1][3],r[1][4])}innerBoundaryIsParser(e,t){const r=V(void 0,this.RING_PARSERS,e,t,this);r&&t[t.length-1].push(r)}outerBoundaryIsParser(e,t){const r=V(void 0,this.RING_PARSERS,e,t,this);if(r){const i=t[t.length-1];i[0]=r}}GEOMETRY_NODE_FACTORY_(e,t,r){const i=t[t.length-1],s=i.multiSurface,o=i.surface,a=i.multiCurve;return Array.isArray(e)?r="Envelope":(r=e.getType(),r==="MultiPolygon"&&s===!0?r="MultiSurface":r==="Polygon"&&o===!0?r="Surface":r==="MultiLineString"&&a===!0&&(r="MultiCurve")),ie("http://www.opengis.net/gml",r)}writeFeatureElement(e,t,r){const i=t.getId();i&&e.setAttribute("fid",i);const s=r[r.length-1],o=s.featureNS,a=t.getGeometryName();s.serializers||(s.serializers={},s.serializers[o]={});const l=[],u=[];if(t.hasProperties()){const c=t.getProperties();for(const d in c){const g=c[d];g!=null&&(l.push(d),u.push(g),d==a||typeof g.getSimplifiedGeometry=="function"?d in s.serializers[o]||(s.serializers[o][d]=I(this.writeGeometryElement,this)):d in s.serializers[o]||(s.serializers[o][d]=I(ce)))}}const f=Object.assign({},s);f.node=e,we(f,s.serializers,at(void 0,o),u,r,l)}writeCurveOrLineString(e,t,r){const s=r[r.length-1].srsName;if(e.nodeName!=="LineStringSegment"&&s&&e.setAttribute("srsName",s),e.nodeName==="LineString"||e.nodeName==="LineStringSegment"){const o=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(o),this.writeCoordinates_(o,t,r)}else if(e.nodeName==="Curve"){const o=ie(e.namespaceURI,"segments");e.appendChild(o),this.writeCurveSegments_(o,t,r)}}writeLineStringOrCurveMember(e,t,r){const i=this.GEOMETRY_NODE_FACTORY_(t,r);i&&(e.appendChild(i),this.writeCurveOrLineString(i,t,r))}writeMultiCurveOrLineString(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName,a=i.curve;o&&e.setAttribute("srsName",o);const l=t.getLineStrings();we({node:e,hasZ:s,srsName:o,curve:a},this.LINESTRINGORCURVEMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeGeometryElement(e,t,r){const i=r[r.length-1],s=Object.assign({},i);s.node=e;let o;Array.isArray(t)?o=Ws(t,i):o=Ge(t,!0,i),we(s,this.GEOMETRY_SERIALIZERS,this.GEOMETRY_NODE_FACTORY_,[o],r,void 0,this)}createCoordinatesNode_(e){const t=ie(e,"coordinates");return t.setAttribute("decimal","."),t.setAttribute("cs",","),t.setAttribute("ts"," "),t}writeCoordinates_(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName,a=t.getCoordinates(),l=a.length,u=new Array(l);for(let f=0;f<l;++f){const c=a[f];u[f]=this.getCoords_(c,o,s)}ce(e,u.join(" "))}writeCurveSegments_(e,t,r){const i=ie(e.namespaceURI,"LineStringSegment");e.appendChild(i),this.writeCurveOrLineString(i,t,r)}writeSurfaceOrPolygon(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName;if(e.nodeName!=="PolygonPatch"&&o&&e.setAttribute("srsName",o),e.nodeName==="Polygon"||e.nodeName==="PolygonPatch"){const a=t.getLinearRings();we({node:e,hasZ:s,srsName:o},this.RING_SERIALIZERS,this.RING_NODE_FACTORY_,a,r,void 0,this)}else if(e.nodeName==="Surface"){const a=ie(e.namespaceURI,"patches");e.appendChild(a),this.writeSurfacePatches_(a,t,r)}}RING_NODE_FACTORY_(e,t,r){const i=t[t.length-1],s=i.node,o=i.exteriorWritten;return o===void 0&&(i.exteriorWritten=!0),ie(s.namespaceURI,o!==void 0?"innerBoundaryIs":"outerBoundaryIs")}writeSurfacePatches_(e,t,r){const i=ie(e.namespaceURI,"PolygonPatch");e.appendChild(i),this.writeSurfaceOrPolygon(i,t,r)}writeRing(e,t,r){const i=ie(e.namespaceURI,"LinearRing");e.appendChild(i),this.writeLinearRing(i,t,r)}getCoords_(e,t,r){let s=(t?ye(t).getAxisOrientation():"enu").startsWith("en")?e[0]+","+e[1]:e[1]+","+e[0];if(r){const o=e[2]||0;s+=","+o}return s}writePoint(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName;o&&e.setAttribute("srsName",o);const a=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(a);const l=t.getCoordinates(),u=this.getCoords_(l,o,s);ce(a,u)}writeMultiPoint(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName;o&&e.setAttribute("srsName",o);const a=t.getPoints();we({node:e,hasZ:s,srsName:o},this.POINTMEMBER_SERIALIZERS,at("pointMember"),a,r,void 0,this)}writePointMember(e,t,r){const i=ie(e.namespaceURI,"Point");e.appendChild(i),this.writePoint(i,t,r)}writeLinearRing(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(o),this.writeCoordinates_(o,t,r)}writeMultiSurfaceOrPolygon(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName,a=i.surface;o&&e.setAttribute("srsName",o);const l=t.getPolygons();we({node:e,hasZ:s,srsName:o,surface:a},this.SURFACEORPOLYGONMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeSurfaceOrPolygonMember(e,t,r){const i=this.GEOMETRY_NODE_FACTORY_(t,r);i&&(e.appendChild(i),this.writeSurfaceOrPolygon(i,t,r))}writeEnvelope(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=["lowerCorner","upperCorner"],a=[t[0]+" "+t[1],t[2]+" "+t[3]];we({node:e},this.ENVELOPE_SERIALIZERS,zr,a,r,o,this)}MULTIGEOMETRY_MEMBER_NODE_FACTORY_(e,t,r){const i=t[t.length-1].node;return ie("http://www.opengis.net/gml",_d[i.nodeName])}}le.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{coordinates:Q(le.prototype.readFlatCoordinates)}};le.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{innerBoundaryIs:le.prototype.innerBoundaryIsParser,outerBoundaryIs:le.prototype.outerBoundaryIsParser}};le.prototype.BOX_PARSERS_={"http://www.opengis.net/gml":{coordinates:K(le.prototype.readFlatCoordinates)}};le.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{Point:Q(Z.prototype.readPoint),MultiPoint:Q(Z.prototype.readMultiPoint),LineString:Q(Z.prototype.readLineString),MultiLineString:Q(Z.prototype.readMultiLineString),LinearRing:Q(Z.prototype.readLinearRing),Polygon:Q(Z.prototype.readPolygon),MultiPolygon:Q(Z.prototype.readMultiPolygon),Box:Q(le.prototype.readBox)}};le.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml":{Curve:I(le.prototype.writeCurveOrLineString),MultiCurve:I(le.prototype.writeMultiCurveOrLineString),Point:I(le.prototype.writePoint),MultiPoint:I(le.prototype.writeMultiPoint),LineString:I(le.prototype.writeCurveOrLineString),MultiLineString:I(le.prototype.writeMultiCurveOrLineString),LinearRing:I(le.prototype.writeLinearRing),Polygon:I(le.prototype.writeSurfaceOrPolygon),MultiPolygon:I(le.prototype.writeMultiSurfaceOrPolygon),Surface:I(le.prototype.writeSurfaceOrPolygon),MultiSurface:I(le.prototype.writeMultiSurfaceOrPolygon),Envelope:I(le.prototype.writeEnvelope)}};le.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{lineStringMember:I(le.prototype.writeLineStringOrCurveMember),curveMember:I(le.prototype.writeLineStringOrCurveMember)}};le.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml":{outerBoundaryIs:I(le.prototype.writeRing),innerBoundaryIs:I(le.prototype.writeRing)}};le.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{pointMember:I(le.prototype.writePointMember)}};le.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{surfaceMember:I(le.prototype.writeSurfaceOrPolygonMember),polygonMember:I(le.prototype.writeSurfaceOrPolygonMember)}};le.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml":{lowerCorner:I(ce),upperCorner:I(ce)}};const yd=Gt+" http://schemas.opengis.net/gml/3.1.1/profiles/gmlsfProfile/1.0.0/gmlsf.xsd",xd={MultiLineString:"lineStringMember",MultiCurve:"curveMember",MultiPolygon:"polygonMember",MultiSurface:"surfaceMember"};class G extends Z{constructor(e){e=e||{},super(e),this.surface_=e.surface!==void 0?e.surface:!1,this.curve_=e.curve!==void 0?e.curve:!1,this.multiCurve_=e.multiCurve!==void 0?e.multiCurve:!0,this.multiSurface_=e.multiSurface!==void 0?e.multiSurface:!0,this.schemaLocation=e.schemaLocation?e.schemaLocation:yd,this.hasZ=e.hasZ!==void 0?e.hasZ:!1}readMultiCurve(e,t){const r=V([],this.MULTICURVE_PARSERS,e,t,this);if(r)return new kr(r)}readFlatCurveRing(e,t){const r=V([],this.MULTICURVE_PARSERS,e,t,this),i=[];for(let s=0,o=r.length;s<o;++s)ti(i,r[s].getFlatCoordinates());return i}readMultiSurface(e,t){const r=V([],this.MULTISURFACE_PARSERS,e,t,this);if(r)return new Tn(r)}curveMemberParser(e,t){Zt(this.CURVEMEMBER_PARSERS,e,t,this)}surfaceMemberParser(e,t){Zt(this.SURFACEMEMBER_PARSERS,e,t,this)}readPatch(e,t){return V([null],this.PATCHES_PARSERS,e,t,this)}readSegment(e,t){return V([],this.SEGMENTS_PARSERS,e,t,this)}readPolygonPatch(e,t){return V([null],this.FLAT_LINEAR_RINGS_PARSERS,e,t,this)}readLineStringSegment(e,t){return V([null],this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this)}interiorParser(e,t){const r=V(void 0,this.RING_PARSERS,e,t,this);r&&t[t.length-1].push(r)}exteriorParser(e,t){const r=V(void 0,this.RING_PARSERS,e,t,this);if(r){const i=t[t.length-1];i[0]=r}}readSurface(e,t){const r=V([null],this.SURFACE_PARSERS,e,t,this);if(r&&r[0]){const i=r[0],s=[i.length];let o,a;for(o=1,a=r.length;o<a;++o)ti(i,r[o]),s.push(i.length);return new cr(i,"XYZ",s)}}readCurve(e,t){const r=V([null],this.CURVE_PARSERS,e,t,this);if(r)return new It(r,"XYZ")}readEnvelope(e,t){const r=V([null],this.ENVELOPE_PARSERS,e,t,this);return jl(r[1][0],r[1][1],r[2][0],r[2][1])}readFlatPos(e,t){let r=ei(e,!1);const i=/^\s*([+\-]?\d*\.?\d+(?:[eE][+\-]?\d+)?)\s*/,s=[];let o;for(;o=i.exec(r);)s.push(parseFloat(o[1])),r=r.substr(o[0].length);if(r!=="")return;const l=t[0].srsName;if((l?ye(l).getAxisOrientation():"enu")==="neu")for(let c=0,d=s.length;c<d;c+=3){const g=s[c],p=s[c+1];s[c]=p,s[c+1]=g}const f=s.length;if(f==2&&s.push(0),f!==0)return s}readFlatPosList(e,t){const r=ei(e,!1).replace(/^\s*|\s*$/g,""),i=t[0],s=i.srsName,o=i.srsDimension,a=s?ye(s).getAxisOrientation():"enu",l=r.split(/\s+/);let u=2;e.getAttribute("srsDimension")?u=Ht(e.getAttribute("srsDimension")):e.getAttribute("dimension")?u=Ht(e.getAttribute("dimension")):e.parentNode.getAttribute("srsDimension")?u=Ht(e.parentNode.getAttribute("srsDimension")):o&&(u=Ht(o));const f=a.startsWith("en");let c,d,g;const p=[];for(let _=0,x=l.length;_<x;_+=u)c=parseFloat(l[_]),d=parseFloat(l[_+1]),g=u===3?parseFloat(l[_+2]):0,f?p.push(c,d,g):p.push(d,c,g);return p}writePos_(e,t,r){const i=r[r.length-1],s=i.hasZ,o=s?"3":"2";e.setAttribute("srsDimension",o);const a=i.srsName,l=a?ye(a).getAxisOrientation():"enu",u=t.getCoordinates();let f=l.startsWith("en")?u[0]+" "+u[1]:u[1]+" "+u[0];if(s){const c=u[2]||0;f+=" "+c}ce(e,f)}getCoords_(e,t,r){let s=(t?ye(t).getAxisOrientation():"enu").startsWith("en")?e[0]+" "+e[1]:e[1]+" "+e[0];if(r){const o=e[2]||0;s+=" "+o}return s}writePosList_(e,t,r){const i=r[r.length-1],s=i.hasZ,o=s?"3":"2";e.setAttribute("srsDimension",o);const a=i.srsName,l=t.getCoordinates(),u=l.length,f=new Array(u);let c;for(let d=0;d<u;++d)c=l[d],f[d]=this.getCoords_(c,a,s);ce(e,f.join(" "))}writePoint(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=ie(e.namespaceURI,"pos");e.appendChild(o),this.writePos_(o,t,r)}writeEnvelope(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=["lowerCorner","upperCorner"],a=[t[0]+" "+t[1],t[2]+" "+t[3]];we({node:e},this.ENVELOPE_SERIALIZERS,zr,a,r,o,this)}writeLinearRing(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=ie(e.namespaceURI,"posList");e.appendChild(o),this.writePosList_(o,t,r)}RING_NODE_FACTORY_(e,t,r){const i=t[t.length-1],s=i.node,o=i.exteriorWritten;return o===void 0&&(i.exteriorWritten=!0),ie(s.namespaceURI,o!==void 0?"interior":"exterior")}writeSurfaceOrPolygon(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName;if(e.nodeName!=="PolygonPatch"&&o&&e.setAttribute("srsName",o),e.nodeName==="Polygon"||e.nodeName==="PolygonPatch"){const a=t.getLinearRings();we({node:e,hasZ:s,srsName:o},this.RING_SERIALIZERS,this.RING_NODE_FACTORY_,a,r,void 0,this)}else if(e.nodeName==="Surface"){const a=ie(e.namespaceURI,"patches");e.appendChild(a),this.writeSurfacePatches_(a,t,r)}}writeCurveOrLineString(e,t,r){const s=r[r.length-1].srsName;if(e.nodeName!=="LineStringSegment"&&s&&e.setAttribute("srsName",s),e.nodeName==="LineString"||e.nodeName==="LineStringSegment"){const o=ie(e.namespaceURI,"posList");e.appendChild(o),this.writePosList_(o,t,r)}else if(e.nodeName==="Curve"){const o=ie(e.namespaceURI,"segments");e.appendChild(o),this.writeCurveSegments_(o,t,r)}}writeMultiSurfaceOrPolygon(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName,a=i.surface;o&&e.setAttribute("srsName",o);const l=t.getPolygons();we({node:e,hasZ:s,srsName:o,surface:a},this.SURFACEORPOLYGONMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeMultiPoint(e,t,r){const i=r[r.length-1],s=i.srsName,o=i.hasZ;s&&e.setAttribute("srsName",s);const a=t.getPoints();we({node:e,hasZ:o,srsName:s},this.POINTMEMBER_SERIALIZERS,at("pointMember"),a,r,void 0,this)}writeMultiCurveOrLineString(e,t,r){const i=r[r.length-1],s=i.hasZ,o=i.srsName,a=i.curve;o&&e.setAttribute("srsName",o);const l=t.getLineStrings();we({node:e,hasZ:s,srsName:o,curve:a},this.LINESTRINGORCURVEMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeRing(e,t,r){const i=ie(e.namespaceURI,"LinearRing");e.appendChild(i),this.writeLinearRing(i,t,r)}writeSurfaceOrPolygonMember(e,t,r){const i=this.GEOMETRY_NODE_FACTORY_(t,r);i&&(e.appendChild(i),this.writeSurfaceOrPolygon(i,t,r))}writePointMember(e,t,r){const i=ie(e.namespaceURI,"Point");e.appendChild(i),this.writePoint(i,t,r)}writeLineStringOrCurveMember(e,t,r){const i=this.GEOMETRY_NODE_FACTORY_(t,r);i&&(e.appendChild(i),this.writeCurveOrLineString(i,t,r))}writeSurfacePatches_(e,t,r){const i=ie(e.namespaceURI,"PolygonPatch");e.appendChild(i),this.writeSurfaceOrPolygon(i,t,r)}writeCurveSegments_(e,t,r){const i=ie(e.namespaceURI,"LineStringSegment");e.appendChild(i),this.writeCurveOrLineString(i,t,r)}writeGeometryElement(e,t,r){const i=r[r.length-1],s=Object.assign({},i);s.node=e;let o;Array.isArray(t)?o=Ws(t,i):o=Ge(t,!0,i),we(s,this.GEOMETRY_SERIALIZERS,this.GEOMETRY_NODE_FACTORY_,[o],r,void 0,this)}writeFeatureElement(e,t,r){const i=t.getId();i&&e.setAttribute("fid",i);const s=r[r.length-1],o=s.featureNS,a=t.getGeometryName();s.serializers||(s.serializers={},s.serializers[o]={});const l=[],u=[];if(t.hasProperties()){const c=t.getProperties();for(const d in c){const g=c[d];g!=null&&(l.push(d),u.push(g),d==a||typeof g.getSimplifiedGeometry=="function"?d in s.serializers[o]||(s.serializers[o][d]=I(this.writeGeometryElement,this)):d in s.serializers[o]||(s.serializers[o][d]=I(ce)))}}const f=Object.assign({},s);f.node=e,we(f,s.serializers,at(void 0,o),u,r,l)}writeFeatureMembers_(e,t,r){const i=r[r.length-1],s=i.featureType,o=i.featureNS,a={};a[o]={},a[o][s]=I(this.writeFeatureElement,this);const l=Object.assign({},i);l.node=e,we(l,a,at(s,o),t,r)}MULTIGEOMETRY_MEMBER_NODE_FACTORY_(e,t,r){const i=t[t.length-1].node;return ie(this.namespace,xd[i.nodeName])}GEOMETRY_NODE_FACTORY_(e,t,r){const i=t[t.length-1],s=i.multiSurface,o=i.surface,a=i.curve,l=i.multiCurve;return Array.isArray(e)?r="Envelope":(r=e.getType(),r==="MultiPolygon"&&s===!0?r="MultiSurface":r==="Polygon"&&o===!0?r="Surface":r==="LineString"&&a===!0?r="Curve":r==="MultiLineString"&&l===!0&&(r="MultiCurve")),ie(this.namespace,r)}writeGeometryNode(e,t){t=this.adaptOptions(t);const r=ie(this.namespace,"geom"),i={node:r,hasZ:this.hasZ,srsName:this.srsName,curve:this.curve_,surface:this.surface_,multiSurface:this.multiSurface_,multiCurve:this.multiCurve_};return t&&Object.assign(i,t),this.writeGeometryElement(r,e,[i]),r}writeFeaturesNode(e,t){t=this.adaptOptions(t);const r=ie(this.namespace,"featureMembers");r.setAttributeNS(fn,"xsi:schemaLocation",this.schemaLocation);const i={srsName:this.srsName,hasZ:this.hasZ,curve:this.curve_,surface:this.surface_,multiSurface:this.multiSurface_,multiCurve:this.multiCurve_,featureNS:this.featureNS,featureType:this.featureType};return t&&Object.assign(i,t),this.writeFeatureMembers_(r,e,[i]),r}}G.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{pos:Q(G.prototype.readFlatPos),posList:Q(G.prototype.readFlatPosList),coordinates:Q(le.prototype.readFlatCoordinates)}};G.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{interior:G.prototype.interiorParser,exterior:G.prototype.exteriorParser}};G.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{Point:Q(Z.prototype.readPoint),MultiPoint:Q(Z.prototype.readMultiPoint),LineString:Q(Z.prototype.readLineString),MultiLineString:Q(Z.prototype.readMultiLineString),LinearRing:Q(Z.prototype.readLinearRing),Polygon:Q(Z.prototype.readPolygon),MultiPolygon:Q(Z.prototype.readMultiPolygon),Surface:Q(G.prototype.readSurface),MultiSurface:Q(G.prototype.readMultiSurface),Curve:Q(G.prototype.readCurve),MultiCurve:Q(G.prototype.readMultiCurve),Envelope:Q(G.prototype.readEnvelope)}};G.prototype.MULTICURVE_PARSERS={"http://www.opengis.net/gml":{curveMember:K(G.prototype.curveMemberParser),curveMembers:K(G.prototype.curveMemberParser)}};G.prototype.MULTISURFACE_PARSERS={"http://www.opengis.net/gml":{surfaceMember:K(G.prototype.surfaceMemberParser),surfaceMembers:K(G.prototype.surfaceMemberParser)}};G.prototype.CURVEMEMBER_PARSERS={"http://www.opengis.net/gml":{LineString:K(Z.prototype.readLineString),Curve:K(G.prototype.readCurve)}};G.prototype.SURFACEMEMBER_PARSERS={"http://www.opengis.net/gml":{Polygon:K(Z.prototype.readPolygon),Surface:K(G.prototype.readSurface)}};G.prototype.SURFACE_PARSERS={"http://www.opengis.net/gml":{patches:Q(G.prototype.readPatch)}};G.prototype.CURVE_PARSERS={"http://www.opengis.net/gml":{segments:Q(G.prototype.readSegment)}};G.prototype.ENVELOPE_PARSERS={"http://www.opengis.net/gml":{lowerCorner:K(G.prototype.readFlatPosList),upperCorner:K(G.prototype.readFlatPosList)}};G.prototype.PATCHES_PARSERS={"http://www.opengis.net/gml":{PolygonPatch:Q(G.prototype.readPolygonPatch)}};G.prototype.SEGMENTS_PARSERS={"http://www.opengis.net/gml":{LineStringSegment:Xl(G.prototype.readLineStringSegment)}};Z.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:Q(Z.prototype.readFlatLinearRing),Ring:Q(G.prototype.readFlatCurveRing)}};G.prototype.writeFeatures;G.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml":{exterior:I(G.prototype.writeRing),interior:I(G.prototype.writeRing)}};G.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml":{lowerCorner:I(ce),upperCorner:I(ce)}};G.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{surfaceMember:I(G.prototype.writeSurfaceOrPolygonMember),polygonMember:I(G.prototype.writeSurfaceOrPolygonMember)}};G.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{pointMember:I(G.prototype.writePointMember)}};G.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{lineStringMember:I(G.prototype.writeLineStringOrCurveMember),curveMember:I(G.prototype.writeLineStringOrCurveMember)}};G.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml":{Curve:I(G.prototype.writeCurveOrLineString),MultiCurve:I(G.prototype.writeMultiCurveOrLineString),Point:I(G.prototype.writePoint),MultiPoint:I(G.prototype.writeMultiPoint),LineString:I(G.prototype.writeCurveOrLineString),MultiLineString:I(G.prototype.writeMultiCurveOrLineString),LinearRing:I(G.prototype.writeLinearRing),Polygon:I(G.prototype.writeSurfaceOrPolygon),MultiPolygon:I(G.prototype.writeMultiSurfaceOrPolygon),Surface:I(G.prototype.writeSurfaceOrPolygon),MultiSurface:I(G.prototype.writeMultiSurfaceOrPolygon),Envelope:I(G.prototype.writeEnvelope)}};const lo=G;lo.prototype.writeFeatures;lo.prototype.writeFeaturesNode;const Ae=[null,"http://www.topografix.com/GPX/1/0","http://www.topografix.com/GPX/1/1"],Ed="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd",bd={rte:hu,trk:fu,wpt:du},Td=H(Ae,{rte:K(hu),trk:K(fu),wpt:K(du)}),wd=H(Ae,{text:S($,"linkText"),type:S($,"linkType")}),vd=H(Ae,{name:S($),email:Kd,link:Rn}),Sd=H(Ae,{name:S($),desc:S($),author:S(Zd),copyright:S(Yd),link:Rn,time:S(Li),keywords:S($),bounds:qd,extensions:Di}),Rd=H(Ae,{year:S(Ie),license:S($)}),Ad=H(Ae,{rte:I(tp),trk:I(rp),wpt:I(ip)});class Pd extends Pi{constructor(e){super(),e=e||{},this.dataProjection=ye("EPSG:4326"),this.readExtensions_=e.readExtensions}handleReadExtensions_(e){e||(e=[]);for(let t=0,r=e.length;t<r;++t){const i=e[t];if(this.readExtensions_){const s=i.get("extensionsNode_")||null;this.readExtensions_(i,s)}i.set("extensionsNode_",void 0)}}readMetadata(e){return e?typeof e=="string"?this.readMetadataFromDocument(ri(e)):ni(e)?this.readMetadataFromDocument(e):this.readMetadataFromNode(e):null}readMetadataFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType===Node.ELEMENT_NODE){const r=this.readMetadataFromNode(t);if(r)return r}return null}readMetadataFromNode(e){if(!Ae.includes(e.namespaceURI))return null;for(let t=e.firstElementChild;t;t=t.nextElementSibling)if(Ae.includes(t.namespaceURI)&&t.localName==="metadata")return V({},Sd,t,[]);return null}readFeatureFromNode(e,t){if(!Ae.includes(e.namespaceURI))return null;const r=bd[e.localName];if(!r)return null;const i=r(e,[this.getReadOptions(e,t)]);return i?(this.handleReadExtensions_([i]),i):null}readFeaturesFromNode(e,t){if(!Ae.includes(e.namespaceURI))return[];if(e.localName=="gpx"){const r=V([],Td,e,[this.getReadOptions(e,t)]);return r?(this.handleReadExtensions_(r),r):[]}return[]}writeFeaturesNode(e,t){t=this.adaptOptions(t);const r=ie("http://www.topografix.com/GPX/1/1","gpx");return r.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xsi",fn),r.setAttributeNS(fn,"xsi:schemaLocation",Ed),r.setAttribute("version","1.1"),r.setAttribute("creator","OpenLayers"),we({node:r},Ad,Wd,e,[t]),r}}const Ld=H(Ae,{name:S($),cmt:S($),desc:S($),src:S($),link:Rn,number:S(Ie),extensions:Di,type:S($),rtept:Qd}),Id=H(Ae,{ele:S(We),time:S(Li)}),Cd=H(Ae,{name:S($),cmt:S($),desc:S($),src:S($),link:Rn,number:S(Ie),type:S($),extensions:Di,trkseg:ep}),Fd=H(Ae,{trkpt:Jd}),Od=H(Ae,{ele:S(We),time:S(Li)}),Md=H(Ae,{ele:S(We),time:S(Li),magvar:S(We),geoidheight:S(We),name:S($),cmt:S($),desc:S($),src:S($),link:Rn,sym:S($),type:S($),fix:S($),sat:S(Ie),hdop:S(We),vdop:S(We),pdop:S(We),ageofdgpsdata:S(We),dgpsid:S(Ie),extensions:Di}),Nd=["text","type"],Dd=H(Ae,{text:I(ce),type:I(ce)}),Ud=H(Ae,["name","cmt","desc","src","link","number","type","rtept"]),Bd=H(Ae,{name:I(ce),cmt:I(ce),desc:I(ce),src:I(ce),link:I(ho),number:I(ii),type:I(ce),rtept:Hl(I(fo))}),Gd=H(Ae,["ele","time"]),kd=H(Ae,["name","cmt","desc","src","link","number","type","trkseg"]),zd=H(Ae,{name:I(ce),cmt:I(ce),desc:I(ce),src:I(ce),link:I(ho),number:I(ii),type:I(ce),trkseg:Hl(I(np))}),$d=at("trkpt"),Vd=H(Ae,{trkpt:I(fo)}),jd=H(Ae,["ele","time","magvar","geoidheight","name","cmt","desc","src","link","sym","type","fix","sat","hdop","vdop","pdop","ageofdgpsdata","dgpsid"]),Xd=H(Ae,{ele:I(nr),time:I(Ih),magvar:I(nr),geoidheight:I(nr),name:I(ce),cmt:I(ce),desc:I(ce),src:I(ce),link:I(ho),sym:I(ce),type:I(ce),fix:I(ce),sat:I(ii),hdop:I(nr),vdop:I(nr),pdop:I(nr),ageofdgpsdata:I(nr),dgpsid:I(ii)}),Hd={Point:"wpt",LineString:"rte",MultiLineString:"trk"};function Wd(n,e,t){const r=n.getGeometry();if(r){const i=Hd[r.getType()];if(i){const s=e[e.length-1].node;return ie(s.namespaceURI,i)}}}function uo(n,e,t,r){return n.push(parseFloat(t.getAttribute("lon")),parseFloat(t.getAttribute("lat"))),"ele"in r?(n.push(r.ele),delete r.ele,e.hasZ=!0):n.push(0),"time"in r?(n.push(r.time),delete r.time,e.hasM=!0):n.push(0),n}function co(n,e,t){let r="XY",i=2;if(n.hasZ&&n.hasM?(r="XYZM",i=4):n.hasZ?(r="XYZ",i=3):n.hasM&&(r="XYM",i=3),i!==4){for(let s=0,o=e.length/4;s<o;s++)e[s*i]=e[s*4],e[s*i+1]=e[s*4+1],n.hasZ&&(e[s*i+2]=e[s*4+2]),n.hasM&&(e[s*i+2]=e[s*4+3]);if(e.length=e.length/4*i,t)for(let s=0,o=t.length;s<o;s++)t[s]=t[s]/4*i}return r}function Zd(n,e){const t=V({},vd,n,e);if(t)return t}function Yd(n,e){const t=V({},Rd,n,e);if(t){const r=n.getAttribute("author");return r!==null&&(t.author=r),t}}function qd(n,e){const t=e[e.length-1],r=n.getAttribute("minlat"),i=n.getAttribute("minlon"),s=n.getAttribute("maxlat"),o=n.getAttribute("maxlon");i!==null&&r!==null&&o!==null&&s!==null&&(t.bounds=[[parseFloat(i),parseFloat(r)],[parseFloat(o),parseFloat(s)]])}function Kd(n,e){const t=e[e.length-1],r=n.getAttribute("id"),i=n.getAttribute("domain");r!==null&&i!==null&&(t.email=`${r}@${i}`)}function Rn(n,e){const t=e[e.length-1],r=n.getAttribute("href");r!==null&&(t.link=r),Zt(wd,n,e)}function Di(n,e){const t=e[e.length-1];t.extensionsNode_=n}function Qd(n,e){const t=V({},Id,n,e);if(t){const r=e[e.length-1],i=r.flatCoordinates,s=r.layoutOptions;uo(i,s,n,t)}}function Jd(n,e){const t=V({},Od,n,e);if(t){const r=e[e.length-1],i=r.flatCoordinates,s=r.layoutOptions;uo(i,s,n,t)}}function ep(n,e){const t=e[e.length-1];Zt(Fd,n,e);const r=t.flatCoordinates;t.ends.push(r.length)}function hu(n,e){const t=e[0],r=V({flatCoordinates:[],layoutOptions:{}},Ld,n,e);if(!r)return;const i=r.flatCoordinates;delete r.flatCoordinates;const s=r.layoutOptions;delete r.layoutOptions;const o=co(s,i),a=new It(i,o);Ge(a,!1,t);const l=new et(a);return l.setProperties(r,!0),l}function fu(n,e){const t=e[0],r=V({flatCoordinates:[],ends:[],layoutOptions:{}},Cd,n,e);if(!r)return;const i=r.flatCoordinates;delete r.flatCoordinates;const s=r.ends;delete r.ends;const o=r.layoutOptions;delete r.layoutOptions;const a=co(o,i,s),l=new kr(i,a,s);Ge(l,!1,t);const u=new et(l);return u.setProperties(r,!0),u}function du(n,e){const t=e[0],r=V({},Md,n,e);if(!r)return;const i={},s=uo([],i,n,r),o=co(i,s),a=new ft(s,o);Ge(a,!1,t);const l=new et(a);return l.setProperties(r,!0),l}function ho(n,e,t){n.setAttribute("href",e);const i=t[t.length-1].properties,s=[i.linkText,i.linkType];we({node:n},Dd,zr,s,t,Nd)}function fo(n,e,t){const r=t[t.length-1],s=r.node.namespaceURI,o=r.properties;switch(n.setAttributeNS(null,"lat",String(e[1])),n.setAttributeNS(null,"lon",String(e[0])),r.geometryLayout){case"XYZM":e[3]!==0&&(o.time=e[3]);case"XYZ":e[2]!==0&&(o.ele=e[2]);break;case"XYM":e[2]!==0&&(o.time=e[2]);break}const l=n.nodeName=="rtept"?Gd[s]:jd[s],u=Zs(o,l);we({node:n,properties:o},Xd,zr,u,t,l)}function tp(n,e,t){const r=t[0],i=e.getProperties(),s={node:n};s.properties=i;const o=e.getGeometry();if(o.getType()=="LineString"){const f=Ge(o,!0,r);s.geometryLayout=f.getLayout(),i.rtept=f.getCoordinates()}const a=t[t.length-1].node,l=Ud[a.namespaceURI],u=Zs(i,l);we(s,Bd,zr,u,t,l)}function rp(n,e,t){const r=t[0],i=e.getProperties(),s={node:n};s.properties=i;const o=e.getGeometry();if(o.getType()=="MultiLineString"){const f=Ge(o,!0,r);i.trkseg=f.getLineStrings()}const a=t[t.length-1].node,l=kd[a.namespaceURI],u=Zs(i,l);we(s,zd,zr,u,t,l)}function np(n,e,t){const r={node:n};r.geometryLayout=e.getLayout(),r.properties={},we(r,Vd,$d,e.getCoordinates(),t)}function ip(n,e,t){const r=t[0],i=t[t.length-1];i.properties=e.getProperties();const s=e.getGeometry();if(s.getType()=="Point"){const o=Ge(s,!0,r);i.geometryLayout=o.getLayout(),fo(n,o.getCoordinates(),t)}}class po extends Wl{constructor(){super()}getType(){return"text"}readFeature(e,t){return this.readFeatureFromText(Gn(e),this.adaptOptions(t))}readFeatureFromText(e,t){return Mt()}readFeatures(e,t){return this.readFeaturesFromText(Gn(e),this.adaptOptions(t))}readFeaturesFromText(e,t){return Mt()}readGeometry(e,t){return this.readGeometryFromText(Gn(e),this.adaptOptions(t))}readGeometryFromText(e,t){return Mt()}readProjection(e){return this.readProjectionFromText(Gn(e))}readProjectionFromText(e){return this.dataProjection}writeFeature(e,t){return this.writeFeatureText(e,this.adaptOptions(t))}writeFeatureText(e,t){return Mt()}writeFeatures(e,t){return this.writeFeaturesText(e,this.adaptOptions(t))}writeFeaturesText(e,t){return Mt()}writeGeometry(e,t){return this.writeGeometryText(e,this.adaptOptions(t))}writeGeometryText(e,t){return Mt()}}function Gn(n){return typeof n=="string"?n:""}const sp=/^B(\d{2})(\d{2})(\d{2})(\d{2})(\d{5})([NS])(\d{3})(\d{5})([EW])([AV])(\d{5})(\d{5})/,op=/^H.([A-Z]{3}).*?:(.*)/,ap=/^HFDTE(\d{2})(\d{2})(\d{2})/,lp=/^HFDTEDATE:(\d{2})(\d{2})(\d{2}),(\d{2})/,up=/\r\n|\r|\n/;class cp extends po{constructor(e){super(),e=e||{},this.dataProjection=ye("EPSG:4326"),this.altitudeMode_=e.altitudeMode?e.altitudeMode:"none",this.lad_=!1,this.lod_=!1,this.ladStart_=0,this.ladStop_=0,this.lodStart_=0,this.lodStop_=0}readFeatureFromText(e,t){const r=this.altitudeMode_,i=e.split(up),s={},o=[];let a=2e3,l=0,u=1,f=-1,c,d;for(c=0,d=i.length;c<d;++c){const x=i[c];let T;if(x.charAt(0)=="B"){if(T=sp.exec(x),T){const E=parseInt(T[1],10),w=parseInt(T[2],10),A=parseInt(T[3],10);let P=parseInt(T[4],10)+parseInt(T[5],10)/6e4;this.lad_&&(P+=parseInt(x.slice(this.ladStart_,this.ladStop_),10)/6e4/10**(this.ladStop_-this.ladStart_)),T[6]=="S"&&(P=-P);let C=parseInt(T[7],10)+parseInt(T[8],10)/6e4;if(this.lod_&&(C+=parseInt(x.slice(this.lodStart_,this.lodStop_),10)/6e4/10**(this.lodStop_-this.lodStart_)),T[9]=="W"&&(C=-C),o.push(C,P),r!="none"){let U;r=="gps"?U=parseInt(T[11],10):r=="barometric"?U=parseInt(T[12],10):U=0,o.push(U)}let N=Date.UTC(a,l,u,E,w,A);N<f&&(N=Date.UTC(a,l,u+1,E,w,A)),o.push(N/1e3),f=N}}else if(x.charAt(0)=="H")T=lp.exec(x),T?(u=parseInt(T[1],10),l=parseInt(T[2],10)-1,a=2e3+parseInt(T[3],10)):(T=ap.exec(x),T?(u=parseInt(T[1],10),l=parseInt(T[2],10)-1,a=2e3+parseInt(T[3],10)):(T=op.exec(x),T&&(s[T[1]]=T[2].trim())));else if(x.charAt(0)=="I"){const E=parseInt(x.slice(1,3),10);for(let w=0;w<E;w++){const A=x.slice(7+w*7,10+w*7);if(A==="LAD"||A==="LOD"){const P=parseInt(x.slice(3+w*7,5+w*7),10)-1,C=parseInt(x.slice(5+w*7,7+w*7),10);A==="LAD"?(this.lad_=!0,this.ladStart_=P,this.ladStop_=C):A==="LOD"&&(this.lod_=!0,this.lodStart_=P,this.lodStop_=C)}}}}if(o.length===0)return null;const g=r=="none"?"XYM":"XYZM",p=new It(o,g),_=new et(Ge(p,!1,t));return _.setProperties(s,!0),_}readFeaturesFromText(e,t){const r=this.readFeatureFromText(e,t);return r?[r]:[]}}const Me={VERSION1:"version1",VERSION2:"version2",VERSION3:"version3"},fr={};fr[Me.VERSION1]={level0:{supports:[],formats:[],qualities:["native"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["native"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg","png"],qualities:["native","color","grey","bitonal"]}};fr[Me.VERSION2]={level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByDistortedWh","sizeByWh"],formats:["jpg","png"],qualities:["default","bitonal"]}};fr[Me.VERSION3]={level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","regionSquare","sizeByW","sizeByH","sizeByWh"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionSquare","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg","png"],qualities:["default"]}};fr.none={none:{supports:[],formats:[],qualities:[]}};const hp=/^https?:\/\/library\.stanford\.edu\/iiif\/image-api\/(?:1\.1\/)?compliance\.html#level[0-2]$/,La=/^https?:\/\/iiif\.io\/api\/image\/2\/level[0-2](?:\.json)?$/,fp=/(^https?:\/\/iiif\.io\/api\/image\/3\/level[0-2](?:\.json)?$)|(^level[0-2]$)/;function dp(n){let e=n.getComplianceLevelSupportedFeatures();return e===void 0&&(e=fr[Me.VERSION1].level0),{url:n.imageInfo["@id"]===void 0?void 0:n.imageInfo["@id"].replace(/\/?(?:info\.json)?$/g,""),supports:e.supports,formats:[...e.formats,n.imageInfo.formats===void 0?[]:n.imageInfo.formats],qualities:[...e.qualities,n.imageInfo.qualities===void 0?[]:n.imageInfo.qualities],resolutions:n.imageInfo.scale_factors,tileSize:n.imageInfo.tile_width!==void 0?n.imageInfo.tile_height!==void 0?[n.imageInfo.tile_width,n.imageInfo.tile_height]:[n.imageInfo.tile_width,n.imageInfo.tile_width]:n.imageInfo.tile_height!=null?[n.imageInfo.tile_height,n.imageInfo.tile_height]:void 0}}function pp(n){const e=n.getComplianceLevelSupportedFeatures(),t=Array.isArray(n.imageInfo.profile)&&n.imageInfo.profile.length>1,r=t&&n.imageInfo.profile[1].supports?n.imageInfo.profile[1].supports:[],i=t&&n.imageInfo.profile[1].formats?n.imageInfo.profile[1].formats:[],s=t&&n.imageInfo.profile[1].qualities?n.imageInfo.profile[1].qualities:[];return{url:n.imageInfo["@id"].replace(/\/?(?:info\.json)?$/g,""),sizes:n.imageInfo.sizes===void 0?void 0:n.imageInfo.sizes.map(function(o){return[o.width,o.height]}),tileSize:n.imageInfo.tiles===void 0?void 0:[n.imageInfo.tiles.map(function(o){return o.width})[0],n.imageInfo.tiles.map(function(o){return o.height===void 0?o.width:o.height})[0]],resolutions:n.imageInfo.tiles===void 0?void 0:n.imageInfo.tiles.map(function(o){return o.scaleFactors})[0],supports:[...e.supports,...r],formats:[...e.formats,...i],qualities:[...e.qualities,...s]}}function gp(n){const e=n.getComplianceLevelSupportedFeatures(),t=n.imageInfo.extraFormats===void 0?e.formats:[...e.formats,...n.imageInfo.extraFormats],r=n.imageInfo.preferredFormats!==void 0&&Array.isArray(n.imageInfo.preferredFormats)&&n.imageInfo.preferredFormats.length>0?n.imageInfo.preferredFormats.filter(function(i){return["jpg","png","gif"].includes(i)}).reduce(function(i,s){return i===void 0&&t.includes(s)?s:i},void 0):void 0;return{url:n.imageInfo.id,sizes:n.imageInfo.sizes===void 0?void 0:n.imageInfo.sizes.map(function(i){return[i.width,i.height]}),tileSize:n.imageInfo.tiles===void 0?void 0:[n.imageInfo.tiles.map(function(i){return i.width})[0],n.imageInfo.tiles.map(function(i){return i.height})[0]],resolutions:n.imageInfo.tiles===void 0?void 0:n.imageInfo.tiles.map(function(i){return i.scaleFactors})[0],supports:n.imageInfo.extraFeatures===void 0?e.supports:[...e.supports,...n.imageInfo.extraFeatures],formats:t,qualities:n.imageInfo.extraQualities===void 0?e.qualities:[...e.qualities,...n.imageInfo.extraQualities],preferredFormat:r}}const Ui={};Ui[Me.VERSION1]=dp;Ui[Me.VERSION2]=pp;Ui[Me.VERSION3]=gp;class mp{constructor(e){this.setImageInfo(e)}setImageInfo(e){typeof e=="string"?this.imageInfo=JSON.parse(e):this.imageInfo=e}getImageApiVersion(){if(this.imageInfo===void 0)return;let e=this.imageInfo["@context"]||"ol-no-context";typeof e=="string"&&(e=[e]);for(let t=0;t<e.length;t++)switch(e[t]){case"http://library.stanford.edu/iiif/image-api/1.1/context.json":case"http://iiif.io/api/image/1/context.json":return Me.VERSION1;case"http://iiif.io/api/image/2/context.json":return Me.VERSION2;case"http://iiif.io/api/image/3/context.json":return Me.VERSION3;case"ol-no-context":if(this.getComplianceLevelEntryFromProfile(Me.VERSION1)&&this.imageInfo.identifier)return Me.VERSION1;break}dt(!1,"Cannot determine IIIF Image API version from provided image information JSON")}getComplianceLevelEntryFromProfile(e){if(!(this.imageInfo===void 0||this.imageInfo.profile===void 0))switch(e===void 0&&(e=this.getImageApiVersion()),e){case Me.VERSION1:if(hp.test(this.imageInfo.profile))return this.imageInfo.profile;break;case Me.VERSION3:if(fp.test(this.imageInfo.profile))return this.imageInfo.profile;break;case Me.VERSION2:if(typeof this.imageInfo.profile=="string"&&La.test(this.imageInfo.profile))return this.imageInfo.profile;if(Array.isArray(this.imageInfo.profile)&&this.imageInfo.profile.length>0&&typeof this.imageInfo.profile[0]=="string"&&La.test(this.imageInfo.profile[0]))return this.imageInfo.profile[0];break}}getComplianceLevelFromProfile(e){const t=this.getComplianceLevelEntryFromProfile(e);if(t===void 0)return;const r=t.match(/level[0-2](?:\.json)?$/g);return Array.isArray(r)?r[0].replace(".json",""):void 0}getComplianceLevelSupportedFeatures(){if(this.imageInfo===void 0)return;const e=this.getImageApiVersion(),t=this.getComplianceLevelFromProfile(e);return t===void 0?fr.none.none:fr[e][t]}getTileSourceOptions(e){const t=e||{},r=this.getImageApiVersion();if(r===void 0)return;const i=r===void 0?void 0:Ui[r](this);if(i!==void 0)return{url:i.url,version:r,size:[this.imageInfo.width,this.imageInfo.height],sizes:i.sizes,format:t.format!==void 0&&i.formats.includes(t.format)?t.format:i.preferredFormat!==void 0?i.preferredFormat:"jpg",supports:i.supports,quality:t.quality&&i.qualities.includes(t.quality)?t.quality:i.qualities.includes("native")?"native":"default",resolutions:Array.isArray(i.resolutions)?i.resolutions.sort(function(s,o){return o-s}):void 0,tileSize:i.tileSize}}}class go{read(e){if(!e)return null;if(typeof e=="string"){const t=ri(e);return this.readFromDocument(t)}return ni(e)?this.readFromDocument(e):this.readFromNode(e)}readFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readFromNode(t);return null}readFromNode(e){Mt()}}const _p="http://www.w3.org/1999/xlink";function jr(n){return n.getAttributeNS(_p,"href")}const rt=[null,"http://www.opengis.net/ows/1.1"],yp=H(rt,{ServiceIdentification:S($p),ServiceProvider:S(jp),OperationsMetadata:S(kp)});class pu extends go{constructor(){super()}readFromNode(e){const t=V({},yp,e,[]);return t||null}}const xp=H(rt,{DeliveryPoint:S($),City:S($),AdministrativeArea:S($),PostalCode:S($),Country:S($),ElectronicMailAddress:S($)}),Ep=H(rt,{Value:be(Xp)}),bp=H(rt,{AllowedValues:S(Op)}),Tp=H(rt,{Phone:S(zp),Address:S(Fp)}),wp=H(rt,{HTTP:S(Bp)}),vp=H(rt,{Get:be(Up),Post:void 0}),Sp=H(rt,{DCP:S(Dp)}),Rp=H(rt,{Operation:Gp}),Ap=H(rt,{Voice:S($),Facsimile:S($)}),Pp=H(rt,{Constraint:be(Mp)}),Lp=H(rt,{IndividualName:S($),PositionName:S($),ContactInfo:S(Np)}),Ip=H(rt,{Abstract:S($),AccessConstraints:S($),Fees:S($),Title:S($),ServiceTypeVersion:S($),ServiceType:S($)}),Cp=H(rt,{ProviderName:S($),ProviderSite:S(jr),ServiceContact:S(Vp)});function Fp(n,e){return V({},xp,n,e)}function Op(n,e){return V({},Ep,n,e)}function Mp(n,e){const t=n.getAttribute("name");if(t)return V({name:t},bp,n,e)}function Np(n,e){return V({},Tp,n,e)}function Dp(n,e){return V({},wp,n,e)}function Up(n,e){const t=jr(n);if(t)return V({href:t},Pp,n,e)}function Bp(n,e){return V({},vp,n,e)}function Gp(n,e){const t=n.getAttribute("name"),r=V({},Sp,n,e);if(!r)return;const i=e[e.length-1];i[t]=r}function kp(n,e){return V({},Rp,n,e)}function zp(n,e){return V({},Ap,n,e)}function $p(n,e){return V({},Ip,n,e)}function Vp(n,e){return V({},Lp,n,e)}function jp(n,e){return V({},Cp,n,e)}function Xp(n,e){return $(n)}function Ia(n,e,t,r,i,s){i!==void 0?(i=i,s=s!==void 0?s:0):(i=[],s=0);let o=e;for(;o<t;){const a=n[o++];i[s++]=n[o++],i[s++]=a;for(let l=2;l<r;++l)i[s++]=n[o++]}return i.length=s,i}class Hp extends po{constructor(e){super(),e=e||{},this.dataProjection=ye("EPSG:4326"),this.factor_=e.factor?e.factor:1e5,this.geometryLayout_=e.geometryLayout?e.geometryLayout:"XY"}readFeatureFromText(e,t){const r=this.readGeometryFromText(e,t);return new et(r)}readFeaturesFromText(e,t){return[this.readFeatureFromText(e,t)]}readGeometryFromText(e,t){const r=Ch(this.geometryLayout_),i=Zp(e,r,this.factor_);Ia(i,0,i.length,r,i);const s=Fh(i,0,i.length,r),o=new It(s,this.geometryLayout_);return Ge(o,!1,this.adaptOptions(t))}writeFeatureText(e,t){const r=e.getGeometry();if(r)return this.writeGeometryText(r,t);throw new Error("Expected `feature` to have a geometry")}writeFeaturesText(e,t){return this.writeFeatureText(e[0],t)}writeGeometryText(e,t){e=Ge(e,!0,this.adaptOptions(t));const r=e.getFlatCoordinates(),i=e.getStride();return Ia(r,0,r.length,i,r),Wp(r,i,this.factor_)}}function Wp(n,e,t){t=t||1e5;let r;const i=new Array(e);for(r=0;r<e;++r)i[r]=0;for(let s=0,o=n.length;s<o;)for(r=0;r<e;++r,++s){const a=n[s],l=a-i[r];i[r]=a,n[s]=l}return Yp(n,t)}function Zp(n,e,t){t=t||1e5;let r;const i=new Array(e);for(r=0;r<e;++r)i[r]=0;const s=qp(n,t);for(let o=0,a=s.length;o<a;)for(r=0;r<e;++r,++o)i[r]+=s[o],s[o]=i[r];return s}function Yp(n,e){e=e||1e5;for(let t=0,r=n.length;t<r;++t)n[t]=Math.round(n[t]*e);return Kp(n)}function qp(n,e){e=e||1e5;const t=Qp(n);for(let r=0,i=t.length;r<i;++r)t[r]/=e;return t}function Kp(n){for(let e=0,t=n.length;e<t;++e){const r=n[e];n[e]=r<0?~(r<<1):r<<1}return Jp(n)}function Qp(n){const e=eg(n);for(let t=0,r=e.length;t<r;++t){const i=e[t];e[t]=i&1?~(i>>1):i>>1}return e}function Jp(n){let e="";for(let t=0,r=n.length;t<r;++t)e+=tg(n[t]);return e}function eg(n){const e=[];let t=0,r=0;for(let i=0,s=n.length;i<s;++i){const o=n.charCodeAt(i)-63;t|=(o&31)<<r,o<32?(e.push(t),t=0,r=0):r+=5}return e}function tg(n){let e,t="";for(;n>=32;)e=(32|n&31)+63,t+=String.fromCharCode(e),n>>=5;return e=n+63,t+=String.fromCharCode(e),t}class pe extends G{constructor(e){e=e||{},super(e),this.schemaLocation=e.schemaLocation?e.schemaLocation:this.namespace+" http://schemas.opengis.net/gml/3.2.1/gml.xsd"}writeGeometryElement(e,t,r){const i=r[r.length-1];r[r.length-1]=Object.assign({multiCurve:!0,multiSurface:!0},i),super.writeGeometryElement(e,t,r)}}pe.prototype.namespace="http://www.opengis.net/gml/3.2";pe.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml/3.2":{pos:Q(G.prototype.readFlatPos),posList:Q(G.prototype.readFlatPosList),coordinates:Q(le.prototype.readFlatCoordinates)}};pe.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml/3.2":{interior:G.prototype.interiorParser,exterior:G.prototype.exteriorParser}};pe.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml/3.2":{Point:Q(Z.prototype.readPoint),MultiPoint:Q(Z.prototype.readMultiPoint),LineString:Q(Z.prototype.readLineString),MultiLineString:Q(Z.prototype.readMultiLineString),LinearRing:Q(Z.prototype.readLinearRing),Polygon:Q(Z.prototype.readPolygon),MultiPolygon:Q(Z.prototype.readMultiPolygon),Surface:Q(pe.prototype.readSurface),MultiSurface:Q(G.prototype.readMultiSurface),Curve:Q(pe.prototype.readCurve),MultiCurve:Q(G.prototype.readMultiCurve),Envelope:Q(pe.prototype.readEnvelope)}};pe.prototype.MULTICURVE_PARSERS={"http://www.opengis.net/gml/3.2":{curveMember:K(G.prototype.curveMemberParser),curveMembers:K(G.prototype.curveMemberParser)}};pe.prototype.MULTISURFACE_PARSERS={"http://www.opengis.net/gml/3.2":{surfaceMember:K(G.prototype.surfaceMemberParser),surfaceMembers:K(G.prototype.surfaceMemberParser)}};pe.prototype.CURVEMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{LineString:K(Z.prototype.readLineString),Curve:K(G.prototype.readCurve)}};pe.prototype.SURFACEMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Polygon:K(Z.prototype.readPolygon),Surface:K(G.prototype.readSurface)}};pe.prototype.SURFACE_PARSERS={"http://www.opengis.net/gml/3.2":{patches:Q(G.prototype.readPatch)}};pe.prototype.CURVE_PARSERS={"http://www.opengis.net/gml/3.2":{segments:Q(G.prototype.readSegment)}};pe.prototype.ENVELOPE_PARSERS={"http://www.opengis.net/gml/3.2":{lowerCorner:K(G.prototype.readFlatPosList),upperCorner:K(G.prototype.readFlatPosList)}};pe.prototype.PATCHES_PARSERS={"http://www.opengis.net/gml/3.2":{PolygonPatch:Q(G.prototype.readPolygonPatch)}};pe.prototype.SEGMENTS_PARSERS={"http://www.opengis.net/gml/3.2":{LineStringSegment:Xl(G.prototype.readLineStringSegment)}};pe.prototype.MULTIPOINT_PARSERS={"http://www.opengis.net/gml/3.2":{pointMember:K(Z.prototype.pointMemberParser),pointMembers:K(Z.prototype.pointMemberParser)}};pe.prototype.MULTILINESTRING_PARSERS={"http://www.opengis.net/gml/3.2":{lineStringMember:K(Z.prototype.lineStringMemberParser),lineStringMembers:K(Z.prototype.lineStringMemberParser)}};pe.prototype.MULTIPOLYGON_PARSERS={"http://www.opengis.net/gml/3.2":{polygonMember:K(Z.prototype.polygonMemberParser),polygonMembers:K(Z.prototype.polygonMemberParser)}};pe.prototype.POINTMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Point:K(Z.prototype.readFlatCoordinatesFromNode)}};pe.prototype.LINESTRINGMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{LineString:K(Z.prototype.readLineString)}};pe.prototype.POLYGONMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Polygon:K(Z.prototype.readPolygon)}};pe.prototype.RING_PARSERS={"http://www.opengis.net/gml/3.2":{LinearRing:Q(Z.prototype.readFlatLinearRing),Ring:Q(pe.prototype.readFlatCurveRing)}};pe.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml/3.2":{exterior:I(G.prototype.writeRing),interior:I(G.prototype.writeRing)}};pe.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml/3.2":{lowerCorner:I(ce),upperCorner:I(ce)}};pe.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{surfaceMember:I(G.prototype.writeSurfaceOrPolygonMember),polygonMember:I(G.prototype.writeSurfaceOrPolygonMember)}};pe.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{pointMember:I(G.prototype.writePointMember)}};pe.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{lineStringMember:I(G.prototype.writeLineStringOrCurveMember),curveMember:I(G.prototype.writeLineStringOrCurveMember)}};pe.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml/3.2":{Curve:I(G.prototype.writeCurveOrLineString),MultiCurve:I(G.prototype.writeMultiCurveOrLineString),Point:I(pe.prototype.writePoint),MultiPoint:I(G.prototype.writeMultiPoint),LineString:I(G.prototype.writeCurveOrLineString),MultiLineString:I(G.prototype.writeMultiCurveOrLineString),LinearRing:I(G.prototype.writeLinearRing),Polygon:I(G.prototype.writeSurfaceOrPolygon),MultiPolygon:I(G.prototype.writeMultiSurfaceOrPolygon),Surface:I(G.prototype.writeSurfaceOrPolygon),MultiSurface:I(G.prototype.writeMultiSurfaceOrPolygon),Envelope:I(G.prototype.writeEnvelope)}};class gu{constructor(e){this.tagName_=e}getTagName(){return this.tagName_}}class rg extends gu{constructor(e,t){super(e),this.conditions=t,dt(this.conditions.length>=2,"At least 2 conditions are required")}}class ng extends rg{constructor(e){super("And",Array.prototype.slice.call(arguments))}}class ig extends gu{constructor(e,t,r){if(super("BBOX"),this.geometryName=e,this.extent=t,t.length!==4)throw new Error("Expected an extent with four values ([minX, minY, maxX, maxY])");this.srsName=r}}function sg(n){const e=[null].concat(Array.prototype.slice.call(arguments));return new(Function.prototype.bind.apply(ng,e))}function og(n,e,t){return new ig(n,e,t)}const Ca={"http://www.opengis.net/gml":{boundedBy:S(Z.prototype.readExtentElement,"bounds")},"http://www.opengis.net/wfs/2.0":{member:K(Z.prototype.readFeaturesInternal)}},ag={"http://www.opengis.net/wfs":{totalInserted:S(Ie),totalUpdated:S(Ie),totalDeleted:S(Ie)},"http://www.opengis.net/wfs/2.0":{totalInserted:S(Ie),totalUpdated:S(Ie),totalDeleted:S(Ie)}},lg={"http://www.opengis.net/wfs":{TransactionSummary:S(Oa,"transactionSummary"),InsertResults:S(Na,"insertIds")},"http://www.opengis.net/wfs/2.0":{TransactionSummary:S(Oa,"transactionSummary"),InsertResults:S(Na,"insertIds")}},ug={"http://www.opengis.net/wfs":{PropertyName:I(ce)},"http://www.opengis.net/wfs/2.0":{PropertyName:I(ce)}},mu={"http://www.opengis.net/wfs":{Insert:I(Da),Update:I(Ba),Delete:I(Ua),Property:I(Ga),Native:I(ka)},"http://www.opengis.net/wfs/2.0":{Insert:I(Da),Update:I(Ba),Delete:I(Ua),Property:I(Ga),Native:I(ka)}},_u="feature",mo="http://www.w3.org/2000/xmlns/",_o={"2.0.0":"http://www.opengis.net/ogc/1.1","1.1.0":"http://www.opengis.net/ogc","1.0.0":"http://www.opengis.net/ogc"},vs={"2.0.0":"http://www.opengis.net/wfs/2.0","1.1.0":"http://www.opengis.net/wfs","1.0.0":"http://www.opengis.net/wfs"},yo={"2.0.0":"http://www.opengis.net/fes/2.0","1.1.0":"http://www.opengis.net/fes","1.0.0":"http://www.opengis.net/fes"},Fa={"2.0.0":"http://www.opengis.net/wfs/2.0 http://schemas.opengis.net/wfs/2.0/wfs.xsd","1.1.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd","1.0.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.0.0/wfs.xsd"},xo={"2.0.0":pe,"1.1.0":G,"1.0.0":le},cg="1.1.0";class hg extends Pi{constructor(e){super(),e=e||{},this.version_=e.version?e.version:cg,this.featureType_=e.featureType,this.featureNS_=e.featureNS,this.gmlFormat_=e.gmlFormat?e.gmlFormat:new xo[this.version_],this.schemaLocation_=e.schemaLocation?e.schemaLocation:Fa[this.version_]}getFeatureType(){return this.featureType_}setFeatureType(e){this.featureType_=e}readFeaturesFromNode(e,t){const r={node:e};Object.assign(r,{featureType:this.featureType_,featureNS:this.featureNS_}),Object.assign(r,this.getReadOptions(e,t||{}));const i=[r];let s;this.version_==="2.0.0"?s=Ca:s=this.gmlFormat_.FEATURE_COLLECTION_PARSERS;let o=V([],s,e,i,this.gmlFormat_);return o||(o=[]),o}readTransactionResponse(e){if(e){if(typeof e=="string"){const t=ri(e);return this.readTransactionResponseFromDocument(t)}return ni(e)?this.readTransactionResponseFromDocument(e):this.readTransactionResponseFromNode(e)}}readFeatureCollectionMetadata(e){if(e){if(typeof e=="string"){const t=ri(e);return this.readFeatureCollectionMetadataFromDocument(t)}return ni(e)?this.readFeatureCollectionMetadataFromDocument(e):this.readFeatureCollectionMetadataFromNode(e)}}readFeatureCollectionMetadataFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readFeatureCollectionMetadataFromNode(t)}readFeatureCollectionMetadataFromNode(e){const t={},r=Ht(e.getAttribute("numberOfFeatures"));return t.numberOfFeatures=r,V(t,Ca,e,[],this.gmlFormat_)}readTransactionResponseFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readTransactionResponseFromNode(t)}readTransactionResponseFromNode(e){return V({},lg,e,[])}writeGetFeature(e){const t=ie(vs[this.version_],"GetFeature");t.setAttribute("service","WFS"),t.setAttribute("version",this.version_),e.handle&&t.setAttribute("handle",e.handle),e.outputFormat&&t.setAttribute("outputFormat",e.outputFormat),e.maxFeatures!==void 0&&t.setAttribute("maxFeatures",String(e.maxFeatures)),e.resultType&&t.setAttribute("resultType",e.resultType),e.startIndex!==void 0&&t.setAttribute("startIndex",String(e.startIndex)),e.count!==void 0&&t.setAttribute("count",String(e.count)),e.viewParams!==void 0&&t.setAttribute("viewParams",e.viewParams),t.setAttributeNS(fn,"xsi:schemaLocation",this.schemaLocation_);const r={node:t};if(Object.assign(r,{version:this.version_,srsName:e.srsName,featureNS:e.featureNS?e.featureNS:this.featureNS_,featurePrefix:e.featurePrefix,propertyNames:e.propertyNames?e.propertyNames:[]}),dt(Array.isArray(e.featureTypes),"`options.featureTypes` must be an Array"),typeof e.featureTypes[0]=="string"){let i=e.filter;e.bbox&&(dt(e.geometryName,"`options.geometryName` must also be provided when `options.bbox` is set"),i=this.combineBboxAndFilter(e.geometryName,e.bbox,e.srsName,i)),Object.assign(r,{geometryName:e.geometryName,filter:i}),qa(t,e.featureTypes,[r])}else e.featureTypes.forEach(i=>{const s=this.combineBboxAndFilter(i.geometryName,i.bbox,e.srsName,e.filter);Object.assign(r,{geometryName:i.geometryName,filter:s}),qa(t,[i.name],[r])});return t}combineBboxAndFilter(e,t,r,i){const s=og(e,t,r);return i?sg(i,s):s}writeTransaction(e,t,r,i){const s=[],o=i.version?i.version:this.version_,a=ie(vs[o],"Transaction");a.setAttribute("service","WFS"),a.setAttribute("version",o);let l;i&&(l=i.gmlOptions?i.gmlOptions:{},i.handle&&a.setAttribute("handle",i.handle)),a.setAttributeNS(fn,"xsi:schemaLocation",Fa[o]);const u=fg(a,l,o,i);return e&&kn("Insert",e,s,u),t&&kn("Update",t,s,u),r&&kn("Delete",r,s,u),i.nativeElements&&kn("Native",i.nativeElements,s,u),a}readProjectionFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readProjectionFromNode(t);return null}readProjectionFromNode(e){if(e.firstElementChild&&e.firstElementChild.firstElementChild){e=e.firstElementChild.firstElementChild;for(let t=e.firstElementChild;t;t=t.nextElementSibling)if(!(t.childNodes.length===0||t.childNodes.length===1&&t.firstChild.nodeType===3)){const r=[{}];return this.gmlFormat_.readGeometryElement(t,r),ye(r.pop().srsName)}}return null}}function fg(n,e,t,r){const i=r.featurePrefix?r.featurePrefix:_u;let s;return t==="1.0.0"?s=2:t==="1.1.0"?s=3:t==="2.0.0"&&(s=3.2),Object.assign({node:n},{version:t,featureNS:r.featureNS,featureType:r.featureType,featurePrefix:i,gmlVersion:s,hasZ:r.hasZ,srsName:r.srsName},e)}function kn(n,e,t,r){we(r,mu,at(n),e,t)}function Oa(n,e){return V({},ag,n,e)}const dg={"http://www.opengis.net/ogc":{FeatureId:K(function(n,e){return n.getAttribute("fid")})},"http://www.opengis.net/ogc/1.1":{FeatureId:K(function(n,e){return n.getAttribute("fid")})}};function Ma(n,e){Zt(dg,n,e)}const pg={"http://www.opengis.net/wfs":{Feature:Ma},"http://www.opengis.net/wfs/2.0":{Feature:Ma}};function Na(n,e){return V([],pg,n,e)}function Da(n,e,t){const r=t[t.length-1],i=r.featureType,s=r.featureNS,o=r.gmlVersion,a=ie(s,i);n.appendChild(a),o===2?le.prototype.writeFeatureElement(a,e,t):o===3?G.prototype.writeFeatureElement(a,e,t):pe.prototype.writeFeatureElement(a,e,t)}function yu(n,e,t){const i=t[t.length-1].version,s=_o[i],o=ie(s,"Filter"),a=ie(s,"FeatureId");o.appendChild(a),a.setAttribute("fid",e),n.appendChild(o)}function Eo(n,e){n=n||_u;const t=n+":";return e.startsWith(t)?e:t+e}function Ua(n,e,t){const r=t[t.length-1];dt(e.getId()!==void 0,"Features must have an id set");const i=r.featureType,s=r.featurePrefix,o=r.featureNS,a=Eo(s,i);n.setAttribute("typeName",a),n.setAttributeNS(mo,"xmlns:"+s,o);const l=e.getId();l!==void 0&&yu(n,l,t)}function Ba(n,e,t){const r=t[t.length-1];dt(e.getId()!==void 0,"Features must have an id set");const i=r.version,s=r.featureType,o=r.featurePrefix,a=r.featureNS,l=Eo(o,s),u=e.getGeometryName();n.setAttribute("typeName",l),n.setAttributeNS(mo,"xmlns:"+o,a);const f=e.getId();if(f!==void 0){const c=e.getKeys(),d=[];for(let g=0,p=c.length;g<p;g++){const _=e.get(c[g]);if(_!==void 0){let x=c[g];_&&typeof _.getSimplifiedGeometry=="function"&&(x=u),d.push({name:x,value:_})}}we({version:i,gmlVersion:r.gmlVersion,node:n,hasZ:r.hasZ,srsName:r.srsName},mu,at("Property"),d,t),yu(n,f,t)}}function Ga(n,e,t){const r=t[t.length-1],i=r.version,s=vs[i],a=ie(s,i==="2.0.0"?"ValueReference":"Name"),l=r.gmlVersion;if(n.appendChild(a),ce(a,e.name),e.value!==void 0&&e.value!==null){const u=ie(s,"Value");n.appendChild(u),e.value&&typeof e.value.getSimplifiedGeometry=="function"?l===2?le.prototype.writeGeometryElement(u,e.value,t):l===3?G.prototype.writeGeometryElement(u,e.value,t):pe.prototype.writeGeometryElement(u,e.value,t):ce(u,e.value)}}function ka(n,e,t){e.vendorId&&n.setAttribute("vendorId",e.vendorId),e.safeToIgnore!==void 0&&n.setAttribute("safeToIgnore",String(e.safeToIgnore)),e.value!==void 0&&ce(n,e.value)}const Bi={"http://www.opengis.net/wfs":{Query:I(za)},"http://www.opengis.net/wfs/2.0":{Query:I(za)},"http://www.opengis.net/ogc":{During:I(ja),And:I(zn),Or:I(zn),Not:I(Xa),BBOX:I($a),Contains:I(jt),Intersects:I(jt),Within:I(jt),DWithin:I(Va),PropertyIsEqualTo:I(lt),PropertyIsNotEqualTo:I(lt),PropertyIsLessThan:I(lt),PropertyIsLessThanOrEqualTo:I(lt),PropertyIsGreaterThan:I(lt),PropertyIsGreaterThanOrEqualTo:I(lt),PropertyIsNull:I(Ha),PropertyIsBetween:I(Wa),PropertyIsLike:I(Za)},"http://www.opengis.net/fes/2.0":{During:I(ja),And:I(zn),Or:I(zn),Not:I(Xa),BBOX:I($a),Contains:I(jt),Disjoint:I(jt),Intersects:I(jt),ResourceId:I(mg),Within:I(jt),DWithin:I(Va),PropertyIsEqualTo:I(lt),PropertyIsNotEqualTo:I(lt),PropertyIsLessThan:I(lt),PropertyIsLessThanOrEqualTo:I(lt),PropertyIsGreaterThan:I(lt),PropertyIsGreaterThanOrEqualTo:I(lt),PropertyIsNull:I(Ha),PropertyIsBetween:I(Wa),PropertyIsLike:I(Za)}};function za(n,e,t){const r=t[t.length-1],i=r.version,s=r.featurePrefix,o=r.featureNS,a=r.propertyNames,l=r.srsName;let u;s?u=Eo(s,e):u=e;let f;i==="2.0.0"?f="typeNames":f="typeName",n.setAttribute(f,u),l&&n.setAttribute("srsName",l),o&&n.setAttributeNS(mo,"xmlns:"+s,o);const c=Object.assign({},r);c.node=n,we(c,ug,at("PropertyName"),a,t);const d=r.filter;if(d){const g=ie(Gi(i),"Filter");n.appendChild(g),gg(g,d,t)}}function gg(n,e,t){const r=t[t.length-1],i={node:n};Object.assign(i,{context:r}),we(i,Bi,at(e.getTagName()),[e],t)}function $a(n,e,t){const r=t[t.length-1],s=r.context.version;r.srsName=e.srsName;const o=xo[s];Xr(s,n,e.geometryName),o.prototype.writeGeometryElement(n,e.extent,t)}function mg(n,e,t){n.setAttribute("rid",e.rid)}function jt(n,e,t){const r=t[t.length-1],s=r.context.version;r.srsName=e.srsName;const o=xo[s];Xr(s,n,e.geometryName),o.prototype.writeGeometryElement(n,e.geometry,t)}function Va(n,e,t){const s=t[t.length-1].context.version;jt(n,e,t);const o=ie(Gi(s),"Distance");ce(o,e.distance.toString()),s==="2.0.0"?o.setAttribute("uom",e.unit):o.setAttribute("units",e.unit),n.appendChild(o)}function ja(n,e,t){const s=t[t.length-1].context.version;hi(yo[s],"ValueReference",n,e.propertyName);const o=ie(Gt,"TimePeriod");n.appendChild(o);const a=ie(Gt,"begin");o.appendChild(a),Ya(a,e.begin);const l=ie(Gt,"end");o.appendChild(l),Ya(l,e.end)}function zn(n,e,t){const i=t[t.length-1].context,s={node:n};Object.assign(s,{context:i});const o=e.conditions;for(let a=0,l=o.length;a<l;++a){const u=o[a];we(s,Bi,at(u.getTagName()),[u],t)}}function Xa(n,e,t){const i=t[t.length-1].context,s={node:n};Object.assign(s,{context:i});const o=e.condition;we(s,Bi,at(o.getTagName()),[o],t)}function lt(n,e,t){const s=t[t.length-1].context.version;e.matchCase!==void 0&&n.setAttribute("matchCase",e.matchCase.toString()),Xr(s,n,e.propertyName),fi(s,n,""+e.expression)}function Ha(n,e,t){const s=t[t.length-1].context.version;Xr(s,n,e.propertyName)}function Wa(n,e,t){const s=t[t.length-1].context.version,o=Gi(s);Xr(s,n,e.propertyName);const a=ie(o,"LowerBoundary");n.appendChild(a),fi(s,a,""+e.lowerBoundary);const l=ie(o,"UpperBoundary");n.appendChild(l),fi(s,l,""+e.upperBoundary)}function Za(n,e,t){const s=t[t.length-1].context.version;n.setAttribute("wildCard",e.wildCard),n.setAttribute("singleChar",e.singleChar),n.setAttribute("escapeChar",e.escapeChar),e.matchCase!==void 0&&n.setAttribute("matchCase",e.matchCase.toString()),Xr(s,n,e.propertyName),fi(s,n,""+e.pattern)}function hi(n,e,t,r){const i=ie(n,e);ce(i,r),t.appendChild(i)}function fi(n,e,t){hi(Gi(n),"Literal",e,t)}function Xr(n,e,t){n==="2.0.0"?hi(yo[n],"ValueReference",e,t):hi(_o[n],"PropertyName",e,t)}function Ya(n,e){const t=ie(Gt,"TimeInstant");n.appendChild(t);const r=ie(Gt,"timePosition");t.appendChild(r),ce(r,e)}function qa(n,e,t){const r=t[t.length-1],i=Object.assign({},r);i.node=n,we(i,Bi,at("Query"),e,t)}function Gi(n){let e;return n==="2.0.0"?e=yo[n]:e=_o[n],e}const Te={POINT:1,LINE_STRING:2,POLYGON:3,MULTI_POINT:4,MULTI_LINE_STRING:5,MULTI_POLYGON:6,GEOMETRY_COLLECTION:7,POLYHEDRAL_SURFACE:15,TIN:16,TRIANGLE:17};class Ka{constructor(e){this.view_=e,this.pos_=0,this.initialized_=!1,this.isLittleEndian_=!1,this.hasZ_=!1,this.hasM_=!1,this.srid_=null,this.layout_="XY"}readUint8(){return this.view_.getUint8(this.pos_++)}readUint32(e){return this.view_.getUint32((this.pos_+=4)-4,e!==void 0?e:this.isLittleEndian_)}readDouble(e){return this.view_.getFloat64((this.pos_+=8)-8,e!==void 0?e:this.isLittleEndian_)}readPoint(){const e=[];return e.push(this.readDouble()),e.push(this.readDouble()),this.hasZ_&&e.push(this.readDouble()),this.hasM_&&e.push(this.readDouble()),e}readLineString(){const e=this.readUint32(),t=[];for(let r=0;r<e;r++)t.push(this.readPoint());return t}readPolygon(){const e=this.readUint32(),t=[];for(let r=0;r<e;r++)t.push(this.readLineString());return t}readWkbHeader(e){const r=this.readUint8()>0,i=this.readUint32(r),s=Math.floor((i&268435455)/1e3),o=!!(i&2147483648)||s===1||s===3,a=!!(i&1073741824)||s===2||s===3,l=!!(i&536870912),u=(i&268435455)%1e3,f=["XY",o?"Z":"",a?"M":""].join(""),c=l?this.readUint32(r):null;if(e!==void 0&&e!==u)throw new Error("Unexpected WKB geometry type "+u);if(this.initialized_){if(this.isLittleEndian_!==r)throw new Error("Inconsistent endian");if(this.layout_!==f)throw new Error("Inconsistent geometry layout");if(c&&this.srid_!==c)throw new Error("Inconsistent coordinate system (SRID)")}else this.isLittleEndian_=r,this.hasZ_=o,this.hasM_=a,this.layout_=f,this.srid_=c,this.initialized_=!0;return u}readWkbPayload(e){switch(e){case Te.POINT:return this.readPoint();case Te.LINE_STRING:return this.readLineString();case Te.POLYGON:case Te.TRIANGLE:return this.readPolygon();case Te.MULTI_POINT:return this.readMultiPoint();case Te.MULTI_LINE_STRING:return this.readMultiLineString();case Te.MULTI_POLYGON:case Te.POLYHEDRAL_SURFACE:case Te.TIN:return this.readMultiPolygon();case Te.GEOMETRY_COLLECTION:return this.readGeometryCollection();default:throw new Error("Unsupported WKB geometry type "+e+" is found")}}readWkbBlock(e){return this.readWkbPayload(this.readWkbHeader(e))}readWkbCollection(e,t){const r=this.readUint32(),i=[];for(let s=0;s<r;s++){const o=e.call(this,t);o&&i.push(o)}return i}readMultiPoint(){return this.readWkbCollection(this.readWkbBlock,Te.POINT)}readMultiLineString(){return this.readWkbCollection(this.readWkbBlock,Te.LINE_STRING)}readMultiPolygon(){return this.readWkbCollection(this.readWkbBlock,Te.POLYGON)}readGeometryCollection(){return this.readWkbCollection(this.readGeometry)}readGeometry(){const e=this.readWkbHeader(),t=this.readWkbPayload(e);switch(e){case Te.POINT:return new ft(t,this.layout_);case Te.LINE_STRING:return new It(t,this.layout_);case Te.POLYGON:case Te.TRIANGLE:return new cr(t,this.layout_);case Te.MULTI_POINT:return new Ai(t,this.layout_);case Te.MULTI_LINE_STRING:return new kr(t,this.layout_);case Te.MULTI_POLYGON:case Te.POLYHEDRAL_SURFACE:case Te.TIN:return new Tn(t,this.layout_);case Te.GEOMETRY_COLLECTION:return new Kt(t);default:return null}}getSrid(){return this.srid_}}class _g{constructor(e){e=e||{},this.layout_=e.layout,this.isLittleEndian_=e.littleEndian!==!1,this.isEWKB_=e.ewkb!==!1,this.writeQueue_=[],this.nodata_=Object.assign({X:0,Y:0,Z:0,M:0},e.nodata)}writeUint8(e){this.writeQueue_.push([1,e])}writeUint32(e){this.writeQueue_.push([4,e])}writeDouble(e){this.writeQueue_.push([8,e])}writePoint(e,t){const r=Object.assign.apply(null,t.split("").map((i,s)=>({[i]:e[s]})));for(const i of this.layout_)this.writeDouble(i in r?r[i]:this.nodata_[i])}writeLineString(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writePoint(e[r],t)}writePolygon(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeLineString(e[r],t)}writeWkbHeader(e,t){e%=1e3,this.layout_.includes("Z")&&(e+=this.isEWKB_?2147483648:1e3),this.layout_.includes("M")&&(e+=this.isEWKB_?1073741824:2e3),this.isEWKB_&&Number.isInteger(t)&&(e|=536870912),this.writeUint8(this.isLittleEndian_?1:0),this.writeUint32(e),this.isEWKB_&&Number.isInteger(t)&&this.writeUint32(t)}writeMultiPoint(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(1),this.writePoint(e[r],t)}writeMultiLineString(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(2),this.writeLineString(e[r],t)}writeMultiPolygon(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(3),this.writePolygon(e[r],t)}writeGeometryCollection(e){this.writeUint32(e.length);for(let t=0;t<e.length;t++)this.writeGeometry(e[t])}findMinimumLayout(e,t="XYZM"){const r=(i,s)=>i===s?i:i==="XYZM"?s:s==="XYZM"?i:"XY";if(e instanceof _a)return r(e.getLayout(),t);if(e instanceof Kt){const i=e.getGeometriesArray();for(let s=0;s<i.length&&t!=="XY";s++)t=this.findMinimumLayout(i[s],t)}return t}writeGeometry(e,t){const r={Point:Te.POINT,LineString:Te.LINE_STRING,Polygon:Te.POLYGON,MultiPoint:Te.MULTI_POINT,MultiLineString:Te.MULTI_LINE_STRING,MultiPolygon:Te.MULTI_POLYGON,GeometryCollection:Te.GEOMETRY_COLLECTION},i=e.getType(),s=r[i];if(!s)throw new Error("GeometryType "+i+" is not supported");this.layout_||(this.layout_=this.findMinimumLayout(e)),this.writeWkbHeader(s,t),e instanceof _a?{Point:this.writePoint,LineString:this.writeLineString,Polygon:this.writePolygon,MultiPoint:this.writeMultiPoint,MultiLineString:this.writeMultiLineString,MultiPolygon:this.writeMultiPolygon}[i].call(this,e.getCoordinates(),e.getLayout()):e instanceof Kt&&this.writeGeometryCollection(e.getGeometriesArray())}getBuffer(){const e=this.writeQueue_.reduce((s,o)=>s+o[0],0),t=new ArrayBuffer(e),r=new DataView(t);let i=0;return this.writeQueue_.forEach(s=>{switch(s[0]){case 1:r.setUint8(i,s[1]);break;case 4:r.setUint32(i,s[1],this.isLittleEndian_);break;case 8:r.setFloat64(i,s[1],this.isLittleEndian_);break}i+=s[0]}),t}}class yg extends Wl{constructor(e){super(),e=e||{},this.splitCollection=!!e.splitCollection,this.viewCache_=null,this.hex_=e.hex!==!1,this.littleEndian_=e.littleEndian!==!1,this.ewkb_=e.ewkb!==!1,this.layout_=e.geometryLayout,this.nodataZ_=e.nodataZ||0,this.nodataM_=e.nodataM||0,this.srid_=e.srid}getType(){return this.hex_?"text":"arraybuffer"}readFeature(e,t){return new et({geometry:this.readGeometry(e,t)})}readFeatures(e,t){let r=[];const i=this.readGeometry(e,t);return this.splitCollection&&i instanceof Kt?r=i.getGeometriesArray():r=[i],r.map(s=>new et({geometry:s}))}readGeometry(e,t){const r=Qa(e);if(!r)return null;const s=new Ka(r).readGeometry();return this.viewCache_=r,t=this.getReadOptions(e,t),this.viewCache_=null,Ge(s,!1,t)}readProjection(e){const t=this.viewCache_||Qa(e);if(!t)return;const r=new Ka(t);return r.readWkbHeader(),r.getSrid()&&ye("EPSG:"+r.getSrid())||void 0}writeFeature(e,t){return this.writeGeometry(e.getGeometry(),t)}writeFeatures(e,t){return this.writeGeometry(new Kt(e.map(r=>r.getGeometry())),t)}writeGeometry(e,t){t=this.adaptOptions(t);const r=new _g({layout:this.layout_,littleEndian:this.littleEndian_,ewkb:this.ewkb_,nodata:{Z:this.nodataZ_,M:this.nodataM_}});let i=Number.isInteger(this.srid_)?Number(this.srid_):null;if(this.srid_!==!1&&!Number.isInteger(this.srid_)){const o=t.dataProjection&&ye(t.dataProjection);if(o){const a=o.getCode();a.startsWith("EPSG:")&&(i=Number(a.substring(5)))}}r.writeGeometry(Ge(e,!0,t),i);const s=r.getBuffer();return this.hex_?xg(s):s}}function xg(n){const e=new Uint8Array(n);return Array.from(e.values()).map(t=>(t<16?"0":"")+Number(t).toString(16).toUpperCase()).join("")}function Eg(n){const e=new Uint8Array(n.length/2);for(let t=0;t<n.length/2;t++)e[t]=parseInt(n.substr(t*2,2),16);return new DataView(e.buffer)}function Qa(n){return typeof n=="string"?Eg(n):ArrayBuffer.isView(n)?n instanceof DataView?n:new DataView(n.buffer,n.byteOffset,n.byteLength):n instanceof ArrayBuffer?new DataView(n):null}const bg={POINT:ft,LINESTRING:It,POLYGON:cr,MULTIPOINT:Ai,MULTILINESTRING:kr,MULTIPOLYGON:Tn},xu="EMPTY",Eu="Z",bu="M",Tg="ZM",Ee={START:0,TEXT:1,LEFT_PAREN:2,RIGHT_PAREN:3,NUMBER:4,COMMA:5,EOF:6},wg={Point:"POINT",LineString:"LINESTRING",Polygon:"POLYGON",MultiPoint:"MULTIPOINT",MultiLineString:"MULTILINESTRING",MultiPolygon:"MULTIPOLYGON",GeometryCollection:"GEOMETRYCOLLECTION",Circle:"CIRCLE"};class vg{constructor(e){this.wkt=e,this.index_=-1}isAlpha_(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"}isNumeric_(e,t){return t=t!==void 0?t:!1,e>="0"&&e<="9"||e=="."&&!t}isWhiteSpace_(e){return e==" "||e=="	"||e=="\r"||e==`
`}nextChar_(){return this.wkt.charAt(++this.index_)}nextToken(){const e=this.nextChar_(),t=this.index_;let r=e,i;if(e=="(")i=Ee.LEFT_PAREN;else if(e==",")i=Ee.COMMA;else if(e==")")i=Ee.RIGHT_PAREN;else if(this.isNumeric_(e)||e=="-")i=Ee.NUMBER,r=this.readNumber_();else if(this.isAlpha_(e))i=Ee.TEXT,r=this.readText_();else{if(this.isWhiteSpace_(e))return this.nextToken();if(e==="")i=Ee.EOF;else throw new Error("Unexpected character: "+e)}return{position:t,value:r,type:i}}readNumber_(){let e;const t=this.index_;let r=!1,i=!1;do e=="."?r=!0:(e=="e"||e=="E")&&(i=!0),e=this.nextChar_();while(this.isNumeric_(e,r)||!i&&(e=="e"||e=="E")||i&&(e=="-"||e=="+"));return parseFloat(this.wkt.substring(t,this.index_--))}readText_(){let e;const t=this.index_;do e=this.nextChar_();while(this.isAlpha_(e));return this.wkt.substring(t,this.index_--).toUpperCase()}}class Sg{constructor(e){this.lexer_=e,this.token_={position:0,type:Ee.START},this.layout_="XY"}consume_(){this.token_=this.lexer_.nextToken()}isTokenType(e){return this.token_.type==e}match(e){const t=this.isTokenType(e);return t&&this.consume_(),t}parse(){return this.consume_(),this.parseGeometry_()}parseGeometryLayout_(){let e="XY";const t=this.token_;if(this.isTokenType(Ee.TEXT)){const r=t.value;r===Eu?e="XYZ":r===bu?e="XYM":r===Tg&&(e="XYZM"),e!=="XY"&&this.consume_()}return e}parseGeometryCollectionText_(){if(this.match(Ee.LEFT_PAREN)){const e=[];do e.push(this.parseGeometry_());while(this.match(Ee.COMMA));if(this.match(Ee.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parsePointText_(){if(this.match(Ee.LEFT_PAREN)){const e=this.parsePoint_();if(this.match(Ee.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parseLineStringText_(){if(this.match(Ee.LEFT_PAREN)){const e=this.parsePointList_();if(this.match(Ee.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parsePolygonText_(){if(this.match(Ee.LEFT_PAREN)){const e=this.parseLineStringTextList_();if(this.match(Ee.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parseMultiPointText_(){if(this.match(Ee.LEFT_PAREN)){let e;if(this.token_.type==Ee.LEFT_PAREN?e=this.parsePointTextList_():e=this.parsePointList_(),this.match(Ee.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parseMultiLineStringText_(){if(this.match(Ee.LEFT_PAREN)){const e=this.parseLineStringTextList_();if(this.match(Ee.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parseMultiPolygonText_(){if(this.match(Ee.LEFT_PAREN)){const e=this.parsePolygonTextList_();if(this.match(Ee.RIGHT_PAREN))return e}throw new Error(this.formatErrorMessage_())}parsePoint_(){const e=[],t=this.layout_.length;for(let r=0;r<t;++r){const i=this.token_;if(this.match(Ee.NUMBER))e.push(i.value);else break}if(e.length==t)return e;throw new Error(this.formatErrorMessage_())}parsePointList_(){const e=[this.parsePoint_()];for(;this.match(Ee.COMMA);)e.push(this.parsePoint_());return e}parsePointTextList_(){const e=[this.parsePointText_()];for(;this.match(Ee.COMMA);)e.push(this.parsePointText_());return e}parseLineStringTextList_(){const e=[this.parseLineStringText_()];for(;this.match(Ee.COMMA);)e.push(this.parseLineStringText_());return e}parsePolygonTextList_(){const e=[this.parsePolygonText_()];for(;this.match(Ee.COMMA);)e.push(this.parsePolygonText_());return e}isEmptyGeometry_(){const e=this.isTokenType(Ee.TEXT)&&this.token_.value==xu;return e&&this.consume_(),e}formatErrorMessage_(){return"Unexpected `"+this.token_.value+"` at position "+this.token_.position+" in `"+this.lexer_.wkt+"`"}parseGeometry_(){const e=this.token_;if(this.match(Ee.TEXT)){const t=e.value;this.layout_=this.parseGeometryLayout_();const r=this.isEmptyGeometry_();if(t=="GEOMETRYCOLLECTION"){if(r)return new Kt([]);const o=this.parseGeometryCollectionText_();return new Kt(o)}const i=bg[t];if(!i)throw new Error("Invalid geometry type: "+t);let s;if(r)t=="POINT"?s=[NaN,NaN]:s=[];else switch(t){case"POINT":{s=this.parsePointText_();break}case"LINESTRING":{s=this.parseLineStringText_();break}case"POLYGON":{s=this.parsePolygonText_();break}case"MULTIPOINT":{s=this.parseMultiPointText_();break}case"MULTILINESTRING":{s=this.parseMultiLineStringText_();break}case"MULTIPOLYGON":{s=this.parseMultiPolygonText_();break}}return new i(s,this.layout_)}throw new Error(this.formatErrorMessage_())}}class Rg extends po{constructor(e){super(),e=e||{},this.splitCollection_=e.splitCollection!==void 0?e.splitCollection:!1}parse_(e){const t=new vg(e);return new Sg(t).parse()}readFeatureFromText(e,t){const r=this.readGeometryFromText(e,t),i=new et;return i.setGeometry(r),i}readFeaturesFromText(e,t){let r=[];const i=this.readGeometryFromText(e,t);this.splitCollection_&&i.getType()=="GeometryCollection"?r=i.getGeometriesArray():r=[i];const s=[];for(let o=0,a=r.length;o<a;++o){const l=new et;l.setGeometry(r[o]),s.push(l)}return s}readGeometryFromText(e,t){const r=this.parse_(e);return Ge(r,!1,t)}writeFeatureText(e,t){const r=e.getGeometry();return r?this.writeGeometryText(r,t):""}writeFeaturesText(e,t){if(e.length==1)return this.writeFeatureText(e[0],t);const r=[];for(let s=0,o=e.length;s<o;++s)r.push(e[s].getGeometry());const i=new Kt(r);return this.writeGeometryText(i,t)}writeGeometryText(e,t){return vu(Ge(e,!0,t))}}function Tu(n){const e=n.getCoordinates();return e.length===0?"":e.join(" ")}function Ag(n){const e=[],t=n.getPoints();for(let r=0,i=t.length;r<i;++r)e.push("("+Tu(t[r])+")");return e.join(",")}function Pg(n){const e=[],t=n.getGeometries();for(let r=0,i=t.length;r<i;++r)e.push(vu(t[r]));return e.join(",")}function bo(n){const e=n.getCoordinates(),t=[];for(let r=0,i=e.length;r<i;++r)t.push(e[r].join(" "));return t.join(",")}function Lg(n){const e=[],t=n.getLineStrings();for(let r=0,i=t.length;r<i;++r)e.push("("+bo(t[r])+")");return e.join(",")}function wu(n){const e=[],t=n.getLinearRings();for(let r=0,i=t.length;r<i;++r)e.push("("+bo(t[r])+")");return e.join(",")}function Ig(n){const e=[],t=n.getPolygons();for(let r=0,i=t.length;r<i;++r)e.push("("+wu(t[r])+")");return e.join(",")}function Cg(n){const e=n.getLayout();let t="";return(e==="XYZ"||e==="XYZM")&&(t+=Eu),(e==="XYM"||e==="XYZM")&&(t+=bu),t}const Fg={Point:Tu,LineString:bo,Polygon:wu,MultiPoint:Ag,MultiLineString:Lg,MultiPolygon:Ig,GeometryCollection:Pg};function vu(n){const e=n.getType(),t=Fg[e],r=t(n);let i=wg[e];if(typeof n.getFlatCoordinates=="function"){const s=Cg(n);s.length>0&&(i+=" "+s)}return r.length===0?i+" "+xu:i+"("+r+")"}const Ne=[null,"http://www.opengis.net/wms","http://www.opengis.net/sld"];function An(n){return Oh(n[0].version,"1.3")>=0}const Og=H(Ne,{Service:S(tm),Capability:S(em)}),Mg=H(Ne,{Request:S(cm),Exception:S(sm),Layer:S(om),UserDefinedSymbolization:S(Qg)});class Ng extends go{constructor(){super(),this.version=void 0}readFromNode(e){this.version=e.getAttribute("version").trim();const t=V({version:this.version},Og,e,[]);return t||null}}const Su={Name:S($),Title:S($),Abstract:S($),KeywordList:S(Cu),OnlineResource:S(jr),ContactInformation:S(rm),Fees:S($),AccessConstraints:S($)},Dg=H(Ne,Su),Ug=H(Ne,{...Su,LayerLimit:S(Ie),MaxWidth:S(Ie),MaxHeight:S(Ie)}),Bg=H(Ne,{ContactPersonPrimary:S(nm),ContactPosition:S($),ContactAddress:S(im),ContactVoiceTelephone:S($),ContactFacsimileTelephone:S($),ContactElectronicMailAddress:S($)}),Gg=H(Ne,{ContactPerson:S($),ContactOrganization:S($)}),kg=H(Ne,{AddressType:S($),Address:S($),City:S($),StateOrProvince:S($),PostCode:S($),Country:S($)}),zg=H(Ne,{Format:K($)}),Ru={Name:S($),Title:S($),Abstract:S($),KeywordList:S(Cu),BoundingBox:be(Lu),Dimension:be(am),Attribution:S(Kg),AuthorityURL:be(dm),Identifier:be($),MetadataURL:be(pm),DataURL:be(zt),FeatureListURL:be(zt),Style:be(gm),Layer:be(ki)},Au=H(Ne,{...Ru,SRS:be($),Extent:S(lm),ScaleHint:be(um),LatLonBoundingBox:S((n,e)=>Lu(n,e,!1)),Layer:be(ki)}),Pu=H(Ne,{...Ru,CRS:be($),EX_GeographicBoundingBox:S(Jg),MinScaleDenominator:S(We),MaxScaleDenominator:S(We),Layer:be(ki)}),$g=H(Ne,{Title:S($),OnlineResource:S(jr),LogoURL:S(Iu)}),Vg=H(Ne,{westBoundLongitude:S(We),eastBoundLongitude:S(We),southBoundLatitude:S(We),northBoundLatitude:S(We)}),jg=H(Ne,{GetCapabilities:S(Qr),GetMap:S(Qr),GetFeatureInfo:S(Qr),DescribeLayer:S(Qr),GetLegendGraphic:S(Qr)}),Xg=H(Ne,{Format:be($),DCPType:be(hm)}),Hg=H(Ne,{HTTP:S(fm)}),Wg=H(Ne,{Get:S(zt),Post:S(zt)}),Zg=H(Ne,{Name:S($),Title:S($),Abstract:S($),LegendURL:be(Iu),StyleSheetURL:S(zt),StyleURL:S(zt)}),Yg=H(Ne,{Format:S($),OnlineResource:S(jr)}),qg=H(Ne,{Keyword:K($)});function Kg(n,e){return V({},$g,n,e)}function Qg(n,e){return{SupportSLD:!!it(n.getAttribute("SupportSLD")),UserLayer:!!it(n.getAttribute("UserLayer")),UserStyle:!!it(n.getAttribute("UserStyle")),RemoteWFS:!!it(n.getAttribute("RemoteWFS")),InlineFeatureData:!!it(n.getAttribute("InlineFeatureData")),RemoteWCS:!!it(n.getAttribute("RemoteWCS"))}}function Lu(n,e,t=!0){const r=[Rt(n.getAttribute("minx")),Rt(n.getAttribute("miny")),Rt(n.getAttribute("maxx")),Rt(n.getAttribute("maxy"))],i=[Rt(n.getAttribute("resx")),Rt(n.getAttribute("resy"))],s={extent:r,res:i};return t&&(An(e)?s.crs=n.getAttribute("CRS"):s.srs=n.getAttribute("SRS")),s}function Jg(n,e){const t=V({},Vg,n,e);if(!t)return;const r=t.westBoundLongitude,i=t.southBoundLatitude,s=t.eastBoundLongitude,o=t.northBoundLatitude;if(!(r===void 0||i===void 0||s===void 0||o===void 0))return[r,i,s,o]}function em(n,e){return V({},Mg,n,e)}function tm(n,e){return V({},An(e)?Ug:Dg,n,e)}function rm(n,e){return V({},Bg,n,e)}function nm(n,e){return V({},Gg,n,e)}function im(n,e){return V({},kg,n,e)}function sm(n,e){return V([],zg,n,e)}function om(n,e){const t=V({},An(e)?Pu:Au,n,e);return t.Layer===void 0?Object.assign(t,ki(n,e)):t}function ki(n,e){const t=An(e),r=e[e.length-1],i=V({},t?Pu:Au,n,e);if(!i)return;let s=it(n.getAttribute("queryable"));s===void 0&&(s=r.queryable),i.queryable=s!==void 0?s:!1;let o=Ht(n.getAttribute("cascaded"));o===void 0&&(o=r.cascaded),i.cascaded=o;let a=it(n.getAttribute("opaque"));a===void 0&&(a=r.opaque),i.opaque=a!==void 0?a:!1;let l=it(n.getAttribute("noSubsets"));l===void 0&&(l=r.noSubsets),i.noSubsets=l!==void 0?l:!1;let u=Rt(n.getAttribute("fixedWidth"));u||(u=r.fixedWidth),i.fixedWidth=u;let f=Rt(n.getAttribute("fixedHeight"));f||(f=r.fixedHeight),i.fixedHeight=f;const c=["Style","AuthorityURL"];t?c.push("CRS"):c.push("SRS","Dimension"),c.forEach(function(g){if(g in r){const p=i[g]||[];i[g]=p.concat(r[g])}});const d=["BoundingBox","Attribution"];return t?d.push("Dimension","EX_GeographicBoundingBox","MinScaleDenominator","MaxScaleDenominator"):d.push("LatLonBoundingBox","ScaleHint","Extent"),d.forEach(function(g){if(!(g in i)){const p=r[g];i[g]=p}}),i}function am(n,e){const t={name:n.getAttribute("name"),units:n.getAttribute("units"),unitSymbol:n.getAttribute("unitSymbol")};return An(e)&&Object.assign(t,{default:n.getAttribute("default"),multipleValues:it(n.getAttribute("multipleValues")),nearestValue:it(n.getAttribute("nearestValue")),current:it(n.getAttribute("current")),values:$(n)}),t}function lm(n,e){return{name:n.getAttribute("name"),default:n.getAttribute("default"),nearestValue:it(n.getAttribute("nearestValue"))}}function um(n,e){return{min:Rt(n.getAttribute("min")),max:Rt(n.getAttribute("max"))}}function zt(n,e){return V({},Yg,n,e)}function cm(n,e){return V({},jg,n,e)}function hm(n,e){return V({},Hg,n,e)}function fm(n,e){return V({},Wg,n,e)}function Qr(n,e){return V({},Xg,n,e)}function Iu(n,e){const t=zt(n,e);if(t){const r=[Ht(n.getAttribute("width")),Ht(n.getAttribute("height"))];return t.size=r,t}}function dm(n,e){const t=zt(n,e);if(t)return t.name=n.getAttribute("name"),t}function pm(n,e){const t=zt(n,e);if(t)return t.type=n.getAttribute("type"),t}function gm(n,e){return V({},Zg,n,e)}function Cu(n,e){return V([],qg,n,e)}const mm="_feature",_m="_layer";class ym extends Pi{constructor(e){super(),e=e||{},this.featureNS_="http://mapserver.gis.umn.edu/mapserver",this.gmlFormat_=new le,this.layers_=e.layers?e.layers:null}getLayers(){return this.layers_}setLayers(e){this.layers_=e}readFeatures_(e,t){e.setAttribute("namespaceURI",this.featureNS_);const r=e.localName;let i=[];if(e.childNodes.length===0)return i;if(r=="msGMLOutput")for(let s=0,o=e.childNodes.length;s<o;s++){const a=e.childNodes[s];if(a.nodeType!==Node.ELEMENT_NODE)continue;const l=a,u=t[0],f=_m,c=l.localName.replace(f,"");if(this.layers_&&!this.layers_.includes(c))continue;const d=c+mm;u.featureType=d,u.featureNS=this.featureNS_;const g={};g[d]=K(this.gmlFormat_.readFeatureElement,this.gmlFormat_);const p=H([u.featureNS,null],g);l.setAttribute("namespaceURI",this.featureNS_);const _=V([],p,l,t,this.gmlFormat_);_&&ti(i,_)}if(r=="FeatureCollection"){const s=V([],this.gmlFormat_.FEATURE_COLLECTION_PARSERS,e,[{}],this.gmlFormat_);s&&(i=s)}return i}readFeaturesFromNode(e,t){const r={};return t&&Object.assign(r,this.getReadOptions(e,t)),this.readFeatures_(e,[r])}}const Ct=[null,"http://www.opengis.net/wmts/1.0"],Hr=[null,"http://www.opengis.net/ows/1.1"],xm=H(Ct,{Contents:S(Lm)});let To=class extends go{constructor(){super(),this.owsParser_=new pu}readFromNode(e){let t=e.getAttribute("version");t&&(t=t.trim());let r=this.owsParser_.readFromNode(e);return r?(r.version=t,r=V(r,xm,e,[]),r||null):null}};const Em=H(Ct,{Layer:be(Im),TileMatrixSet:be(Cm)}),bm=H(Ct,{Style:be(Fm),Format:be($),TileMatrixSetLink:be(Om),Dimension:be(Mm),ResourceURL:be(Nm)},H(Hr,{Title:S($),Abstract:S($),WGS84BoundingBox:S(Ou),BoundingBox:be(Dm),Identifier:S($)})),Tm=H(Ct,{LegendURL:be(Um)},H(Hr,{Title:S($),Identifier:S($)})),wm=H(Ct,{TileMatrixSet:S($),TileMatrixSetLimits:S(Gm)}),vm=H(Ct,{TileMatrixLimits:K(km)}),Sm=H(Ct,{TileMatrix:S($),MinTileRow:S(Ie),MaxTileRow:S(Ie),MinTileCol:S(Ie),MaxTileCol:S(Ie)}),Rm=H(Ct,{Default:S($),Value:be($)},H(Hr,{Identifier:S($)})),Fu=H(Hr,{LowerCorner:K(Ss),UpperCorner:K(Ss)}),Am=H(Ct,{WellKnownScaleSet:S($),TileMatrix:be(Bm)},H(Hr,{SupportedCRS:S($),Identifier:S($),BoundingBox:S(Ou)})),Pm=H(Ct,{TopLeftCorner:S(Ss),ScaleDenominator:S(We),TileWidth:S(Ie),TileHeight:S(Ie),MatrixWidth:S(Ie),MatrixHeight:S(Ie)},H(Hr,{Identifier:S($)}));function Lm(n,e){return V({},Em,n,e)}function Im(n,e){return V({},bm,n,e)}function Cm(n,e){return V({},Am,n,e)}function Fm(n,e){const t=V({},Tm,n,e);if(!t)return;const r=n.getAttribute("isDefault")==="true";return t.isDefault=r,t}function Om(n,e){return V({},wm,n,e)}function Mm(n,e){return V({},Rm,n,e)}function Nm(n,e){const t=n.getAttribute("format"),r=n.getAttribute("template"),i=n.getAttribute("resourceType"),s={};return t&&(s.format=t),r&&(s.template=r),i&&(s.resourceType=i),s}function Ou(n,e){const t=V([],Fu,n,e);if(t.length==2)return Ys(t)}function Dm(n,e){const t=n.getAttribute("crs"),r=V([],Fu,n,e);if(r.length==2)return{extent:Ys(r),crs:t}}function Um(n,e){const t={};return t.format=n.getAttribute("format"),t.href=jr(n),t}function Ss(n,e){const t=$(n).split(/\s+/);if(!t||t.length!=2)return;const r=+t[0],i=+t[1];if(!(isNaN(r)||isNaN(i)))return[r,i]}function Bm(n,e){return V({},Pm,n,e)}function Gm(n,e){return V([],vm,n,e)}function km(n,e){return V({},Sm,n,e)}window.eoxMapAdvancedOlFormats={EsriJSON:td,GML:lo,GPX:Pd,IGC:cp,IIIFInfo:mp,KML:Nh,OWS:pu,Polyline:Hp,TopoJSON:Mh,WFS:hg,WKB:yg,WKT:Rg,WMSCapabilities:Ng,WMSGetFeatureInfo:ym,WMTSCapabilities:To};function Mu(n,e,t){const r=[];let i=n(0),s=n(1),o=e(i),a=e(s);const l=[s,i],u=[a,o],f=[1,0],c={};let d=1e5,g,p,_,x,T,E;for(;--d>0&&f.length>0;)_=f.pop(),i=l.pop(),o=u.pop(),E=_.toString(),E in c||(r.push(o[0],o[1]),c[E]=!0),x=f.pop(),s=l.pop(),a=u.pop(),T=(_+x)/2,g=n(T),p=e(g),Dh(p[0],p[1],o[0],o[1],a[0],a[1])<t?(r.push(a[0],a[1]),E=x.toString(),c[E]=!0):(f.push(x,T,T,_),u.push(a,p,p,o),l.push(s,g,g,i));return r}function zm(n,e,t,r,i){const s=ye("EPSG:4326");return Mu(function(o){return[n,e+(t-e)*o]},si(s,r),i)}function $m(n,e,t,r,i){const s=ye("EPSG:4326");return Mu(function(o){return[e+(t-e)*o,n]},si(s,r),i)}function Vm(n){if(!(n.context instanceof CanvasRenderingContext2D))throw new Error("Only works for render events from Canvas 2D layers");const e=n.inversePixelTransform[0],t=n.inversePixelTransform[1],r=Math.sqrt(e*e+t*t),i=n.frameState,s=dn(n.inversePixelTransform.slice(),i.coordinateToPixelTransform),o=Uh(i.viewState.resolution,r);let a;return new Bh(n.context,r,i.extent,s,i.viewState.rotation,o,a)}const jm=new oi({color:"rgba(0,0,0,0.2)"}),Xm=[90,45,30,20,10,5,2,1,30/60,20/60,10/60,5/60,2/60,1/60,30/3600,20/3600,10/3600,5/3600,2/3600,1/3600];class Hm extends Zl{constructor(e){e=e||{};const t=Object.assign({updateWhileAnimating:!0,updateWhileInteracting:!0,renderBuffer:0},e);delete t.maxLines,delete t.strokeStyle,delete t.targetSize,delete t.showLabels,delete t.lonLabelFormatter,delete t.latLabelFormatter,delete t.lonLabelPosition,delete t.latLabelPosition,delete t.lonLabelStyle,delete t.latLabelStyle,delete t.intervals,super(t),this.projection_=null,this.maxLat_=1/0,this.maxLon_=1/0,this.minLat_=-1/0,this.minLon_=-1/0,this.maxX_=1/0,this.maxY_=1/0,this.minX_=-1/0,this.minY_=-1/0,this.targetSize_=e.targetSize!==void 0?e.targetSize:100,this.maxLines_=e.maxLines!==void 0?e.maxLines:100,this.meridians_=[],this.parallels_=[],this.strokeStyle_=e.strokeStyle!==void 0?e.strokeStyle:jm,this.fromLonLatTransform_=void 0,this.toLonLatTransform_=void 0,this.projectionCenterLonLat_=null,this.bottomLeft_=null,this.bottomRight_=null,this.topLeft_=null,this.topRight_=null,this.meridiansLabels_=null,this.parallelsLabels_=null,e.showLabels&&(this.lonLabelFormatter_=e.lonLabelFormatter==null?ya.bind(this,"EW"):e.lonLabelFormatter,this.latLabelFormatter_=e.latLabelFormatter==null?ya.bind(this,"NS"):e.latLabelFormatter,this.lonLabelPosition_=e.lonLabelPosition==null?0:e.lonLabelPosition,this.latLabelPosition_=e.latLabelPosition==null?1:e.latLabelPosition,this.lonLabelStyleBase_=new Zn({text:e.lonLabelStyle!==void 0?e.lonLabelStyle.clone():new xa({font:"12px Calibri,sans-serif",textBaseline:"bottom",fill:new ai({color:"rgba(0,0,0,1)"}),stroke:new oi({color:"rgba(255,255,255,1)",width:3})})}),this.lonLabelStyle_=r=>{const i=r.get("graticule_label");return this.lonLabelStyleBase_.getText().setText(i),this.lonLabelStyleBase_},this.latLabelStyleBase_=new Zn({text:e.latLabelStyle!==void 0?e.latLabelStyle.clone():new xa({font:"12px Calibri,sans-serif",textAlign:"right",fill:new ai({color:"rgba(0,0,0,1)"}),stroke:new oi({color:"rgba(255,255,255,1)",width:3})})}),this.latLabelStyle_=r=>{const i=r.get("graticule_label");return this.latLabelStyleBase_.getText().setText(i),this.latLabelStyleBase_},this.meridiansLabels_=[],this.parallelsLabels_=[],this.addEventListener(sr.POSTRENDER,this.drawLabels_.bind(this))),this.intervals_=e.intervals!==void 0?e.intervals:Xm,this.setSource(new Ii({loader:this.loaderFunction.bind(this),strategy:this.strategyFunction.bind(this),features:new Gh,overlaps:!1,useSpatialIndex:!1,wrapX:e.wrapX})),this.featurePool_=[],this.lineStyle_=new Zn({stroke:this.strokeStyle_}),this.loadedExtent_=null,this.renderedExtent_=null,this.renderedResolution_=null,this.setRenderOrder(null)}strategyFunction(e,t){let r=e.slice();return this.projection_&&this.getSource().getWrapX()&&kh(r,this.projection_),this.loadedExtent_&&(zh(this.loadedExtent_,r,t)?r=this.loadedExtent_.slice():this.getSource().removeLoadedExtent(this.loadedExtent_)),[r]}loaderFunction(e,t,r){this.loadedExtent_=e;const i=this.getSource(),s=this.getExtent()||[-1/0,-1/0,1/0,1/0],o=Pt(s,e);if(this.renderedExtent_&&pn(this.renderedExtent_,o)&&this.renderedResolution_===t||(this.renderedExtent_=o,this.renderedResolution_=t,Ci(o)))return;const a=Yt(o),l=t*t/4;(!this.projection_||!Yn(this.projection_,r))&&this.updateProjectionInfo_(r),this.createGraticule_(o,a,t,l);let f=this.meridians_.length+this.parallels_.length;this.meridiansLabels_&&(f+=this.meridians_.length),this.parallelsLabels_&&(f+=this.parallels_.length);let c;for(;f>this.featurePool_.length;)c=new et,this.featurePool_.push(c);const d=i.getFeaturesCollection();d.clear();let g=0,p,_;for(p=0,_=this.meridians_.length;p<_;++p)c=this.featurePool_[g++],c.setGeometry(this.meridians_[p]),c.setStyle(this.lineStyle_),d.push(c);for(p=0,_=this.parallels_.length;p<_;++p)c=this.featurePool_[g++],c.setGeometry(this.parallels_[p]),c.setStyle(this.lineStyle_),d.push(c)}addMeridian_(e,t,r,i,s,o){const a=this.getMeridian_(e,t,r,i,o);if(Or(a.getExtent(),s)){if(this.meridiansLabels_){const l=this.lonLabelFormatter_(e);o in this.meridiansLabels_?this.meridiansLabels_[o].text=l:this.meridiansLabels_[o]={geom:new ft([]),text:l}}this.meridians_[o++]=a}return o}addParallel_(e,t,r,i,s,o){const a=this.getParallel_(e,t,r,i,o);if(Or(a.getExtent(),s)){if(this.parallelsLabels_){const l=this.latLabelFormatter_(e);o in this.parallelsLabels_?this.parallelsLabels_[o].text=l:this.parallelsLabels_[o]={geom:new ft([]),text:l}}this.parallels_[o++]=a}return o}drawLabels_(e){const t=e.frameState.viewState.rotation,r=e.frameState.viewState.resolution,i=e.frameState.size,s=e.frameState.extent,o=Yt(s);let a=s;if(t){const p=i[0]*r,_=i[1]*r;a=[o[0]-p/2,o[1]-_/2,o[0]+p/2,o[1]+_/2]}let l=0,u=0,f=this.latLabelPosition_<.5;const c=this.projection_.getExtent(),d=Ve(c);if(this.getSource().getWrapX()&&this.projection_.canWrapX()&&!Jn(c,s)){l=Math.floor((s[0]-c[0])/d),u=Math.ceil((s[2]-c[2])/d);const p=Math.abs(t)>Math.PI/2;f=f!==p}const g=Vm(e);for(let p=l;p<=u;++p){let _=this.meridians_.length+this.parallels_.length,x,T,E,w;if(this.meridiansLabels_)for(T=0,E=this.meridiansLabels_.length;T<E;++T){const A=this.meridians_[T];if(!t&&p===0)w=this.getMeridianPoint_(A,s,T);else{const P=A.clone();P.translate(p*d,0),P.rotate(-t,o),w=this.getMeridianPoint_(P,a,T),w.rotate(t,o)}x=this.featurePool_[_++],x.setGeometry(w),x.set("graticule_label",this.meridiansLabels_[T].text),g.drawFeature(x,this.lonLabelStyle_(x))}if(this.parallelsLabels_&&(p===l&&f||p===u&&!f))for(T=0,E=this.parallels_.length;T<E;++T){const A=this.parallels_[T];if(!t&&p===0)w=this.getParallelPoint_(A,s,T);else{const P=A.clone();P.translate(p*d,0),P.rotate(-t,o),w=this.getParallelPoint_(P,a,T),w.rotate(t,o)}x=this.featurePool_[_++],x.setGeometry(w),x.set("graticule_label",this.parallelsLabels_[T].text),g.drawFeature(x,this.latLabelStyle_(x))}}}createGraticule_(e,t,r,i){const s=this.getInterval_(r);if(s==-1){this.meridians_.length=0,this.parallels_.length=0,this.meridiansLabels_&&(this.meridiansLabels_.length=0),this.parallelsLabels_&&(this.parallelsLabels_.length=0);return}let o=!1;const a=this.projection_.getExtent(),l=Ve(a);this.getSource().getWrapX()&&this.projection_.canWrapX()&&!Jn(a,e)&&(Ve(e)>=l?(e[0]=a[0],e[2]=a[2]):o=!0);const u=[Le(t[0],this.minX_,this.maxX_),Le(t[1],this.minY_,this.maxY_)],f=this.toLonLatTransform_(u);isNaN(f[1])&&(f[1]=Math.abs(this.maxLat_)>=Math.abs(this.minLat_)?this.maxLat_:this.minLat_);let c=Le(f[0],this.minLon_,this.maxLon_),d=Le(f[1],this.minLat_,this.maxLat_);const g=this.maxLines_;let p,_,x,T,E=e;o||(E=[Le(e[0],this.minX_,this.maxX_),Le(e[1],this.minY_,this.maxY_),Le(e[2],this.minX_,this.maxX_),Le(e[3],this.minY_,this.maxY_)]);const w=Mr(E,this.toLonLatTransform_,void 0,8);let A=w[3],P=w[2],C=w[1],N=w[0];if(o||(Pr(E,this.bottomLeft_)&&(N=this.minLon_,C=this.minLat_),Pr(E,this.bottomRight_)&&(P=this.maxLon_,C=this.minLat_),Pr(E,this.topLeft_)&&(N=this.minLon_,A=this.maxLat_),Pr(E,this.topRight_)&&(P=this.maxLon_,A=this.maxLat_),A=Le(A,d,this.maxLat_),P=Le(P,c,this.maxLon_),C=Le(C,this.minLat_,d),N=Le(N,this.minLon_,c)),c=Math.floor(c/s)*s,T=Le(c,this.minLon_,this.maxLon_),_=this.addMeridian_(T,C,A,i,e,0),p=0,o)for(;(T-=s)>=N&&p++<g;)_=this.addMeridian_(T,C,A,i,e,_);else for(;T!=this.minLon_&&p++<g;)T=Math.max(T-s,this.minLon_),_=this.addMeridian_(T,C,A,i,e,_);if(T=Le(c,this.minLon_,this.maxLon_),p=0,o)for(;(T+=s)<=P&&p++<g;)_=this.addMeridian_(T,C,A,i,e,_);else for(;T!=this.maxLon_&&p++<g;)T=Math.min(T+s,this.maxLon_),_=this.addMeridian_(T,C,A,i,e,_);for(this.meridians_.length=_,this.meridiansLabels_&&(this.meridiansLabels_.length=_),d=Math.floor(d/s)*s,x=Le(d,this.minLat_,this.maxLat_),_=this.addParallel_(x,N,P,i,e,0),p=0;x!=this.minLat_&&p++<g;)x=Math.max(x-s,this.minLat_),_=this.addParallel_(x,N,P,i,e,_);for(x=Le(d,this.minLat_,this.maxLat_),p=0;x!=this.maxLat_&&p++<g;)x=Math.min(x+s,this.maxLat_),_=this.addParallel_(x,N,P,i,e,_);this.parallels_.length=_,this.parallelsLabels_&&(this.parallelsLabels_.length=_)}getInterval_(e){const t=this.projectionCenterLonLat_[0],r=this.projectionCenterLonLat_[1];let i=-1;const s=Math.pow(this.targetSize_*e,2),o=[],a=[];for(let l=0,u=this.intervals_.length;l<u;++l){const f=Le(this.intervals_[l]/2,0,90),c=Le(r,-90+f,90-f);if(o[0]=t-f,o[1]=c-f,a[0]=t+f,a[1]=c+f,this.fromLonLatTransform_(o,o),this.fromLonLatTransform_(a,a),Math.pow(a[0]-o[0],2)+Math.pow(a[1]-o[1],2)<=s)break;i=this.intervals_[l]}return i}getMeridian_(e,t,r,i,s){const o=zm(e,t,r,this.projection_,i);let a=this.meridians_[s];return a?(a.setFlatCoordinates("XY",o),a.changed()):(a=new It(o,"XY"),this.meridians_[s]=a),a}getMeridianPoint_(e,t,r){const i=e.getFlatCoordinates();let s=1,o=i.length-1;i[s]>i[o]&&(s=o,o=1);const a=Math.max(t[1],i[s]),l=Math.min(t[3],i[o]),u=Le(t[1]+Math.abs(t[1]-t[3])*this.lonLabelPosition_,a,l),c=[i[s-1]+(i[o-1]-i[s-1])*(u-i[s])/(i[o]-i[s]),u],d=this.meridiansLabels_[r].geom;return d.setCoordinates(c),d}getMeridians(){return this.meridians_}getParallel_(e,t,r,i,s){const o=$m(e,t,r,this.projection_,i);let a=this.parallels_[s];return a?(a.setFlatCoordinates("XY",o),a.changed()):a=new It(o,"XY"),a}getParallelPoint_(e,t,r){const i=e.getFlatCoordinates();let s=0,o=i.length-2;i[s]>i[o]&&(s=o,o=0);const a=Math.max(t[0],i[s]),l=Math.min(t[2],i[o]),u=Le(t[0]+Math.abs(t[0]-t[2])*this.latLabelPosition_,a,l),f=i[s+1]+(i[o+1]-i[s+1])*(u-i[s])/(i[o]-i[s]),c=[u,f],d=this.parallelsLabels_[r].geom;return d.setCoordinates(c),d}getParallels(){return this.parallels_}updateProjectionInfo_(e){const t=ye("EPSG:4326"),r=e.getWorldExtent();this.maxLat_=r[3],this.maxLon_=r[2],this.minLat_=r[1],this.minLon_=r[0];const i=si(e,t);if(this.minLon_<this.maxLon_)this.toLonLatTransform_=i;else{const o=this.minLon_+this.maxLon_/2;this.maxLon_+=360,this.toLonLatTransform_=function(a,l,u){u=u||2;const f=i(a,l,u);for(let c=0,d=f.length;c<d;c+=u)f[c]<o&&(f[c]+=360);return f}}this.fromLonLatTransform_=si(t,e);const s=Mr([this.minLon_,this.minLat_,this.maxLon_,this.maxLat_],this.fromLonLatTransform_,void 0,8);this.minX_=s[0],this.maxX_=s[2],this.minY_=s[1],this.maxY_=s[3],this.bottomLeft_=this.fromLonLatTransform_([this.minLon_,this.minLat_]),this.bottomRight_=this.fromLonLatTransform_([this.maxLon_,this.minLat_]),this.topLeft_=this.fromLonLatTransform_([this.minLon_,this.maxLat_]),this.topRight_=this.fromLonLatTransform_([this.maxLon_,this.maxLat_]),this.projectionCenterLonLat_=this.toLonLatTransform_(Yt(e.getExtent())),isNaN(this.projectionCenterLonLat_[1])&&(this.projectionCenterLonLat_[1]=Math.abs(this.maxLat_)>=Math.abs(this.minLat_)?this.maxLat_:this.minLat_),this.projection_=e}}function yr(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function di(n,e){return n[0]=e[0],n[1]=e[1],n[4]=e[2],n[5]=e[3],n[12]=e[4],n[13]=e[5],n}function Rs(n,e,t,r,i,s,o){o=o??yr();const a=1/(n-e),l=1/(t-r),u=1/(i-s);return o[0]=-2*a,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=-2*l,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=2*u,o[11]=0,o[12]=(n+e)*a,o[13]=(r+t)*l,o[14]=(s+i)*u,o[15]=1,o}function Ja(n,e,t,r,i){return i=i??yr(),i[0]=n[0]*e,i[1]=n[1]*e,i[2]=n[2]*e,i[3]=n[3]*e,i[4]=n[4]*t,i[5]=n[5]*t,i[6]=n[6]*t,i[7]=n[7]*t,i[8]=n[8]*r,i[9]=n[9]*r,i[10]=n[10]*r,i[11]=n[11]*r,i[12]=n[12],i[13]=n[13],i[14]=n[14],i[15]=n[15],i}function Wm(n,e,t,r,i){i=i??yr();let s,o,a,l,u,f,c,d,g,p,_,x;return n===i?(i[12]=n[0]*e+n[4]*t+n[8]*r+n[12],i[13]=n[1]*e+n[5]*t+n[9]*r+n[13],i[14]=n[2]*e+n[6]*t+n[10]*r+n[14],i[15]=n[3]*e+n[7]*t+n[11]*r+n[15]):(s=n[0],o=n[1],a=n[2],l=n[3],u=n[4],f=n[5],c=n[6],d=n[7],g=n[8],p=n[9],_=n[10],x=n[11],i[0]=s,i[1]=o,i[2]=a,i[3]=l,i[4]=u,i[5]=f,i[6]=c,i[7]=d,i[8]=g,i[9]=p,i[10]=_,i[11]=x,i[12]=s*e+u*t+g*r+n[12],i[13]=o*e+f*t+p*r+n[13],i[14]=a*e+c*t+_*r+n[14],i[15]=l*e+d*t+x*r+n[15]),i}function Zm(n,e,t,r){return r=r??yr(),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=n,r[13]=e,r[14]=t,r[15]=1,r}const Pn=34962,Ln=34963,wo=35044,pi=35048,Ym=5121,qm=5123,Km=5125,Nu=5126,el=["experimental-webgl","webgl","webkit-3d","moz-webgl"];function Qm(n,e){e=Object.assign({preserveDrawingBuffer:!0,antialias:!$h},e);const t=el.length;for(let r=0;r<t;++r)try{const i=n.getContext(el[r],e);if(i)return i}catch{}return null}const Jm={STATIC_DRAW:wo};class Nr{constructor(e,t){this.array_=null,this.type_=e,dt(e===Pn||e===Ln,"A `WebGLArrayBuffer` must either be of type `ELEMENT_ARRAY_BUFFER` or `ARRAY_BUFFER`"),this.usage_=t!==void 0?t:Jm.STATIC_DRAW}ofSize(e){return this.array_=new($n(this.type_))(e),this}fromArray(e){return this.array_=$n(this.type_).from(e),this}fromArrayBuffer(e){return this.array_=new($n(this.type_))(e),this}getType(){return this.type_}getArray(){return this.array_}setArray(e){const t=$n(this.type_);if(!(e instanceof t))throw new Error(`Expected ${t}`);this.array_=e}getUsage(){return this.usage_}getSize(){return this.array_?this.array_.length:0}}function $n(n){switch(n){case Pn:return Float32Array;case Ln:return Uint32Array;default:return Float32Array}}const Vn={LOST:"webglcontextlost",RESTORED:"webglcontextrestored"},e_=`
  precision mediump float;

  attribute vec2 a_position;
  varying vec2 v_texCoord;
  varying vec2 v_screenCoord;

  uniform vec2 u_screenSize;

  void main() {
    v_texCoord = a_position * 0.5 + 0.5;
    v_screenCoord = v_texCoord * u_screenSize;
    gl_Position = vec4(a_position, 0.0, 1.0);
  }
`,t_=`
  precision mediump float;

  uniform sampler2D u_image;
  uniform float u_opacity;

  varying vec2 v_texCoord;

  void main() {
    gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;
  }
`;class tl{constructor(e){this.gl_=e.webGlContext;const t=this.gl_;this.scaleRatio_=e.scaleRatio||1,this.renderTargetTexture_=t.createTexture(),this.renderTargetTextureSize_=null,this.frameBuffer_=t.createFramebuffer(),this.depthBuffer_=t.createRenderbuffer();const r=t.createShader(t.VERTEX_SHADER);t.shaderSource(r,e.vertexShader||e_),t.compileShader(r);const i=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(i,e.fragmentShader||t_),t.compileShader(i),this.renderTargetProgram_=t.createProgram(),t.attachShader(this.renderTargetProgram_,r),t.attachShader(this.renderTargetProgram_,i),t.linkProgram(this.renderTargetProgram_),this.renderTargetVerticesBuffer_=t.createBuffer();const s=[-1,-1,1,-1,-1,1,1,-1,1,1,-1,1];t.bindBuffer(t.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),t.bufferData(t.ARRAY_BUFFER,new Float32Array(s),t.STATIC_DRAW),this.renderTargetAttribLocation_=t.getAttribLocation(this.renderTargetProgram_,"a_position"),this.renderTargetUniformLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_screenSize"),this.renderTargetOpacityLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_opacity"),this.renderTargetTextureLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_image"),this.uniforms_=[],e.uniforms&&Object.keys(e.uniforms).forEach(o=>{this.uniforms_.push({value:e.uniforms[o],location:t.getUniformLocation(this.renderTargetProgram_,o)})})}getRenderTargetTexture(){return this.renderTargetTexture_}getGL(){return this.gl_}init(e){const t=this.getGL(),r=[t.drawingBufferWidth*this.scaleRatio_,t.drawingBufferHeight*this.scaleRatio_];if(t.bindFramebuffer(t.FRAMEBUFFER,this.getFrameBuffer()),t.bindRenderbuffer(t.RENDERBUFFER,this.getDepthBuffer()),t.viewport(0,0,r[0],r[1]),!this.renderTargetTextureSize_||this.renderTargetTextureSize_[0]!==r[0]||this.renderTargetTextureSize_[1]!==r[1]){this.renderTargetTextureSize_=r;const i=0,s=t.RGBA,o=0,a=t.RGBA,l=t.UNSIGNED_BYTE,u=null;t.bindTexture(t.TEXTURE_2D,this.renderTargetTexture_),t.texImage2D(t.TEXTURE_2D,i,s,r[0],r[1],o,a,l,u),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.renderTargetTexture_,0),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,r[0],r[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer_)}}apply(e,t,r,i){const s=this.getGL(),o=e.size;if(s.bindFramebuffer(s.FRAMEBUFFER,t?t.getFrameBuffer():null),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.renderTargetTexture_),!t){const l=_e(s.canvas);if(!e.renderTargets[l]){const u=s.getContextAttributes();u&&u.preserveDrawingBuffer&&(s.clearColor(0,0,0,0),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)),e.renderTargets[l]=!0}}s.disable(s.DEPTH_TEST),s.enable(s.BLEND),s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA),s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.bindBuffer(s.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),s.useProgram(this.renderTargetProgram_),s.enableVertexAttribArray(this.renderTargetAttribLocation_),s.vertexAttribPointer(this.renderTargetAttribLocation_,2,s.FLOAT,!1,0,0),s.uniform2f(this.renderTargetUniformLocation_,o[0],o[1]),s.uniform1i(this.renderTargetTextureLocation_,0);const a=e.layerStatesArray[e.layerIndex].opacity;s.uniform1f(this.renderTargetOpacityLocation_,a),this.applyUniforms(e),r&&r(s,e),s.drawArrays(s.TRIANGLES,0,6),i&&i(s,e)}getFrameBuffer(){return this.frameBuffer_}getDepthBuffer(){return this.depthBuffer_}applyUniforms(e){const t=this.getGL();let r,i=1;this.uniforms_.forEach(function(s){if(r=typeof s.value=="function"?s.value(e):s.value,r instanceof HTMLCanvasElement||r instanceof ImageData)s.texture||(s.texture=t.createTexture()),t.activeTexture(t[`TEXTURE${i}`]),t.bindTexture(t.TEXTURE_2D,s.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r instanceof ImageData?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,r.width,r.height,0,t.UNSIGNED_BYTE,new Uint8Array(r.data)):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.uniform1i(s.location,i++);else if(Array.isArray(r))switch(r.length){case 2:t.uniform2f(s.location,r[0],r[1]);return;case 3:t.uniform3f(s.location,r[0],r[1],r[2]);return;case 4:t.uniform4f(s.location,r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(s.location,r)})}}const St={PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix",TIME:"u_time",ZOOM:"u_zoom",RESOLUTION:"u_resolution",ROTATION:"u_rotation",VIEWPORT_SIZE_PX:"u_viewportSizePx",PIXEL_RATIO:"u_pixelRatio",HIT_DETECTION:"u_hitDetection"},Fe={UNSIGNED_BYTE:Ym,UNSIGNED_SHORT:qm,UNSIGNED_INT:Km,FLOAT:Nu},gi={};function rl(n){return"shared/"+n}let nl=0;function r_(){const n="unique/"+nl;return nl+=1,n}function n_(n){let e=gi[n];if(!e){const t=document.createElement("canvas");t.width=1,t.height=1,t.style.position="absolute",t.style.left="0",e={users:0,context:Qm(t)},gi[n]=e}return e.users+=1,e.context}function i_(n){const e=gi[n];if(!e||(e.users-=1,e.users>0))return;const t=e.context,r=t.getExtension("WEBGL_lose_context");r&&r.loseContext();const i=t.canvas;i.width=1,i.height=1,delete gi[n]}class s_ extends Yl{constructor(e){super(),e=e||{},this.boundHandleWebGLContextLost_=this.handleWebGLContextLost.bind(this),this.boundHandleWebGLContextRestored_=this.handleWebGLContextRestored.bind(this),this.canvasCacheKey_=e.canvasCacheKey?rl(e.canvasCacheKey):r_(),this.gl_=n_(this.canvasCacheKey_),this.bufferCache_={},this.extensionCache_={},this.currentProgram_=null,this.needsToBeRecreated_=!1;const t=this.gl_.canvas;t.addEventListener(Vn.LOST,this.boundHandleWebGLContextLost_),t.addEventListener(Vn.RESTORED,this.boundHandleWebGLContextRestored_),this.offsetRotateMatrix_=$e(),this.offsetScaleMatrix_=$e(),this.tmpMat4_=yr(),this.uniformLocationsByProgram_={},this.attribLocationsByProgram_={},this.uniforms_=[],e.uniforms&&this.setUniforms(e.uniforms),this.postProcessPasses_=e.postProcesses?e.postProcesses.map(r=>new tl({webGlContext:this.gl_,scaleRatio:r.scaleRatio,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,uniforms:r.uniforms})):[new tl({webGlContext:this.gl_})],this.shaderCompileErrors_=null,this.startTime_=Date.now(),this.maxAttributeCount_=this.gl_.getParameter(this.gl_.MAX_VERTEX_ATTRIBS)}setUniforms(e){this.uniforms_=[],this.addUniforms(e)}addUniforms(e){for(const t in e)this.uniforms_.push({name:t,value:e[t]})}canvasCacheKeyMatches(e){return this.canvasCacheKey_===rl(e)}getExtension(e){if(e in this.extensionCache_)return this.extensionCache_[e];const t=this.gl_.getExtension(e);return this.extensionCache_[e]=t,t}bindBuffer(e){const t=this.gl_,r=_e(e);let i=this.bufferCache_[r];if(!i){const s=t.createBuffer();i={buffer:e,webGlBuffer:s},this.bufferCache_[r]=i}t.bindBuffer(e.getType(),i.webGlBuffer)}flushBufferData(e){const t=this.gl_;this.bindBuffer(e),t.bufferData(e.getType(),e.getArray(),e.getUsage())}deleteBuffer(e){const t=_e(e);delete this.bufferCache_[t]}disposeInternal(){const e=this.gl_.canvas;e.removeEventListener(Vn.LOST,this.boundHandleWebGLContextLost_),e.removeEventListener(Vn.RESTORED,this.boundHandleWebGLContextRestored_),i_(this.canvasCacheKey_),delete this.gl_}prepareDraw(e,t,r){const i=this.gl_,s=this.getCanvas(),o=e.size,a=e.pixelRatio;(s.width!==o[0]*a||s.height!==o[1]*a)&&(s.width=o[0]*a,s.height=o[1]*a,s.style.width=o[0]+"px",s.style.height=o[1]+"px");for(let l=this.postProcessPasses_.length-1;l>=0;l--)this.postProcessPasses_[l].init(e);i.bindTexture(i.TEXTURE_2D,null),i.clearColor(0,0,0,0),i.depthRange(0,1),i.clearDepth(1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),i.enable(i.BLEND),i.blendFunc(i.ONE,t?i.ZERO:i.ONE_MINUS_SRC_ALPHA),r?(i.enable(i.DEPTH_TEST),i.depthFunc(i.LEQUAL)):i.disable(i.DEPTH_TEST)}bindFrameBuffer(e,t){const r=this.getGL();r.bindFramebuffer(r.FRAMEBUFFER,e),t&&r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,t,0)}bindInitialFrameBuffer(){const e=this.getGL(),t=this.postProcessPasses_[0].getFrameBuffer();e.bindFramebuffer(e.FRAMEBUFFER,t);const r=this.postProcessPasses_[0].getRenderTargetTexture();e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,r,0)}bindTexture(e,t,r){const i=this.gl_;i.activeTexture(i.TEXTURE0+t),i.bindTexture(i.TEXTURE_2D,e),i.uniform1i(this.getUniformLocation(r),t)}bindAttribute(e,t,r){const i=this.getGL();this.bindBuffer(e);const s=this.getAttributeLocation(t);i.enableVertexAttribArray(s),i.vertexAttribPointer(s,r,i.FLOAT,!1,0,0)}prepareDrawToRenderTarget(e,t,r,i){const s=this.gl_,o=t.getSize();s.bindFramebuffer(s.FRAMEBUFFER,t.getFramebuffer()),s.bindRenderbuffer(s.RENDERBUFFER,t.getDepthbuffer()),s.viewport(0,0,o[0],o[1]),s.bindTexture(s.TEXTURE_2D,t.getTexture()),s.clearColor(0,0,0,0),s.depthRange(0,1),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.enable(s.BLEND),s.blendFunc(s.ONE,r?s.ZERO:s.ONE_MINUS_SRC_ALPHA),i?(s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL)):s.disable(s.DEPTH_TEST)}drawElements(e,t){const r=this.gl_;this.getExtension("OES_element_index_uint");const i=r.UNSIGNED_INT,s=4,o=t-e,a=e*s;r.drawElements(r.TRIANGLES,o,i,a)}finalizeDraw(e,t,r){for(let i=0,s=this.postProcessPasses_.length;i<s;i++)i===s-1?this.postProcessPasses_[i].apply(e,null,t,r):this.postProcessPasses_[i].apply(e,this.postProcessPasses_[i+1])}getCanvas(){return this.gl_.canvas}getGL(){return this.gl_}applyFrameState(e){const t=e.size,r=e.viewState.rotation,i=e.pixelRatio;this.setUniformFloatValue(St.TIME,(Date.now()-this.startTime_)*.001),this.setUniformFloatValue(St.ZOOM,e.viewState.zoom),this.setUniformFloatValue(St.RESOLUTION,e.viewState.resolution),this.setUniformFloatValue(St.PIXEL_RATIO,i),this.setUniformFloatVec2(St.VIEWPORT_SIZE_PX,[t[0],t[1]]),this.setUniformFloatValue(St.ROTATION,r)}applyHitDetectionUniform(e){const t=this.getUniformLocation(St.HIT_DETECTION);this.getGL().uniform1i(t,e?1:0),e&&this.setUniformFloatValue(St.PIXEL_RATIO,.5)}applyUniforms(e){const t=this.gl_;let r,i=0;this.uniforms_.forEach(s=>{if(r=typeof s.value=="function"?s.value(e):s.value,r instanceof HTMLCanvasElement||r instanceof HTMLImageElement||r instanceof ImageData||r instanceof WebGLTexture){r instanceof WebGLTexture&&!s.texture?(s.prevValue=void 0,s.texture=r):s.texture||(s.prevValue=void 0,s.texture=t.createTexture()),this.bindTexture(s.texture,i,s.name),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const o=!(r instanceof HTMLImageElement)||r.complete;!(r instanceof WebGLTexture)&&o&&s.prevValue!==r&&(s.prevValue=r,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r)),i++}else if(Array.isArray(r)&&r.length===6)this.setUniformMatrixValue(s.name,di(this.tmpMat4_,r));else if(Array.isArray(r)&&r.length<=4)switch(r.length){case 2:t.uniform2f(this.getUniformLocation(s.name),r[0],r[1]);return;case 3:t.uniform3f(this.getUniformLocation(s.name),r[0],r[1],r[2]);return;case 4:t.uniform4f(this.getUniformLocation(s.name),r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(this.getUniformLocation(s.name),r)})}useProgram(e,t){this.disableAllAttributes_(),this.gl_.useProgram(e),this.currentProgram_=e,t&&(this.applyFrameState(t),this.applyUniforms(t))}compileShader(e,t){const r=this.gl_,i=r.createShader(t);return r.shaderSource(i,e),r.compileShader(i),i}getProgram(e,t){const r=this.gl_,i=this.compileShader(e,r.FRAGMENT_SHADER),s=this.compileShader(t,r.VERTEX_SHADER),o=r.createProgram();if(r.attachShader(o,i),r.attachShader(o,s),r.linkProgram(o),!r.getShaderParameter(i,r.COMPILE_STATUS)){const a=`Fragment shader compilation failed: ${r.getShaderInfoLog(i)}`;throw new Error(a)}if(r.deleteShader(i),!r.getShaderParameter(s,r.COMPILE_STATUS)){const a=`Vertex shader compilation failed: ${r.getShaderInfoLog(s)}`;throw new Error(a)}if(r.deleteShader(s),!r.getProgramParameter(o,r.LINK_STATUS)){const a=`GL program linking failed: ${r.getProgramInfoLog(o)}`;throw new Error(a)}return o}getUniformLocation(e){const t=_e(this.currentProgram_);return this.uniformLocationsByProgram_[t]===void 0&&(this.uniformLocationsByProgram_[t]={}),this.uniformLocationsByProgram_[t][e]===void 0&&(this.uniformLocationsByProgram_[t][e]=this.gl_.getUniformLocation(this.currentProgram_,e)),this.uniformLocationsByProgram_[t][e]}getAttributeLocation(e){const t=_e(this.currentProgram_);return this.attribLocationsByProgram_[t]===void 0&&(this.attribLocationsByProgram_[t]={}),this.attribLocationsByProgram_[t][e]===void 0&&(this.attribLocationsByProgram_[t][e]=this.gl_.getAttribLocation(this.currentProgram_,e)),this.attribLocationsByProgram_[t][e]}makeProjectionTransform(e,t){const r=e.size,i=e.viewState.rotation,s=e.viewState.resolution,o=e.viewState.center;return qs(t,0,0,2/(s*r[0]),2/(s*r[1]),-i,-o[0],-o[1]),t}setUniformFloatValue(e,t){this.gl_.uniform1f(this.getUniformLocation(e),t)}setUniformFloatVec2(e,t){this.gl_.uniform2fv(this.getUniformLocation(e),t)}setUniformFloatVec4(e,t){this.gl_.uniform4fv(this.getUniformLocation(e),t)}setUniformMatrixValue(e,t){this.gl_.uniformMatrix4fv(this.getUniformLocation(e),!1,t)}disableAllAttributes_(){for(let e=0;e<this.maxAttributeCount_;e++)this.gl_.disableVertexAttribArray(e)}enableAttributeArray_(e,t,r,i,s){const o=this.getAttributeLocation(e);o<0||(this.gl_.enableVertexAttribArray(o),this.gl_.vertexAttribPointer(o,t,r,!1,i,s))}enableAttributes(e){const t=o_(e);let r=0;for(let i=0;i<e.length;i++){const s=e[i];this.enableAttributeArray_(s.name,s.size,s.type||Nu,t,r),r+=s.size*Du(s.type)}}handleWebGLContextLost(e){Vh(this.bufferCache_),this.currentProgram_=null,e.preventDefault()}handleWebGLContextRestored(){this.needsToBeRecreated_=!0}needsToBeRecreated(){return this.needsToBeRecreated_}createTexture(e,t,r,i){const s=this.gl_;r=r||s.createTexture();const o=i?s.NEAREST:s.LINEAR;s.bindTexture(s.TEXTURE_2D,r),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);const a=0,l=s.RGBA,u=0,f=s.RGBA,c=s.UNSIGNED_BYTE;return t instanceof Uint8Array?s.texImage2D(s.TEXTURE_2D,a,l,e[0],e[1],u,f,c,t):t?s.texImage2D(s.TEXTURE_2D,a,l,f,c,t):s.texImage2D(s.TEXTURE_2D,a,l,e[0],e[1],u,f,c,null),r}}function o_(n){let e=0;for(let t=0;t<n.length;t++){const r=n[t];e+=r.size*Du(r.type)}return e}function Du(n){switch(n){case Fe.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case Fe.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case Fe.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT;case Fe.FLOAT:default:return Float32Array.BYTES_PER_ELEMENT}}class a_ extends jh{constructor(e){super(),this.tile,this.handleTileChange_=this.handleTileChange_.bind(this),this.gutter=e.gutter||0,this.helper=e.helper,this.loaded=!1,this.ready=!1}setTile(e){if(e!==this.tile)if(this.tile&&this.tile.removeEventListener(Ke.CHANGE,this.handleTileChange_),this.tile=e,this.loaded=e.getState()===ue.LOADED,this.loaded)this.uploadTile();else{if(e instanceof Ks){const t=e.getImage();t instanceof Image&&!t.crossOrigin&&(t.crossOrigin="anonymous")}e.addEventListener(Ke.CHANGE,this.handleTileChange_)}}uploadTile(){Mt()}setReady(){this.ready=!0,this.dispatchEvent(Ke.CHANGE)}handleTileChange_(){this.tile.getState()===ue.LOADED&&(this.loaded=!0,this.uploadTile())}setHelper(e){this.helper=e,this.helper&&this.loaded&&this.uploadTile()}disposeInternal(){this.setHelper(null),this.tile.removeEventListener(Ke.CHANGE,this.handleTileChange_)}}function Uu(n,e,t){const r=t?n.LINEAR:n.NEAREST;n.bindTexture(n.TEXTURE_2D,e),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,r),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,r)}function l_(n,e,t,r){Uu(n,e,r),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t)}function il(n,e,t,r,i,s){const o=n.getGL();let a,l;t instanceof Float32Array?(a=o.FLOAT,n.getExtension("OES_texture_float"),l=n.getExtension("OES_texture_float_linear")!==null):(a=o.UNSIGNED_BYTE,l=!0),Uu(o,e,s&&l);const u=t.byteLength/r[1];let f=1;u%8===0?f=8:u%4===0?f=4:u%2===0&&(f=2);let c;switch(i){case 1:{c=o.LUMINANCE;break}case 2:{c=o.LUMINANCE_ALPHA;break}case 3:{c=o.RGB;break}case 4:{c=o.RGBA;break}default:throw new Error(`Unsupported number of bands: ${i}`)}const d=o.getParameter(o.UNPACK_ALIGNMENT);o.pixelStorei(o.UNPACK_ALIGNMENT,f),o.texImage2D(o.TEXTURE_2D,0,c,r[0],r[1],0,c,a,t),o.pixelStorei(o.UNPACK_ALIGNMENT,d)}let vr=null;function u_(){vr=Qt(1,1,void 0,{willReadFrequently:!0})}class c_ extends a_{constructor(e){super(e),this.textures=[],this.renderSize_=mt(e.grid.getTileSize(e.tile.tileCoord[0])),this.bandCount=NaN;const t=new Nr(Pn,wo);t.fromArray([0,1,1,1,1,0,0,0]),this.helper.flushBufferData(t),this.coords=t,this.setTile(e.tile)}setHelper(e){var r;const t=(r=this.helper)==null?void 0:r.getGL();if(t){this.helper.deleteBuffer(this.coords);for(let i=0;i<this.textures.length;++i)t.deleteTexture(this.textures[i])}super.setHelper(e),e&&e.flushBufferData(this.coords)}uploadTile(){const e=this.helper,t=e.getGL(),r=this.tile;this.textures.length=0;let i;r instanceof Ks||r instanceof Xh?i=r.getImage():i=r.getData();const s=_s(i);if(s){const E=t.createTexture();this.textures.push(E),this.bandCount=4,l_(t,E,s,r.interpolate),this.setReady();return}i=ms(i);const o=r.getSize(),a=[o[0]+2*this.gutter,o[1]+2*this.gutter],l=i instanceof Float32Array,u=a[0]*a[1],f=l?Float32Array:Uint8Array,c=f.BYTES_PER_ELEMENT,d=i.byteLength/a[1];this.bandCount=Math.floor(d/c/a[0]);const g=Math.ceil(this.bandCount/4);if(g===1){const E=t.createTexture();this.textures.push(E),il(e,E,i,a,this.bandCount,r.interpolate),this.setReady();return}const p=new Array(g);for(let E=0;E<g;++E){const w=t.createTexture();this.textures.push(w);const A=E<g-1?4:(this.bandCount-1)%4+1;p[E]=new f(u*A)}let _=0,x=0;const T=a[0]*this.bandCount;for(let E=0;E<a[1];++E){for(let w=0;w<T;++w){const A=i[x+w],P=Math.floor(_/this.bandCount),C=w%this.bandCount,N=Math.floor(C/4),U=p[N],k=U.length/u,D=C%4;U[P*k+D]=A,++_}x+=d/c}for(let E=0;E<g;++E){const w=this.textures[E],A=p[E],P=A.length/u;il(e,w,A,a,P,r.interpolate)}this.setReady()}getImagePixelData_(e,t,r){const i=this.gutter,s=this.renderSize_[0],o=this.renderSize_[1];vr||u_(),vr.clearRect(0,0,1,1);const a=e.width,l=e.height,u=a-2*i,f=l-2*i,c=i+Math.floor(u*(t/s)),d=i+Math.floor(f*(r/o));let g;try{vr.drawImage(e,c,d,1,1,0,0,1,1),g=vr.getImageData(0,0,1,1).data}catch{return vr=null,null}return g}getArrayPixelData_(e,t,r,i){const s=this.gutter,o=this.renderSize_[0],a=this.renderSize_[1],l=t[0],u=t[1],f=l+2*s,c=u+2*s,d=s+Math.floor(l*(r/o)),g=s+Math.floor(u*(i/a));if(e instanceof DataView){const _=e.byteLength/(f*c),x=_*(g*f+d),T=e.buffer.slice(x,x+_);return new DataView(T)}const p=this.bandCount*(g*f+d);return e.slice(p,p+this.bandCount)}getPixelData(e,t){if(!this.loaded)return null;if(this.tile instanceof Qs){const r=this.tile.getData(),i=ms(r);if(i){const s=this.tile.getSize();return this.getArrayPixelData_(i,s,e,t)}return this.getImagePixelData_(_s(r),e,t)}return this.getImagePixelData_(this.tile.getImage(),e,t)}}class In extends Hh{constructor(e,t){super(e),t=t||{},this.inversePixelTransform_=$e(),this.postProcesses_=t.postProcesses,this.uniforms_=t.uniforms,this.helper,this.onMapChanged_=()=>{this.clearCache(),this.removeHelper()},e.addChangeListener(ys.MAP,this.onMapChanged_),this.dispatchPreComposeEvent=this.dispatchPreComposeEvent.bind(this),this.dispatchPostComposeEvent=this.dispatchPostComposeEvent.bind(this)}dispatchPreComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(sr.PRECOMPOSE)){const i=new qi(sr.PRECOMPOSE,void 0,t,e);r.dispatchEvent(i)}}dispatchPostComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(sr.POSTCOMPOSE)){const i=new qi(sr.POSTCOMPOSE,void 0,t,e);r.dispatchEvent(i)}}reset(e){this.uniforms_=e.uniforms,this.helper&&this.helper.setUniforms(this.uniforms_)}removeHelper(){this.helper&&(this.helper.dispose(),delete this.helper)}prepareFrame(e){if(this.getLayer().getRenderSource()){let t=!0,r=-1,i;for(let o=0,a=e.layerStatesArray.length;o<a;o++){const l=e.layerStatesArray[o].layer,u=l.getRenderer();if(!(u instanceof In)){t=!0;continue}const f=l.getClassName();if((t||f!==i)&&(r+=1,t=!1),i=f,u===this)break}const s="map/"+e.mapId+"/group/"+r;(!this.helper||!this.helper.canvasCacheKeyMatches(s)||this.helper.needsToBeRecreated())&&(this.removeHelper(),this.helper=new s_({postProcesses:this.postProcesses_,uniforms:this.uniforms_,canvasCacheKey:s}),i&&(this.helper.getCanvas().className=i),this.afterHelperCreated())}return this.prepareFrameInternal(e)}afterHelperCreated(){}prepareFrameInternal(e){return!0}clearCache(){}disposeInternal(){var e;this.clearCache(),this.removeHelper(),(e=this.getLayer())==null||e.removeChangeListener(ys.MAP,this.onMapChanged_),super.disposeInternal()}dispatchRenderEvent_(e,t,r){const i=this.getLayer();if(i.hasListener(e)){qs(this.inversePixelTransform_,0,0,r.pixelRatio,-r.pixelRatio,0,0,-r.size[1]);const s=new qi(e,this.inversePixelTransform_,r,t);i.dispatchEvent(s)}}preRender(e,t){this.dispatchRenderEvent_(sr.PRERENDER,e,t)}postRender(e,t){this.dispatchRenderEvent_(sr.POSTRENDER,e,t)}}const h_={TILE_TRANSFORM:"u_tileTransform",TRANSITION_ALPHA:"u_transitionAlpha",DEPTH:"u_depth",RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",RESOLUTION:"u_resolution",ZOOM:"u_zoom",GLOBAL_ALPHA:"u_globalAlpha",PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix"};function sl(n){return 1/(n+2)}function f_(){return{tileIds:new Set,representationsByZ:{}}}function ol(n,e){return n.tileIds.has(_e(e))}function al(n,e,t){const r=n.representationsByZ;t in r||(r[t]=new Set),r[t].add(e),n.tileIds.add(_e(e.tile))}function Qi(n,e){const t=n.layerStatesArray[n.layerIndex];t.extent&&(e=Pt(e,Kl(t.extent,n.viewState.projection)));const r=t.layer.getRenderSource();if(!r.getWrapX()){const i=r.getTileGridForProjection(n.viewState.projection).getExtent();i&&(e=Pt(e,i))}return e}function As(n,e){return`${_e(n)},${n.getKey()},${n.getRevision()},${wr(e)}`}class d_ extends In{constructor(e,t){super(e,{uniforms:t.uniforms,postProcesses:t.postProcesses}),this.renderComplete=!1,this.tileTransform_=$e(),this.tempMat4=yr(),this.tempTileRange_=new Wh(0,0,0,0),this.tempTileCoord_=xs(0,0,0),this.tempSize_=[0,0];const r=t.cacheSize!==void 0?t.cacheSize:512;this.tileRepresentationCache=new ql(r),this.frameState=null,this.renderedProjection_=void 0}reset(e){super.reset({uniforms:e.uniforms})}prepareFrameInternal(e){this.renderedProjection_?e.viewState.projection!==this.renderedProjection_&&(this.clearCache(),this.renderedProjection_=e.viewState.projection):this.renderedProjection_=e.viewState.projection;const r=this.getLayer().getRenderSource();return!r||Ci(Qi(e,e.extent))?!1:r.getState()==="ready"}createTileRepresentation(e){return Mt()}enqueueTiles(e,t,r,i,s){const o=e.viewState,a=this.getLayer(),l=a.getRenderSource(),u=l.getTileGridForProjection(o.projection),f=l.getGutterForProjection(o.projection),c=_e(l);c in e.wantedTiles||(e.wantedTiles[c]={});const d=e.wantedTiles[c],g=this.tileRepresentationCache,p=a.getMapInternal(),_=Math.max(r-s,u.getMinZoom(),u.getZForResolution(Math.min(a.getMaxResolution(),p?p.getView().getResolutionForZoom(Math.max(a.getMinZoom(),0)):u.getResolution(0)),l.zDirection)),x=o.rotation,T=x?Zh(o.center,o.resolution,x,e.size):void 0;for(let E=r;E>=_;--E){const w=u.getTileRangeForExtentAndZ(t,E,this.tempTileRange_),A=u.getResolution(E);for(let P=w.minX;P<=w.maxX;++P)for(let C=w.minY;C<=w.maxY;++C){if(x&&!u.tileCoordIntersectsViewport([E,P,C],T))continue;const N=xs(E,P,C,this.tempTileCoord_),U=As(l,N);let k,D;if(g.containsKey(U)&&(k=g.get(U),D=k.tile),(!k||k.tile.key!==l.getKey())&&(D=l.getTile(E,P,C,e.pixelRatio,o.projection),!D)||ol(i,D))continue;k?k.setTile(D):(k=this.createTileRepresentation({tile:D,grid:u,helper:this.helper,gutter:f}),g.set(U,k)),al(i,k,E);const j=D.getKey();d[j]=!0,D.getState()===ue.IDLE&&(e.tileQueue.isKeyQueued(j)||e.tileQueue.enqueue([D,c,u.getTileCoordCenter(N),A]))}}}beforeTilesRender(e,t){this.helper.prepareDraw(this.frameState,!t,!0)}beforeTilesMaskRender(e){return!1}renderTile(e,t,r,i,s,o,a,l,u,f,c){}renderTileMask(e,t,r,i){}drawTile_(e,t,r,i,s,o,a){if(!t.ready)return;const u=t.tile.tileCoord,f=wr(u),c=f in o?o[f]:1,d=a.getResolution(r),g=mt(a.getTileSize(r),this.tempSize_),p=a.getOrigin(r),_=a.getTileCoordExtent(u),x=c<1?-1:sl(r);c<1&&(e.animate=!0);const T=e.viewState,E=T.center[0],w=T.center[1],A=g[0]+2*i,P=g[1]+2*i,C=A/P,N=(E-p[0])/(g[0]*d),U=(p[1]-w)/(g[1]*d),k=T.resolution/d,D=u[1],j=u[2];Yh(this.tileTransform_),Ea(this.tileTransform_,2/(e.size[0]*k/A),-2/(e.size[1]*k/A)),qh(this.tileTransform_,T.rotation),Ea(this.tileTransform_,1,1/C),Js(this.tileTransform_,(g[0]*(D-N)-i)/A,(g[1]*(j-U)-i)/P),this.renderTile(t,this.tileTransform_,e,s,d,g,p,_,x,i,c)}renderFrame(e){this.frameState=e,this.renderComplete=!0;const t=this.helper.getGL();this.preRender(t,e);const r=e.viewState,i=this.getLayer(),s=i.getRenderSource(),o=s.getTileGridForProjection(r.projection),a=s.getGutterForProjection(r.projection),l=Qi(e,e.extent),u=o.getZForResolution(r.resolution,s.zDirection),f=f_(),c=i.getPreload();if(e.nextExtent){const w=o.getZForResolution(r.nextResolution,s.zDirection),A=Qi(e,e.nextExtent);this.enqueueTiles(e,A,w,f,c)}this.enqueueTiles(e,l,u,f,0),c>0&&setTimeout(()=>{this.enqueueTiles(e,l,u-1,f,c-1)},0);const d={};let g=!1;const p=f.representationsByZ;if(u in p){const w=_e(this),A=e.time;for(const P of p[u]){const C=P.tile;if(C.getState()===ue.EMPTY)continue;const N=C.tileCoord;if(P.ready){const D=C.getAlpha(w,A);if(D===1){C.endTransition(w);continue}g=!0;const j=wr(N);d[j]=D}if(this.renderComplete=!1,this.findAltTiles_(o,N,u+1,f))continue;const k=o.getMinZoom();for(let D=u-1;D>=k&&!this.findAltTiles_(o,N,D,f);--D);}}const _=Object.keys(p).map(Number).sort(Kh);if(this.beforeTilesMaskRender(e))for(let w=0,A=_.length;w<A;++w){const P=_[w];for(const C of p[P]){const N=C.tile.tileCoord;if(wr(N)in d)continue;const k=o.getTileCoordExtent(N);this.renderTileMask(C,P,k,sl(P))}}this.beforeTilesRender(e,g);for(let w=0,A=_.length;w<A;++w){const P=_[w];for(const C of p[P]){const N=C.tile.tileCoord;wr(N)in d||this.drawTile_(e,C,P,a,l,d,o)}}if(u in p)for(const w of p[u]){const A=w.tile.tileCoord;wr(A)in d&&this.drawTile_(e,w,u,a,l,d,o)}this.beforeFinalize(e),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const T=this.helper.getCanvas(),E=this.tileRepresentationCache;for(;E.canExpireCache();)E.pop().dispose();return this.postRender(t,e),T}beforeFinalize(e){}findAltTiles_(e,t,r,i){const s=e.getTileRangeForTileCoordAndZ(t,r,this.tempTileRange_);if(!s)return!1;let o=!0;const a=this.tileRepresentationCache,l=this.getLayer().getRenderSource();for(let u=s.minX;u<=s.maxX;++u)for(let f=s.minY;f<=s.maxY;++f){const c=As(l,[r,u,f]);let d=!1;if(a.containsKey(c)){const g=a.get(c);g.ready&&!ol(i,g.tile)&&(al(i,g,r),d=!0)}d||(o=!1)}return o}clearCache(){super.clearCache();const e=this.tileRepresentationCache;e.forEach(t=>t.dispose()),e.clear()}afterHelperCreated(){super.afterHelperCreated(),this.tileRepresentationCache.forEach(e=>e.setHelper(this.helper))}disposeInternal(){super.disposeInternal(),delete this.frameState}}const ne={...h_,TILE_TEXTURE_ARRAY:"u_tileTextures",TEXTURE_PIXEL_WIDTH:"u_texturePixelWidth",TEXTURE_PIXEL_HEIGHT:"u_texturePixelHeight",TEXTURE_RESOLUTION:"u_textureResolution",TEXTURE_ORIGIN_X:"u_textureOriginX",TEXTURE_ORIGIN_Y:"u_textureOriginY"},qn={TEXTURE_COORD:"a_textureCoord"},p_=[{name:qn.TEXTURE_COORD,size:2,type:Fe.FLOAT}];class g_ extends d_{constructor(e,t){super(e,t),this.program_,this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.indices_=new Nr(Ln,wo),this.indices_.fromArray([0,1,3,1,2,3]),this.paletteTextures_=t.paletteTextures||[]}reset(e){if(super.reset(e),this.helper){const t=this.helper.getGL();for(const r of this.paletteTextures_)r.delete(t)}if(this.vertexShader_=e.vertexShader,this.fragmentShader_=e.fragmentShader,this.paletteTextures_=e.paletteTextures||[],this.helper){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_);const t=this.helper.getGL();for(const r of this.paletteTextures_)r.getTexture(t)}}afterHelperCreated(){super.afterHelperCreated();const e=this.helper.getGL();for(const t of this.paletteTextures_)t.getTexture(e);this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.helper.flushBufferData(this.indices_)}removeHelper(){if(this.helper){const e=this.helper.getGL();for(const t of this.paletteTextures_)t.delete(e)}super.removeHelper()}createTileRepresentation(e){return new c_(e)}beforeTilesRender(e,t){super.beforeTilesRender(e,t),this.helper.useProgram(this.program_,e)}renderTile(e,t,r,i,s,o,a,l,u,f,c){const d=this.helper.getGL();this.helper.bindBuffer(e.coords),this.helper.bindBuffer(this.indices_),this.helper.enableAttributes(p_);let g=0;for(;g<e.textures.length;){const C=`${ne.TILE_TEXTURE_ARRAY}[${g}]`;this.helper.bindTexture(e.textures[g],g,C),++g}for(let C=0;C<this.paletteTextures_.length;++C){const N=this.paletteTextures_[C],U=N.getTexture(d);this.helper.bindTexture(U,g,N.name),++g}const p=r.viewState,_=o[0]+2*f,x=o[1]+2*f,E=e.tile.tileCoord,w=E[1],A=E[2];this.helper.setUniformMatrixValue(ne.TILE_TRANSFORM,di(this.tempMat4,t)),this.helper.setUniformFloatValue(ne.TRANSITION_ALPHA,c),this.helper.setUniformFloatValue(ne.DEPTH,u);let P=i;f>0&&(P=l,Pt(P,i,P)),this.helper.setUniformFloatVec4(ne.RENDER_EXTENT,P),this.helper.setUniformFloatValue(ne.RESOLUTION,p.resolution),this.helper.setUniformFloatValue(ne.ZOOM,p.zoom),this.helper.setUniformFloatValue(ne.TEXTURE_PIXEL_WIDTH,_),this.helper.setUniformFloatValue(ne.TEXTURE_PIXEL_HEIGHT,x),this.helper.setUniformFloatValue(ne.TEXTURE_RESOLUTION,s),this.helper.setUniformFloatValue(ne.TEXTURE_ORIGIN_X,a[0]+w*o[0]*s-f*s),this.helper.setUniformFloatValue(ne.TEXTURE_ORIGIN_Y,a[1]-A*o[1]*s+f*s),this.helper.drawElements(0,this.indices_.getSize())}getData(e){if(!this.helper.getGL())return null;const r=this.frameState;if(!r)return null;const i=this.getLayer(),s=kt(r.pixelToCoordinateTransform,e.slice()),o=r.viewState,a=i.getExtent();if(a&&!Pr(Kl(a,o.projection),s))return null;const l=i.getSources(Ys([s]),o.resolution);let u,f,c;for(u=l.length-1;u>=0;--u)if(f=l[u],f.getState()==="ready"){if(c=f.getTileGridForProjection(o.projection),f.getWrapX())break;const g=c.getExtent();if(!g||Pr(g,s))break}if(u<0)return null;const d=this.tileRepresentationCache;for(let g=c.getZForResolution(o.resolution);g>=c.getMinZoom();--g){const p=c.getTileCoordForCoordAndZ(s,g),_=As(f,p);if(!d.containsKey(_))continue;const x=d.get(_);if(x.tile.getState()===ue.EMPTY)return null;if(!x.loaded)continue;const E=c.getOrigin(g),w=mt(c.getTileSize(g)),A=c.getResolution(g),P=(s[0]-E[0])/A-p[1]*w[0],C=(E[1]-s[1])/A-p[2]*w[1];return x.getPixelData(P,C)}return null}disposeInternal(){const e=this.helper;if(e){const t=e.getGL();for(const r of this.paletteTextures_)r.delete(t);this.paletteTextures_.length=0,t.deleteProgram(this.program_),delete this.program_,e.deleteBuffer(this.indices_)}super.disposeInternal(),delete this.indices_}}class m_{constructor(e,t){this.name=e,this.data=t,this.texture_=null}getTexture(e){if(!this.texture_){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.data.length/4,1,0,e.RGBA,e.UNSIGNED_BYTE,this.data),this.texture_=t}return this.texture_}delete(e){this.texture_&&e.deleteTexture(this.texture_),this.texture_=null}}function __(n,e){return`operator_${n}_${Object.keys(e.functions).length}`}function qt(n){const e=n.toString();return e.includes(".")?e:e+".0"}function vo(n){if(n.length<2||n.length>4)throw new Error("`formatArray` can only output `vec2`, `vec3` or `vec4` arrays.");return`vec${n.length}(${n.map(qt).join(", ")})`}function Kn(n){const e=wn(n),t=e.length>3?e[3]:1;return vo([e[0]/255,e[1]/255,e[2]/255,t])}function y_(n){const e=mt(n);return vo(e)}const Ji={};let x_=0;function Dr(n){return n in Ji||(Ji[n]=x_++),Ji[n]}function Nt(n){return qt(Dr(n))}function zi(n){return"u_var_"+n}function So(){return{variables:{},properties:{},functions:{},bandCount:0,featureId:!1,geometryType:!1}}const es="getBandValue",Bu="u_paletteTextures",Gu="featureId",ku="geometryType",Ps=-9999999;function E_(n,e,t,r){const i=Qh(n,e,t);return Ro(i,e,r)}function me(n){return(e,t,r)=>{const i=t.args.length,s=new Array(i);for(let o=0;o<i;++o)s[o]=Ro(t.args[o],r,e);return n(s,e)}}const b_={[se.Get]:(n,e)=>{const r=e.args[0].value;return r in n.properties||(n.properties[r]={name:r,type:e.type}),"a_prop_"+r},[se.Id]:n=>(n.featureId=!0,"a_"+Gu),[se.GeometryType]:n=>(n.geometryType=!0,"a_"+ku),[se.LineMetric]:()=>"currentLineMetric",[se.Var]:(n,e)=>{const r=e.args[0].value;return r in n.variables||(n.variables[r]={name:r,type:e.type}),zi(r)},[se.Has]:(n,e)=>{const r=e.args[0].value;return r in n.properties||(n.properties[r]={name:r,type:e.type}),`(a_prop_${r} != ${qt(Ps)})`},[se.Resolution]:()=>"u_resolution",[se.Zoom]:()=>"u_zoom",[se.Time]:()=>"u_time",[se.Any]:me(n=>`(${n.join(" || ")})`),[se.All]:me(n=>`(${n.join(" && ")})`),[se.Not]:me(([n])=>`(!${n})`),[se.Equal]:me(([n,e])=>`(${n} == ${e})`),[se.NotEqual]:me(([n,e])=>`(${n} != ${e})`),[se.GreaterThan]:me(([n,e])=>`(${n} > ${e})`),[se.GreaterThanOrEqualTo]:me(([n,e])=>`(${n} >= ${e})`),[se.LessThan]:me(([n,e])=>`(${n} < ${e})`),[se.LessThanOrEqualTo]:me(([n,e])=>`(${n} <= ${e})`),[se.Multiply]:me(n=>`(${n.join(" * ")})`),[se.Divide]:me(([n,e])=>`(${n} / ${e})`),[se.Add]:me(n=>`(${n.join(" + ")})`),[se.Subtract]:me(([n,e])=>`(${n} - ${e})`),[se.Clamp]:me(([n,e,t])=>`clamp(${n}, ${e}, ${t})`),[se.Mod]:me(([n,e])=>`mod(${n}, ${e})`),[se.Pow]:me(([n,e])=>`pow(${n}, ${e})`),[se.Abs]:me(([n])=>`abs(${n})`),[se.Floor]:me(([n])=>`floor(${n})`),[se.Ceil]:me(([n])=>`ceil(${n})`),[se.Round]:me(([n])=>`floor(${n} + 0.5)`),[se.Sin]:me(([n])=>`sin(${n})`),[se.Cos]:me(([n])=>`cos(${n})`),[se.Atan]:me(([n,e])=>e!==void 0?`atan(${n}, ${e})`:`atan(${n})`),[se.Sqrt]:me(([n])=>`sqrt(${n})`),[se.Match]:me(n=>{const e=n[0],t=n[n.length-1];let r=null;for(let i=n.length-3;i>=1;i-=2){const s=n[i],o=n[i+1];r=`(${e} == ${s} ? ${o} : ${r||t})`}return r}),[se.Between]:me(([n,e,t])=>`(${n} >= ${e} && ${n} <= ${t})`),[se.Interpolate]:me(([n,e,...t])=>{let r="";for(let i=0;i<t.length-2;i+=2){const s=t[i],o=r||t[i+1],a=t[i+2],l=t[i+3];let u;n===qt(1)?u=`(${e} - ${s}) / (${a} - ${s})`:u=`(pow(${n}, (${e} - ${s})) - 1.0) / (pow(${n}, (${a} - ${s})) - 1.0)`,r=`mix(${o}, ${l}, clamp(${u}, 0.0, 1.0))`}return r}),[se.Case]:me(n=>{const e=n[n.length-1];let t=null;for(let r=n.length-3;r>=0;r-=2){const i=n[r],s=n[r+1];t=`(${i} ? ${s} : ${t||e})`}return t}),[se.In]:me(([n,...e],t)=>{const r=__("in",t),i=[];for(let s=0;s<e.length;s+=1)i.push(`  if (inputValue == ${e[s]}) { return true; }`);return t.functions[r]=`bool ${r}(float inputValue) {
${i.join(`
`)}
  return false;
}`,`${r}(${n})`}),[se.Array]:me(n=>`vec${n.length}(${n.join(", ")})`),[se.Color]:me(n=>{if(n.length===1)return`vec4(vec3(${n[0]} / 255.0), 1.0)`;if(n.length===2)return`vec4(vec3(${n[0]} / 255.0), ${n[1]})`;const e=n.slice(0,3).map(r=>`${r} / 255.0`);if(n.length===3)return`vec4(${e.join(", ")}, 1.0)`;const t=n[3];return`vec4(${e.join(", ")}, ${t})`}),[se.Band]:me(([n,e,t],r)=>{if(!(es in r.functions)){let i="";const s=r.bandCount||1;for(let o=0;o<s;o++){const a=Math.floor(o/4);let l=o%4;o===s-1&&l===1&&(l=3);const u=`${ne.TILE_TEXTURE_ARRAY}[${a}]`;i+=`  if (band == ${o+1}.0) {
    return texture2D(${u}, v_textureCoord + vec2(dx, dy))[${l}];
  }
`}r.functions[es]=`float getBandValue(float band, float xOffset, float yOffset) {
  float dx = xOffset / ${ne.TEXTURE_PIXEL_WIDTH};
  float dy = yOffset / ${ne.TEXTURE_PIXEL_HEIGHT};
${i}
}`}return`${es}(${n}, ${e??"0.0"}, ${t??"0.0"})`}),[se.Palette]:(n,e)=>{const[t,...r]=e.args,i=r.length,s=new Uint8Array(i*4);for(let u=0;u<r.length;u++){const f=r[u].value,c=wn(f),d=u*4;s[d]=c[0],s[d+1]=c[1],s[d+2]=c[2],s[d+3]=c[3]*255}n.paletteTextures||(n.paletteTextures=[]);const o=`${Bu}[${n.paletteTextures.length}]`,a=new m_(o,s);n.paletteTextures.push(a);const l=Ro(t,ge,n);return`texture2D(${o}, vec2((${l} + 0.5) / ${i}.0, 0.5))`}};function Ro(n,e,t){if(n instanceof Jh){const r=b_[n.operator];if(r===void 0)throw new Error(`No compiler defined for this operator: ${JSON.stringify(n.operator)}`);return r(t,n,e)}if((n.type&ge)>0)return qt(n.value);if((n.type&Fi)>0)return n.value.toString();if((n.type&gn)>0)return Nt(n.value.toString());if((n.type&tt)>0)return Kn(n.value);if((n.type&hr)>0)return vo(n.value);if((n.type&pr)>0)return y_(n.value);throw new Error(`Unexpected expression ${n.value} (expected type ${ef(e)})`)}function T_(){return{"fill-color":"rgba(255,255,255,0.4)","stroke-color":"#3399CC","stroke-width":1.25,"circle-radius":5,"circle-fill-color":"rgba(255,255,255,0.4)","circle-stroke-width":1.25,"circle-stroke-color":"#3399CC"}}const ll=.985,xr=`#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif
uniform mat4 u_projectionMatrix;
uniform mat4 u_screenToWorldMatrix;
uniform vec2 u_viewportSizePx;
uniform float u_pixelRatio;
uniform float u_globalAlpha;
uniform float u_time;
uniform float u_zoom;
uniform float u_resolution;
uniform float u_rotation;
uniform vec4 u_renderExtent;
uniform vec2 u_patternOrigin;
uniform float u_depth;
uniform mediump int u_hitDetection;

const float PI = 3.141592653589793238;
const float TWO_PI = 2.0 * PI;
float currentLineMetric = 0.; // an actual value will be used in the stroke shaders
`,Er=T_();class zu{constructor(){this.uniforms_=[],this.attributes_=[],this.hasSymbol_=!1,this.symbolSizeExpression_=`vec2(${qt(Er["circle-radius"])} + ${qt(Er["circle-stroke-width"]*.5)})`,this.symbolRotationExpression_="0.0",this.symbolOffsetExpression_="vec2(0.0)",this.symbolColorExpression_=Kn(Er["circle-fill-color"]),this.texCoordExpression_="vec4(0.0, 0.0, 1.0, 1.0)",this.discardExpression_="false",this.symbolRotateWithView_=!1,this.hasStroke_=!1,this.strokeWidthExpression_=qt(Er["stroke-width"]),this.strokeColorExpression_=Kn(Er["stroke-color"]),this.strokeOffsetExpression_="0.",this.strokeCapExpression_=Nt("round"),this.strokeJoinExpression_=Nt("round"),this.strokeMiterLimitExpression_="10.",this.strokeDistanceFieldExpression_="-1000.",this.hasFill_=!1,this.fillColorExpression_=Kn(Er["fill-color"]),this.vertexShaderFunctions_=[],this.fragmentShaderFunctions_=[]}addUniform(e,t){return this.uniforms_.push({name:e,type:t}),this}addAttribute(e,t,r,i){return this.attributes_.push({name:e,type:t,varyingName:e.replace(/^a_/,"v_"),varyingType:i??t,varyingExpression:r??e}),this}setSymbolSizeExpression(e){return this.hasSymbol_=!0,this.symbolSizeExpression_=e,this}getSymbolSizeExpression(){return this.symbolSizeExpression_}setSymbolRotationExpression(e){return this.symbolRotationExpression_=e,this}setSymbolOffsetExpression(e){return this.symbolOffsetExpression_=e,this}getSymbolOffsetExpression(){return this.symbolOffsetExpression_}setSymbolColorExpression(e){return this.hasSymbol_=!0,this.symbolColorExpression_=e,this}getSymbolColorExpression(){return this.symbolColorExpression_}setTextureCoordinateExpression(e){return this.texCoordExpression_=e,this}setFragmentDiscardExpression(e){return this.discardExpression_=e,this}getFragmentDiscardExpression(){return this.discardExpression_}setSymbolRotateWithView(e){return this.symbolRotateWithView_=e,this}setStrokeWidthExpression(e){return this.hasStroke_=!0,this.strokeWidthExpression_=e,this}setStrokeColorExpression(e){return this.hasStroke_=!0,this.strokeColorExpression_=e,this}getStrokeColorExpression(){return this.strokeColorExpression_}setStrokeOffsetExpression(e){return this.strokeOffsetExpression_=e,this}setStrokeCapExpression(e){return this.strokeCapExpression_=e,this}setStrokeJoinExpression(e){return this.strokeJoinExpression_=e,this}setStrokeMiterLimitExpression(e){return this.strokeMiterLimitExpression_=e,this}setStrokeDistanceFieldExpression(e){return this.strokeDistanceFieldExpression_=e,this}setFillColorExpression(e){return this.hasFill_=!0,this.fillColorExpression_=e,this}getFillColorExpression(){return this.fillColorExpression_}addVertexShaderFunction(e){return this.vertexShaderFunctions_.includes(e)?this:(this.vertexShaderFunctions_.push(e),this)}addFragmentShaderFunction(e){return this.fragmentShaderFunctions_.includes(e)?this:(this.fragmentShaderFunctions_.push(e),this)}getSymbolVertexShader(){return this.hasSymbol_?`${xr}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
attribute vec2 a_position;
attribute float a_index;
attribute vec4 a_hitColor;

varying vec2 v_texCoord;
varying vec2 v_quadCoord;
varying vec4 v_hitColor;
varying vec2 v_centerPx;
varying float v_angle;
varying vec2 v_quadSizePx;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
vec2 pxToScreen(vec2 coordPx) {
  vec2 scaled = coordPx / u_viewportSizePx / 0.5;
  return scaled;
}

vec2 screenToPx(vec2 coordScreen) {
  return (coordScreen * 0.5 + 0.5) * u_viewportSizePx;
}

void main(void) {
  v_quadSizePx = ${this.symbolSizeExpression_};
  vec2 halfSizePx = v_quadSizePx * 0.5;
  vec2 centerOffsetPx = ${this.symbolOffsetExpression_};
  vec2 offsetPx = centerOffsetPx;
  if (a_index == 0.0) {
    offsetPx -= halfSizePx;
  } else if (a_index == 1.0) {
    offsetPx += halfSizePx * vec2(1., -1.);
  } else if (a_index == 2.0) {
    offsetPx += halfSizePx;
  } else {
    offsetPx += halfSizePx * vec2(-1., 1.);
  }
  float angle = ${this.symbolRotationExpression_}${this.symbolRotateWithView_?" + u_rotation":""};
  float c = cos(-angle);
  float s = sin(-angle);
  offsetPx = vec2(c * offsetPx.x - s * offsetPx.y, s * offsetPx.x + c * offsetPx.y);
  vec4 center = u_projectionMatrix * vec4(a_position, 0.0, 1.0);
  gl_Position = center + vec4(pxToScreen(offsetPx), u_depth, 0.);
  vec4 texCoord = ${this.texCoordExpression_};
  float u = a_index == 0.0 || a_index == 3.0 ? texCoord.s : texCoord.p;
  float v = a_index == 2.0 || a_index == 3.0 ? texCoord.t : texCoord.q;
  v_texCoord = vec2(u, v);
  v_hitColor = a_hitColor;
  v_angle = angle;
  c = cos(-v_angle);
  s = sin(-v_angle);
  centerOffsetPx = vec2(c * centerOffsetPx.x - s * centerOffsetPx.y, s * centerOffsetPx.x + c * centerOffsetPx.y);
  v_centerPx = screenToPx(center.xy) + centerOffsetPx;
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getSymbolFragmentShader(){return this.hasSymbol_?`${xr}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
varying vec2 v_texCoord;
varying vec4 v_hitColor;
varying vec2 v_centerPx;
varying float v_angle;
varying vec2 v_quadSizePx;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}
  if (${this.discardExpression_}) { discard; }
  vec2 coordsPx = gl_FragCoord.xy / u_pixelRatio - v_centerPx; // relative to center
  float c = cos(v_angle);
  float s = sin(v_angle);
  coordsPx = vec2(c * coordsPx.x - s * coordsPx.y, s * coordsPx.x + c * coordsPx.y);
  gl_FragColor = ${this.symbolColorExpression_};
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.05) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}getStrokeVertexShader(){return this.hasStroke_?`${xr}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
attribute vec2 a_segmentStart;
attribute vec2 a_segmentEnd;
attribute float a_measureStart;
attribute float a_measureEnd;
attribute float a_parameters;
attribute float a_distance;
attribute vec2 a_joinAngles;
attribute vec4 a_hitColor;

varying vec2 v_segmentStart;
varying vec2 v_segmentEnd;
varying float v_angleStart;
varying float v_angleEnd;
varying float v_width;
varying vec4 v_hitColor;
varying float v_distanceOffsetPx;
varying float v_measureStart;
varying float v_measureEnd;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
vec2 worldToPx(vec2 worldPos) {
  vec4 screenPos = u_projectionMatrix * vec4(worldPos, 0.0, 1.0);
  return (0.5 * screenPos.xy + 0.5) * u_viewportSizePx;
}

vec4 pxToScreen(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return vec4(screenPos, u_depth, 1.0);
}

bool isCap(float joinAngle) {
  return joinAngle < -0.1;
}

vec2 getJoinOffsetDirection(vec2 normalPx, float joinAngle) {
  float halfAngle = joinAngle / 2.0;
  float c = cos(halfAngle);
  float s = sin(halfAngle);
  vec2 angleBisectorNormal = vec2(s * normalPx.x + c * normalPx.y, -c * normalPx.x + s * normalPx.y);
  float length = 1.0 / s;
  return angleBisectorNormal * length;
}

vec2 getOffsetPoint(vec2 point, vec2 normal, float joinAngle, float offsetPx) {
  // if on a cap or the join angle is too high, offset the line along the segment normal
  if (cos(joinAngle) > 0.998 || isCap(joinAngle)) {
    return point - normal * offsetPx;
  }
  // offset is applied along the inverted normal (positive offset goes "right" relative to line direction)
  return point - getJoinOffsetDirection(normal, joinAngle) * offsetPx;
}

void main(void) {
  v_angleStart = a_joinAngles.x;
  v_angleEnd = a_joinAngles.y;
  float vertexNumber = floor(abs(a_parameters) / 10000. + 0.5);
  currentLineMetric = vertexNumber < 1.5 ? a_measureStart : a_measureEnd;
  // we're reading the fractional part while keeping the sign (so -4.12 gives -0.12, 3.45 gives 0.45)
  float angleTangentSum = fract(abs(a_parameters) / 10000.) * 10000. * sign(a_parameters);

  float lineWidth = ${this.strokeWidthExpression_};
  float lineOffsetPx = ${this.strokeOffsetExpression_};

  // compute segment start/end in px with offset
  vec2 segmentStartPx = worldToPx(a_segmentStart);
  vec2 segmentEndPx = worldToPx(a_segmentEnd);
  vec2 tangentPx = normalize(segmentEndPx - segmentStartPx);
  vec2 normalPx = vec2(-tangentPx.y, tangentPx.x);
  segmentStartPx = getOffsetPoint(segmentStartPx, normalPx, v_angleStart, lineOffsetPx),
  segmentEndPx = getOffsetPoint(segmentEndPx, normalPx, v_angleEnd, lineOffsetPx);

  // compute current vertex position
  float normalDir = vertexNumber < 0.5 || (vertexNumber > 1.5 && vertexNumber < 2.5) ? 1.0 : -1.0;
  float tangentDir = vertexNumber < 1.5 ? 1.0 : -1.0;
  float angle = vertexNumber < 1.5 ? v_angleStart : v_angleEnd;
  vec2 joinDirection;
  vec2 positionPx = vertexNumber < 1.5 ? segmentStartPx : segmentEndPx;
  // if angle is too high, do not make a proper join
  if (cos(angle) > ${ll} || isCap(angle)) {
    joinDirection = normalPx * normalDir - tangentPx * tangentDir;
  } else {
    joinDirection = getJoinOffsetDirection(normalPx * normalDir, angle);
  }
  positionPx = positionPx + joinDirection * (lineWidth * 0.5 + 1.); // adding 1 pixel for antialiasing
  gl_Position = pxToScreen(positionPx);

  v_segmentStart = segmentStartPx;
  v_segmentEnd = segmentEndPx;
  v_width = lineWidth;
  v_hitColor = a_hitColor;
  v_distanceOffsetPx = a_distance / u_resolution - (lineOffsetPx * angleTangentSum);
  v_measureStart = a_measureStart;
  v_measureEnd = a_measureEnd;
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getStrokeFragmentShader(){return this.hasStroke_?`${xr}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
varying vec2 v_segmentStart;
varying vec2 v_segmentEnd;
varying float v_angleStart;
varying float v_angleEnd;
varying float v_width;
varying vec4 v_hitColor;
varying float v_distanceOffsetPx;
varying float v_measureStart;
varying float v_measureEnd;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}

vec2 pxToWorld(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return (u_screenToWorldMatrix * vec4(screenPos, 0.0, 1.0)).xy;
}

bool isCap(float joinAngle) {
  return joinAngle < -0.1;
}

float segmentDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  vec2 tangent = normalize(end - start);
  vec2 normal = vec2(-tangent.y, tangent.x);
  vec2 startToPoint = point - start;
  return abs(dot(startToPoint, normal)) - width * 0.5;
}

float buttCapDistanceField(vec2 point, vec2 start, vec2 end) {
  vec2 startToPoint = point - start;
  vec2 tangent = normalize(end - start);
  return dot(startToPoint, -tangent);
}

float squareCapDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  return buttCapDistanceField(point, start, end) - width * 0.5;
}

float roundCapDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  float onSegment = max(0., 1000. * dot(point - start, end - start)); // this is very high when inside the segment
  return length(point - start) - width * 0.5 - onSegment;
}

float roundJoinDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  return roundCapDistanceField(point, start, end, width);
}

float bevelJoinField(vec2 point, vec2 start, vec2 end, float width, float joinAngle) {
  vec2 startToPoint = point - start;
  vec2 tangent = normalize(end - start);
  float c = cos(joinAngle * 0.5);
  float s = sin(joinAngle * 0.5);
  float direction = -sign(sin(joinAngle));
  vec2 bisector = vec2(c * tangent.x - s * tangent.y, s * tangent.x + c * tangent.y);
  float radius = width * 0.5 * s;
  return dot(startToPoint, bisector * direction) - radius;
}

float miterJoinDistanceField(vec2 point, vec2 start, vec2 end, float width, float joinAngle) {
  if (cos(joinAngle) > ${ll}) { // avoid risking a division by zero
    return bevelJoinField(point, start, end, width, joinAngle);
  }
  float miterLength = 1. / sin(joinAngle * 0.5);
  float miterLimit = ${this.strokeMiterLimitExpression_};
  if (miterLength > miterLimit) {
    return bevelJoinField(point, start, end, width, joinAngle);
  }
  return -1000.;
}

float capDistanceField(vec2 point, vec2 start, vec2 end, float width, float capType) {
   if (capType == ${Nt("butt")}) {
    return buttCapDistanceField(point, start, end);
  } else if (capType == ${Nt("square")}) {
    return squareCapDistanceField(point, start, end, width);
  }
  return roundCapDistanceField(point, start, end, width);
}

float joinDistanceField(vec2 point, vec2 start, vec2 end, float width, float joinAngle, float joinType) {
  if (joinType == ${Nt("bevel")}) {
    return bevelJoinField(point, start, end, width, joinAngle);
  } else if (joinType == ${Nt("miter")}) {
    return miterJoinDistanceField(point, start, end, width, joinAngle);
  }
  return roundJoinDistanceField(point, start, end, width);
}

float computeSegmentPointDistance(vec2 point, vec2 start, vec2 end, float width, float joinAngle, float capType, float joinType) {
  if (isCap(joinAngle)) {
    return capDistanceField(point, start, end, width, capType);
  }
  return joinDistanceField(point, start, end, width, joinAngle, joinType);
}

float distanceFromSegment(vec2 point, vec2 start, vec2 end) {
  vec2 tangent = end - start;
  vec2 startToPoint = point - start;
  // inspire by capsule fn in https://iquilezles.org/articles/distfunctions/
  float h = clamp(dot(startToPoint, tangent) / dot(tangent, tangent), 0.0, 1.0);
  return length(startToPoint - tangent * h);
}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}

  vec2 currentPoint = gl_FragCoord.xy / u_pixelRatio;
  #ifdef GL_FRAGMENT_PRECISION_HIGH
  vec2 worldPos = pxToWorld(currentPoint);
  if (
    abs(u_renderExtent[0] - u_renderExtent[2]) > 0.0 && (
      worldPos[0] < u_renderExtent[0] ||
      worldPos[1] < u_renderExtent[1] ||
      worldPos[0] > u_renderExtent[2] ||
      worldPos[1] > u_renderExtent[3]
    )
  ) {
    discard;
  }
  #endif

  float segmentLength = length(v_segmentEnd - v_segmentStart);
  vec2 segmentTangent = (v_segmentEnd - v_segmentStart) / segmentLength;
  vec2 segmentNormal = vec2(-segmentTangent.y, segmentTangent.x);
  vec2 startToPoint = currentPoint - v_segmentStart;
  float lengthToPoint = max(0., min(dot(segmentTangent, startToPoint), segmentLength));
  float currentLengthPx = lengthToPoint + v_distanceOffsetPx;
  float currentRadiusPx = distanceFromSegment(currentPoint, v_segmentStart, v_segmentEnd);
  float currentRadiusRatio = dot(segmentNormal, startToPoint) * 2. / v_width;
  currentLineMetric = mix(
    v_measureStart,
    v_measureEnd,
    lengthToPoint / max(segmentLength, 1.17549429e-38)
  );

  if (${this.discardExpression_}) { discard; }

  float capType = ${this.strokeCapExpression_};
  float joinType = ${this.strokeJoinExpression_};
  float segmentStartDistance = computeSegmentPointDistance(currentPoint, v_segmentStart, v_segmentEnd, v_width, v_angleStart, capType, joinType);
  float segmentEndDistance = computeSegmentPointDistance(currentPoint, v_segmentEnd, v_segmentStart, v_width, v_angleEnd, capType, joinType);
  float distanceField = max(
    segmentDistanceField(currentPoint, v_segmentStart, v_segmentEnd, v_width),
    max(segmentStartDistance, segmentEndDistance)
  );
  distanceField = max(distanceField, ${this.strokeDistanceFieldExpression_});

  vec4 color = ${this.strokeColorExpression_};
  color.a *= smoothstep(0.5, -0.5, distanceField);
  gl_FragColor = color;
  gl_FragColor.a *= u_globalAlpha;
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.1) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}getFillVertexShader(){return this.hasFill_?`${xr}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
attribute vec2 a_position;
attribute vec4 a_hitColor;

varying vec4 v_hitColor;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
void main(void) {
  gl_Position = u_projectionMatrix * vec4(a_position, u_depth, 1.0);
  v_hitColor = a_hitColor;
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getFillFragmentShader(){return this.hasFill_?`${xr}
${this.uniforms_.map(e=>`uniform ${e.type} ${e.name};`).join(`
`)}
varying vec4 v_hitColor;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}
vec2 pxToWorld(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return (u_screenToWorldMatrix * vec4(screenPos, 0.0, 1.0)).xy;
}

vec2 worldToPx(vec2 worldPos) {
  vec4 screenPos = u_projectionMatrix * vec4(worldPos, 0.0, 1.0);
  return (0.5 * screenPos.xy + 0.5) * u_viewportSizePx;
}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}
  vec2 pxPos = gl_FragCoord.xy / u_pixelRatio;
  vec2 pxOrigin = worldToPx(u_patternOrigin);
  #ifdef GL_FRAGMENT_PRECISION_HIGH
  vec2 worldPos = pxToWorld(pxPos);
  if (
    abs(u_renderExtent[0] - u_renderExtent[2]) > 0.0 && (
      worldPos[0] < u_renderExtent[0] ||
      worldPos[1] < u_renderExtent[1] ||
      worldPos[0] > u_renderExtent[2] ||
      worldPos[1] > u_renderExtent[3]
    )
  ) {
    discard;
  }
  #endif
  if (${this.discardExpression_}) { discard; }
  gl_FragColor = ${this.fillColorExpression_};
  gl_FragColor.a *= u_globalAlpha;
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.1) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}}function J(n,e,t){const r=Ql();return E_(e,t,r,n)}function w_(n){const e=wn(n),t=e[0]*256,r=e[1],i=e[2]*256,s=Math.round(e[3]*255);return[t+r,i+s]}const v_=`vec4 unpackColor(vec2 packedColor) {
  return vec4(
    fract(floor(packedColor[0] / 256.0) / 256.0),
    fract(packedColor[0] / 256.0),
    fract(floor(packedColor[1] / 256.0) / 256.0),
    fract(packedColor[1] / 256.0)
  );
}`;function Ao(n){return n===tt||n===pr?2:n===hr?4:1}function Ls(n){const e=Ao(n);return e>1?`vec${e}`:"float"}function $u(n,e){for(const t in e.variables){const r=e.variables[t],i=zi(r.name);let s=Ls(r.type);r.type===tt&&(s="vec4"),n.addUniform(i,s)}for(const t in e.properties){const r=e.properties[t],i=Ls(r.type),s=`a_prop_${r.name}`;r.type===tt?(n.addAttribute(s,i,`unpackColor(${s})`,"vec4"),n.addVertexShaderFunction(v_)):n.addAttribute(s,i)}for(const t in e.functions)n.addVertexShaderFunction(e.functions[t]),n.addFragmentShaderFunction(e.functions[t])}function Vu(n,e){const t={};for(const r in n.variables){const i=n.variables[r],s=zi(i.name);t[s]=()=>{const o=e[i.name];if(typeof o=="number")return o;if(typeof o=="boolean")return o?1:0;if(i.type===tt){const a=[...wn(o||"#eee")];return a[0]/=255,a[1]/=255,a[2]/=255,a[3]??(a[3]=1),a}return typeof o=="string"?Dr(o):o}}return t}function ju(n){const e={};for(const t in n.properties){const r=n.properties[t],i=s=>{const o=s.get(r.name);return r.type===tt?w_([...wn(o||"#eee")]):typeof o=="string"?Dr(o):typeof o=="boolean"?o?1:0:o};e[`prop_${r.name}`]={size:Ao(r.type),callback:i}}return e}class mi{constructor(){this.globalCounter_=0,this.refToFeature_=new Map,this.uidToRef_=new Map,this.freeGlobalRef_=[],this.polygonBatch={entries:{},geometriesCount:0,verticesCount:0,ringsCount:0},this.pointBatch={entries:{},geometriesCount:0},this.lineStringBatch={entries:{},geometriesCount:0,verticesCount:0}}addFeatures(e,t){for(let r=0;r<e.length;r++)this.addFeature(e[r],t)}addFeature(e,t){let r=e.getGeometry();r&&(t&&(r=r.clone(),r.applyTransform(t)),this.addGeometry_(r,e))}clearFeatureEntryInPointBatch_(e){const t=_e(e),r=this.pointBatch.entries[t];if(r)return this.pointBatch.geometriesCount-=r.flatCoordss.length,delete this.pointBatch.entries[t],r}clearFeatureEntryInLineStringBatch_(e){const t=_e(e),r=this.lineStringBatch.entries[t];if(r)return this.lineStringBatch.verticesCount-=r.verticesCount,this.lineStringBatch.geometriesCount-=r.flatCoordss.length,delete this.lineStringBatch.entries[t],r}clearFeatureEntryInPolygonBatch_(e){const t=_e(e),r=this.polygonBatch.entries[t];if(r)return this.polygonBatch.verticesCount-=r.verticesCount,this.polygonBatch.ringsCount-=r.ringsCount,this.polygonBatch.geometriesCount-=r.flatCoordss.length,delete this.polygonBatch.entries[t],r}addGeometry_(e,t){var i;const r=e.getType();switch(r){case"GeometryCollection":{const s=e.getGeometriesArray();for(const o of s)this.addGeometry_(o,t);break}case"MultiPolygon":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEndss(),t,_e(t),s.getStride());break}case"MultiLineString":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEnds(),t,_e(t),s.getStride());break}case"MultiPoint":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),null,t,_e(t),s.getStride());break}case"Polygon":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEnds(),t,_e(t),s.getStride());break}case"Point":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),null,t,_e(t),s.getStride());break}case"LineString":case"LinearRing":{const s=e,o=s.getStride();this.addCoordinates_(r,s.getFlatCoordinates(),null,t,_e(t),o,(i=s.getLayout)==null?void 0:i.call(s));break}}}addCoordinates_(e,t,r,i,s,o,a){let l;switch(e){case"MultiPolygon":{const u=r;for(let f=0,c=u.length;f<c;f++){let d=u[f];const g=f>0?u[f-1]:null,p=g?g[g.length-1]:0,_=d[d.length-1];d=p>0?d.map(x=>x-p):d,this.addCoordinates_("Polygon",t.slice(p,_),d,i,s,o,a)}break}case"MultiLineString":{const u=r;for(let f=0,c=u.length;f<c;f++){const d=f>0?u[f-1]:0;this.addCoordinates_("LineString",t.slice(d,u[f]),null,i,s,o,a)}break}case"MultiPoint":for(let u=0,f=t.length;u<f;u+=o)this.addCoordinates_("Point",t.slice(u,u+2),null,i,s,null,null);break;case"Polygon":{const u=r;if(i instanceof tf){const d=rf(t,u);if(d.length>1){this.addCoordinates_("MultiPolygon",t,d,i,s,o,a);return}}this.polygonBatch.entries[s]||(this.polygonBatch.entries[s]=this.addRefToEntry_(s,{feature:i,flatCoordss:[],verticesCount:0,ringsCount:0,ringsVerticesCounts:[]})),l=t.length/o;const f=r.length,c=r.map((d,g,p)=>g>0?(d-p[g-1])/o:d/o);this.polygonBatch.verticesCount+=l,this.polygonBatch.ringsCount+=f,this.polygonBatch.geometriesCount++,this.polygonBatch.entries[s].flatCoordss.push(S_(t,o)),this.polygonBatch.entries[s].ringsVerticesCounts.push(c),this.polygonBatch.entries[s].verticesCount+=l,this.polygonBatch.entries[s].ringsCount+=f;for(let d=0,g=u.length;d<g;d++){const p=d>0?u[d-1]:0;this.addCoordinates_("LinearRing",t.slice(p,u[d]),null,i,s,o,a)}break}case"Point":this.pointBatch.entries[s]||(this.pointBatch.entries[s]=this.addRefToEntry_(s,{feature:i,flatCoordss:[]})),this.pointBatch.geometriesCount++,this.pointBatch.entries[s].flatCoordss.push(t);break;case"LineString":case"LinearRing":this.lineStringBatch.entries[s]||(this.lineStringBatch.entries[s]=this.addRefToEntry_(s,{feature:i,flatCoordss:[],verticesCount:0})),l=t.length/o,this.lineStringBatch.verticesCount+=l,this.lineStringBatch.geometriesCount++,this.lineStringBatch.entries[s].flatCoordss.push(R_(t,o,a)),this.lineStringBatch.entries[s].verticesCount+=l;break}}addRefToEntry_(e,t){const r=this.uidToRef_.get(e),i=r||this.freeGlobalRef_.pop()||++this.globalCounter_;return t.ref=i,r||(this.refToFeature_.set(i,t.feature),this.uidToRef_.set(e,i)),t}removeRef_(e,t){if(!e)throw new Error("This feature has no ref: "+t);this.refToFeature_.delete(e),this.uidToRef_.delete(t),this.freeGlobalRef_.push(e)}changeFeature(e,t){if(!this.uidToRef_.get(_e(e)))return;this.removeFeature(e);let r=e.getGeometry();r&&(t&&(r=r.clone(),r.applyTransform(t)),this.addGeometry_(r,e))}removeFeature(e){let t=this.clearFeatureEntryInPointBatch_(e);t=this.clearFeatureEntryInPolygonBatch_(e)||t,t=this.clearFeatureEntryInLineStringBatch_(e)||t,t&&this.removeRef_(t.ref,_e(t.feature))}clear(){this.polygonBatch.entries={},this.polygonBatch.geometriesCount=0,this.polygonBatch.verticesCount=0,this.polygonBatch.ringsCount=0,this.lineStringBatch.entries={},this.lineStringBatch.geometriesCount=0,this.lineStringBatch.verticesCount=0,this.pointBatch.entries={},this.pointBatch.geometriesCount=0,this.globalCounter_=0,this.freeGlobalRef_=[],this.refToFeature_.clear(),this.uidToRef_.clear()}getFeatureFromRef(e){return this.refToFeature_.get(e)}isEmpty(){return this.globalCounter_===0}filter(e){const t=new mi;t.globalCounter_=this.globalCounter_,t.uidToRef_=this.uidToRef_,t.refToFeature_=this.refToFeature_;let r=!0;for(const i of this.refToFeature_.values())e(i)&&(t.addFeature(i),r=!1);return r?new mi:t}}function S_(n,e){return e===2?n:n.filter((t,r)=>r%e<2)}function R_(n,e,t){return e===3&&t==="XYM"?n:e===4?n.filter((r,i)=>i%e!==2):e===3?n.map((r,i)=>i%e!==2?r:0):new Array(n.length*1.5).fill(0).map((r,i)=>i%3===2?0:n[Math.round(i/1.5)])}function Xu(){const n='function t(t,n,x=2){const o=n&&n.length,i=o?n[0]*x:t.length;let u=e(t,0,i,x,!0);const l=[];if(!u||u.next===u.prev)return l;let c,h,y;if(o&&(u=function(t,n,r,x){const o=[];for(let r=0,i=n.length;r<i;r++){const u=e(t,n[r]*x,r<i-1?n[r+1]*x:t.length,x,!1);u===u.next&&(u.steiner=!0),o.push(a(u))}o.sort(f);for(let t=0;t<o.length;t++)r=s(o[t],r);return r}(t,n,u,x)),t.length>80*x){c=1/0,h=1/0;let e=-1/0,n=-1/0;for(let r=x;r<i;r+=x){const x=t[r],o=t[r+1];x<c&&(c=x),o<h&&(h=o),x>e&&(e=x),o>n&&(n=o)}y=Math.max(e-c,n-h),y=0!==y?32767/y:0}return r(u,l,x,c,h,y,0),l}function e(t,e,n,r,x){let o;if(x===function(t,e,n,r){let x=0;for(let o=e,i=n-r;o<n;o+=r)x+=(t[i]-t[o])*(t[o+1]+t[i+1]),i=o;return x}(t,e,n,r)>0)for(let x=e;x<n;x+=r)o=w(x/r|0,t[x],t[x+1],o);else for(let x=n-r;x>=e;x-=r)o=w(x/r|0,t[x],t[x+1],o);return o&&g(o,o.next)&&(A(o),o=o.next),o}function n(t,e){if(!t)return t;e||(e=t);let n,r=t;do{if(n=!1,r.steiner||!g(r,r.next)&&0!==v(r.prev,r,r.next))r=r.next;else{if(A(r),r=e=r.prev,r===r.next)break;n=!0}}while(n||r!==e);return e}function r(t,e,f,s,l,a,h){if(!t)return;!h&&a&&function(t,e,n,r){let x=t;do{0===x.z&&(x.z=c(x.x,x.y,e,n,r)),x.prevZ=x.prev,x.nextZ=x.next,x=x.next}while(x!==t);x.prevZ.nextZ=null,x.prevZ=null,function(t){let e,n=1;do{let r,x=t;t=null;let o=null;for(e=0;x;){e++;let i=x,u=0;for(let t=0;t<n&&(u++,i=i.nextZ,i);t++);let f=n;for(;u>0||f>0&&i;)0!==u&&(0===f||!i||x.z<=i.z)?(r=x,x=x.nextZ,u--):(r=i,i=i.nextZ,f--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;x=i}o.nextZ=null,n*=2}while(e>1)}(x)}(t,s,l,a);let y=t;for(;t.prev!==t.next;){const c=t.prev,p=t.next;if(a?o(t,s,l,a):x(t))e.push(c.i,t.i,p.i),A(t),t=p.next,y=p.next;else if((t=p)===y){h?1===h?r(t=i(n(t),e),e,f,s,l,a,2):2===h&&u(t,e,f,s,l,a):r(n(t),e,f,s,l,a,1);break}}}function x(t){const e=t.prev,n=t,r=t.next;if(v(e,n,r)>=0)return!1;const x=e.x,o=n.x,i=r.x,u=e.y,f=n.y,s=r.y,l=Math.min(x,o,i),c=Math.min(u,f,s),a=Math.max(x,o,i),h=Math.max(u,f,s);let p=r.next;for(;p!==e;){if(p.x>=l&&p.x<=a&&p.y>=c&&p.y<=h&&y(x,u,o,f,i,s,p.x,p.y)&&v(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function o(t,e,n,r){const x=t.prev,o=t,i=t.next;if(v(x,o,i)>=0)return!1;const u=x.x,f=o.x,s=i.x,l=x.y,a=o.y,h=i.y,p=Math.min(u,f,s),g=Math.min(l,a,h),b=Math.max(u,f,s),M=Math.max(l,a,h),m=c(p,g,e,n,r),Z=c(b,M,e,n,r);let d=t.prevZ,w=t.nextZ;for(;d&&d.z>=m&&w&&w.z<=Z;){if(d.x>=p&&d.x<=b&&d.y>=g&&d.y<=M&&d!==x&&d!==i&&y(u,l,f,a,s,h,d.x,d.y)&&v(d.prev,d,d.next)>=0)return!1;if(d=d.prevZ,w.x>=p&&w.x<=b&&w.y>=g&&w.y<=M&&w!==x&&w!==i&&y(u,l,f,a,s,h,w.x,w.y)&&v(w.prev,w,w.next)>=0)return!1;w=w.nextZ}for(;d&&d.z>=m;){if(d.x>=p&&d.x<=b&&d.y>=g&&d.y<=M&&d!==x&&d!==i&&y(u,l,f,a,s,h,d.x,d.y)&&v(d.prev,d,d.next)>=0)return!1;d=d.prevZ}for(;w&&w.z<=Z;){if(w.x>=p&&w.x<=b&&w.y>=g&&w.y<=M&&w!==x&&w!==i&&y(u,l,f,a,s,h,w.x,w.y)&&v(w.prev,w,w.next)>=0)return!1;w=w.nextZ}return!0}function i(t,e){let r=t;do{const n=r.prev,x=r.next.next;!g(n,x)&&b(n,r,r.next,x)&&Z(n,x)&&Z(x,n)&&(e.push(n.i,r.i,x.i),A(r),A(r.next),r=t=x),r=r.next}while(r!==t);return n(r)}function u(t,e,x,o,i,u){let f=t;do{let t=f.next.next;for(;t!==f.prev;){if(f.i!==t.i&&p(f,t)){let s=d(f,t);return f=n(f,f.next),s=n(s,s.next),r(f,e,x,o,i,u,0),void r(s,e,x,o,i,u,0)}t=t.next}f=f.next}while(f!==t)}function f(t,e){let n=t.x-e.x;if(0===n&&(n=t.y-e.y,0===n)){n=(t.next.y-t.y)/(t.next.x-t.x)-(e.next.y-e.y)/(e.next.x-e.x)}return n}function s(t,e){const r=function(t,e){let n=e;const r=t.x,x=t.y;let o,i=-1/0;if(g(t,n))return n;do{if(g(t,n.next))return n.next;if(x<=n.y&&x>=n.next.y&&n.next.y!==n.y){const t=n.x+(x-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(t<=r&&t>i&&(i=t,o=n.x<n.next.x?n:n.next,t===r))return o}n=n.next}while(n!==e);if(!o)return null;const u=o,f=o.x,s=o.y;let c=1/0;n=o;do{if(r>=n.x&&n.x>=f&&r!==n.x&&h(x<s?r:i,x,f,s,x<s?i:r,x,n.x,n.y)){const e=Math.abs(x-n.y)/(r-n.x);Z(n,t)&&(e<c||e===c&&(n.x>o.x||n.x===o.x&&l(o,n)))&&(o=n,c=e)}n=n.next}while(n!==u);return o}(t,e);if(!r)return e;const x=d(r,t);return n(x,x.next),n(r,r.next)}function l(t,e){return v(t.prev,t,e.prev)<0&&v(e.next,t,t.next)<0}function c(t,e,n,r,x){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*x|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*x|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function a(t){let e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function h(t,e,n,r,x,o,i,u){return(x-i)*(e-u)>=(t-i)*(o-u)&&(t-i)*(r-u)>=(n-i)*(e-u)&&(n-i)*(o-u)>=(x-i)*(r-u)}function y(t,e,n,r,x,o,i,u){return!(t===i&&e===u)&&h(t,e,n,r,x,o,i,u)}function p(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&b(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(Z(t,e)&&Z(e,t)&&function(t,e){let n=t,r=!1;const x=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&x<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}(t,e)&&(v(t.prev,t,e.prev)||v(t,e.prev,e))||g(t,e)&&v(t.prev,t,t.next)>0&&v(e.prev,e,e.next)>0)}function v(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function g(t,e){return t.x===e.x&&t.y===e.y}function b(t,e,n,r){const x=m(v(t,e,n)),o=m(v(t,e,r)),i=m(v(n,r,t)),u=m(v(n,r,e));return x!==o&&i!==u||(!(0!==x||!M(t,n,e))||(!(0!==o||!M(t,r,e))||(!(0!==i||!M(n,t,r))||!(0!==u||!M(n,e,r)))))}function M(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function m(t){return t>0?1:t<0?-1:0}function Z(t,e){return v(t.prev,t,t.next)<0?v(t,e,t.next)>=0&&v(t,t.prev,e)>=0:v(t,e,t.prev)<0||v(t,t.next,e)<0}function d(t,e){const n=E(t.i,t.x,t.y),r=E(e.i,e.x,e.y),x=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=x,x.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function w(t,e,n,r){const x=E(t,e,n);return r?(x.next=r.next,x.prev=r,r.next.prev=x,r.next=x):(x.prev=x,x.next=x),x}function A(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function E(t,e,n){return{i:t,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function I(t,e){const n=e[0],r=e[1];return e[0]=t[0]*n+t[2]*r+t[4],e[1]=t[1]*n+t[3]*r+t[5],e}function z(t,e){const n=(r=e)[0]*r[3]-r[1]*r[2];var r;!function(t,e){if(!t)throw new Error(e)}(0!==n,"Transformation matrix cannot be inverted");const x=e[0],o=e[1],i=e[2],u=e[3],f=e[4],s=e[5];return t[0]=u/n,t[1]=-o/n,t[2]=-i/n,t[3]=x/n,t[4]=(i*s-u*f)/n,t[5]=-(x*s-o*f)/n,t}new Array(6);const F=[],P={vertexPosition:0,indexPosition:0};function B(t,e,n,r,x){t[e+0]=n,t[e+1]=r,t[e+2]=x}function N(t,e,n,r,x,o){const i=3+x,u=t[e+0],f=t[e+1],s=F;s.length=x;for(let n=0;n<s.length;n++)s[n]=t[e+2+n];let l=o?o.vertexPosition:0,c=o?o.indexPosition:0;const a=l/i;return B(n,l,u,f,0),s.length&&n.set(s,l+3),l+=i,B(n,l,u,f,1),s.length&&n.set(s,l+3),l+=i,B(n,l,u,f,2),s.length&&n.set(s,l+3),l+=i,B(n,l,u,f,3),s.length&&n.set(s,l+3),l+=i,r[c++]=a,r[c++]=a+1,r[c++]=a+3,r[c++]=a+1,r[c++]=a+2,r[c++]=a+3,P.vertexPosition=l,P.indexPosition=c,P}function R(t,e,n,r,x,o,i,u,f,s,l){const c=10+u.length,a=o.length/c,h=[t[e+0],t[e+1]],y=[t[n],t[n+1]],p=t[e+2],v=t[n+2],g=I(f,[...h]),b=I(f,[...y]);function M(t,e,n){const r=Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])),x=[(e[0]-t[0])/r,(e[1]-t[1])/r],o=[-x[1],x[0]],i=Math.sqrt((n[0]-t[0])*(n[0]-t[0])+(n[1]-t[1])*(n[1]-t[1])),u=[(n[0]-t[0])/i,(n[1]-t[1])/i],f=0===r||0===i?0:Math.acos((s=u[0]*x[0]+u[1]*x[1],l=-1,c=1,Math.min(Math.max(s,l),c)));var s,l,c;return u[0]*o[0]+u[1]*o[1]>0?f:2*Math.PI-f}let m=-1,Z=-1,d=l;const w=null!==x;if(null!==r){m=M(g,b,I(f,[...[t[r],t[r+1]]])),Math.cos(m)<=.985&&(d+=Math.tan((m-Math.PI)/2))}if(w){Z=M(b,g,I(f,[...[t[x],t[x+1]]])),Math.cos(Z)<=.985&&(d+=Math.tan((Math.PI-Z)/2))}function A(t,e){return 0===e?1e4*t:Math.sign(e)*(1e4*t+Math.abs(e))}return o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(0,l)),o.push(...u),o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(1,l)),o.push(...u),o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(2,l)),o.push(...u),o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(3,l)),o.push(...u),i.push(a,a+1,a+2,a+1,a+3,a+2),{length:s+Math.sqrt((b[0]-g[0])*(b[0]-g[0])+(b[1]-g[1])*(b[1]-g[1])),angle:d}}function S(e,n,r,x,o){const i=2+o;let u=n;const f=e.slice(u,u+o);u+=o;const s=e[u++];let l=0;const c=new Array(s-1);for(let t=0;t<s;t++)l+=e[u++],t<s-1&&(c[t]=l);const a=e.slice(u,u+2*l),h=t(a,c,2);for(let t=0;t<h.length;t++)x.push(h[t]+r.length/i);for(let t=0;t<a.length;t+=2)r.push(a[t],a[t+1],...f);return u+2*l}const T="GENERATE_POLYGON_BUFFERS",_="GENERATE_POINT_BUFFERS",O="GENERATE_LINE_STRING_BUFFERS",U=self;U.onmessage=t=>{const e=t.data;switch(e.type){case _:{const t=3,n=2,r=e.customAttributesSize,x=n+r,o=new Float32Array(e.renderInstructions),i=o.length/x,u=4*i*(r+t),f=new Uint32Array(6*i),s=new Float32Array(u);let l;for(let t=0;t<o.length;t+=x)l=N(o,t,s,f,r,l);const c=Object.assign({vertexBuffer:s.buffer,indexBuffer:f.buffer,renderInstructions:o.buffer},e);U.postMessage(c,[s.buffer,f.buffer,o.buffer]);break}case O:{const t=[],n=[],r=e.customAttributesSize,x=3,o=new Float32Array(e.renderInstructions);let i=0;const u=[1,0,0,1,0,0];let f,s;for(z(u,e.renderInstructionsTransform);i<o.length;){s=Array.from(o.slice(i,i+r)),i+=r,f=o[i++];const e=i,l=i+(f-1)*x,c=o[e]===o[l]&&o[e+1]===o[l+1];let a=0,h=0;for(let r=0;r<f-1;r++){let y=null;r>0?y=i+(r-1)*x:c&&(y=l-x);let p=null;r<f-2?p=i+(r+2)*x:c&&(p=e+x);const v=R(o,i+r*x,i+(r+1)*x,y,p,t,n,s,u,a,h);a=v.length,h=v.angle}i+=f*x}const l=Uint32Array.from(n),c=Float32Array.from(t),a=Object.assign({vertexBuffer:c.buffer,indexBuffer:l.buffer,renderInstructions:o.buffer},e);U.postMessage(a,[c.buffer,l.buffer,o.buffer]);break}case T:{const t=[],n=[],r=e.customAttributesSize,x=new Float32Array(e.renderInstructions);let o=0;for(;o<x.length;)o=S(x,o,t,n,r);const i=Uint32Array.from(n),u=Float32Array.from(t),f=Object.assign({vertexBuffer:u.buffer,indexBuffer:i.buffer,renderInstructions:x.buffer},e);U.postMessage(f,[u.buffer,i.buffer,x.buffer]);break}}};';return new Worker(typeof Blob>"u"?"data:application/javascript;base64,"+Buffer.from(n,"binary").toString("base64"):URL.createObjectURL(new Blob([n],{type:"application/javascript"})))}const an={GENERATE_POLYGON_BUFFERS:"GENERATE_POLYGON_BUFFERS",GENERATE_POINT_BUFFERS:"GENERATE_POINT_BUFFERS",GENERATE_LINE_STRING_BUFFERS:"GENERATE_LINE_STRING_BUFFERS"};function Hu(n,e){e=e||[];const t=256,r=t-1;return e[0]=Math.floor(n/t/t/t)/r,e[1]=Math.floor(n/t/t)%t/r,e[2]=Math.floor(n/t)%t/r,e[3]=n%t/r,e}function Wu(n){let e=0;const t=256,r=t-1;return e+=Math.round(n[0]*t*t*t*r),e+=Math.round(n[1]*t*t*r),e+=Math.round(n[2]*t*r),e+=Math.round(n[3]*r),e}function Po(n,e,t,r){let i=0;for(const s in e){const o=e[s],a=o.callback.call(t,t.feature);let l=(a==null?void 0:a[0])??a;l===Ps&&console.warn('The "has" operator might return false positives.'),l===void 0?l=Ps:l===null&&(l=0),n[r+i++]=l,!(!o.size||o.size===1)&&(n[r+i++]=a[1],!(o.size<3)&&(n[r+i++]=a[2],!(o.size<4)&&(n[r+i++]=a[3])))}return i}function $i(n){return Object.keys(n).reduce((e,t)=>e+(n[t].size||1),0)}function A_(n,e,t,r){const i=(2+$i(t))*n.geometriesCount;(!e||e.length!==i)&&(e=new Float32Array(i));const s=[];let o=0;for(const a in n.entries){const l=n.entries[a];for(let u=0,f=l.flatCoordss.length;u<f;u++)s[0]=l.flatCoordss[u][0],s[1]=l.flatCoordss[u][1],kt(r,s),e[o++]=s[0],e[o++]=s[1],o+=Po(e,t,l,o)}return e}function P_(n,e,t,r){const i=3*n.verticesCount+(1+$i(t))*n.geometriesCount;(!e||e.length!==i)&&(e=new Float32Array(i));const s=[];let o=0;for(const a in n.entries){const l=n.entries[a];for(let u=0,f=l.flatCoordss.length;u<f;u++){s.length=l.flatCoordss[u].length,Jl(l.flatCoordss[u],0,s.length,3,r,s,3),o+=Po(e,t,l,o),e[o++]=s.length/3;for(let c=0,d=s.length;c<d;c+=3)e[o++]=s[c],e[o++]=s[c+1],e[o++]=s[c+2]}}return e}function L_(n,e,t,r){const i=2*n.verticesCount+(1+$i(t))*n.geometriesCount+n.ringsCount;(!e||e.length!==i)&&(e=new Float32Array(i));const s=[];let o=0;for(const a in n.entries){const l=n.entries[a];for(let u=0,f=l.flatCoordss.length;u<f;u++){s.length=l.flatCoordss[u].length,Jl(l.flatCoordss[u],0,s.length,2,r,s),o+=Po(e,t,l,o),e[o++]=l.ringsVerticesCounts[u].length;for(let c=0,d=l.ringsVerticesCounts[u].length;c<d;c++)e[o++]=l.ringsVerticesCounts[u][c];for(let c=0,d=s.length;c<d;c+=2)e[o++]=s[c],e[o++]=s[c+1]}}return e}function _i(n){return(JSON.stringify(n).split("").reduce((t,r)=>(t<<5)-t+r.charCodeAt(0),0)>>>0).toString()}function Lo(n,e,t,r){if(`${r}radius`in n&&r!=="icon-"){let i=J(t,n[`${r}radius`],ge);if(`${r}radius2`in n){const s=J(t,n[`${r}radius2`],ge);i=`max(${i}, ${s})`}`${r}stroke-width`in n&&(i=`(${i} + ${J(t,n[`${r}stroke-width`],ge)} * 0.5)`),e.setSymbolSizeExpression(`vec2(${i} * 2. + 0.5)`)}if(`${r}scale`in n){const i=J(t,n[`${r}scale`],pr);e.setSymbolSizeExpression(`${e.getSymbolSizeExpression()} * ${i}`)}`${r}displacement`in n&&e.setSymbolOffsetExpression(J(t,n[`${r}displacement`],hr)),`${r}rotation`in n&&e.setSymbolRotationExpression(J(t,n[`${r}rotation`],ge)),`${r}rotate-with-view`in n&&e.setSymbolRotateWithView(!!n[`${r}rotate-with-view`])}function Zu(n,e,t,r,i){let s="vec4(0.)";if(e!==null&&(s=e),t!==null&&r!==null){const l=`smoothstep(-${r} + 0.63, -${r} - 0.58, ${n})`;s=`mix(${t}, ${s}, ${l})`}const o=`(1.0 - smoothstep(-0.63, 0.58, ${n}))`;let a=`${s} * vec4(1.0, 1.0, 1.0, ${o})`;return i!==null&&(a=`${a} * vec4(1.0, 1.0, 1.0, ${i})`),a}function Io(n,e,t,r,i){const s=new Image;s.crossOrigin=n[`${r}cross-origin`]===void 0?"anonymous":n[`${r}cross-origin`],dt(typeof n[`${r}src`]=="string",`WebGL layers do not support expressions for the ${r}src style property`),s.src=n[`${r}src`],t[`u_texture${i}_size`]=()=>s.complete?[s.width,s.height]:[0,0],e.addUniform(`u_texture${i}_size`,"vec2");const o=`u_texture${i}_size`;return t[`u_texture${i}`]=s,e.addUniform(`u_texture${i}`,"sampler2D"),o}function Co(n,e,t,r,i){let s=J(t,n[`${e}offset`],pr);if(`${e}offset-origin`in n)switch(n[`${e}offset-origin`]){case"top-right":s=`vec2(${r}.x, 0.) + ${i} * vec2(-1., 0.) + ${s} * vec2(-1., 1.)`;break;case"bottom-left":s=`vec2(0., ${r}.y) + ${i} * vec2(0., -1.) + ${s} * vec2(1., -1.)`;break;case"bottom-right":s=`${r} - ${i} - ${s}`;break}return s}function I_(n,e,t,r){r.functions.circleDistanceField=`float circleDistanceField(vec2 point, float radius) {
  return length(point) - radius;
}`,Lo(n,e,r,"circle-");let i=null;"circle-opacity"in n&&(i=J(r,n["circle-opacity"],ge));let s="coordsPx";"circle-scale"in n&&(s=`coordsPx / ${J(r,n["circle-scale"],pr)}`);let o=null;"circle-fill-color"in n&&(o=J(r,n["circle-fill-color"],tt));let a=null;"circle-stroke-color"in n&&(a=J(r,n["circle-stroke-color"],tt));let l=J(r,n["circle-radius"],ge),u=null;"circle-stroke-width"in n&&(u=J(r,n["circle-stroke-width"],ge),l=`(${l} + ${u} * 0.5)`);const f=`circleDistanceField(${s}, ${l})`,c=Zu(f,o,a,u,i);e.setSymbolColorExpression(c)}function C_(n,e,t,r){r.functions.round=`float round(float v) {
  return sign(v) * floor(abs(v) + 0.5);
}`,r.functions.starDistanceField=`float starDistanceField(vec2 point, float numPoints, float radius, float radius2, float angle) {
  float startAngle = -PI * 0.5 + angle; // tip starts upwards and rotates clockwise with angle
  float c = cos(startAngle);
  float s = sin(startAngle);
  vec2 pointRotated = vec2(c * point.x - s * point.y, s * point.x + c * point.y);
  float alpha = TWO_PI / numPoints; // the angle of one sector
  float beta = atan(pointRotated.y, pointRotated.x);
  float gamma = round(beta / alpha) * alpha; // angle in sector
  c = cos(-gamma);
  s = sin(-gamma);
  vec2 inSector = vec2(c * pointRotated.x - s * pointRotated.y, abs(s * pointRotated.x + c * pointRotated.y));
  vec2 tipToPoint = inSector + vec2(-radius, 0.);
  vec2 edgeNormal = vec2(radius2 * sin(alpha * 0.5), -radius2 * cos(alpha * 0.5) + radius);
  return dot(normalize(edgeNormal), tipToPoint);
}`,r.functions.regularDistanceField=`float regularDistanceField(vec2 point, float numPoints, float radius, float angle) {
  float startAngle = -PI * 0.5 + angle; // tip starts upwards and rotates clockwise with angle
  float c = cos(startAngle);
  float s = sin(startAngle);
  vec2 pointRotated = vec2(c * point.x - s * point.y, s * point.x + c * point.y);
  float alpha = TWO_PI / numPoints; // the angle of one sector
  float radiusIn = radius * cos(PI / numPoints);
  float beta = atan(pointRotated.y, pointRotated.x);
  float gamma = round((beta - alpha * 0.5) / alpha) * alpha + alpha * 0.5; // angle in sector from mid
  c = cos(-gamma);
  s = sin(-gamma);
  vec2 inSector = vec2(c * pointRotated.x - s * pointRotated.y, abs(s * pointRotated.x + c * pointRotated.y));
  return inSector.x - radiusIn;
}`,Lo(n,e,r,"shape-");let i=null;"shape-opacity"in n&&(i=J(r,n["shape-opacity"],ge));let s="coordsPx";"shape-scale"in n&&(s=`coordsPx / ${J(r,n["shape-scale"],pr)}`);let o=null;"shape-fill-color"in n&&(o=J(r,n["shape-fill-color"],tt));let a=null;"shape-stroke-color"in n&&(a=J(r,n["shape-stroke-color"],tt));let l=null;"shape-stroke-width"in n&&(l=J(r,n["shape-stroke-width"],ge));const u=J(r,n["shape-points"],ge);let f="0.";"shape-angle"in n&&(f=J(r,n["shape-angle"],ge));let c,d=J(r,n["shape-radius"],ge);if(l!==null&&(d=`${d} + ${l} * 0.5`),"shape-radius2"in n){let p=J(r,n["shape-radius2"],ge);l!==null&&(p=`${p} + ${l} * 0.5`),c=`starDistanceField(${s}, ${u}, ${d}, ${p}, ${f})`}else c=`regularDistanceField(${s}, ${u}, ${d}, ${f})`;const g=Zu(c,o,a,l,i);e.setSymbolColorExpression(g)}function F_(n,e,t,r){let i="vec4(1.0)";"icon-color"in n&&(i=J(r,n["icon-color"],tt)),"icon-opacity"in n&&(i=`${i} * vec4(1.0, 1.0, 1.0, ${J(r,n["icon-opacity"],ge)})`);const s=_i(n["icon-src"]),o=Io(n,e,t,"icon-",s);if(e.setSymbolColorExpression(`${i} * texture2D(u_texture${s}, v_texCoord)`).setSymbolSizeExpression(o),"icon-width"in n&&"icon-height"in n&&e.setSymbolSizeExpression(`vec2(${J(r,n["icon-width"],ge)}, ${J(r,n["icon-height"],ge)})`),"icon-offset"in n&&"icon-size"in n){const a=J(r,n["icon-size"],hr),l=e.getSymbolSizeExpression();e.setSymbolSizeExpression(a);const u=Co(n,"icon-",r,"v_quadSizePx",a);e.setTextureCoordinateExpression(`(vec4((${u}).xyxy) + vec4(0., 0., ${a})) / (${l}).xyxy`)}if(Lo(n,e,r,"icon-"),"icon-anchor"in n){const a=J(r,n["icon-anchor"],hr);let l="1.0";"icon-scale"in n&&(l=J(r,n["icon-scale"],pr));let u;n["icon-anchor-x-units"]==="pixels"&&n["icon-anchor-y-units"]==="pixels"?u=`${a} * ${l}`:n["icon-anchor-x-units"]==="pixels"?u=`${a} * vec2(vec2(${l}).x, v_quadSizePx.y)`:n["icon-anchor-y-units"]==="pixels"?u=`${a} * vec2(v_quadSizePx.x, vec2(${l}).x)`:u=`${a} * v_quadSizePx`;let f=`v_quadSizePx * vec2(0.5, -0.5) + ${u} * vec2(-1., 1.)`;if("icon-anchor-origin"in n)switch(n["icon-anchor-origin"]){case"top-right":f=`v_quadSizePx * -0.5 + ${u}`;break;case"bottom-left":f=`v_quadSizePx * 0.5 - ${u}`;break;case"bottom-right":f=`v_quadSizePx * vec2(-0.5, 0.5) + ${u} * vec2(1., -1.)`;break}e.setSymbolOffsetExpression(`${e.getSymbolOffsetExpression()} + ${f}`)}}function O_(n,e,t,r){if("stroke-color"in n&&e.setStrokeColorExpression(J(r,n["stroke-color"],tt)),"stroke-pattern-src"in n){const i=_i(n["stroke-pattern-src"]),s=Io(n,e,t,"stroke-pattern-",i);let o=s,a="vec2(0.)";"stroke-pattern-offset"in n&&"stroke-pattern-size"in n&&(o=J(r,n["stroke-pattern-size"],hr),a=Co(n,"stroke-pattern-",r,s,o));let l="0.";"stroke-pattern-spacing"in n&&(l=J(r,n["stroke-pattern-spacing"],ge)),r.functions.sampleStrokePattern=`vec4 sampleStrokePattern(sampler2D texture, vec2 textureSize, vec2 textureOffset, vec2 sampleSize, float spacingPx, float currentLengthPx, float currentRadiusRatio, float lineWidth) {
  float currentLengthScaled = currentLengthPx * sampleSize.y / lineWidth;
  float spacingScaled = spacingPx * sampleSize.y / lineWidth;
  float uCoordPx = mod(currentLengthScaled, (sampleSize.x + spacingScaled));
  // make sure that we're not sampling too close to the borders to avoid interpolation with outside pixels
  uCoordPx = clamp(uCoordPx, 0.5, sampleSize.x - 0.5);
  float vCoordPx = (-currentRadiusRatio * 0.5 + 0.5) * sampleSize.y;
  vec2 texCoord = (vec2(uCoordPx, vCoordPx) + textureOffset) / textureSize;
  return texture2D(texture, texCoord);
}`;const u=`u_texture${i}`;let f="1.";"stroke-color"in n&&(f=e.getStrokeColorExpression()),e.setStrokeColorExpression(`${f} * sampleStrokePattern(${u}, ${s}, ${a}, ${o}, ${l}, currentLengthPx, currentRadiusRatio, v_width)`)}if("stroke-width"in n&&e.setStrokeWidthExpression(J(r,n["stroke-width"],ge)),"stroke-offset"in n&&e.setStrokeOffsetExpression(J(r,n["stroke-offset"],ge)),"stroke-line-cap"in n&&e.setStrokeCapExpression(J(r,n["stroke-line-cap"],gn)),"stroke-line-join"in n&&e.setStrokeJoinExpression(J(r,n["stroke-line-join"],gn)),"stroke-miter-limit"in n&&e.setStrokeMiterLimitExpression(J(r,n["stroke-miter-limit"],ge)),"stroke-line-dash"in n){r.functions.getSingleDashDistance=`float getSingleDashDistance(float distance, float radius, float dashOffset, float dashLength, float dashLengthTotal, float capType, float lineWidth) {
  float localDistance = mod(distance, dashLengthTotal);
  float distanceSegment = abs(localDistance - dashOffset - dashLength * 0.5) - dashLength * 0.5;
  distanceSegment = min(distanceSegment, dashLengthTotal - localDistance);
  if (capType == ${Nt("square")}) {
    distanceSegment -= lineWidth * 0.5;
  } else if (capType == ${Nt("round")}) {
    distanceSegment = min(distanceSegment, sqrt(distanceSegment * distanceSegment + radius * radius) - lineWidth * 0.5);
  }
  return distanceSegment;
}`;let i=n["stroke-line-dash"].map(g=>J(r,g,ge));i.length%2===1&&(i=[...i,...i]);let s="0.";"stroke-line-dash-offset"in n&&(s=J(r,n["stroke-line-dash-offset"],ge));const a=`dashDistanceField_${_i(n["stroke-line-dash"])}`,l=i.map((g,p)=>`float dashLength${p}`).join(", "),u=i.map((g,p)=>`dashLength${p}`).join(" + ");let f="0.",c=`getSingleDashDistance(distance, radius, ${f}, dashLength0, totalDashLength, capType, lineWidth)`;for(let g=2;g<i.length;g+=2)f=`${f} + dashLength${g-2} + dashLength${g-1}`,c=`min(${c}, getSingleDashDistance(distance, radius, ${f}, dashLength${g}, totalDashLength, capType, lineWidth))`;r.functions[a]=`float ${a}(float distance, float radius, float capType, float lineWidth, ${l}) {
  float totalDashLength = ${u};
  return ${c};
}`;const d=i.map((g,p)=>`${g}`).join(", ");e.setStrokeDistanceFieldExpression(`${a}(currentLengthPx + ${s}, currentRadiusPx, capType, v_width, ${d})`)}}function M_(n,e,t,r){if("fill-color"in n&&e.setFillColorExpression(J(r,n["fill-color"],tt)),"fill-pattern-src"in n){const i=_i(n["fill-pattern-src"]),s=Io(n,e,t,"fill-pattern-",i);let o=s,a="vec2(0.)";"fill-pattern-offset"in n&&"fill-pattern-size"in n&&(o=J(r,n["fill-pattern-size"],hr),a=Co(n,"fill-pattern-",r,s,o)),r.functions.sampleFillPattern=`vec4 sampleFillPattern(sampler2D texture, vec2 textureSize, vec2 textureOffset, vec2 sampleSize, vec2 pxOrigin, vec2 pxPosition) {
  float scaleRatio = pow(2., mod(u_zoom + 0.5, 1.) - 0.5);
  vec2 pxRelativePos = pxPosition - pxOrigin;
  // rotate the relative position from origin by the current view rotation
  pxRelativePos = vec2(pxRelativePos.x * cos(u_rotation) - pxRelativePos.y * sin(u_rotation), pxRelativePos.x * sin(u_rotation) + pxRelativePos.y * cos(u_rotation));
  // sample position is computed according to the sample offset & size
  vec2 samplePos = mod(pxRelativePos / scaleRatio, sampleSize);
  // also make sure that we're not sampling too close to the borders to avoid interpolation with outside pixels
  samplePos = clamp(samplePos, vec2(0.5), sampleSize - vec2(0.5));
  samplePos.y = sampleSize.y - samplePos.y; // invert y axis so that images appear upright
  return texture2D(texture, (samplePos + textureOffset) / textureSize);
}`;const l=`u_texture${i}`;let u="1.";"fill-color"in n&&(u=e.getFillColorExpression()),e.setFillColorExpression(`${u} * sampleFillPattern(${l}, ${s}, ${a}, ${o}, pxOrigin, pxPos)`)}}function Yu(n,e,t){const r=So(),i=new zu,s={};if("icon-src"in n?F_(n,i,s,r):"shape-points"in n?C_(n,i,s,r):"circle-radius"in n&&I_(n,i,s,r),O_(n,i,s,r),M_(n,i,s,r),t){const l=J(r,t,Fi);i.setFragmentDiscardExpression(`!${l}`)}const o={};function a(l,u,f,c){if(!r[l])return;const d=Ls(f),g=Ao(f);i.addAttribute(`a_${u}`,d),o[u]={size:g,callback:c}}return a("geometryType",ku,gn,l=>Dr(eu(l.getGeometry()))),a("featureId",Gu,gn|ge,l=>{const u=l.getId()??null;return typeof u=="string"?Dr(u):u}),$u(i,r),{builder:i,attributes:{...o,...ju(r)},uniforms:{...s,...Vu(r,e)}}}function N_(n){const e=Array.isArray(n)?n:[n];if("style"in e[0]){const t=[],r=e,i=[];for(const s of r){const o=Array.isArray(s.style)?s.style:[s.style];let a=s.filter;s.else&&i.length&&(a=["all",...i.map(u=>["!",u])],s.filter&&a.push(s.filter),a.length<3&&(a=a[1])),s.filter&&i.push(s.filter);const l=o.map(u=>({style:u,...a&&{filter:a}}));t.push(...l)}return t}return"builder"in e[0]?e:e.map(t=>({style:t}))}const D_=[];let ts;function U_(){return ts||(ts=Xu()),ts}let B_=0;const Et={POSITION:"a_position",INDEX:"a_index",SEGMENT_START:"a_segmentStart",SEGMENT_END:"a_segmentEnd",MEASURE_START:"a_measureStart",MEASURE_END:"a_measureEnd",PARAMETERS:"a_parameters",JOIN_ANGLES:"a_joinAngles",DISTANCE:"a_distance"};class G_{constructor(e,t,r,i,s){this.helper_,this.hitDetectionEnabled_=!!i;let o=e;if(!("builder"in e)){const f=e,c=Yu(f.style,t,f.filter);o={builder:c.builder,attributes:c.attributes,uniforms:c.uniforms}}this.fillProgram_,this.strokeProgram_,this.symbolProgram_,this.hasFill_=!!o.builder.getFillVertexShader(),this.hasFill_&&(this.fillVertexShader_=o.builder.getFillVertexShader(),this.fillFragmentShader_=o.builder.getFillFragmentShader()),this.hasStroke_=!!o.builder.getStrokeVertexShader(),this.hasStroke_&&(this.strokeVertexShader_=o.builder.getStrokeVertexShader(),this.strokeFragmentShader_=o.builder.getStrokeFragmentShader()),this.hasSymbol_=!!o.builder.getSymbolVertexShader(),this.hasSymbol_&&(this.symbolVertexShader_=o.builder.getSymbolVertexShader(),this.symbolFragmentShader_=o.builder.getSymbolFragmentShader()),this.featureFilter_=null,s&&(this.featureFilter_=this.computeFeatureFilter(s));const l=this.hitDetectionEnabled_?{hitColor:{callback(){return Hu(this.ref,D_)},size:4}}:{};this.customAttributes_=Object.assign({},l,o.attributes),this.uniforms_=o.uniforms;const u=Object.entries(this.customAttributes_).map(([f,c])=>({name:`a_${f}`,size:c.size||1,type:Fe.FLOAT}));this.polygonAttributesDesc_=[{name:Et.POSITION,size:2,type:Fe.FLOAT},...u],this.lineStringAttributesDesc_=[{name:Et.SEGMENT_START,size:2,type:Fe.FLOAT},{name:Et.MEASURE_START,size:1,type:Fe.FLOAT},{name:Et.SEGMENT_END,size:2,type:Fe.FLOAT},{name:Et.MEASURE_END,size:1,type:Fe.FLOAT},{name:Et.JOIN_ANGLES,size:2,type:Fe.FLOAT},{name:Et.DISTANCE,size:1,type:Fe.FLOAT},{name:Et.PARAMETERS,size:1,type:Fe.FLOAT},...u],this.pointAttributesDesc_=[{name:Et.POSITION,size:2,type:Fe.FLOAT},{name:Et.INDEX,size:1,type:Fe.FLOAT},...u],this.setHelper(r)}computeFeatureFilter(e){const t=Ql();let r;try{r=nf(e,Fi,t)}catch{return null}if(t.mapState||t.variables.size>0)return null;const i=sf();return s=>{if(i.properties=s.getPropertiesInternal(),t.featureId){const o=s.getId();o!==void 0?i.featureId=o:i.featureId=null}return i.geometryType=eu(s.getGeometry()),r(i)}}async generateBuffers(e,t){let r=e;if(this.featureFilter_&&(r=r.filter(this.featureFilter_),r.isEmpty()))return null;const i=this.generateRenderInstructions_(r,t),[s,o,a]=await Promise.all([this.generateBuffersForType_(i.polygonInstructions,"Polygon",t),this.generateBuffersForType_(i.lineStringInstructions,"LineString",t),this.generateBuffersForType_(i.pointInstructions,"Point",t)]),l=mn($e(),t);return{polygonBuffers:s,lineStringBuffers:o,pointBuffers:a,invertVerticesTransform:l}}generateRenderInstructions_(e,t){const r=this.hasFill_?L_(e.polygonBatch,new Float32Array(0),this.customAttributes_,t):null,i=this.hasStroke_?P_(e.lineStringBatch,new Float32Array(0),this.customAttributes_,t):null,s=this.hasSymbol_?A_(e.pointBatch,new Float32Array(0),this.customAttributes_,t):null;return{polygonInstructions:r,lineStringInstructions:i,pointInstructions:s}}generateBuffersForType_(e,t,r){if(e===null)return null;const i=B_++;let s;switch(t){case"Polygon":s=an.GENERATE_POLYGON_BUFFERS;break;case"LineString":s=an.GENERATE_LINE_STRING_BUFFERS;break;case"Point":s=an.GENERATE_POINT_BUFFERS;break}const o={id:i,type:s,renderInstructions:e.buffer,renderInstructionsTransform:r,customAttributesSize:$i(this.customAttributes_)},a=U_();return a.postMessage(o,[e.buffer]),e=null,new Promise(l=>{const u=f=>{const c=f.data;if(c.id!==i||(a.removeEventListener("message",u),!this.helper_.getGL()))return;const d=new Nr(Pn,pi).fromArrayBuffer(c.vertexBuffer),g=new Nr(Ln,pi).fromArrayBuffer(c.indexBuffer);this.helper_.flushBufferData(d),this.helper_.flushBufferData(g),l([g,d])};a.addEventListener("message",u)})}render(e,t,r){this.hasFill_&&this.renderInternal_(e.polygonBuffers[0],e.polygonBuffers[1],this.fillProgram_,this.polygonAttributesDesc_,t,r),this.hasStroke_&&this.renderInternal_(e.lineStringBuffers[0],e.lineStringBuffers[1],this.strokeProgram_,this.lineStringAttributesDesc_,t,r),this.hasSymbol_&&this.renderInternal_(e.pointBuffers[0],e.pointBuffers[1],this.symbolProgram_,this.pointAttributesDesc_,t,r)}renderInternal_(e,t,r,i,s,o){const a=e.getSize();a!==0&&(this.helper_.useProgram(r,s),this.helper_.bindBuffer(t),this.helper_.bindBuffer(e),this.helper_.enableAttributes(i),o(),this.helper_.drawElements(0,a))}setHelper(e,t=null){this.helper_=e,this.hasFill_&&(this.fillProgram_=this.helper_.getProgram(this.fillFragmentShader_,this.fillVertexShader_)),this.hasStroke_&&(this.strokeProgram_=this.helper_.getProgram(this.strokeFragmentShader_,this.strokeVertexShader_)),this.hasSymbol_&&(this.symbolProgram_=this.helper_.getProgram(this.symbolFragmentShader_,this.symbolVertexShader_)),this.helper_.addUniforms(this.uniforms_),t&&(t.polygonBuffers&&(this.helper_.flushBufferData(t.polygonBuffers[0]),this.helper_.flushBufferData(t.polygonBuffers[1])),t.lineStringBuffers&&(this.helper_.flushBufferData(t.lineStringBuffers[0]),this.helper_.flushBufferData(t.lineStringBuffers[1])),t.pointBuffers&&(this.helper_.flushBufferData(t.pointBuffers[0]),this.helper_.flushBufferData(t.pointBuffers[1])))}}const bt=new Uint8Array(4);class qu{constructor(e,t){this.helper_=e;const r=e.getGL();this.texture_=r.createTexture(),this.framebuffer_=r.createFramebuffer(),this.depthbuffer_=r.createRenderbuffer(),this.size_=t||[1,1],this.data_=new Uint8Array(0),this.dataCacheDirty_=!0,this.updateSize_()}setSize(e){of(e,this.size_)||(this.size_[0]=e[0],this.size_[1]=e[1],this.updateSize_())}getSize(){return this.size_}clearCachedData(){this.dataCacheDirty_=!0}readAll(){if(this.dataCacheDirty_){const e=this.size_,t=this.helper_.getGL();t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer_),t.readPixels(0,0,e[0],e[1],t.RGBA,t.UNSIGNED_BYTE,this.data_),this.dataCacheDirty_=!1}return this.data_}readPixel(e,t){if(e<0||t<0||e>this.size_[0]||t>=this.size_[1])return bt[0]=0,bt[1]=0,bt[2]=0,bt[3]=0,bt;this.readAll();const r=Math.floor(e)+(this.size_[1]-Math.floor(t)-1)*this.size_[0];return bt[0]=this.data_[r*4],bt[1]=this.data_[r*4+1],bt[2]=this.data_[r*4+2],bt[3]=this.data_[r*4+3],bt}getTexture(){return this.texture_}getFramebuffer(){return this.framebuffer_}getDepthbuffer(){return this.depthbuffer_}updateSize_(){const e=this.size_,t=this.helper_.getGL();this.texture_=this.helper_.createTexture(e,null,this.texture_),t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer_),t.viewport(0,0,e[0],e[1]),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture_,0),t.bindRenderbuffer(t.RENDERBUFFER,this.depthbuffer_),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e[0],e[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthbuffer_),this.data_=new Uint8Array(e[0]*e[1]*4)}}function Ku(n,e){const t=n.viewState.projection,i=e.getSource().getWrapX()&&t.canWrapX(),s=t.getExtent(),o=n.extent,a=i?Ve(s):null,l=i?Math.ceil((o[2]-s[2])/a)+1:1;return[i?Math.floor((o[0]-s[0])/a):0,l,a]}const br={...St,RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",GLOBAL_ALPHA:"u_globalAlpha"};class Qu extends In{constructor(e,t){const r={[br.RENDER_EXTENT]:[0,0,0,0],[br.PATTERN_ORIGIN]:[0,0],[br.GLOBAL_ALPHA]:1};super(e,{uniforms:r,postProcesses:t.postProcesses}),this.hitDetectionEnabled_=!t.disableHitDetection,this.hitRenderTarget_,this.sourceRevision_=-1,this.previousExtent_=vn(),this.currentTransform_=$e(),this.tmpCoords_=[0,0],this.tmpTransform_=$e(),this.tmpMat4_=yr(),this.currentFrameStateTransform_=$e(),this.styleVariables_={},this.styles_=[],this.styleRenderers_=[],this.buffers_=[],this.applyOptions_(t),this.batch_=new mi,this.initialFeaturesAdded_=!1,this.sourceListenKeys_=null}addInitialFeatures_(e){const t=this.getLayer().getSource();let r;this.batch_.addFeatures(t.getFeatures(),r),this.sourceListenKeys_=[Ut(t,Wt.ADDFEATURE,this.handleSourceFeatureAdded_.bind(this,r)),Ut(t,Wt.CHANGEFEATURE,this.handleSourceFeatureChanged_.bind(this,r),this),Ut(t,Wt.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),Ut(t,Wt.CLEAR,this.handleSourceFeatureClear_,this)]}applyOptions_(e){this.styleVariables_=e.variables,this.styles_=N_(e.style)}createRenderers_(){this.buffers_=[],this.styleRenderers_=this.styles_.map(e=>new G_(e,this.styleVariables_,this.helper,this.hitDetectionEnabled_,"filter"in e?e.filter:null))}reset(e){this.applyOptions_(e),this.helper&&this.createRenderers_(),super.reset(e)}afterHelperCreated(){this.styleRenderers_.length?this.styleRenderers_.forEach((e,t)=>e.setHelper(this.helper,this.buffers_[t])):this.createRenderers_(),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new qu(this.helper))}handleSourceFeatureAdded_(e,t){const r=t.feature;this.batch_.addFeature(r,e)}handleSourceFeatureChanged_(e,t){const r=t.feature;this.batch_.changeFeature(r,e)}handleSourceFeatureDelete_(e){const t=e.feature;this.batch_.removeFeature(t)}handleSourceFeatureClear_(){this.batch_.clear()}applyUniforms_(e){af(this.tmpTransform_,this.currentFrameStateTransform_),dn(this.tmpTransform_,e),this.helper.setUniformMatrixValue(br.PROJECTION_MATRIX,di(this.tmpMat4_,this.tmpTransform_)),mn(this.tmpTransform_,this.tmpTransform_),this.helper.setUniformMatrixValue(br.SCREEN_TO_WORLD_MATRIX,di(this.tmpMat4_,this.tmpTransform_)),this.tmpCoords_[0]=0,this.tmpCoords_[1]=0,mn(this.tmpTransform_,e),kt(this.tmpTransform_,this.tmpCoords_),this.helper.setUniformFloatVec2(br.PATTERN_ORIGIN,this.tmpCoords_)}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[r,i,s]=Ku(e,this.getLayer());this.helper.prepareDraw(e),this.renderWorlds(e,!1,r,i,s),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const o=this.helper.getCanvas();return this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,r,i,s),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),o}prepareFrameInternal(e){this.initialFeaturesAdded_||(this.addInitialFeatures_(e),this.initialFeaturesAdded_=!0);const t=this.getLayer(),r=t.getSource(),i=e.viewState,s=!e.viewHints[Jt.ANIMATING]&&!e.viewHints[Jt.INTERACTING],o=!pn(this.previousExtent_,e.extent),a=this.sourceRevision_<r.getRevision();if(a&&(this.sourceRevision_=r.getRevision()),s&&(o||a)){const l=i.projection,u=i.resolution,f=t instanceof Oi?t.getRenderBuffer():0,c=eo(e.extent,f*u);r.loadFeatures(c,u,l),this.ready=!1;const d=this.helper.makeProjectionTransform(e,$e()),g=this.styleRenderers_.map((p,_)=>p.generateBuffers(this.batch_,d).then(x=>{this.buffers_[_]&&this.disposeBuffers(this.buffers_[_]),this.buffers_[_]=x}));Promise.all(g).then(()=>{this.ready=!0,this.getLayer().changed()}),this.previousExtent_=e.extent.slice()}return!0}renderWorlds(e,t,r,i,s){let o=r;t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0));do{this.helper.makeProjectionTransform(e,this.currentFrameStateTransform_),Js(this.currentFrameStateTransform_,o*s,0);for(let a=0,l=this.styleRenderers_.length;a<l;a++){const u=this.styleRenderers_[a],f=this.buffers_[a];f&&u.render(f,e,()=>{this.applyUniforms_(f.invertVerticesTransform),this.helper.applyHitDetectionUniform(t)})}}while(++o<i)}forEachFeatureAtCoordinate(e,t,r,i,s){if(dt(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.styleRenderers_.length||!this.hitDetectionEnabled_)return;const o=kt(t.coordinateToPixelTransform,e.slice()),a=this.hitRenderTarget_.readPixel(o[0]/2,o[1]/2),l=[a[0]/255,a[1]/255,a[2]/255,a[3]/255],u=Wu(l),f=this.batch_.getFeatureFromRef(u);if(f)return i(f,this.getLayer(),null)}disposeBuffers(e){const t=r=>{for(const i of r)i&&this.helper.deleteBuffer(i)};e.pointBuffers&&t(e.pointBuffers),e.lineStringBuffers&&t(e.lineStringBuffers),e.polygonBuffers&&t(e.polygonBuffers)}disposeInternal(){this.buffers_.forEach(e=>{e&&this.disposeBuffers(e)}),this.sourceListenKeys_&&(this.sourceListenKeys_.forEach(function(e){li(e)}),this.sourceListenKeys_=null),super.disposeInternal()}renderDeclutter(){}}const Ot={BLUR:"blur",GRADIENT:"gradient",RADIUS:"radius"},k_=["#00f","#0ff","#0f0","#ff0","#f00"];class z_ extends Oi{constructor(e){e=e||{};const t=Object.assign({},e);delete t.gradient,delete t.radius,delete t.blur,delete t.weight,super(t),this.filter_=e.filter??!0,this.styleVariables_=e.variables||{},this.gradient_=null,this.addChangeListener(Ot.GRADIENT,this.handleGradientChanged_),this.setGradient(e.gradient?e.gradient:k_),this.setBlur(e.blur!==void 0?e.blur:15),this.setRadius(e.radius!==void 0?e.radius:8);const r=e.weight?e.weight:"weight";this.weight_=r,this.setRenderOrder(null)}getBlur(){return this.get(Ot.BLUR)}getGradient(){return this.get(Ot.GRADIENT)}getRadius(){return this.get(Ot.RADIUS)}handleGradientChanged_(){this.gradient_=$_(this.getGradient())}setBlur(e){const t=this.get(Ot.BLUR);if(this.set(Ot.BLUR,e),typeof e=="number"&&typeof t=="number"){this.changed();return}this.clearRenderer()}setGradient(e){this.set(Ot.GRADIENT,e)}setRadius(e){const t=this.get(Ot.RADIUS);if(this.set(Ot.RADIUS,e),typeof e=="number"&&typeof t=="number"){this.changed();return}this.clearRenderer()}setFilter(e){this.filter_=e,this.changed(),this.clearRenderer()}setWeight(e){this.weight_=e,this.changed(),this.clearRenderer()}createRenderer(){const e=new zu,t=So(),r=J(t,this.filter_,Fi);let i=J(t,this.getRadius(),ge),s=J(t,this.getBlur(),ge);const o={};typeof this.getBlur()=="number"&&(s="a_blur",o.a_blur=()=>this.getBlur(),e.addUniform("a_blur","float")),typeof this.getRadius()=="number"&&(i="a_radius",o.a_radius=()=>this.getRadius(),e.addUniform("a_radius","float"));const a={};let l=null;if(typeof this.weight_=="string"||typeof this.weight_=="function"){const c=typeof this.weight_=="string"?d=>d.get(this.weight_):this.weight_;a.prop_weight={size:1,callback:d=>{const g=c(d);return g!==void 0?Le(g,0,1):1}},l="a_prop_weight",e.addAttribute("a_prop_weight","float")}else{const c=["clamp",this.weight_,0,1];l=J(t,c,ge)}e.addFragmentShaderFunction(`float getBlurSlope() {
  float blur = max(1., ${s});
  float radius = ${i};
  return radius / blur;
}`).setSymbolSizeExpression(`vec2(${i} + ${s}) * 2.`).setSymbolColorExpression(`vec4(smoothstep(0., 1., (1. - length(coordsPx * 2. / v_quadSizePx)) * getBlurSlope()) * ${l})`).setStrokeColorExpression(`vec4(smoothstep(0., 1., (1. - length(currentRadiusPx * 2. / v_width)) * getBlurSlope()) * ${l})`).setStrokeWidthExpression(`(${i} + ${s}) * 2.`).setFillColorExpression(`vec4(${l})`).setFragmentDiscardExpression(`!${r}`),$u(e,t);const u=ju(t),f=Vu(t,this.styleVariables_);return new Qu(this,{className:this.getClassName(),variables:this.styleVariables_,style:{builder:e,attributes:{...u,...a},uniforms:{...f,...o}},disableHitDetection:!1,postProcesses:[{fragmentShader:`
            precision mediump float;

            uniform sampler2D u_image;
            uniform sampler2D u_gradientTexture;
            uniform float u_opacity;

            varying vec2 v_texCoord;

            void main() {
              vec4 color = texture2D(u_image, v_texCoord);
              gl_FragColor.a = color.a * u_opacity;
              gl_FragColor.rgb = texture2D(u_gradientTexture, vec2(0.5, color.a)).rgb;
              gl_FragColor.rgb *= gl_FragColor.a;
            }`,uniforms:{u_gradientTexture:()=>this.gradient_,u_opacity:()=>this.getOpacity()}}]})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}renderDeclutter(){}}function $_(n){const r=Qt(1,256),i=r.createLinearGradient(0,0,1,256),s=1/(n.length-1);for(let o=0,a=n.length;o<a;++o)i.addColorStop(o*s,n[o]);return r.fillStyle=i,r.fillRect(0,0,1,256),r.canvas}class Fo extends tu{constructor(e,t,r,i,s){const o=s!==void 0?or.IDLE:or.LOADED;super(e,t,r,o),this.loader_=s!==void 0?s:null,this.canvas_=i,this.error_=null}getError(){return this.error_}handleLoad_(e){e?(this.error_=e,this.state=or.ERROR):this.state=or.LOADED,this.changed()}load(){this.state==or.IDLE&&(this.state=or.LOADING,this.changed(),this.loader_(this.handleLoad_.bind(this)))}getImage(){return this.canvas_}}class V_ extends lf{constructor(e){super(e),this.vectorRenderer_=new uf(e),this.layerImageRatio_=e.getImageRatio(),this.coordinateToVectorPixelTransform_=$e(),this.renderedPixelToCoordinateTransform_=null}disposeInternal(){this.vectorRenderer_.dispose(),super.disposeInternal()}getFeatures(e){if(!this.vectorRenderer_)return Promise.resolve([]);const t=kt(this.coordinateToVectorPixelTransform_,kt(this.renderedPixelToCoordinateTransform_,e.slice()));return this.vectorRenderer_.getFeatures(t)}handleFontsChanged(){this.vectorRenderer_.handleFontsChanged()}prepareFrame(e){var f;const t=e.pixelRatio,r=e.viewState,i=r.resolution,s=e.viewHints,o=this.vectorRenderer_;let a=e.extent;this.layerImageRatio_!==1&&(a=a.slice(0),ru(a,this.layerImageRatio_));const l=Ve(a)/i,u=_t(a)/i;if(!s[Jt.ANIMATING]&&!s[Jt.INTERACTING]&&!Ci(a)){o.useContainer(null,null);const c=o.context,d=e.layerStatesArray[e.layerIndex],g=Object.assign({},d,{opacity:1}),p=Object.assign({},e,{extent:a,size:[l,u],viewState:Object.assign({},e.viewState,{rotation:0}),layerStatesArray:[g],layerIndex:0,declutter:null}),_=this.getLayer().getDeclutter();_&&(p.declutter={[_]:new cf(9)});const x=new Fo(a,i,t,c.canvas,function(T){o.prepareFrame(p)&&o.replayGroupChanged&&(o.clipping=!1,o.renderFrame(p,null),o.renderDeclutter(p),o.renderDeferred(p),T())});x.addEventListener(Ke.CHANGE,()=>{if(x.getState()!==or.LOADED)return;this.image=x;const T=x.getPixelRatio(),E=hf(x.getResolution())*t/T;this.renderedResolution=E,this.coordinateToVectorPixelTransform_=qs(this.coordinateToVectorPixelTransform_,l/2,u/2,1/E,-1/E,0,-r.center[0],-r.center[1])}),x.load()}return this.image&&(this.renderedPixelToCoordinateTransform_=e.pixelToCoordinateTransform.slice()),!((f=this.getLayer().getSource())!=null&&f.loading)&&!!this.image}preRender(){}postRender(){}renderDeclutter(){}forEachFeatureAtCoordinate(e,t,r,i,s){return this.vectorRenderer_?this.vectorRenderer_.forEachFeatureAtCoordinate(e,t,r,i,s):super.forEachFeatureAtCoordinate(e,t,r,i,s)}}class j_ extends Oi{constructor(e){e=e||{};const t=Object.assign({},e);delete t.imageRatio,super(t),this.imageRatio_=e.imageRatio!==void 0?e.imageRatio:1}getImageRatio(){return this.imageRatio_}createRenderer(){return new V_(this)}}class X_ extends In{constructor(e,t){const r=t.uniforms||{},i=$e();r[St.PROJECTION_MATRIX]=i,super(e,{uniforms:r,postProcesses:t.postProcesses}),this.sourceRevision_=-1,this.verticesBuffer_=new Nr(Pn,pi),this.indicesBuffer_=new Nr(Ln,pi),this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.program_,this.hitDetectionEnabled_=t.hitDetectionEnabled??!0;const s=t.attributes?t.attributes.map(function(a){return{name:"a_"+a.name,size:1,type:Fe.FLOAT}}):[];this.attributes=[{name:"a_position",size:2,type:Fe.FLOAT},{name:"a_index",size:1,type:Fe.FLOAT}],this.hitDetectionEnabled_&&(this.attributes.push({name:"a_hitColor",size:4,type:Fe.FLOAT}),this.attributes.push({name:"a_featureUid",size:1,type:Fe.FLOAT})),this.attributes.push(...s),this.customAttributes=t.attributes?t.attributes:[],this.previousExtent_=vn(),this.currentTransform_=i,this.renderTransform_=$e(),this.invertRenderTransform_=$e(),this.renderInstructions_=new Float32Array(0),this.hitRenderTarget_,this.lastSentId=0,this.worker_=Xu(),this.worker_.addEventListener("message",a=>{const l=a.data;if(l.type===an.GENERATE_POINT_BUFFERS){const u=l.projectionTransform;this.verticesBuffer_.fromArrayBuffer(l.vertexBuffer),this.helper.flushBufferData(this.verticesBuffer_),this.indicesBuffer_.fromArrayBuffer(l.indexBuffer),this.helper.flushBufferData(this.indicesBuffer_),this.renderTransform_=u,mn(this.invertRenderTransform_,this.renderTransform_),this.renderInstructions_=new Float32Array(a.data.renderInstructions),l.id===this.lastSentId&&(this.ready=!0),this.getLayer().changed()}}),this.featureCache_={},this.featureCount_=0;const o=this.getLayer().getSource();this.sourceListenKeys_=[Ut(o,Wt.ADDFEATURE,this.handleSourceFeatureAdded_,this),Ut(o,Wt.CHANGEFEATURE,this.handleSourceFeatureChanged_,this),Ut(o,Wt.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),Ut(o,Wt.CLEAR,this.handleSourceFeatureClear_,this)],o.forEachFeature(a=>{const l=a.getGeometry();l&&l.getType()==="Point"&&(this.featureCache_[_e(a)]={feature:a,properties:a.getProperties(),flatCoordinates:l.getFlatCoordinates()},this.featureCount_++)})}afterHelperCreated(){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new qu(this.helper)),this.verticesBuffer_.getArray()&&this.helper.flushBufferData(this.verticesBuffer_),this.indicesBuffer_.getArray()&&this.helper.flushBufferData(this.indicesBuffer_)}handleSourceFeatureAdded_(e){const t=e.feature,r=t.getGeometry();r&&r.getType()==="Point"&&(this.featureCache_[_e(t)]={feature:t,properties:t.getProperties(),flatCoordinates:r.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureChanged_(e){const t=e.feature,r=_e(t),i=this.featureCache_[r],s=t.getGeometry();i?s&&s.getType()==="Point"?(i.properties=t.getProperties(),i.flatCoordinates=s.getFlatCoordinates()):(delete this.featureCache_[r],this.featureCount_--):s&&s.getType()==="Point"&&(this.featureCache_[r]={feature:t,properties:t.getProperties(),flatCoordinates:s.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureDelete_(e){const t=e.feature,r=_e(t);r in this.featureCache_&&(delete this.featureCache_[r],this.featureCount_--)}handleSourceFeatureClear_(){this.featureCache_={},this.featureCount_=0}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[r,i,s]=Ku(e,this.getLayer());return this.renderWorlds(e,!1,r,i,s),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent),this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,r,i,s),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),this.helper.getCanvas()}prepareFrameInternal(e){const t=this.getLayer(),r=t.getSource(),i=e.viewState,s=!e.viewHints[Jt.ANIMATING]&&!e.viewHints[Jt.INTERACTING],o=!pn(this.previousExtent_,e.extent),a=this.sourceRevision_<r.getRevision();if(a&&(this.sourceRevision_=r.getRevision()),s&&(o||a)){const l=i.projection,u=i.resolution,f=t instanceof Oi?t.getRenderBuffer():0,c=eo(e.extent,f*u);r.loadFeatures(c,u,l),this.rebuildBuffers_(e),this.previousExtent_=e.extent.slice()}return this.helper.useProgram(this.program_,e),this.helper.prepareDraw(e),this.helper.bindBuffer(this.verticesBuffer_),this.helper.bindBuffer(this.indicesBuffer_),this.helper.enableAttributes(this.attributes),!0}rebuildBuffers_(e){const t=$e();this.helper.makeProjectionTransform(e,t);const i=(this.hitDetectionEnabled_?7:2)+this.customAttributes.length,s=i*this.featureCount_,o=this.renderInstructions_&&this.renderInstructions_.length===s?this.renderInstructions_:new Float32Array(s);this.renderInstructions_=null;let a=[];const l=[];let u=-1;e.viewState.projection;for(const c in this.featureCache_){const d=this.featureCache_[c];if(a[0]=d.flatCoordinates[0],a[1]=d.flatCoordinates[1],kt(t,a),o[++u]=a[0],o[++u]=a[1],this.hitDetectionEnabled_){const g=Hu(u+5,l);o[++u]=g[0],o[++u]=g[1],o[++u]=g[2],o[++u]=g[3],o[++u]=Number(c)}for(let g=0;g<this.customAttributes.length;g++){const p=this.customAttributes[g].callback(d.feature,d.properties);o[++u]=p}}const f={id:++this.lastSentId,type:an.GENERATE_POINT_BUFFERS,renderInstructions:o.buffer,customAttributesSize:i-2};f.projectionTransform=t,this.ready=!1,this.worker_.postMessage(f,[o.buffer])}forEachFeatureAtCoordinate(e,t,r,i,s){if(dt(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.renderInstructions_||!this.hitDetectionEnabled_)return;const o=kt(t.coordinateToPixelTransform,e.slice()),a=this.hitRenderTarget_.readPixel(o[0]/2,o[1]/2),l=[a[0]/255,a[1]/255,a[2]/255,a[3]/255],u=Wu(l),f=this.renderInstructions_[u],c=Math.floor(f).toString(),g=this.getLayer().getSource().getFeatureByUid(c);if(g)return i(g,this.getLayer(),null)}renderWorlds(e,t,r,i,s){let o=r;this.helper.useProgram(this.program_,e),t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0)),this.helper.bindBuffer(this.verticesBuffer_),this.helper.bindBuffer(this.indicesBuffer_),this.helper.enableAttributes(this.attributes);do{this.helper.makeProjectionTransform(e,this.currentTransform_),Js(this.currentTransform_,o*s,0),dn(this.currentTransform_,this.invertRenderTransform_),this.helper.applyUniforms(e),this.helper.applyHitDetectionUniform(t);const a=this.indicesBuffer_.getSize();this.helper.drawElements(0,a)}while(++o<i)}disposeInternal(){this.worker_.terminate(),this.sourceListenKeys_.forEach(function(e){li(e)}),this.sourceListenKeys_=null,super.disposeInternal()}renderDeclutter(){}}class H_ extends to{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.parseResult_=Yu(e.style,this.styleVariables_,e.filter),this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){const e=Object.keys(this.parseResult_.attributes).map(t=>({name:t,...this.parseResult_.attributes[t]}));return new X_(this,{vertexShader:this.parseResult_.builder.getSymbolVertexShader(),fragmentShader:this.parseResult_.builder.getSymbolFragmentShader(),hitDetectionEnabled:!this.hitDetectionDisabled_,uniforms:this.parseResult_.uniforms,attributes:e})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}function ul(n,e){const t=`
    attribute vec2 ${qn.TEXTURE_COORD};
    uniform mat4 ${ne.TILE_TRANSFORM};
    uniform float ${ne.TEXTURE_PIXEL_WIDTH};
    uniform float ${ne.TEXTURE_PIXEL_HEIGHT};
    uniform float ${ne.TEXTURE_RESOLUTION};
    uniform float ${ne.TEXTURE_ORIGIN_X};
    uniform float ${ne.TEXTURE_ORIGIN_Y};
    uniform float ${ne.DEPTH};

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;

    void main() {
      v_textureCoord = ${qn.TEXTURE_COORD};
      v_mapCoord = vec2(
        ${ne.TEXTURE_ORIGIN_X} + ${ne.TEXTURE_RESOLUTION} * ${ne.TEXTURE_PIXEL_WIDTH} * v_textureCoord[0],
        ${ne.TEXTURE_ORIGIN_Y} - ${ne.TEXTURE_RESOLUTION} * ${ne.TEXTURE_PIXEL_HEIGHT} * v_textureCoord[1]
      );
      gl_Position = ${ne.TILE_TRANSFORM} * vec4(${qn.TEXTURE_COORD}, ${ne.DEPTH}, 1.0);
    }
  `,r={...So(),bandCount:e},i=[];if(n.color!==void 0){const c=J(r,n.color,tt);i.push(`color = ${c};`)}if(n.contrast!==void 0){const c=J(r,n.contrast,ge);i.push(`color.rgb = clamp((${c} + 1.0) * color.rgb - (${c} / 2.0), vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(n.exposure!==void 0){const c=J(r,n.exposure,ge);i.push(`color.rgb = clamp((${c} + 1.0) * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(n.saturation!==void 0){const c=J(r,n.saturation,ge);i.push(`
      float saturation = ${c} + 1.0;
      float sr = (1.0 - saturation) * 0.2126;
      float sg = (1.0 - saturation) * 0.7152;
      float sb = (1.0 - saturation) * 0.0722;
      mat3 saturationMatrix = mat3(
        sr + saturation, sr, sr,
        sg, sg + saturation, sg,
        sb, sb, sb + saturation
      );
      color.rgb = clamp(saturationMatrix * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));
    `)}if(n.gamma!==void 0){const c=J(r,n.gamma,ge);i.push(`color.rgb = pow(color.rgb, vec3(1.0 / ${c}));`)}if(n.brightness!==void 0){const c=J(r,n.brightness,ge);i.push(`color.rgb = clamp(color.rgb + ${c}, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}const s={},o=Object.keys(r.variables).length;if(o>1&&!n.variables)throw new Error(`Missing variables in style (expected ${r.variables})`);for(let c=0;c<o;++c){const d=r.variables[Object.keys(r.variables)[c]];if(!(d.name in n.variables))throw new Error(`Missing '${d.name}' in style variables`);const g=zi(d.name);s[g]=function(){let p=n.variables[d.name];return typeof p=="string"&&(p=Dr(p)),p!==void 0?p:-9999999}}const a=Object.keys(s).map(function(c){return`uniform float ${c};`}),l=Math.ceil(e/4);a.push(`uniform sampler2D ${ne.TILE_TEXTURE_ARRAY}[${l}];`),r.paletteTextures&&a.push(`uniform sampler2D ${Bu}[${r.paletteTextures.length}];`);const u=Object.keys(r.functions).map(function(c){return r.functions[c]}),f=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    #else
    precision mediump float;
    #endif

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;
    uniform vec4 ${ne.RENDER_EXTENT};
    uniform float ${ne.TRANSITION_ALPHA};
    uniform float ${ne.TEXTURE_PIXEL_WIDTH};
    uniform float ${ne.TEXTURE_PIXEL_HEIGHT};
    uniform float ${ne.RESOLUTION};
    uniform float ${ne.ZOOM};

    ${a.join(`
`)}

    ${u.join(`
`)}

    void main() {
      if (
        v_mapCoord[0] < ${ne.RENDER_EXTENT}[0] ||
        v_mapCoord[1] < ${ne.RENDER_EXTENT}[1] ||
        v_mapCoord[0] > ${ne.RENDER_EXTENT}[2] ||
        v_mapCoord[1] > ${ne.RENDER_EXTENT}[3]
      ) {
        discard;
      }

      vec4 color = texture2D(${ne.TILE_TEXTURE_ARRAY}[0],  v_textureCoord);

      ${i.join(`
`)}

      gl_FragColor = color;
      gl_FragColor.rgb *= gl_FragColor.a;
      gl_FragColor *= ${ne.TRANSITION_ALPHA};
    }`;return{vertexShader:t,fragmentShader:f,uniforms:s,paletteTextures:r.paletteTextures}}class yi extends ff{constructor(e){e=e?Object.assign({},e):{};const t=e.style||{};delete e.style,super(e),this.sources_=e.sources,this.renderedSource_=null,this.renderedResolution_=NaN,this.style_=t,this.styleVariables_=this.style_.variables||{},this.handleSourceUpdate_(),this.addChangeListener(ys.SOURCE,this.handleSourceUpdate_)}getSources(e,t){const r=this.getSource();return this.sources_?typeof this.sources_=="function"?this.sources_(e,t):this.sources_:r?[r]:[]}getRenderSource(){return this.renderedSource_||this.getSource()}getSourceState(){const e=this.getRenderSource();return e?e.getState():"undefined"}handleSourceUpdate_(){this.hasRenderer()&&this.getRenderer().clearCache();const e=this.getSource();if(e)if(e.getState()==="loading"){const t=()=>{e.getState()==="ready"&&(e.removeEventListener("change",t),this.setStyle(this.style_))};e.addEventListener("change",t)}else this.setStyle(this.style_)}getSourceBandCount_(){const e=Number.MAX_SAFE_INTEGER,t=this.getSources([-e,-e,e,e],e);return t&&t.length&&"bandCount"in t[0]?t[0].bandCount:4}createRenderer(){const e=ul(this.style_,this.getSourceBandCount_());return new g_(this,{vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,cacheSize:this.getCacheSize(),paletteTextures:e.paletteTextures})}renderSources(e,t){const r=this.getRenderer();let i;for(let s=0,o=t.length;s<o;++s)this.renderedSource_=t[s],r.prepareFrame(e)&&(i=r.renderFrame(e));return i}render(e,t){this.rendered=!0;const r=e.viewState,i=this.getSources(e.extent,r.resolution);let s=!0;for(let a=0,l=i.length;a<l;++a){const u=i[a],f=u.getState();if(f=="loading"){const c=()=>{u.getState()=="ready"&&(u.removeEventListener("change",c),this.changed())};u.addEventListener("change",c)}s=s&&f=="ready"}const o=this.renderSources(e,i);if(this.getRenderer().renderComplete&&s)return this.renderedResolution_=r.resolution,o;if(this.renderedResolution_>.5*r.resolution){const a=this.getSources(e.extent,this.renderedResolution_).filter(l=>!i.includes(l));if(a.length>0)return this.renderSources(e,a)}return o}setStyle(e){if(this.styleVariables_=e.variables||{},this.style_=e,this.hasRenderer()){const t=ul(this.style_,this.getSourceBandCount_());this.getRenderer().reset({vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,uniforms:t.uniforms,paletteTextures:t.paletteTextures}),this.changed()}}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}yi.prototype.dispose;class W_ extends to{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.style_=e.style,this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){return new Qu(this,{style:this.style_,variables:this.styleVariables_,disableHitDetection:this.hitDetectionDisabled_})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}setStyle(e){this.style_=e,this.clearRenderer(),this.changed()}}var st=Uint8Array,Lr=Uint16Array,Z_=Int32Array,Ju=new st([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),ec=new st([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Y_=new st([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),tc=function(n,e){for(var t=new Lr(31),r=0;r<31;++r)t[r]=e+=1<<n[r-1];for(var i=new Z_(t[30]),r=1;r<30;++r)for(var s=t[r];s<t[r+1];++s)i[s]=s-t[r]<<5|r;return{b:t,r:i}},rc=tc(Ju,2),nc=rc.b,q_=rc.r;nc[28]=258,q_[258]=28;var K_=tc(ec,0),Q_=K_.b,Is=new Lr(32768);for(var Re=0;Re<32768;++Re){var Vt=(Re&43690)>>1|(Re&21845)<<1;Vt=(Vt&52428)>>2|(Vt&13107)<<2,Vt=(Vt&61680)>>4|(Vt&3855)<<4,Is[Re]=((Vt&65280)>>8|(Vt&255)<<8)>>1}var ln=function(n,e,t){for(var r=n.length,i=0,s=new Lr(e);i<r;++i)n[i]&&++s[n[i]-1];var o=new Lr(e);for(i=1;i<e;++i)o[i]=o[i-1]+s[i-1]<<1;var a;if(t){a=new Lr(1<<e);var l=15-e;for(i=0;i<r;++i)if(n[i])for(var u=i<<4|n[i],f=e-n[i],c=o[n[i]-1]++<<f,d=c|(1<<f)-1;c<=d;++c)a[Is[c]>>l]=u}else for(a=new Lr(r),i=0;i<r;++i)n[i]&&(a[i]=Is[o[n[i]-1]++]>>15-n[i]);return a},Cn=new st(288);for(var Re=0;Re<144;++Re)Cn[Re]=8;for(var Re=144;Re<256;++Re)Cn[Re]=9;for(var Re=256;Re<280;++Re)Cn[Re]=7;for(var Re=280;Re<288;++Re)Cn[Re]=8;var ic=new st(32);for(var Re=0;Re<32;++Re)ic[Re]=5;var J_=ln(Cn,9,1),ey=ln(ic,5,1),rs=function(n){for(var e=n[0],t=1;t<n.length;++t)n[t]>e&&(e=n[t]);return e},pt=function(n,e,t){var r=e/8|0;return(n[r]|n[r+1]<<8)>>(e&7)&t},ns=function(n,e){var t=e/8|0;return(n[t]|n[t+1]<<8|n[t+2]<<16)>>(e&7)},ty=function(n){return(n+7)/8|0},ry=function(n,e,t){return(t==null||t>n.length)&&(t=n.length),new st(n.subarray(e,t))},ny=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],nt=function(n,e,t){var r=new Error(e||ny[n]);if(r.code=n,Error.captureStackTrace&&Error.captureStackTrace(r,nt),!t)throw r;return r},Oo=function(n,e,t,r){var i=n.length,s=0;if(!i||e.f&&!e.l)return t||new st(0);var o=!t,a=o||e.i!=2,l=e.i;o&&(t=new st(i*3));var u=function(Ce){var ke=t.length;if(Ce>ke){var Xe=new st(Math.max(ke*2,Ce));Xe.set(t),t=Xe}},f=e.f||0,c=e.p||0,d=e.b||0,g=e.l,p=e.d,_=e.m,x=e.n,T=i*8;do{if(!g){f=pt(n,c,1);var E=pt(n,c+1,3);if(c+=3,E)if(E==1)g=J_,p=ey,_=9,x=5;else if(E==2){var C=pt(n,c,31)+257,N=pt(n,c+10,15)+4,U=C+pt(n,c+5,31)+1;c+=14;for(var k=new st(U),D=new st(19),j=0;j<N;++j)D[Y_[j]]=pt(n,c+j*3,7);c+=N*3;for(var X=rs(D),h=(1<<X)-1,m=ln(D,X,1),j=0;j<U;){var y=m[pt(n,c,h)];c+=y&15;var w=y>>4;if(w<16)k[j++]=w;else{var b=0,R=0;for(w==16?(R=3+pt(n,c,3),c+=2,b=k[j-1]):w==17?(R=3+pt(n,c,7),c+=3):w==18&&(R=11+pt(n,c,127),c+=7);R--;)k[j++]=b}}var O=k.subarray(0,C),F=k.subarray(C);_=rs(O),x=rs(F),g=ln(O,_,1),p=ln(F,x,1)}else nt(1);else{var w=ty(c)+4,A=n[w-4]|n[w-3]<<8,P=w+A;if(P>i){l&&nt(0);break}a&&u(d+A),t.set(n.subarray(w,P),d),e.b=d+=A,e.p=c=P*8,e.f=f;continue}if(c>T){l&&nt(0);break}}a&&u(d+131072);for(var M=(1<<_)-1,z=(1<<x)-1,W=c;;W=c){var b=g[ns(n,c)&M],Y=b>>4;if(c+=b&15,c>T){l&&nt(0);break}if(b||nt(2),Y<256)t[d++]=Y;else if(Y==256){W=c,g=null;break}else{var ee=Y-254;if(Y>264){var j=Y-257,te=Ju[j];ee=pt(n,c,(1<<te)-1)+nc[j],c+=te}var re=p[ns(n,c)&z],de=re>>4;re||nt(3),c+=re&15;var F=Q_[de];if(de>3){var te=ec[de];F+=ns(n,c)&(1<<te)-1,c+=te}if(c>T){l&&nt(0);break}a&&u(d+131072);var Oe=d+ee;if(d<F){var Pe=s-F,De=Math.min(F,Oe);for(Pe+d<0&&nt(3);d<De;++d)t[d]=r[Pe+d]}for(;d<Oe;++d)t[d]=t[d-F]}}e.l=g,e.p=W,e.b=d,e.f=f,g&&(f=1,e.m=_,e.d=p,e.n=x)}while(!f);return d!=t.length&&o?ry(t,0,d):t.subarray(0,d)},iy=new st(0),sy=function(n){(n[0]!=31||n[1]!=139||n[2]!=8)&&nt(6,"invalid gzip data");var e=n[3],t=10;e&4&&(t+=(n[10]|n[11]<<8)+2);for(var r=(e>>3&1)+(e>>4&1);r>0;r-=!n[t++]);return t+(e&2)},oy=function(n){var e=n.length;return(n[e-4]|n[e-3]<<8|n[e-2]<<16|n[e-1]<<24)>>>0},ay=function(n,e){return((n[0]&15)!=8||n[0]>>4>7||(n[0]<<8|n[1])%31)&&nt(6,"invalid zlib data"),(n[1]>>5&1)==1&&nt(6,"invalid zlib data: "+(n[1]&32?"need":"unexpected")+" dictionary"),(n[1]>>3&4)+2};function ly(n,e){return Oo(n,{i:2},e,e)}function uy(n,e){var t=sy(n);return t+8>n.length&&nt(6,"invalid gzip data"),Oo(n.subarray(t,-8),{i:2},new st(oy(n)),e)}function cy(n,e){return Oo(n.subarray(ay(n),-4),{i:2},e,e)}function hy(n,e){return n[0]==31&&n[1]==139&&n[2]==8?uy(n,e):(n[0]&15)!=8||n[0]>>4>7||(n[0]<<8|n[1])%31?ly(n,e):cy(n,e)}var fy=typeof TextDecoder<"u"&&new TextDecoder,dy=0;try{fy.decode(iy,{stream:!0}),dy=1}catch{}var py=Object.defineProperty,un=Math.pow,ve=(n,e)=>py(n,"name",{value:e,configurable:!0}),Be=(n,e,t)=>new Promise((r,i)=>{var s=l=>{try{a(t.next(l))}catch(u){i(u)}},o=l=>{try{a(t.throw(l))}catch(u){i(u)}},a=l=>l.done?r(l.value):Promise.resolve(l.value).then(s,o);a((t=t.apply(n,e)).next())});ve((n,e)=>{let t=!1,r="",i=L.GridLayer.extend({createTile:ve((s,o)=>{let a=document.createElement("img"),l=new AbortController,u=l.signal;return a.cancel=()=>{l.abort()},t||(n.getHeader().then(f=>{f.tileType===1?console.error("Error: archive contains MVT vector tiles, but leafletRasterLayer is for displaying raster tiles. See https://github.com/protomaps/PMTiles/tree/main/js for details."):f.tileType===2?r="image/png":f.tileType===3?r="image/jpeg":f.tileType===4?r="image/webp":f.tileType===5&&(r="image/avif")}),t=!0),n.getZxy(s.z,s.x,s.y,u).then(f=>{if(f){let c=new Blob([f.data],{type:r}),d=window.URL.createObjectURL(c);a.src=d,a.cancel=void 0,o(void 0,a)}}).catch(f=>{if(f.name!=="AbortError")throw f}),a},"createTile"),_removeTile:ve(function(s){let o=this._tiles[s];o&&(o.el.cancel&&o.el.cancel(),o.el.width=0,o.el.height=0,o.el.deleted=!0,L.DomUtil.remove(o.el),delete this._tiles[s],this.fire("tileunload",{tile:o.el,coords:this._keyToTileCoords(s)}))},"_removeTile")});return new i(e)},"leafletRasterLayer");var gy=ve(n=>(e,t)=>{if(t instanceof AbortController)return n(e,t);let r=new AbortController;return n(e,r).then(i=>t(void 0,i.data,i.cacheControl||"",i.expires||""),i=>t(i)).catch(i=>t(i)),{cancel:ve(()=>r.abort(),"cancel")}},"v3compat"),my=class{constructor(e){this.tilev4=ve((t,r)=>Be(this,null,function*(){if(t.type==="json"){let g=t.url.substr(10),p=this.tiles.get(g);if(p||(p=new yn(g),this.tiles.set(g,p)),this.metadata)return{data:yield p.getTileJson(t.url)};let _=yield p.getHeader();return(_.minLon>=_.maxLon||_.minLat>=_.maxLat)&&console.error(`Bounds of PMTiles archive ${_.minLon},${_.minLat},${_.maxLon},${_.maxLat} are not valid.`),{data:{tiles:[`${t.url}/{z}/{x}/{y}`],minzoom:_.minZoom,maxzoom:_.maxZoom,bounds:[_.minLon,_.minLat,_.maxLon,_.maxLat]}}}let i=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),s=t.url.match(i);if(!s)throw new Error("Invalid PMTiles protocol URL");let o=s[1],a=this.tiles.get(o);a||(a=new yn(o),this.tiles.set(o,a));let l=s[2],u=s[3],f=s[4],c=yield a.getHeader(),d=yield a==null?void 0:a.getZxy(+l,+u,+f,r.signal);if(d)return{data:new Uint8Array(d.data),cacheControl:d.cacheControl,expires:d.expires};if(c.tileType===1){if(this.errorOnMissingTile)throw new Error("Tile not found.");return{data:new Uint8Array}}return{data:null}}),"tilev4"),this.tile=gy(this.tilev4),this.tiles=new Map,this.metadata=(e==null?void 0:e.metadata)||!1,this.errorOnMissingTile=(e==null?void 0:e.errorOnMissingTile)||!1}add(e){this.tiles.set(e.source.getKey(),e)}get(e){return this.tiles.get(e)}};ve(my,"Protocol");function sc(n,e){return(e>>>0)*4294967296+(n>>>0)}ve(sc,"toNum");function oc(n,e){let t=e.buf,r=t[e.pos++],i=(r&112)>>4;if(r<128||(r=t[e.pos++],i|=(r&127)<<3,r<128)||(r=t[e.pos++],i|=(r&127)<<10,r<128)||(r=t[e.pos++],i|=(r&127)<<17,r<128)||(r=t[e.pos++],i|=(r&127)<<24,r<128)||(r=t[e.pos++],i|=(r&1)<<31,r<128))return sc(n,i);throw new Error("Expected varint not more than 10 bytes")}ve(oc,"readVarintRemainder");function Sr(n){let e=n.buf,t=e[n.pos++],r=t&127;return t<128||(t=e[n.pos++],r|=(t&127)<<7,t<128)||(t=e[n.pos++],r|=(t&127)<<14,t<128)||(t=e[n.pos++],r|=(t&127)<<21,t<128)?r:(t=e[n.pos],r|=(t&15)<<28,oc(r,n))}ve(Sr,"readVarint");function Mo(n,e,t,r){if(r===0){t===1&&(e[0]=n-1-e[0],e[1]=n-1-e[1]);let i=e[0];e[0]=e[1],e[1]=i}}ve(Mo,"rotate");function ac(n,e){let t=un(2,n),r=e,i=e,s=e,o=[0,0],a=1;for(;a<t;)r=1&s/2,i=1&(s^r),Mo(a,o,r,i),o[0]+=a*r,o[1]+=a*i,s=s/4,a*=2;return[n,o[0],o[1]]}ve(ac,"idOnLevel");var _y=[0,1,5,21,85,341,1365,5461,21845,87381,349525,1398101,5592405,22369621,89478485,357913941,1431655765,5726623061,22906492245,91625968981,366503875925,1466015503701,5864062014805,23456248059221,93824992236885,375299968947541,0x5555555555555];function lc(n,e,t){if(n>26)throw new Error("Tile zoom level exceeds max safe number limit (26)");if(e>un(2,n)-1||t>un(2,n)-1)throw new Error("tile x/y outside zoom level bounds");let r=_y[n],i=un(2,n),s=0,o=0,a=0,l=[e,t],u=i/2;for(;u>0;)s=(l[0]&u)>0?1:0,o=(l[1]&u)>0?1:0,a+=u*u*(3*s^o),Mo(u,l,s,o),u=u/2;return r+a}ve(lc,"zxyToTileId");function yy(n){let e=0;for(let t=0;t<27;t++){let r=(1<<t)*(1<<t);if(e+r>n)return ac(t,n-e);e+=r}throw new Error("Tile zoom level exceeds max safe number limit (26)")}ve(yy,"tileIdToZxy");var xy=(n=>(n[n.Unknown=0]="Unknown",n[n.None=1]="None",n[n.Gzip=2]="Gzip",n[n.Brotli=3]="Brotli",n[n.Zstd=4]="Zstd",n))(xy||{});function Vi(n,e){return Be(this,null,function*(){if(e===1||e===0)return n;if(e===2){if(typeof globalThis.DecompressionStream>"u")return hy(new Uint8Array(n));let t=new Response(n).body;if(!t)throw new Error("Failed to read response stream");let r=t.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(r).arrayBuffer()}throw new Error("Compression method not supported")})}ve(Vi,"defaultDecompress");var Rr=(n=>(n[n.Unknown=0]="Unknown",n[n.Mvt=1]="Mvt",n[n.Png=2]="Png",n[n.Jpeg=3]="Jpeg",n[n.Webp=4]="Webp",n[n.Avif=5]="Avif",n))(Rr||{});function uc(n){return n===1?".mvt":n===2?".png":n===3?".jpg":n===4?".webp":n===5?".avif":""}ve(uc,"tileTypeExt");var Ey=127;function cc(n,e){let t=0,r=n.length-1;for(;t<=r;){let i=r+t>>1,s=e-n[i].tileId;if(s>0)t=i+1;else if(s<0)r=i-1;else return n[i]}return r>=0&&(n[r].runLength===0||e-n[r].tileId<n[r].runLength)?n[r]:null}ve(cc,"findTile");var by=class{constructor(e){this.file=e}getKey(){return this.file.name}getBytes(e,t){return Be(this,null,function*(){return{data:yield this.file.slice(e,e+t).arrayBuffer()}})}};ve(by,"FileSource");var hc=class{constructor(e,t=new Headers){this.url=e,this.customHeaders=t,this.mustReload=!1;let r="";"navigator"in globalThis&&(r=globalThis.navigator.userAgent||"");let i=r.indexOf("Windows")>-1,s=/Chrome|Chromium|Edg|OPR|Brave/.test(r);this.chromeWindowsNoCache=!1,i&&s&&(this.chromeWindowsNoCache=!0)}getKey(){return this.url}setHeaders(e){this.customHeaders=e}getBytes(e,t,r,i){return Be(this,null,function*(){let s,o;r?o=r:(s=new AbortController,o=s.signal);let a=new Headers(this.customHeaders);a.set("range",`bytes=${e}-${e+t-1}`);let l;this.mustReload?l="reload":this.chromeWindowsNoCache&&(l="no-store");let u=yield fetch(this.url,{signal:o,cache:l,headers:a});if(e===0&&u.status===416){let d=u.headers.get("Content-Range");if(!d||!d.startsWith("bytes */"))throw new Error("Missing content-length on 416 response");let g=+d.substr(8);u=yield fetch(this.url,{signal:o,cache:"reload",headers:{range:`bytes=0-${g-1}`}})}let f=u.headers.get("Etag");if(f!=null&&f.startsWith("W/")&&(f=null),u.status===416||i&&f&&f!==i)throw this.mustReload=!0,new Cs(`Server returned non-matching ETag ${i} after one retry. Check browser extensions and servers for issues that may affect correct ETag headers.`);if(u.status>=300)throw new Error(`Bad response code: ${u.status}`);let c=u.headers.get("Content-Length");if(u.status===200&&(!c||+c>t))throw s&&s.abort(),new Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:yield u.arrayBuffer(),etag:f||void 0,cacheControl:u.headers.get("Cache-Control")||void 0,expires:u.headers.get("Expires")||void 0}})}};ve(hc,"FetchSource");var Ty=hc;function ut(n,e){let t=n.getUint32(e+4,!0),r=n.getUint32(e+0,!0);return t*un(2,32)+r}ve(ut,"getUint64");function fc(n,e){let t=new DataView(n),r=t.getUint8(7);if(r>3)throw new Error(`Archive is spec version ${r} but this library supports up to spec version 3`);return{specVersion:r,rootDirectoryOffset:ut(t,8),rootDirectoryLength:ut(t,16),jsonMetadataOffset:ut(t,24),jsonMetadataLength:ut(t,32),leafDirectoryOffset:ut(t,40),leafDirectoryLength:ut(t,48),tileDataOffset:ut(t,56),tileDataLength:ut(t,64),numAddressedTiles:ut(t,72),numTileEntries:ut(t,80),numTileContents:ut(t,88),clustered:t.getUint8(96)===1,internalCompression:t.getUint8(97),tileCompression:t.getUint8(98),tileType:t.getUint8(99),minZoom:t.getUint8(100),maxZoom:t.getUint8(101),minLon:t.getInt32(102,!0)/1e7,minLat:t.getInt32(106,!0)/1e7,maxLon:t.getInt32(110,!0)/1e7,maxLat:t.getInt32(114,!0)/1e7,centerZoom:t.getUint8(118),centerLon:t.getInt32(119,!0)/1e7,centerLat:t.getInt32(123,!0)/1e7,etag:e}}ve(fc,"bytesToHeader");function No(n){let e={buf:new Uint8Array(n),pos:0},t=Sr(e),r=[],i=0;for(let s=0;s<t;s++){let o=Sr(e);r.push({tileId:i+o,offset:0,length:0,runLength:1}),i+=o}for(let s=0;s<t;s++)r[s].runLength=Sr(e);for(let s=0;s<t;s++)r[s].length=Sr(e);for(let s=0;s<t;s++){let o=Sr(e);o===0&&s>0?r[s].offset=r[s-1].offset+r[s-1].length:r[s].offset=o-1}return r}ve(No,"deserializeIndex");var dc=class extends Error{};ve(dc,"EtagMismatch");var Cs=dc;function Do(n,e){return Be(this,null,function*(){let t=yield n.getBytes(0,16384);if(new DataView(t.data).getUint16(0,!0)!==19792)throw new Error("Wrong magic number for PMTiles archive");let r=t.data.slice(0,Ey),i=fc(r,t.etag),s=t.data.slice(i.rootDirectoryOffset,i.rootDirectoryOffset+i.rootDirectoryLength),o=`${n.getKey()}|${i.etag||""}|${i.rootDirectoryOffset}|${i.rootDirectoryLength}`,a=No(yield e(s,i.internalCompression));return[i,[o,a.length,a]]})}ve(Do,"getHeaderAndRoot");function Uo(n,e,t,r,i){return Be(this,null,function*(){let s=yield n.getBytes(t,r,void 0,i.etag),o=yield e(s.data,i.internalCompression),a=No(o);if(a.length===0)throw new Error("Empty directory is invalid");return a})}ve(Uo,"getDirectory");var wy=class{constructor(e=100,t=!0,r=Vi){this.cache=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=r}getHeader(e){return Be(this,null,function*(){let t=e.getKey(),r=this.cache.get(t);if(r)return r.lastUsed=this.counter++,r.data;let i=yield Do(e,this.decompress);return i[1]&&this.cache.set(i[1][0],{lastUsed:this.counter++,data:i[1][2]}),this.cache.set(t,{lastUsed:this.counter++,data:i[0]}),this.prune(),i[0]})}getDirectory(e,t,r,i){return Be(this,null,function*(){let s=`${e.getKey()}|${i.etag||""}|${t}|${r}`,o=this.cache.get(s);if(o)return o.lastUsed=this.counter++,o.data;let a=yield Uo(e,this.decompress,t,r,i);return this.cache.set(s,{lastUsed:this.counter++,data:a}),this.prune(),a})}prune(){if(this.cache.size>this.maxCacheEntries){let e=1/0,t;this.cache.forEach((r,i)=>{r.lastUsed<e&&(e=r.lastUsed,t=i)}),t&&this.cache.delete(t)}}invalidate(e){return Be(this,null,function*(){this.cache.delete(e.getKey())})}};ve(wy,"ResolvedValueCache");var pc=class{constructor(e=100,t=!0,r=Vi){this.cache=new Map,this.invalidations=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=r}getHeader(e){return Be(this,null,function*(){let t=e.getKey(),r=this.cache.get(t);if(r)return r.lastUsed=this.counter++,yield r.data;let i=new Promise((s,o)=>{Do(e,this.decompress).then(a=>{a[1]&&this.cache.set(a[1][0],{lastUsed:this.counter++,data:Promise.resolve(a[1][2])}),s(a[0]),this.prune()}).catch(a=>{o(a)})});return this.cache.set(t,{lastUsed:this.counter++,data:i}),i})}getDirectory(e,t,r,i){return Be(this,null,function*(){let s=`${e.getKey()}|${i.etag||""}|${t}|${r}`,o=this.cache.get(s);if(o)return o.lastUsed=this.counter++,yield o.data;let a=new Promise((l,u)=>{Uo(e,this.decompress,t,r,i).then(f=>{l(f),this.prune()}).catch(f=>{u(f)})});return this.cache.set(s,{lastUsed:this.counter++,data:a}),a})}prune(){if(this.cache.size>=this.maxCacheEntries){let e=1/0,t;this.cache.forEach((r,i)=>{r.lastUsed<e&&(e=r.lastUsed,t=i)}),t&&this.cache.delete(t)}}invalidate(e){return Be(this,null,function*(){let t=e.getKey();if(this.invalidations.get(t))return yield this.invalidations.get(t);this.cache.delete(e.getKey());let r=new Promise((i,s)=>{this.getHeader(e).then(o=>{i(),this.invalidations.delete(t)}).catch(o=>{s(o)})});this.invalidations.set(t,r)})}};ve(pc,"SharedPromiseCache");var vy=pc,gc=class{constructor(e,t,r){typeof e=="string"?this.source=new Ty(e):this.source=e,r?this.decompress=r:this.decompress=Vi,t?this.cache=t:this.cache=new vy}getHeader(){return Be(this,null,function*(){return yield this.cache.getHeader(this.source)})}getZxyAttempt(e,t,r,i){return Be(this,null,function*(){let s=lc(e,t,r),o=yield this.cache.getHeader(this.source);if(e<o.minZoom||e>o.maxZoom)return;let a=o.rootDirectoryOffset,l=o.rootDirectoryLength;for(let u=0;u<=3;u++){let f=yield this.cache.getDirectory(this.source,a,l,o),c=cc(f,s);if(c){if(c.runLength>0){let d=yield this.source.getBytes(o.tileDataOffset+c.offset,c.length,i,o.etag);return{data:yield this.decompress(d.data,o.tileCompression),cacheControl:d.cacheControl,expires:d.expires}}a=o.leafDirectoryOffset+c.offset,l=c.length}else return}throw new Error("Maximum directory depth exceeded")})}getZxy(e,t,r,i){return Be(this,null,function*(){try{return yield this.getZxyAttempt(e,t,r,i)}catch(s){if(s instanceof Cs)return this.cache.invalidate(this.source),yield this.getZxyAttempt(e,t,r,i);throw s}})}getMetadataAttempt(){return Be(this,null,function*(){let e=yield this.cache.getHeader(this.source),t=yield this.source.getBytes(e.jsonMetadataOffset,e.jsonMetadataLength,void 0,e.etag),r=yield this.decompress(t.data,e.internalCompression),i=new TextDecoder("utf-8");return JSON.parse(i.decode(r))})}getMetadata(){return Be(this,null,function*(){try{return yield this.getMetadataAttempt()}catch(e){if(e instanceof Cs)return this.cache.invalidate(this.source),yield this.getMetadataAttempt();throw e}})}getTileJson(e){return Be(this,null,function*(){let t=yield this.getHeader(),r=yield this.getMetadata(),i=uc(t.tileType);return{tilejson:"3.0.0",scheme:"xyz",tiles:[`${e}/{z}/{x}/{y}${i}`],vector_layers:r.vector_layers,attribution:r.attribution,description:r.description,name:r.name,version:r.version,bounds:[t.minLon,t.minLat,t.maxLon,t.maxLat],center:[t.centerLon,t.centerLat,t.centerZoom],minzoom:t.minZoom,maxzoom:t.maxZoom}})}};ve(gc,"PMTiles");var yn=gc;class Sy extends nu{constructor(e){super(Ke.ERROR),this.error=e}}function je(n){return(e,...t)=>Ry(n,e,t)}function Wr(n,e){return je(mc(n,e).get)}const{apply:Ry,getOwnPropertyDescriptor:mc,getPrototypeOf:Bo,ownKeys:Ay}=Reflect,{iterator:Fn,toStringTag:Py}=Symbol,Ly=Object,{create:Go,defineProperty:Iy}=Ly,Cy=Array,Fy=Cy.prototype,_c=Fy[Fn],Oy=je(_c),yc=ArrayBuffer,My=yc.prototype;Wr(My,"byteLength");const cl=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:null;cl&&Wr(cl.prototype,"byteLength");const xc=Bo(Uint8Array);xc.from;const Qe=xc.prototype;Qe[Fn];je(Qe.keys);je(Qe.values);je(Qe.entries);je(Qe.set);je(Qe.reverse);je(Qe.fill);je(Qe.copyWithin);je(Qe.sort);je(Qe.slice);je(Qe.subarray);Wr(Qe,"buffer");Wr(Qe,"byteOffset");Wr(Qe,"length");Wr(Qe,Py);const Ny=Uint8Array,Ec=Uint16Array,ko=Uint32Array,Dy=Float32Array,xn=Bo([][Fn]()),bc=je(xn.next),Uy=je(function*(){}().next),By=Bo(xn),Gy=DataView.prototype,ky=je(Gy.getUint16),zo=WeakMap,Tc=zo.prototype,wc=je(Tc.get),zy=je(Tc.set),vc=new zo,$y=Go(null,{next:{value:function(){const e=wc(vc,this);return bc(e)}},[Fn]:{value:function(){return this}}});function Vy(n){if(n[Fn]===_c&&xn.next===bc)return n;const e=Go($y);return zy(vc,e,Oy(n)),e}const jy=new zo,Xy=Go(By,{next:{value:function(){const e=wc(jy,this);return Uy(e)},writable:!0,configurable:!0}});for(const n of Ay(xn))n!=="next"&&Iy(Xy,n,mc(xn,n));const Sc=new yc(4),Hy=new Dy(Sc),Wy=new ko(Sc),Tt=new Ec(512),wt=new Ny(512);for(let n=0;n<256;++n){const e=n-127;e<-24?(Tt[n]=0,Tt[n|256]=32768,wt[n]=24,wt[n|256]=24):e<-14?(Tt[n]=1024>>-e-14,Tt[n|256]=1024>>-e-14|32768,wt[n]=-e-1,wt[n|256]=-e-1):e<=15?(Tt[n]=e+15<<10,Tt[n|256]=e+15<<10|32768,wt[n]=13,wt[n|256]=13):e<128?(Tt[n]=31744,Tt[n|256]=64512,wt[n]=24,wt[n|256]=24):(Tt[n]=31744,Tt[n|256]=64512,wt[n]=13,wt[n|256]=13)}const $o=new ko(2048);for(let n=1;n<1024;++n){let e=n<<13,t=0;for(;!(e&8388608);)e<<=1,t-=8388608;e&=-8388609,t+=947912704,$o[n]=e|t}for(let n=1024;n<2048;++n)$o[n]=939524096+(n-1024<<13);const Zr=new ko(64);for(let n=1;n<31;++n)Zr[n]=n<<23;Zr[31]=1199570944;Zr[32]=2147483648;for(let n=33;n<63;++n)Zr[n]=2147483648+(n-32<<23);Zr[63]=3347054592;const Rc=new Ec(64);for(let n=1;n<64;++n)n!==32&&(Rc[n]=1024);function Zy(n){const e=n>>10;return Wy[0]=$o[Rc[e]+(n&1023)]+Zr[e],Hy[0]}function Ac(n,e,...t){return Zy(ky(n,e,...Vy(t)))}var Vo={exports:{}};function Pc(n,e,t){const r=t&&t.debug||!1;r&&console.log("[xml-utils] getting "+e+" in "+n);const i=typeof n=="object"?n.outer:n,s=i.slice(0,i.indexOf(">")+1),o=['"',"'"];for(let a=0;a<o.length;a++){const l=o[a],u=e+"\\="+l+"([^"+l+"]*)"+l;r&&console.log("[xml-utils] pattern:",u);const c=new RegExp(u).exec(s);if(r&&console.log("[xml-utils] match:",c),c)return c[1]}}Vo.exports=Pc;Vo.exports.default=Pc;var Yy=Vo.exports;const is=Ni(Yy);var jo={exports:{}},Xo={exports:{}},Ho={exports:{}};function Lc(n,e,t){const i=new RegExp(e).exec(n.slice(t));return i?t+i.index:-1}Ho.exports=Lc;Ho.exports.default=Lc;var qy=Ho.exports,Wo={exports:{}};function Ic(n,e,t){const i=new RegExp(e).exec(n.slice(t));return i?t+i.index+i[0].length-1:-1}Wo.exports=Ic;Wo.exports.default=Ic;var Ky=Wo.exports,Zo={exports:{}};function Cc(n,e){const t=new RegExp(e,"g"),r=n.match(t);return r?r.length:0}Zo.exports=Cc;Zo.exports.default=Cc;var Qy=Zo.exports;const Jy=qy,ss=Ky,hl=Qy;function Fc(n,e,t){const r=t&&t.debug||!1,i=!(t&&typeof t.nested===!1),s=t&&t.startIndex||0;r&&console.log("[xml-utils] starting findTagByName with",e," and ",t);const o=Jy(n,`<${e}[ 
>/]`,s);if(r&&console.log("[xml-utils] start:",o),o===-1)return;const a=n.slice(o+e.length);let l=ss(a,"^[^<]*[ /]>",0);const u=l!==-1&&a[l-1]==="/";if(r&&console.log("[xml-utils] selfClosing:",u),u===!1)if(i){let g=0,p=1,_=0;for(;(l=ss(a,"[ /]"+e+">",g))!==-1;){const x=a.substring(g,l+1);if(p+=hl(x,"<"+e+`[ 
	>]`),_+=hl(x,"</"+e+">"),_>=p)break;g=l}}else l=ss(a,"[ /]"+e+">",0);const f=o+e.length+l+1;if(r&&console.log("[xml-utils] end:",f),f===-1)return;const c=n.slice(o,f);let d;return u?d=null:d=c.slice(c.indexOf(">")+1,c.lastIndexOf("<")),{inner:d,outer:c,start:o,end:f}}Xo.exports=Fc;Xo.exports.default=Fc;var e0=Xo.exports;const t0=e0;function Oc(n,e,t){const r=[],i=t&&t.debug||!1,s=t&&typeof t.nested=="boolean"?t.nested:!0;let o=t&&t.startIndex||0,a;for(;a=t0(n,e,{debug:i,startIndex:o});)s?o=a.start+1+e.length:o=a.end,r.push(a);return i&&console.log("findTagsByName found",r.length,"tags"),r}jo.exports=Oc;jo.exports.default=Oc;var r0=jo.exports;const n0=Ni(r0),cn={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop",33550:"ModelPixelScale",33922:"ModelTiepoint",34264:"ModelTransformation",34735:"GeoKeyDirectory",34736:"GeoDoubleParams",34737:"GeoAsciiParams",50674:"LercParameters"},vt={};for(const n in cn)cn.hasOwnProperty(n)&&(vt[cn[n]]=parseInt(n,10));const i0=[vt.BitsPerSample,vt.ExtraSamples,vt.SampleFormat,vt.StripByteCounts,vt.StripOffsets,vt.StripRowCounts,vt.TileByteCounts,vt.TileOffsets,vt.SubIFDs],os={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE",13:"IFD",16:"LONG8",17:"SLONG8",18:"IFD8"},oe={};for(const n in os)os.hasOwnProperty(n)&&(oe[os[n]]=parseInt(n,10));const Je={WhiteIsZero:0,BlackIsZero:1,RGB:2,Palette:3,CMYK:5,YCbCr:6,CIELab:8,ICCLab:9},s0={Unspecified:0},Cb={AddCompression:1},Fb={None:0,Deflate:1,Zstandard:2},o0={1024:"GTModelTypeGeoKey",1025:"GTRasterTypeGeoKey",1026:"GTCitationGeoKey",2048:"GeographicTypeGeoKey",2049:"GeogCitationGeoKey",2050:"GeogGeodeticDatumGeoKey",2051:"GeogPrimeMeridianGeoKey",2052:"GeogLinearUnitsGeoKey",2053:"GeogLinearUnitSizeGeoKey",2054:"GeogAngularUnitsGeoKey",2055:"GeogAngularUnitSizeGeoKey",2056:"GeogEllipsoidGeoKey",2057:"GeogSemiMajorAxisGeoKey",2058:"GeogSemiMinorAxisGeoKey",2059:"GeogInvFlatteningGeoKey",2060:"GeogAzimuthUnitsGeoKey",2061:"GeogPrimeMeridianLongGeoKey",2062:"GeogTOWGS84GeoKey",3072:"ProjectedCSTypeGeoKey",3073:"PCSCitationGeoKey",3074:"ProjectionGeoKey",3075:"ProjCoordTransGeoKey",3076:"ProjLinearUnitsGeoKey",3077:"ProjLinearUnitSizeGeoKey",3078:"ProjStdParallel1GeoKey",3079:"ProjStdParallel2GeoKey",3080:"ProjNatOriginLongGeoKey",3081:"ProjNatOriginLatGeoKey",3082:"ProjFalseEastingGeoKey",3083:"ProjFalseNorthingGeoKey",3084:"ProjFalseOriginLongGeoKey",3085:"ProjFalseOriginLatGeoKey",3086:"ProjFalseOriginEastingGeoKey",3087:"ProjFalseOriginNorthingGeoKey",3088:"ProjCenterLongGeoKey",3089:"ProjCenterLatGeoKey",3090:"ProjCenterEastingGeoKey",3091:"ProjCenterNorthingGeoKey",3092:"ProjScaleAtNatOriginGeoKey",3093:"ProjScaleAtCenterGeoKey",3094:"ProjAzimuthAngleGeoKey",3095:"ProjStraightVertPoleLongGeoKey",3096:"ProjRectifiedGridAngleGeoKey",4096:"VerticalCSTypeGeoKey",4097:"VerticalCitationGeoKey",4098:"VerticalDatumGeoKey",4099:"VerticalUnitsGeoKey"};function a0(n,e){const{width:t,height:r}=n,i=new Uint8Array(t*r*3);let s;for(let o=0,a=0;o<n.length;++o,a+=3)s=256-n[o]/e*256,i[a]=s,i[a+1]=s,i[a+2]=s;return i}function l0(n,e){const{width:t,height:r}=n,i=new Uint8Array(t*r*3);let s;for(let o=0,a=0;o<n.length;++o,a+=3)s=n[o]/e*256,i[a]=s,i[a+1]=s,i[a+2]=s;return i}function u0(n,e){const{width:t,height:r}=n,i=new Uint8Array(t*r*3),s=e.length/3,o=e.length/3*2;for(let a=0,l=0;a<n.length;++a,l+=3){const u=n[a];i[l]=e[u]/65536*256,i[l+1]=e[u+s]/65536*256,i[l+2]=e[u+o]/65536*256}return i}function c0(n){const{width:e,height:t}=n,r=new Uint8Array(e*t*3);for(let i=0,s=0;i<n.length;i+=4,s+=3){const o=n[i],a=n[i+1],l=n[i+2],u=n[i+3];r[s]=255*((255-o)/256)*((255-u)/256),r[s+1]=255*((255-a)/256)*((255-u)/256),r[s+2]=255*((255-l)/256)*((255-u)/256)}return r}function h0(n){const{width:e,height:t}=n,r=new Uint8ClampedArray(e*t*3);for(let i=0,s=0;i<n.length;i+=3,s+=3){const o=n[i],a=n[i+1],l=n[i+2];r[s]=o+1.402*(l-128),r[s+1]=o-.34414*(a-128)-.71414*(l-128),r[s+2]=o+1.772*(a-128)}return r}const f0=.95047,d0=1,p0=1.08883;function g0(n){const{width:e,height:t}=n,r=new Uint8Array(e*t*3);for(let i=0,s=0;i<n.length;i+=3,s+=3){const o=n[i+0],a=n[i+1]<<24>>24,l=n[i+2]<<24>>24;let u=(o+16)/116,f=a/500+u,c=u-l/200,d,g,p;f=f0*(f*f*f>.008856?f*f*f:(f-16/116)/7.787),u=d0*(u*u*u>.008856?u*u*u:(u-16/116)/7.787),c=p0*(c*c*c>.008856?c*c*c:(c-16/116)/7.787),d=f*3.2406+u*-1.5372+c*-.4986,g=f*-.9689+u*1.8758+c*.0415,p=f*.0557+u*-.204+c*1.057,d=d>.0031308?1.055*d**(1/2.4)-.055:12.92*d,g=g>.0031308?1.055*g**(1/2.4)-.055:12.92*g,p=p>.0031308?1.055*p**(1/2.4)-.055:12.92*p,r[s]=Math.max(0,Math.min(1,d))*255,r[s+1]=Math.max(0,Math.min(1,g))*255,r[s+2]=Math.max(0,Math.min(1,p))*255}return r}const Mc=new Map;function rr(n,e){Array.isArray(n)||(n=[n]),n.forEach(t=>Mc.set(t,e))}async function Nc(n){const e=Mc.get(n.Compression);if(!e)throw new Error(`Unknown compression method identifier: ${n.Compression}`);const t=await e();return new t(n)}rr([void 0,1],()=>tr(()=>import("./raw.DxtaBMev.js"),__vite__mapDeps([0,1])).then(n=>n.default));rr(5,()=>tr(()=>import("./lzw.BikwkTY2.js"),__vite__mapDeps([2,1])).then(n=>n.default));rr(6,()=>{throw new Error("old style JPEG compression is not supported.")});rr(7,()=>tr(()=>import("./jpeg.CbvpOiPg.js"),__vite__mapDeps([3,1])).then(n=>n.default));rr([8,32946],()=>tr(()=>import("./deflate.B4_27dB1.js"),__vite__mapDeps([4,5,1])).then(n=>n.default));rr(32773,()=>tr(()=>import("./packbits.D6Qr5eNi.js"),__vite__mapDeps([6,1])).then(n=>n.default));rr(34887,()=>tr(()=>import("./lerc.DAuOJrWD.js"),__vite__mapDeps([7,5,8,1,9,10])).then(async n=>(await n.zstd.init(),n)).then(n=>n.default));rr(50001,()=>tr(()=>import("./webimage.CU41Mh7j.js"),__vite__mapDeps([11,1])).then(n=>n.default));function ji(n,e,t,r=1){return new(Object.getPrototypeOf(n)).constructor(e*t*r)}function m0(n,e,t,r,i){const s=e/r,o=t/i;return n.map(a=>{const l=ji(a,r,i);for(let u=0;u<i;++u){const f=Math.min(Math.round(o*u),t-1);for(let c=0;c<r;++c){const d=Math.min(Math.round(s*c),e-1),g=a[f*e+d];l[u*r+c]=g}}return l})}function Cr(n,e,t){return(1-t)*n+t*e}function _0(n,e,t,r,i){const s=e/r,o=t/i;return n.map(a=>{const l=ji(a,r,i);for(let u=0;u<i;++u){const f=o*u,c=Math.floor(f),d=Math.min(Math.ceil(f),t-1);for(let g=0;g<r;++g){const p=s*g,_=p%1,x=Math.floor(p),T=Math.min(Math.ceil(p),e-1),E=a[c*e+x],w=a[c*e+T],A=a[d*e+x],P=a[d*e+T],C=Cr(Cr(E,w,_),Cr(A,P,_),f%1);l[u*r+g]=C}}return l})}function y0(n,e,t,r,i,s="nearest"){switch(s.toLowerCase()){case"nearest":return m0(n,e,t,r,i);case"bilinear":case"linear":return _0(n,e,t,r,i);default:throw new Error(`Unsupported resampling method: '${s}'`)}}function x0(n,e,t,r,i,s){const o=e/r,a=t/i,l=ji(n,r,i,s);for(let u=0;u<i;++u){const f=Math.min(Math.round(a*u),t-1);for(let c=0;c<r;++c){const d=Math.min(Math.round(o*c),e-1);for(let g=0;g<s;++g){const p=n[f*e*s+d*s+g];l[u*r*s+c*s+g]=p}}}return l}function E0(n,e,t,r,i,s){const o=e/r,a=t/i,l=ji(n,r,i,s);for(let u=0;u<i;++u){const f=a*u,c=Math.floor(f),d=Math.min(Math.ceil(f),t-1);for(let g=0;g<r;++g){const p=o*g,_=p%1,x=Math.floor(p),T=Math.min(Math.ceil(p),e-1);for(let E=0;E<s;++E){const w=n[c*e*s+x*s+E],A=n[c*e*s+T*s+E],P=n[d*e*s+x*s+E],C=n[d*e*s+T*s+E],N=Cr(Cr(w,A,_),Cr(P,C,_),f%1);l[u*r*s+g*s+E]=N}}}return l}function b0(n,e,t,r,i,s,o="nearest"){switch(o.toLowerCase()){case"nearest":return x0(n,e,t,r,i,s);case"bilinear":case"linear":return E0(n,e,t,r,i,s);default:throw new Error(`Unsupported resampling method: '${o}'`)}}function T0(n,e,t){let r=0;for(let i=e;i<t;++i)r+=n[i];return r}function Fs(n,e,t){switch(n){case 1:if(e<=8)return new Uint8Array(t);if(e<=16)return new Uint16Array(t);if(e<=32)return new Uint32Array(t);break;case 2:if(e===8)return new Int8Array(t);if(e===16)return new Int16Array(t);if(e===32)return new Int32Array(t);break;case 3:switch(e){case 16:case 32:return new Float32Array(t);case 64:return new Float64Array(t)}break}throw Error("Unsupported data format/bitsPerSample")}function w0(n,e){return(n===1||n===2)&&e<=32&&e%8===0?!1:!(n===3&&(e===16||e===32||e===64))}function v0(n,e,t,r,i,s,o){const a=new DataView(n),l=t===2?o*s:o*s*r,u=t===2?1:r,f=Fs(e,i,l),c=parseInt("1".repeat(i),2);if(e===1){let d;t===1?d=r*i:d=i;let g=s*d;g&7&&(g=g+7&-8);for(let p=0;p<o;++p){const _=p*g;for(let x=0;x<s;++x){const T=_+x*u*i;for(let E=0;E<u;++E){const w=T+E*i,A=(p*s+x)*u+E,P=Math.floor(w/8),C=w%8;if(C+i<=8)f[A]=a.getUint8(P)>>8-i-C&c;else if(C+i<=16)f[A]=a.getUint16(P)>>16-i-C&c;else if(C+i<=24){const N=a.getUint16(P)<<8|a.getUint8(P+2);f[A]=N>>24-i-C&c}else f[A]=a.getUint32(P)>>32-i-C&c}}}}return f.buffer}class Dc{constructor(e,t,r,i,s,o){this.fileDirectory=e,this.geoKeys=t,this.dataView=r,this.littleEndian=i,this.tiles=s?{}:null,this.isTiled=!e.StripOffsets;const a=e.PlanarConfiguration;if(this.planarConfiguration=typeof a>"u"?1:a,this.planarConfiguration!==1&&this.planarConfiguration!==2)throw new Error("Invalid planar configuration.");this.source=o}getFileDirectory(){return this.fileDirectory}getGeoKeys(){return this.geoKeys}getWidth(){return this.fileDirectory.ImageWidth}getHeight(){return this.fileDirectory.ImageLength}getSamplesPerPixel(){return typeof this.fileDirectory.SamplesPerPixel<"u"?this.fileDirectory.SamplesPerPixel:1}getTileWidth(){return this.isTiled?this.fileDirectory.TileWidth:this.getWidth()}getTileHeight(){return this.isTiled?this.fileDirectory.TileLength:typeof this.fileDirectory.RowsPerStrip<"u"?Math.min(this.fileDirectory.RowsPerStrip,this.getHeight()):this.getHeight()}getBlockWidth(){return this.getTileWidth()}getBlockHeight(e){return this.isTiled||(e+1)*this.getTileHeight()<=this.getHeight()?this.getTileHeight():this.getHeight()-e*this.getTileHeight()}getBytesPerPixel(){let e=0;for(let t=0;t<this.fileDirectory.BitsPerSample.length;++t)e+=this.getSampleByteSize(t);return e}getSampleByteSize(e){if(e>=this.fileDirectory.BitsPerSample.length)throw new RangeError(`Sample index ${e} is out of range.`);return Math.ceil(this.fileDirectory.BitsPerSample[e]/8)}getReaderForSample(e){const t=this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[e]:1,r=this.fileDirectory.BitsPerSample[e];switch(t){case 1:if(r<=8)return DataView.prototype.getUint8;if(r<=16)return DataView.prototype.getUint16;if(r<=32)return DataView.prototype.getUint32;break;case 2:if(r<=8)return DataView.prototype.getInt8;if(r<=16)return DataView.prototype.getInt16;if(r<=32)return DataView.prototype.getInt32;break;case 3:switch(r){case 16:return function(i,s){return Ac(this,i,s)};case 32:return DataView.prototype.getFloat32;case 64:return DataView.prototype.getFloat64}break}throw Error("Unsupported data format/bitsPerSample")}getSampleFormat(e=0){return this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[e]:1}getBitsPerSample(e=0){return this.fileDirectory.BitsPerSample[e]}getArrayForSample(e,t){const r=this.getSampleFormat(e),i=this.getBitsPerSample(e);return Fs(r,i,t)}async getTileOrStrip(e,t,r,i,s){const o=Math.ceil(this.getWidth()/this.getTileWidth()),a=Math.ceil(this.getHeight()/this.getTileHeight());let l;const{tiles:u}=this;this.planarConfiguration===1?l=t*o+e:this.planarConfiguration===2&&(l=r*o*a+t*o+e);let f,c;this.isTiled?(f=this.fileDirectory.TileOffsets[l],c=this.fileDirectory.TileByteCounts[l]):(f=this.fileDirectory.StripOffsets[l],c=this.fileDirectory.StripByteCounts[l]);const d=(await this.source.fetch([{offset:f,length:c}],s))[0];let g;return u===null||!u[l]?(g=(async()=>{let p=await i.decode(this.fileDirectory,d);const _=this.getSampleFormat(),x=this.getBitsPerSample();return w0(_,x)&&(p=v0(p,_,this.planarConfiguration,this.getSamplesPerPixel(),x,this.getTileWidth(),this.getBlockHeight(t))),p})(),u!==null&&(u[l]=g)):g=u[l],{x:e,y:t,sample:r,data:await g}}async _readRaster(e,t,r,i,s,o,a,l,u){const f=this.getTileWidth(),c=this.getTileHeight(),d=this.getWidth(),g=this.getHeight(),p=Math.max(Math.floor(e[0]/f),0),_=Math.min(Math.ceil(e[2]/f),Math.ceil(d/f)),x=Math.max(Math.floor(e[1]/c),0),T=Math.min(Math.ceil(e[3]/c),Math.ceil(g/c)),E=e[2]-e[0];let w=this.getBytesPerPixel();const A=[],P=[];for(let U=0;U<t.length;++U)this.planarConfiguration===1?A.push(T0(this.fileDirectory.BitsPerSample,0,t[U])/8):A.push(0),P.push(this.getReaderForSample(t[U]));const C=[],{littleEndian:N}=this;for(let U=x;U<T;++U)for(let k=p;k<_;++k){let D;this.planarConfiguration===1&&(D=this.getTileOrStrip(k,U,0,s,u));for(let j=0;j<t.length;++j){const X=j,h=t[j];this.planarConfiguration===2&&(w=this.getSampleByteSize(h),D=this.getTileOrStrip(k,U,h,s,u));const m=D.then(y=>{const b=y.data,R=new DataView(b),O=this.getBlockHeight(y.y),F=y.y*c,M=y.x*f,z=F+O,W=(y.x+1)*f,Y=P[X],ee=Math.min(O,O-(z-e[3]),g-F),te=Math.min(f,f-(W-e[2]),d-M);for(let re=Math.max(0,e[1]-F);re<ee;++re)for(let de=Math.max(0,e[0]-M);de<te;++de){const Oe=(re*f+de)*w,Pe=Y.call(R,Oe+A[X],N);let De;i?(De=(re+F-e[1])*E*t.length+(de+M-e[0])*t.length+X,r[De]=Pe):(De=(re+F-e[1])*E+de+M-e[0],r[X][De]=Pe)}});C.push(m)}}if(await Promise.all(C),o&&e[2]-e[0]!==o||a&&e[3]-e[1]!==a){let U;return i?U=b0(r,e[2]-e[0],e[3]-e[1],o,a,t.length,l):U=y0(r,e[2]-e[0],e[3]-e[1],o,a,l),U.width=o,U.height=a,U}return r.width=o||e[2]-e[0],r.height=a||e[3]-e[1],r}async readRasters({window:e,samples:t=[],interleave:r,pool:i=null,width:s,height:o,resampleMethod:a,fillValue:l,signal:u}={}){const f=e||[0,0,this.getWidth(),this.getHeight()];if(f[0]>f[2]||f[1]>f[3])throw new Error("Invalid subsets");const c=f[2]-f[0],d=f[3]-f[1],g=c*d,p=this.getSamplesPerPixel();if(!t||!t.length)for(let E=0;E<p;++E)t.push(E);else for(let E=0;E<t.length;++E)if(t[E]>=p)return Promise.reject(new RangeError(`Invalid sample index '${t[E]}'.`));let _;if(r){const E=this.fileDirectory.SampleFormat?Math.max.apply(null,this.fileDirectory.SampleFormat):1,w=Math.max.apply(null,this.fileDirectory.BitsPerSample);_=Fs(E,w,g*t.length),l&&_.fill(l)}else{_=[];for(let E=0;E<t.length;++E){const w=this.getArrayForSample(t[E],g);Array.isArray(l)&&E<l.length?w.fill(l[E]):l&&!Array.isArray(l)&&w.fill(l),_.push(w)}}const x=i||await Nc(this.fileDirectory);return await this._readRaster(f,t,_,r,x,s,o,a,u)}async readRGB({window:e,interleave:t=!0,pool:r=null,width:i,height:s,resampleMethod:o,enableAlpha:a=!1,signal:l}={}){const u=e||[0,0,this.getWidth(),this.getHeight()];if(u[0]>u[2]||u[1]>u[3])throw new Error("Invalid subsets");const f=this.fileDirectory.PhotometricInterpretation;if(f===Je.RGB){let T=[0,1,2];if(this.fileDirectory.ExtraSamples!==s0.Unspecified&&a){T=[];for(let E=0;E<this.fileDirectory.BitsPerSample.length;E+=1)T.push(E)}return this.readRasters({window:e,interleave:t,samples:T,pool:r,width:i,height:s,resampleMethod:o,signal:l})}let c;switch(f){case Je.WhiteIsZero:case Je.BlackIsZero:case Je.Palette:c=[0];break;case Je.CMYK:c=[0,1,2,3];break;case Je.YCbCr:case Je.CIELab:c=[0,1,2];break;default:throw new Error("Invalid or unsupported photometric interpretation.")}const d={window:u,interleave:!0,samples:c,pool:r,width:i,height:s,resampleMethod:o,signal:l},{fileDirectory:g}=this,p=await this.readRasters(d),_=2**this.fileDirectory.BitsPerSample[0];let x;switch(f){case Je.WhiteIsZero:x=a0(p,_);break;case Je.BlackIsZero:x=l0(p,_);break;case Je.Palette:x=u0(p,g.ColorMap);break;case Je.CMYK:x=c0(p);break;case Je.YCbCr:x=h0(p);break;case Je.CIELab:x=g0(p);break;default:throw new Error("Unsupported photometric interpretation.")}if(!t){const T=new Uint8Array(x.length/3),E=new Uint8Array(x.length/3),w=new Uint8Array(x.length/3);for(let A=0,P=0;A<x.length;A+=3,++P)T[P]=x[A],E[P]=x[A+1],w[P]=x[A+2];x=[T,E,w]}return x.width=p.width,x.height=p.height,x}getTiePoints(){if(!this.fileDirectory.ModelTiepoint)return[];const e=[];for(let t=0;t<this.fileDirectory.ModelTiepoint.length;t+=6)e.push({i:this.fileDirectory.ModelTiepoint[t],j:this.fileDirectory.ModelTiepoint[t+1],k:this.fileDirectory.ModelTiepoint[t+2],x:this.fileDirectory.ModelTiepoint[t+3],y:this.fileDirectory.ModelTiepoint[t+4],z:this.fileDirectory.ModelTiepoint[t+5]});return e}getGDALMetadata(e=null){const t={};if(!this.fileDirectory.GDAL_METADATA)return null;const r=this.fileDirectory.GDAL_METADATA;let i=n0(r,"Item");e===null?i=i.filter(s=>is(s,"sample")===void 0):i=i.filter(s=>Number(is(s,"sample"))===e);for(let s=0;s<i.length;++s){const o=i[s];t[is(o,"name")]=o.inner}return t}getGDALNoData(){if(!this.fileDirectory.GDAL_NODATA)return null;const e=this.fileDirectory.GDAL_NODATA;return Number(e.substring(0,e.length-1))}getOrigin(){const e=this.fileDirectory.ModelTiepoint,t=this.fileDirectory.ModelTransformation;if(e&&e.length===6)return[e[3],e[4],e[5]];if(t)return[t[3],t[7],t[11]];throw new Error("The image does not have an affine transformation.")}getResolution(e=null){const t=this.fileDirectory.ModelPixelScale,r=this.fileDirectory.ModelTransformation;if(t)return[t[0],-t[1],t[2]];if(r)return r[1]===0&&r[4]===0?[r[0],-r[5],r[10]]:[Math.sqrt(r[0]*r[0]+r[4]*r[4]),-Math.sqrt(r[1]*r[1]+r[5]*r[5]),r[10]];if(e){const[i,s,o]=e.getResolution();return[i*e.getWidth()/this.getWidth(),s*e.getHeight()/this.getHeight(),o*e.getWidth()/this.getWidth()]}throw new Error("The image does not have an affine transformation.")}pixelIsArea(){return this.geoKeys.GTRasterTypeGeoKey===1}getBoundingBox(e=!1){const t=this.getHeight(),r=this.getWidth();if(this.fileDirectory.ModelTransformation&&!e){const[i,s,o,a,l,u,f,c]=this.fileDirectory.ModelTransformation,g=[[0,0],[0,t],[r,0],[r,t]].map(([x,T])=>[a+i*x+s*T,c+l*x+u*T]),p=g.map(x=>x[0]),_=g.map(x=>x[1]);return[Math.min(...p),Math.min(..._),Math.max(...p),Math.max(..._)]}else{const i=this.getOrigin(),s=this.getResolution(),o=i[0],a=i[1],l=o+s[0]*r,u=a+s[1]*t;return[Math.min(o,l),Math.min(a,u),Math.max(o,l),Math.max(a,u)]}}}class S0{constructor(e){this._dataView=new DataView(e)}get buffer(){return this._dataView.buffer}getUint64(e,t){const r=this.getUint32(e,t),i=this.getUint32(e+4,t);let s;if(t){if(s=r+2**32*i,!Number.isSafeInteger(s))throw new Error(`${s} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return s}if(s=2**32*r+i,!Number.isSafeInteger(s))throw new Error(`${s} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return s}getInt64(e,t){let r=0;const i=(this._dataView.getUint8(e+(t?7:0))&128)>0;let s=!0;for(let o=0;o<8;o++){let a=this._dataView.getUint8(e+(t?o:7-o));i&&(s?a!==0&&(a=~(a-1)&255,s=!1):a=~a&255),r+=a*256**o}return i&&(r=-r),r}getUint8(e,t){return this._dataView.getUint8(e,t)}getInt8(e,t){return this._dataView.getInt8(e,t)}getUint16(e,t){return this._dataView.getUint16(e,t)}getInt16(e,t){return this._dataView.getInt16(e,t)}getUint32(e,t){return this._dataView.getUint32(e,t)}getInt32(e,t){return this._dataView.getInt32(e,t)}getFloat16(e,t){return Ac(this._dataView,e,t)}getFloat32(e,t){return this._dataView.getFloat32(e,t)}getFloat64(e,t){return this._dataView.getFloat64(e,t)}}class R0{constructor(e,t,r,i){this._dataView=new DataView(e),this._sliceOffset=t,this._littleEndian=r,this._bigTiff=i}get sliceOffset(){return this._sliceOffset}get sliceTop(){return this._sliceOffset+this.buffer.byteLength}get littleEndian(){return this._littleEndian}get bigTiff(){return this._bigTiff}get buffer(){return this._dataView.buffer}covers(e,t){return this.sliceOffset<=e&&this.sliceTop>=e+t}readUint8(e){return this._dataView.getUint8(e-this._sliceOffset,this._littleEndian)}readInt8(e){return this._dataView.getInt8(e-this._sliceOffset,this._littleEndian)}readUint16(e){return this._dataView.getUint16(e-this._sliceOffset,this._littleEndian)}readInt16(e){return this._dataView.getInt16(e-this._sliceOffset,this._littleEndian)}readUint32(e){return this._dataView.getUint32(e-this._sliceOffset,this._littleEndian)}readInt32(e){return this._dataView.getInt32(e-this._sliceOffset,this._littleEndian)}readFloat32(e){return this._dataView.getFloat32(e-this._sliceOffset,this._littleEndian)}readFloat64(e){return this._dataView.getFloat64(e-this._sliceOffset,this._littleEndian)}readUint64(e){const t=this.readUint32(e),r=this.readUint32(e+4);let i;if(this._littleEndian){if(i=t+2**32*r,!Number.isSafeInteger(i))throw new Error(`${i} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return i}if(i=2**32*t+r,!Number.isSafeInteger(i))throw new Error(`${i} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return i}readInt64(e){let t=0;const r=(this._dataView.getUint8(e+(this._littleEndian?7:0))&128)>0;let i=!0;for(let s=0;s<8;s++){let o=this._dataView.getUint8(e+(this._littleEndian?s:7-s));r&&(i?o!==0&&(o=~(o-1)&255,i=!1):o=~o&255),t+=o*256**s}return r&&(t=-t),t}readOffset(e){return this._bigTiff?this.readUint64(e):this.readUint32(e)}}const A0=typeof navigator<"u"&&navigator.hardwareConcurrency||2;class P0{constructor(e=A0,t){this.workers=null,this._awaitingDecoder=null,this.size=e,this.messageId=0,e&&(this._awaitingDecoder=t?Promise.resolve(t):new Promise(r=>{tr(()=>import("./decoder.tqM1uIvc.js"),[]).then(i=>{r(i.create)})}),this._awaitingDecoder.then(r=>{this._awaitingDecoder=null,this.workers=[];for(let i=0;i<e;i++)this.workers.push({worker:r(),idle:!0})}))}async decode(e,t){return this._awaitingDecoder&&await this._awaitingDecoder,this.size===0?Nc(e).then(r=>r.decode(e,t)):new Promise(r=>{const i=this.workers.find(a=>a.idle)||this.workers[Math.floor(Math.random()*this.size)];i.idle=!1;const s=this.messageId++,o=a=>{a.data.id===s&&(i.idle=!0,r(a.data.decoded),i.worker.removeEventListener("message",o))};i.worker.addEventListener("message",o),i.worker.postMessage({fileDirectory:e,buffer:t,id:s},[t])})}destroy(){this.workers&&(this.workers.forEach(e=>{e.worker.terminate()}),this.workers=null)}}const fl=`\r
\r
`;function Uc(n){if(typeof Object.fromEntries<"u")return Object.fromEntries(n);const e={};for(const[t,r]of n)e[t.toLowerCase()]=r;return e}function L0(n){const e=n.split(`\r
`).map(t=>{const r=t.split(":").map(i=>i.trim());return r[0]=r[0].toLowerCase(),r});return Uc(e)}function I0(n){const[e,...t]=n.split(";").map(i=>i.trim()),r=t.map(i=>i.split("="));return{type:e,params:Uc(r)}}function Os(n){let e,t,r;return n&&([,e,t,r]=n.match(/bytes (\d+)-(\d+)\/(\d+)/),e=parseInt(e,10),t=parseInt(t,10),r=parseInt(r,10)),{start:e,end:t,total:r}}function C0(n,e){let t=null;const r=new TextDecoder("ascii"),i=[],s=`--${e}`,o=`${s}--`;for(let a=0;a<10;++a)r.decode(new Uint8Array(n,a,s.length))===s&&(t=a);if(t===null)throw new Error("Could not find initial boundary");for(;t<n.byteLength;){const a=r.decode(new Uint8Array(n,t,Math.min(s.length+1024,n.byteLength-t)));if(a.length===0||a.startsWith(o))break;if(!a.startsWith(s))throw new Error("Part does not start with boundary");const l=a.substr(s.length+2);if(l.length===0)break;const u=l.indexOf(fl),f=L0(l.substr(0,u)),{start:c,end:d,total:g}=Os(f["content-range"]),p=t+s.length+u+fl.length,_=parseInt(d,10)+1-parseInt(c,10);i.push({headers:f,data:n.slice(p,p+_),offset:c,length:_,fileSize:g}),t=p+_+4}return i}class Yo{async fetch(e,t=void 0){return Promise.all(e.map(r=>this.fetchSlice(r,t)))}async fetchSlice(e){throw new Error(`fetching of slice ${e} not possible, not implemented`)}get fileSize(){return null}async close(){}}class F0 extends Map{constructor(e={}){if(super(),!(e.maxSize&&e.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof e.maxAge=="number"&&e.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=e.maxSize,this.maxAge=e.maxAge||Number.POSITIVE_INFINITY,this.onEviction=e.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(e){if(typeof this.onEviction=="function")for(const[t,r]of e)this.onEviction(t,r.value)}_deleteIfExpired(e,t){return typeof t.expiry=="number"&&t.expiry<=Date.now()?(typeof this.onEviction=="function"&&this.onEviction(e,t.value),this.delete(e)):!1}_getOrDeleteIfExpired(e,t){if(this._deleteIfExpired(e,t)===!1)return t.value}_getItemValue(e,t){return t.expiry?this._getOrDeleteIfExpired(e,t):t.value}_peek(e,t){const r=t.get(e);return this._getItemValue(e,r)}_set(e,t){this.cache.set(e,t),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(e,t){this.oldCache.delete(e),this._set(e,t)}*_entriesAscending(){for(const e of this.oldCache){const[t,r]=e;this.cache.has(t)||this._deleteIfExpired(t,r)===!1&&(yield e)}for(const e of this.cache){const[t,r]=e;this._deleteIfExpired(t,r)===!1&&(yield e)}}get(e){if(this.cache.has(e)){const t=this.cache.get(e);return this._getItemValue(e,t)}if(this.oldCache.has(e)){const t=this.oldCache.get(e);if(this._deleteIfExpired(e,t)===!1)return this._moveToRecent(e,t),t.value}}set(e,t,{maxAge:r=this.maxAge}={}){const i=typeof r=="number"&&r!==Number.POSITIVE_INFINITY?Date.now()+r:void 0;return this.cache.has(e)?this.cache.set(e,{value:t,expiry:i}):this._set(e,{value:t,expiry:i}),this}has(e){return this.cache.has(e)?!this._deleteIfExpired(e,this.cache.get(e)):this.oldCache.has(e)?!this._deleteIfExpired(e,this.oldCache.get(e)):!1}peek(e){if(this.cache.has(e))return this._peek(e,this.cache);if(this.oldCache.has(e))return this._peek(e,this.oldCache)}delete(e){const t=this.cache.delete(e);return t&&this._size--,this.oldCache.delete(e)||t}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(e){if(!(e&&e>0))throw new TypeError("`maxSize` must be a number greater than 0");const t=[...this._entriesAscending()],r=t.length-e;r<0?(this.cache=new Map(t),this.oldCache=new Map,this._size=t.length):(r>0&&this._emitEvictions(t.slice(0,r)),this.oldCache=new Map(t.slice(r)),this.cache=new Map,this._size=0),this.maxSize=e}*keys(){for(const[e]of this)yield e}*values(){for(const[,e]of this)yield e}*[Symbol.iterator](){for(const e of this.cache){const[t,r]=e;this._deleteIfExpired(t,r)===!1&&(yield[t,r.value])}for(const e of this.oldCache){const[t,r]=e;this.cache.has(t)||this._deleteIfExpired(t,r)===!1&&(yield[t,r.value])}}*entriesDescending(){let e=[...this.cache];for(let t=e.length-1;t>=0;--t){const r=e[t],[i,s]=r;this._deleteIfExpired(i,s)===!1&&(yield[i,s.value])}e=[...this.oldCache];for(let t=e.length-1;t>=0;--t){const r=e[t],[i,s]=r;this.cache.has(i)||this._deleteIfExpired(i,s)===!1&&(yield[i,s.value])}}*entriesAscending(){for(const[e,t]of this._entriesAscending())yield[e,t.value]}get size(){if(!this._size)return this.oldCache.size;let e=0;for(const t of this.oldCache.keys())this.cache.has(t)||e++;return Math.min(this._size+e,this.maxSize)}entries(){return this.entriesAscending()}forEach(e,t=this){for(const[r,i]of this.entriesAscending())e.call(t,i,r,this)}get[Symbol.toStringTag](){return JSON.stringify([...this.entriesAscending()])}}async function O0(n){return new Promise(e=>setTimeout(e,n))}function M0(n,e){const t=Array.isArray(n)?n:Array.from(n),r=Array.isArray(e)?e:Array.from(e);return t.map((i,s)=>[i,r[s]])}class Ur extends Error{constructor(e){super(e),Error.captureStackTrace&&Error.captureStackTrace(this,Ur),this.name="AbortError"}}class N0 extends Error{constructor(e,t){super(t),this.errors=e,this.message=t,this.name="AggregateError"}}const D0=N0;class U0{constructor(e,t,r=null){this.offset=e,this.length=t,this.data=r}get top(){return this.offset+this.length}}class dl{constructor(e,t,r){this.offset=e,this.length=t,this.blockIds=r}}class B0 extends Yo{constructor(e,{blockSize:t=65536,cacheSize:r=100}={}){super(),this.source=e,this.blockSize=t,this.blockCache=new F0({maxSize:r,onEviction:(i,s)=>{this.evictedBlocks.set(i,s)}}),this.evictedBlocks=new Map,this.blockRequests=new Map,this.blockIdsToFetch=new Set,this.abortedBlockIds=new Set}get fileSize(){return this.source.fileSize}async fetch(e,t){const r=[],i=[],s=[];this.evictedBlocks.clear();for(const{offset:d,length:g}of e){let p=d+g;const{fileSize:_}=this;_!==null&&(p=Math.min(p,_));const x=Math.floor(d/this.blockSize)*this.blockSize;for(let T=x;T<p;T+=this.blockSize){const E=Math.floor(T/this.blockSize);!this.blockCache.has(E)&&!this.blockRequests.has(E)&&(this.blockIdsToFetch.add(E),i.push(E)),this.blockRequests.has(E)&&r.push(this.blockRequests.get(E)),s.push(E)}}await O0(),this.fetchBlocks(t);const o=[];for(const d of i)this.blockRequests.has(d)&&o.push(this.blockRequests.get(d));await Promise.allSettled(r),await Promise.allSettled(o);const a=[],l=s.filter(d=>this.abortedBlockIds.has(d)||!this.blockCache.has(d));if(l.forEach(d=>this.blockIdsToFetch.add(d)),l.length>0&&t&&!t.aborted){this.fetchBlocks(null);for(const d of l){const g=this.blockRequests.get(d);if(!g)throw new Error(`Block ${d} is not in the block requests`);a.push(g)}await Promise.allSettled(a)}if(t&&t.aborted)throw new Ur("Request was aborted");const u=s.map(d=>this.blockCache.get(d)||this.evictedBlocks.get(d)),f=u.filter(d=>!d);if(f.length)throw new D0(f,"Request failed");const c=new Map(M0(s,u));return this.readSliceData(e,c)}fetchBlocks(e){if(this.blockIdsToFetch.size>0){const t=this.groupBlocks(this.blockIdsToFetch),r=this.source.fetch(t,e);for(let i=0;i<t.length;++i){const s=t[i];for(const o of s.blockIds)this.blockRequests.set(o,(async()=>{try{const a=(await r)[i],l=o*this.blockSize,u=l-a.offset,f=Math.min(u+this.blockSize,a.data.byteLength),c=a.data.slice(u,f),d=new U0(l,c.byteLength,c,o);this.blockCache.set(o,d),this.abortedBlockIds.delete(o)}catch(a){if(a.name==="AbortError")a.signal=e,this.blockCache.delete(o),this.abortedBlockIds.add(o);else throw a}finally{this.blockRequests.delete(o)}})())}this.blockIdsToFetch.clear()}}groupBlocks(e){const t=Array.from(e).sort((o,a)=>o-a);if(t.length===0)return[];let r=[],i=null;const s=[];for(const o of t)i===null||i+1===o?(r.push(o),i=o):(s.push(new dl(r[0]*this.blockSize,r.length*this.blockSize,r)),r=[o],i=o);return s.push(new dl(r[0]*this.blockSize,r.length*this.blockSize,r)),s}readSliceData(e,t){return e.map(r=>{let i=r.offset+r.length;this.fileSize!==null&&(i=Math.min(this.fileSize,i));const s=Math.floor(r.offset/this.blockSize),o=Math.floor(i/this.blockSize),a=new ArrayBuffer(r.length),l=new Uint8Array(a);for(let u=s;u<=o;++u){const f=t.get(u),c=f.offset-r.offset,d=f.top-i;let g=0,p=0,_;c<0?g=-c:c>0&&(p=c),d<0?_=f.length-g:_=i-f.offset-g;const x=new Uint8Array(f.data,g,_);l.set(x,p)}return a})}}class qo{get ok(){return this.status>=200&&this.status<=299}get status(){throw new Error("not implemented")}getHeader(e){throw new Error("not implemented")}async getData(){throw new Error("not implemented")}}class Ko{constructor(e){this.url=e}async request({headers:e,signal:t}={}){throw new Error("request is not implemented")}}class G0 extends qo{constructor(e){super(),this.response=e}get status(){return this.response.status}getHeader(e){return this.response.headers.get(e)}async getData(){return this.response.arrayBuffer?await this.response.arrayBuffer():(await this.response.buffer()).buffer}}class k0 extends Ko{constructor(e,t){super(e),this.credentials=t}async request({headers:e,signal:t}={}){const r=await fetch(this.url,{headers:e,credentials:this.credentials,signal:t});return new G0(r)}}class z0 extends qo{constructor(e,t){super(),this.xhr=e,this.data=t}get status(){return this.xhr.status}getHeader(e){return this.xhr.getResponseHeader(e)}async getData(){return this.data}}class $0 extends Ko{constructRequest(e,t){return new Promise((r,i)=>{const s=new XMLHttpRequest;s.open("GET",this.url),s.responseType="arraybuffer";for(const[o,a]of Object.entries(e))s.setRequestHeader(o,a);s.onload=()=>{const o=s.response;r(new z0(s,o))},s.onerror=i,s.onabort=()=>i(new Ur("Request aborted")),s.send(),t&&(t.aborted&&s.abort(),t.addEventListener("abort",()=>s.abort()))})}async request({headers:e,signal:t}={}){return await this.constructRequest(e,t)}}const as={};class V0 extends qo{constructor(e,t){super(),this.response=e,this.dataPromise=t}get status(){return this.response.statusCode}getHeader(e){return this.response.headers[e]}async getData(){return await this.dataPromise}}class j0 extends Ko{constructor(e){super(e),this.parsedUrl=as.parse(this.url),this.httpApi=(this.parsedUrl.protocol==="http:",as)}constructRequest(e,t){return new Promise((r,i)=>{const s=this.httpApi.get({...this.parsedUrl,headers:e},o=>{const a=new Promise(l=>{const u=[];o.on("data",f=>{u.push(f)}),o.on("end",()=>{const f=Buffer.concat(u).buffer;l(f)}),o.on("error",i)});r(new V0(o,a))});s.on("error",i),t&&(t.aborted&&s.destroy(new Ur("Request aborted")),t.addEventListener("abort",()=>s.destroy(new Ur("Request aborted"))))})}async request({headers:e,signal:t}={}){return await this.constructRequest(e,t)}}class Qo extends Yo{constructor(e,t,r,i){super(),this.client=e,this.headers=t,this.maxRanges=r,this.allowFullFile=i,this._fileSize=null}async fetch(e,t){return this.maxRanges>=e.length?this.fetchSlices(e,t):(this.maxRanges>0&&e.length>1,Promise.all(e.map(r=>this.fetchSlice(r,t))))}async fetchSlices(e,t){const r=await this.client.request({headers:{...this.headers,Range:`bytes=${e.map(({offset:i,length:s})=>`${i}-${i+s}`).join(",")}`},signal:t});if(r.ok)if(r.status===206){const{type:i,params:s}=I0(r.getHeader("content-type"));if(i==="multipart/byteranges"){const c=C0(await r.getData(),s.boundary);return this._fileSize=c[0].fileSize||null,c}const o=await r.getData(),{start:a,end:l,total:u}=Os(r.getHeader("content-range"));this._fileSize=u||null;const f=[{data:o,offset:a,length:l-a}];if(e.length>1){const c=await Promise.all(e.slice(1).map(d=>this.fetchSlice(d,t)));return f.concat(c)}return f}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const i=await r.getData();return this._fileSize=i.byteLength,[{data:i,offset:0,length:i.byteLength}]}else throw new Error("Error fetching data.")}async fetchSlice(e,t){const{offset:r,length:i}=e,s=await this.client.request({headers:{...this.headers,Range:`bytes=${r}-${r+i}`},signal:t});if(s.ok)if(s.status===206){const o=await s.getData(),{total:a}=Os(s.getHeader("content-range"));return this._fileSize=a||null,{data:o,offset:r,length:i}}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const o=await s.getData();return this._fileSize=o.byteLength,{data:o,offset:0,length:o.byteLength}}else throw new Error("Error fetching data.")}get fileSize(){return this._fileSize}}function Jo(n,{blockSize:e,cacheSize:t}){return e===null?n:new B0(n,{blockSize:e,cacheSize:t})}function X0(n,{headers:e={},credentials:t,maxRanges:r=0,allowFullFile:i=!1,...s}={}){const o=new k0(n,t),a=new Qo(o,e,r,i);return Jo(a,s)}function H0(n,{headers:e={},maxRanges:t=0,allowFullFile:r=!1,...i}={}){const s=new $0(n),o=new Qo(s,e,t,r);return Jo(o,i)}function W0(n,{headers:e={},maxRanges:t=0,allowFullFile:r=!1,...i}={}){const s=new j0(n),o=new Qo(s,e,t,r);return Jo(o,i)}function Ms(n,{forceXHR:e=!1,...t}={}){return typeof fetch=="function"&&!e?X0(n,t):typeof XMLHttpRequest<"u"?H0(n,t):W0(n,t)}class Z0 extends Yo{constructor(e){super(),this.file=e}async fetchSlice(e,t){return new Promise((r,i)=>{const s=this.file.slice(e.offset,e.offset+e.length),o=new FileReader;o.onload=a=>r(a.target.result),o.onerror=i,o.onabort=i,o.readAsArrayBuffer(s),t&&t.addEventListener("abort",()=>o.abort())})}}function Y0(n){return new Z0(n)}function Ns(n){switch(n){case oe.BYTE:case oe.ASCII:case oe.SBYTE:case oe.UNDEFINED:return 1;case oe.SHORT:case oe.SSHORT:return 2;case oe.LONG:case oe.SLONG:case oe.FLOAT:case oe.IFD:return 4;case oe.RATIONAL:case oe.SRATIONAL:case oe.DOUBLE:case oe.LONG8:case oe.SLONG8:case oe.IFD8:return 8;default:throw new RangeError(`Invalid field type: ${n}`)}}function q0(n){const e=n.GeoKeyDirectory;if(!e)return null;const t={};for(let r=4;r<=e[3]*4;r+=4){const i=o0[e[r]],s=e[r+1]?cn[e[r+1]]:null,o=e[r+2],a=e[r+3];let l=null;if(!s)l=a;else{if(l=n[s],typeof l>"u"||l===null)throw new Error(`Could not get value of geoKey '${i}'.`);typeof l=="string"?l=l.substring(a,a+o-1):l.subarray&&(l=l.subarray(a,a+o),o===1&&(l=l[0]))}t[i]=l}return t}function Tr(n,e,t,r){let i=null,s=null;const o=Ns(e);switch(e){case oe.BYTE:case oe.ASCII:case oe.UNDEFINED:i=new Uint8Array(t),s=n.readUint8;break;case oe.SBYTE:i=new Int8Array(t),s=n.readInt8;break;case oe.SHORT:i=new Uint16Array(t),s=n.readUint16;break;case oe.SSHORT:i=new Int16Array(t),s=n.readInt16;break;case oe.LONG:case oe.IFD:i=new Uint32Array(t),s=n.readUint32;break;case oe.SLONG:i=new Int32Array(t),s=n.readInt32;break;case oe.LONG8:case oe.IFD8:i=new Array(t),s=n.readUint64;break;case oe.SLONG8:i=new Array(t),s=n.readInt64;break;case oe.RATIONAL:i=new Uint32Array(t*2),s=n.readUint32;break;case oe.SRATIONAL:i=new Int32Array(t*2),s=n.readInt32;break;case oe.FLOAT:i=new Float32Array(t),s=n.readFloat32;break;case oe.DOUBLE:i=new Float64Array(t),s=n.readFloat64;break;default:throw new RangeError(`Invalid field type: ${e}`)}if(e===oe.RATIONAL||e===oe.SRATIONAL)for(let a=0;a<t;a+=2)i[a]=s.call(n,r+a*o),i[a+1]=s.call(n,r+(a*o+4));else for(let a=0;a<t;++a)i[a]=s.call(n,r+a*o);return e===oe.ASCII?new TextDecoder("utf-8").decode(i):i}class K0{constructor(e,t,r){this.fileDirectory=e,this.geoKeyDirectory=t,this.nextIFDByteOffset=r}}class jn extends Error{constructor(e){super(`No image at index ${e}`),this.index=e}}class Bc{async readRasters(e={}){const{window:t,width:r,height:i}=e;let{resX:s,resY:o,bbox:a}=e;const l=await this.getImage();let u=l;const f=await this.getImageCount(),c=l.getBoundingBox();if(t&&a)throw new Error('Both "bbox" and "window" passed.');if(r||i){if(t){const[p,_]=l.getOrigin(),[x,T]=l.getResolution();a=[p+t[0]*x,_+t[1]*T,p+t[2]*x,_+t[3]*T]}const g=a||c;if(r){if(s)throw new Error("Both width and resX passed");s=(g[2]-g[0])/r}if(i){if(o)throw new Error("Both width and resY passed");o=(g[3]-g[1])/i}}if(s||o){const g=[];for(let p=0;p<f;++p){const _=await this.getImage(p),{SubfileType:x,NewSubfileType:T}=_.fileDirectory;(p===0||x===2||T&1)&&g.push(_)}g.sort((p,_)=>p.getWidth()-_.getWidth());for(let p=0;p<g.length;++p){const _=g[p],x=(c[2]-c[0])/_.getWidth(),T=(c[3]-c[1])/_.getHeight();if(u=_,s&&s>x||o&&o>T)break}}let d=t;if(a){const[g,p]=l.getOrigin(),[_,x]=u.getResolution(l);d=[Math.round((a[0]-g)/_),Math.round((a[1]-p)/x),Math.round((a[2]-g)/_),Math.round((a[3]-p)/x)],d=[Math.min(d[0],d[2]),Math.min(d[1],d[3]),Math.max(d[0],d[2]),Math.max(d[1],d[3])]}return u.readRasters({...e,window:d})}}class Br extends Bc{constructor(e,t,r,i,s={}){super(),this.source=e,this.littleEndian=t,this.bigTiff=r,this.firstIFDOffset=i,this.cache=s.cache||!1,this.ifdRequests=[],this.ghostValues=null}async getSlice(e,t){const r=this.bigTiff?4048:1024;return new R0((await this.source.fetch([{offset:e,length:typeof t<"u"?t:r}]))[0],e,this.littleEndian,this.bigTiff)}async parseFileDirectoryAt(e){const t=this.bigTiff?20:12,r=this.bigTiff?8:2;let i=await this.getSlice(e);const s=this.bigTiff?i.readUint64(e):i.readUint16(e),o=s*t+(this.bigTiff?16:6);i.covers(e,o)||(i=await this.getSlice(e,o));const a={};let l=e+(this.bigTiff?8:2);for(let c=0;c<s;l+=t,++c){const d=i.readUint16(l),g=i.readUint16(l+2),p=this.bigTiff?i.readUint64(l+4):i.readUint32(l+4);let _,x;const T=Ns(g),E=l+(this.bigTiff?12:8);if(T*p<=(this.bigTiff?8:4))_=Tr(i,g,p,E);else{const w=i.readOffset(E),A=Ns(g)*p;if(i.covers(w,A))_=Tr(i,g,p,w);else{const P=await this.getSlice(w,A);_=Tr(P,g,p,w)}}p===1&&i0.indexOf(d)===-1&&!(g===oe.RATIONAL||g===oe.SRATIONAL)?x=_[0]:x=_,a[cn[d]]=x}const u=q0(a),f=i.readOffset(e+r+t*s);return new K0(a,u,f)}async requestIFD(e){if(this.ifdRequests[e])return this.ifdRequests[e];if(e===0)return this.ifdRequests[e]=this.parseFileDirectoryAt(this.firstIFDOffset),this.ifdRequests[e];if(!this.ifdRequests[e-1])try{this.ifdRequests[e-1]=this.requestIFD(e-1)}catch(t){throw t instanceof jn?new jn(e):t}return this.ifdRequests[e]=(async()=>{const t=await this.ifdRequests[e-1];if(t.nextIFDByteOffset===0)throw new jn(e);return this.parseFileDirectoryAt(t.nextIFDByteOffset)})(),this.ifdRequests[e]}async getImage(e=0){const t=await this.requestIFD(e);return new Dc(t.fileDirectory,t.geoKeyDirectory,this.dataView,this.littleEndian,this.cache,this.source)}async getImageCount(){let e=0,t=!0;for(;t;)try{await this.requestIFD(e),++e}catch(r){if(r instanceof jn)t=!1;else throw r}return e}async getGhostValues(){const e=this.bigTiff?16:8;if(this.ghostValues)return this.ghostValues;const t="GDAL_STRUCTURAL_METADATA_SIZE=",r=t.length+100;let i=await this.getSlice(e,r);if(t===Tr(i,oe.ASCII,t.length,e)){const o=Tr(i,oe.ASCII,r,e).split(`
`)[0],a=Number(o.split("=")[1].split(" ")[0])+o.length;a>r&&(i=await this.getSlice(e,a));const l=Tr(i,oe.ASCII,a,e);this.ghostValues={},l.split(`
`).filter(u=>u.length>0).map(u=>u.split("=")).forEach(([u,f])=>{this.ghostValues[u]=f})}return this.ghostValues}static async fromSource(e,t,r){const i=(await e.fetch([{offset:0,length:1024}],r))[0],s=new S0(i),o=s.getUint16(0,0);let a;if(o===18761)a=!0;else if(o===19789)a=!1;else throw new TypeError("Invalid byte order value.");const l=s.getUint16(2,a);let u;if(l===42)u=!1;else if(l===43){if(u=!0,s.getUint16(4,a)!==8)throw new Error("Unsupported offset byte-size.")}else throw new TypeError("Invalid magic number.");const f=u?s.getUint64(8,a):s.getUint32(4,a);return new Br(e,a,u,f,t)}close(){return typeof this.source.close=="function"?this.source.close():!1}}class Q0 extends Bc{constructor(e,t){super(),this.mainFile=e,this.overviewFiles=t,this.imageFiles=[e].concat(t),this.fileDirectoriesPerFile=null,this.fileDirectoriesPerFileParsing=null,this.imageCount=null}async parseFileDirectoriesPerFile(){const e=[this.mainFile.parseFileDirectoryAt(this.mainFile.firstIFDOffset)].concat(this.overviewFiles.map(t=>t.parseFileDirectoryAt(t.firstIFDOffset)));return this.fileDirectoriesPerFile=await Promise.all(e),this.fileDirectoriesPerFile}async getImage(e=0){await this.getImageCount(),await this.parseFileDirectoriesPerFile();let t=0,r=0;for(let i=0;i<this.imageFiles.length;i++){const s=this.imageFiles[i];for(let o=0;o<this.imageCounts[i];o++){if(e===t){const a=await s.requestIFD(r);return new Dc(a.fileDirectory,a.geoKeyDirectory,s.dataView,s.littleEndian,s.cache,s.source)}t++,r++}r=0}throw new RangeError("Invalid image index")}async getImageCount(){if(this.imageCount!==null)return this.imageCount;const e=[this.mainFile.getImageCount()].concat(this.overviewFiles.map(t=>t.getImageCount()));return this.imageCounts=await Promise.all(e),this.imageCount=this.imageCounts.reduce((t,r)=>t+r,0),this.imageCount}}async function J0(n,e={},t){return Br.fromSource(Ms(n,e),t)}async function ex(n,e){return Br.fromSource(Y0(n),e)}async function tx(n,e=[],t={},r){const i=await Br.fromSource(Ms(n,t),r),s=await Promise.all(e.map(o=>Br.fromSource(Ms(o,t))));return new Q0(i,s)}const rx=`
  attribute vec4 a_position;
  attribute vec4 a_texcoord;

  uniform mat4 u_matrix;
  uniform mat4 u_textureMatrix;

  varying vec2 v_texcoord;

  void main() {
    gl_Position = u_matrix * a_position;
    vec2 texcoord = (u_textureMatrix * a_texcoord).xy;
    v_texcoord = texcoord;
  }
`,nx=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (
      v_texcoord.x < 0.0 ||
      v_texcoord.y < 0.0 ||
      v_texcoord.x > 1.0 ||
      v_texcoord.y > 1.0
    ) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;class ix{constructor(e){this.gl_=e,this.program_=Ds(e,nx,rx),this.positionLocation=e.getAttribLocation(this.program_,"a_position"),this.texcoordLocation=e.getAttribLocation(this.program_,"a_texcoord"),this.matrixLocation=e.getUniformLocation(this.program_,"u_matrix"),this.textureMatrixLocation=e.getUniformLocation(this.program_,"u_textureMatrix"),this.textureLocation=e.getUniformLocation(this.program_,"u_texture"),this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),this.positions=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.positions),e.STATIC_DRAW),this.texcoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer),this.texcoords=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.texcoords),e.STATIC_DRAW)}drawImage(e,t,r,i,s,o,a,l,u,f,c,d,g){const p=this.gl_;l===void 0&&(l=i),u===void 0&&(u=s),o===void 0&&(o=t),a===void 0&&(a=r),f===void 0&&(f=o),c===void 0&&(c=a),d===void 0&&(d=p.canvas.width),g===void 0&&(g=p.canvas.height),p.bindTexture(p.TEXTURE_2D,e),p.useProgram(this.program_),p.bindBuffer(p.ARRAY_BUFFER,this.positionBuffer),p.enableVertexAttribArray(this.positionLocation),p.vertexAttribPointer(this.positionLocation,2,p.FLOAT,!1,0,0),p.bindBuffer(p.ARRAY_BUFFER,this.texcoordBuffer),p.enableVertexAttribArray(this.texcoordLocation),p.vertexAttribPointer(this.texcoordLocation,2,p.FLOAT,!1,0,0);let _=Rs(0,d,0,g,-1,1);_=Wm(_,l,u,0),_=Ja(_,f,c,1),p.uniformMatrix4fv(this.matrixLocation,!1,_);let x=Zm(i/t,s/r,0);x=Ja(x,o/t,a/r,1),p.uniformMatrix4fv(this.textureMatrixLocation,!1,x),p.uniform1i(this.textureLocation,0),p.drawArrays(p.TRIANGLES,0,this.positions.length/2)}}function pl(n,e,t){const r=n.createShader(e);if(r===null)throw new Error("Shader compilation failed");if(n.shaderSource(r,t),n.compileShader(r),!n.getShaderParameter(r,n.COMPILE_STATUS)){const i=n.getShaderInfoLog(r);throw i===null?new Error("Shader info log creation failed"):new Error(i)}return r}function Ds(n,e,t){const r=n.createProgram(),i=pl(n,n.VERTEX_SHADER,t),s=pl(n,n.FRAGMENT_SHADER,e);if(r===null)throw new Error("Program creation failed");if(n.attachShader(r,i),n.attachShader(r,s),n.linkProgram(r),!n.getProgramParameter(r,n.LINK_STATUS))throw n.getProgramInfoLog(r)===null?new Error("Program info log creation failed"):new Error;return r}const sx=`
  attribute vec4 a_position;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
  }
`,ox=`
  precision mediump float;

  uniform vec4 u_val;
  void main() {
     gl_FragColor = u_val;
  }
`,ax=`
  attribute vec4 a_position;
  attribute vec2 a_texcoord;

  varying vec2 v_texcoord;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
     v_texcoord = a_texcoord;
  }
`,lx=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (v_texcoord.x < 0.0 || v_texcoord.x > 1.0 || v_texcoord.y < 0.0 || v_texcoord.y > 1.0) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;function ux(n,e,t,r){let i;return t&&t.length?i=t.shift():df?i=new OffscreenCanvas(n||300,e||300):i=document.createElement("canvas"),n&&(i.width=n),e&&(i.height=e),i.getContext("webgl",r)}function cx(n){const e=n.canvas;e.width=1,e.height=1,n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT|n.STENCIL_BUFFER_BIT)}const gl=[];function hx(n,e,t,r,i,s,o,a,l,u,f,c,d,g){const p=Math.round(r*e),_=Math.round(r*t);n.canvas.width=p,n.canvas.height=_;let x,T;if(T=n.createTexture(),n.bindTexture(n.TEXTURE_2D,T),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),d?(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR)):(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST)),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,p,_,0,n.RGBA,f,null),x=n.createFramebuffer(),n.bindFramebuffer(n.FRAMEBUFFER,x),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,T,0),x===null)throw new Error("Could not create framebuffer");if(T===null)throw new Error("Could not create texture");if(l.length===0)return{width:p,height:_,framebuffer:x,texture:T};const E=vn();l.forEach(function(D,j,X){pf(E,D.extent)});let w,A,P;const C=1/i;{if(w=n.createTexture(),T===null)throw new Error("Could not create texture");A=Math.round(Ve(E)*C),P=Math.round(_t(E)*C);const D=n.getParameter(n.MAX_TEXTURE_SIZE),j=Math.max(A,P),X=j>D?D/j:1,h=Math.round(A*X),m=Math.round(P*X);n.bindTexture(n.TEXTURE_2D,w),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),d?(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR)):(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST)),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,h,m,0,n.RGBA,f,null);const y=n.createFramebuffer();n.bindFramebuffer(n.FRAMEBUFFER,y),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,w,0);const b=new ix(n);l.forEach(function(R,O,F){const M=(R.extent[0]-E[0])*C*X,z=-(R.extent[3]-E[3])*C*X,W=Ve(R.extent)*C*X,Y=_t(R.extent)*C*X;if(n.bindFramebuffer(n.FRAMEBUFFER,y),n.viewport(0,0,h,m),R.clipExtent){const ee=(R.clipExtent[0]-E[0])*C*X,te=-(R.clipExtent[3]-E[3])*C*X,re=Ve(R.clipExtent)*C*X,de=_t(R.clipExtent)*C*X;n.enable(n.SCISSOR_TEST),n.scissor(d?ee:Math.round(ee),d?te:Math.round(te),d?re:Math.round(ee+re)-Math.round(ee),d?de:Math.round(te+de)-Math.round(te))}b.drawImage(R.texture,R.width,R.height,u,u,R.width-2*u,R.height-2*u,d?M:Math.round(M),d?z:Math.round(z),d?W:Math.round(M+W)-Math.round(M),d?Y:Math.round(z+Y)-Math.round(z),h,m),n.disable(n.SCISSOR_TEST)}),n.deleteFramebuffer(y)}const N=Es(o),U=Es(E),k=D=>{const j=(D[0][0]-N[0])/s*r,X=-(D[0][1]-N[1])/s*r,h=(D[1][0]-N[0])/s*r,m=-(D[1][1]-N[1])/s*r,y=(D[2][0]-N[0])/s*r,b=-(D[2][1]-N[1])/s*r;return{u1:h,v1:m,u0:j,v0:X,u2:y,v2:b}};n.bindFramebuffer(n.FRAMEBUFFER,x),n.viewport(0,0,p,_);{const D=[],j=[],X=Ds(n,lx,ax);n.useProgram(X);const h=n.getUniformLocation(X,"u_texture");n.bindTexture(n.TEXTURE_2D,w),n.uniform1i(h,0),a.getTriangles().forEach(function(M,z,W){const Y=M.source,ee=M.target,{u1:te,v1:re,u0:de,v0:Oe,u2:Pe,v2:De}=k(ee),Ce=(Y[0][0]-U[0])/i/A,ke=-(Y[0][1]-U[1])/i/P,Xe=(Y[1][0]-U[0])/i/A,xt=-(Y[1][1]-U[1])/i/P,Ft=(Y[2][0]-U[0])/i/A,Kr=-(Y[2][1]-U[1])/i/P;D.push(te,re,de,Oe,Pe,De),j.push(Xe,xt,Ce,ke,Ft,Kr)});const m=Rs(0,p,_,0,-1,1),y=n.getUniformLocation(X,"u_matrix");n.uniformMatrix4fv(y,!1,m);const b=n.getAttribLocation(X,"a_position"),R=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,R),n.bufferData(n.ARRAY_BUFFER,new Float32Array(D),n.STATIC_DRAW),n.vertexAttribPointer(b,2,n.FLOAT,!1,0,0),n.enableVertexAttribArray(b);const O=n.getAttribLocation(X,"a_texcoord"),F=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,F),n.bufferData(n.ARRAY_BUFFER,new Float32Array(j),n.STATIC_DRAW),n.vertexAttribPointer(O,2,n.FLOAT,!1,0,0),n.enableVertexAttribArray(O),n.drawArrays(n.TRIANGLES,0,D.length/2)}if(c){const D=Ds(n,ox,sx);n.useProgram(D);const j=Rs(0,p,_,0,-1,1),X=n.getUniformLocation(D,"u_matrix");n.uniformMatrix4fv(X,!1,j);const h=Array.isArray(c)?c:[0,0,0,255],m=n.getUniformLocation(D,"u_val");n.uniform4fv(m,h);const y=n.getAttribLocation(D,"a_position"),b=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,b),n.vertexAttribPointer(y,2,n.FLOAT,!1,0,0),n.enableVertexAttribArray(y);const R=a.getTriangles().reduce(function(O,F){const M=F.target,{u1:z,v1:W,u0:Y,v0:ee,u2:te,v2:re}=k(M);return O.concat([z,W,Y,ee,Y,ee,te,re,te,re,z,W])},[]);n.bufferData(n.ARRAY_BUFFER,new Float32Array(R),n.STATIC_DRAW),n.drawArrays(n.LINES,0,R.length/2)}return{width:p,height:_,framebuffer:x,texture:T}}class fx extends Qs{constructor(e){super({tileCoord:e.tileCoord,loader:()=>Promise.resolve(new Uint8ClampedArray(4)),interpolate:e.interpolate,transition:e.transition}),this.renderEdges_=e.renderEdges!==void 0?e.renderEdges:!1,this.pixelRatio_=e.pixelRatio,this.gutter_=e.gutter,this.reprojData_=null,this.reprojError_=null,this.reprojSize_=void 0,this.sourceTileGrid_=e.sourceTileGrid,this.targetTileGrid_=e.targetTileGrid,this.wrappedTileCoord_=e.wrappedTileCoord||e.tileCoord,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0;const t=e.sourceProj,r=t.getExtent(),i=e.sourceTileGrid.getExtent();this.clipExtent_=t.canWrapX()?i?Pt(r,i):r:i;const s=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),o=this.targetTileGrid_.getExtent();let a=this.sourceTileGrid_.getExtent();const l=o?Pt(s,o):s;if(ba(l)===0){this.state=ue.EMPTY;return}r&&(a?a=Pt(a,r):a=r);const u=this.targetTileGrid_.getResolution(this.wrappedTileCoord_[0]),f=e.targetProj,c=gf(t,f,l,u);if(!isFinite(c)||c<=0){this.state=ue.EMPTY;return}const d=e.errorThreshold!==void 0?e.errorThreshold:mf;if(this.triangulation_=new _f(t,f,l,a,c*d,u,e.transformMatrix),this.triangulation_.getTriangles().length===0){this.state=ue.EMPTY;return}this.sourceZ_=this.sourceTileGrid_.getZForResolution(c);let g=this.triangulation_.calculateSourceExtent();if(a&&(t.canWrapX()?(g[1]=Le(g[1],a[1],a[3]),g[3]=Le(g[3],a[1],a[3])):g=Pt(g,a)),!ba(g))this.state=ue.EMPTY;else{let p=0,_=0;t.canWrapX()&&(p=Ve(r),_=Math.floor((g[0]-r[0])/p)),yf(g.slice(),t,!0).forEach(T=>{const E=this.sourceTileGrid_.getTileRangeForExtentAndZ(T,this.sourceZ_),w=e.getTileFunction;for(let A=E.minX;A<=E.maxX;A++)for(let P=E.minY;P<=E.maxY;P++){const C=w(this.sourceZ_,A,P,this.pixelRatio_);if(C){const N=_*p;this.sourceTiles_.push({tile:C,offset:N})}}++_}),this.sourceTiles_.length===0&&(this.state=ue.EMPTY)}}getSize(){return this.reprojSize_}getData(){return this.reprojData_}getError(){return this.reprojError_}reproject_(){const e=[];let t=!1;if(this.sourceTiles_.forEach(A=>{var z;const P=A.tile;if(!P||P.getState()!==ue.LOADED)return;const C=P.getSize(),N=this.gutter_;let U;const k=ms(P.getData());k?U=k:(t=!0,U=xf(_s(P.getData())));const D=[C[0]+2*N,C[1]+2*N],j=U instanceof Float32Array,X=D[0]*D[1],h=j?Float32Array:Uint8ClampedArray,m=new h(U.buffer),y=h.BYTES_PER_ELEMENT,b=y*m.length/X,R=m.byteLength/D[1],O=Math.floor(R/y/D[0]),F=this.sourceTileGrid_.getTileCoordExtent(P.tileCoord);F[0]+=A.offset,F[2]+=A.offset;const M=(z=this.clipExtent_)==null?void 0:z.slice();M&&(M[0]+=A.offset,M[2]+=A.offset),e.push({extent:F,clipExtent:M,data:m,dataType:h,bytesPerPixel:b,pixelSize:D,bandCount:O})}),this.sourceTiles_.length=0,e.length===0){this.state=ue.ERROR,this.changed();return}const r=this.wrappedTileCoord_[0],i=this.targetTileGrid_.getTileSize(r),s=typeof i=="number"?i:i[0],o=typeof i=="number"?i:i[1],a=s*this.pixelRatio_,l=o*this.pixelRatio_,u=this.targetTileGrid_.getResolution(r),f=this.sourceTileGrid_.getResolution(this.sourceZ_),c=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),d=e[0].bandCount,g=new e[0].dataType(d*a*l),p=ux(a,l,gl,{premultipliedAlpha:!1,antialias:!1});let _;const x=p.RGBA;let T;e[0].dataType==Float32Array?(T=p.FLOAT,p.getExtension("WEBGL_color_buffer_float"),p.getExtension("OES_texture_float"),p.getExtension("EXT_float_blend"),_=p.getExtension("OES_texture_float_linear")!==null&&this.interpolate):(T=p.UNSIGNED_BYTE,_=this.interpolate);const E=4,w=Math.ceil(d/E);for(let A=w-1;A>=0;--A){const P=[];for(let h=0,m=e.length;h<m;++h){const y=e[h],b=y.pixelSize,R=b[0],O=b[1],F=new y.dataType(E*R*O),M=y.data;let z=A*E;for(let Y=0,ee=F.length;Y<ee;Y+=E)F[Y]=M[z],F[Y+1]=M[z+1],F[Y+2]=M[z+2],F[Y+3]=M[z+3],z+=d;const W=p.createTexture();p.bindTexture(p.TEXTURE_2D,W),_?(p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,p.LINEAR),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.LINEAR)):(p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,p.NEAREST),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.NEAREST)),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE),p.texImage2D(p.TEXTURE_2D,0,x,R,O,0,x,T,F),P.push({extent:y.extent,clipExtent:y.clipExtent,texture:W,width:R,height:O})}const{framebuffer:C,width:N,height:U}=hx(p,s,o,this.pixelRatio_,f,u,c,this.triangulation_,P,this.gutter_,T,this.renderEdges_,_),k=N,D=U*E,j=new e[0].dataType(k*D);p.bindFramebuffer(p.FRAMEBUFFER,C),p.readPixels(0,0,N,U,p.RGBA,T,j);let X=A*E;for(let h=0,m=j.length;h<m;h+=E){const y=(k-1-(h/D|0))*D+h%D;g[X]=j[y],g[X+1]=j[y+1],g[X+2]=j[y+2],g[X+3]=j[y+3],X+=d}}if(cx(p),gl.push(p.canvas),t){const A=Qt(s,o),P=new ImageData(g,s);A.putImageData(P,0,0),this.reprojData_=A.canvas}else this.reprojData_=g;this.reprojSize_=[Math.round(a),Math.round(l)],this.state=ue.LOADED,this.changed()}load(){if(this.state!==ue.IDLE&&this.state!==ue.ERROR)return;this.state=ue.LOADING,this.changed();let e=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(({tile:t})=>{const r=t.getState();if(r!==ue.IDLE&&r!==ue.LOADING)return;e++;const i=Ut(t,Ke.CHANGE,()=>{const s=t.getState();(s==ue.LOADED||s==ue.ERROR||s==ue.EMPTY)&&(li(i),e--,e===0&&(this.unlistenSources_(),this.reproject_()))});this.sourcesListenerKeys_.push(i)}),e===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function({tile:t}){t.getState()==ue.IDLE&&t.load()})}unlistenSources_(){this.sourcesListenerKeys_.forEach(li),this.sourcesListenerKeys_=null}}class On extends ro{constructor(e){const t=e.projection===void 0?"EPSG:3857":e.projection;let r=e.tileGrid;r===void 0&&t&&(r=gr({extent:mr(t),maxResolution:e.maxResolution,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize})),super({cacheSize:.1,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,projection:t,tileGrid:r,state:e.state,wrapX:e.wrapX,transition:e.transition,interpolate:e.interpolate,key:e.key,zDirection:e.zDirection}),this.gutter_=e.gutter!==void 0?e.gutter:0,this.tileSize_=e.tileSize?mt(e.tileSize):null,this.tileSizes_=null,this.tileLoadingKeys_={},this.loader_=e.loader,this.handleTileChange_=this.handleTileChange_.bind(this),this.bandCount=e.bandCount===void 0?4:e.bandCount,this.tileGridForProjection_={},this.crossOrigin_=e.crossOrigin||"anonymous",this.transformMatrix=null}setTileSizes(e){this.tileSizes_=e}getTileSize(e){if(this.tileSizes_)return this.tileSizes_[e];if(this.tileSize_)return this.tileSize_;const t=this.getTileGrid();return t?mt(t.getTileSize(e)):[256,256]}getGutterForProjection(e){const t=this.getProjection();return(!t||Yn(t,e))&&!this.transformMatrix?this.gutter_:0}setLoader(e){this.loader_=e}getReprojTile_(e,t,r,i,s){const o=this.tileGrid||this.getTileGridForProjection(s||i),a=Math.max.apply(null,o.getResolutions().map((g,p)=>{const _=mt(o.getTileSize(p)),x=this.getTileSize(p);return Math.max(x[0]/_[0],x[1]/_[1])})),l=this.getTileGridForProjection(i),u=[e,t,r],f=this.getTileCoordForTileUrlFunction(u,i),c=Object.assign({sourceProj:s||i,sourceTileGrid:o,targetProj:i,targetTileGrid:l,tileCoord:u,wrappedTileCoord:f,pixelRatio:a,gutter:this.gutter_,getTileFunction:(g,p,_,x)=>this.getTile(g,p,_,x),transformMatrix:this.transformMatrix},this.tileOptions),d=new fx(c);return d.key=this.getKey(),d}getTile(e,t,r,i,s){var w;const o=this.getProjection();if(s&&(o&&!Yn(o,s)||this.transformMatrix))return this.getReprojTile_(e,t,r,s,o);const a=this.getTileSize(e),l=this.loader_,u=new AbortController,f={signal:u.signal,crossOrigin:this.crossOrigin_},c=this.getTileCoordForTileUrlFunction([e,t,r]);if(!c)return null;const d=c[0],g=c[1],p=c[2],_=(w=this.getTileGrid())==null?void 0:w.getFullTileRange(d);_&&(f.maxY=_.getHeight()-1);function x(){return Tf(function(){return l(d,g,p,f)})}const T=Object.assign({tileCoord:[e,t,r],loader:x,size:a,controller:u},this.tileOptions),E=new Qs(T);return E.key=this.getKey(),E.addEventListener(Ke.CHANGE,this.handleTileChange_),E}handleTileChange_(e){const t=e.target,r=_e(t),i=t.getState();let s;i==ue.LOADING?(this.tileLoadingKeys_[r]=!0,s=Ki.TILELOADSTART):r in this.tileLoadingKeys_&&(delete this.tileLoadingKeys_[r],s=i==ue.ERROR?Ki.TILELOADERROR:i==ue.LOADED?Ki.TILELOADEND:void 0),s&&this.dispatchEvent(new Ef(s,t))}getTileGridForProjection(e){const t=this.getProjection();if(this.tileGrid&&(!t||Yn(t,e))&&!this.transformMatrix)return this.tileGrid;const r=_e(e);return r in this.tileGridForProjection_||(this.tileGridForProjection_[r]=bf(e)),this.tileGridForProjection_[r]}setTileGridForProjection(e,t){const r=ye(e);if(r){const i=_e(r);i in this.tileGridForProjection_||(this.tileGridForProjection_[i]=t)}}}function dx(n){return((n.fileDirectory.NewSubfileType||0)&4)===4}function px(n,e){if(!n)return!1;if(n===!0)return!0;if(e.getSamplesPerPixel()!==3)return!1;const t=e.fileDirectory.PhotometricInterpretation,r=Je;return t===r.CMYK||t===r.YCbCr||t===r.CIELab||t===r.ICCLab}const ml="STATISTICS_MAXIMUM",_l="STATISTICS_MINIMUM",ls=256;let us;function gx(){return us||(us=new P0),us}function mx(n){try{return n.getBoundingBox(!0)}catch{return[0,0,n.getWidth(),n.getHeight()]}}function _x(n){try{return n.getOrigin().slice(0,2)}catch{return[0,n.getHeight()]}}function yx(n,e){try{return n.getResolution(e)}catch{return[e.getWidth()/n.getWidth(),e.getHeight()/n.getHeight()]}}function xx(n){const e=n.geoKeys;if(!e)return null;if(e.ProjectedCSTypeGeoKey&&e.ProjectedCSTypeGeoKey!==32767){const t="EPSG:"+e.ProjectedCSTypeGeoKey;let r=ye(t);if(!r){const i=Ta(e.ProjLinearUnitsGeoKey);i&&(r=new wa({code:t,units:i}))}return r}if(e.GeographicTypeGeoKey&&e.GeographicTypeGeoKey!==32767){const t="EPSG:"+e.GeographicTypeGeoKey;let r=ye(t);if(!r){const i=Ta(e.GeogAngularUnitsGeoKey);i&&(r=new wa({code:t,units:i}))}return r}return null}function Ex(n){return n.getImageCount().then(function(e){const t=new Array(e);for(let r=0;r<e;++r)t[r]=n.getImage(r);return Promise.all(t)})}function bx(n,e){let t;return n.blob?t=ex(n.blob):n.overviews?t=tx(n.url,n.overviews,e):t=J0(n.url,e),t.then(Ex)}function rn(n,e,t,r,i){if(Array.isArray(n)){const s=n.length;if(!Array.isArray(e)||s!=e.length){const o=new Error(r);throw i(o),o}for(let o=0;o<s;++o)rn(n[o],e[o],t,r,i);return}if(e=e,Math.abs(n-e)>t*n)throw new Error(r)}function Tx(n){return n instanceof Int8Array?-128:n instanceof Int16Array?-32768:n instanceof Int32Array?-2147483648:n instanceof Float32Array?12e-39:0}function wx(n){return n instanceof Int8Array?127:n instanceof Uint8Array||n instanceof Uint8ClampedArray?255:n instanceof Int16Array?32767:n instanceof Uint16Array?65535:n instanceof Int32Array?2147483647:n instanceof Uint32Array?4294967295:n instanceof Float32Array?34e37:255}class ea extends On{constructor(e){super({state:"loading",tileGrid:null,projection:e.projection||null,transition:e.transition,interpolate:e.interpolate!==!1,wrapX:e.wrapX}),this.sourceInfo_=e.sources;const t=this.sourceInfo_.length;this.sourceOptions_=e.sourceOptions,this.sourceImagery_=new Array(t),this.sourceMasks_=new Array(t),this.resolutionFactors_=new Array(t),this.samplesPerPixel_,this.nodataValues_,this.metadata_,this.normalize_=e.normalize!==!1,this.addAlpha_=!1,this.error_=null,this.convertToRGB_=e.convertToRGB||!1,this.setKey(this.sourceInfo_.map(s=>s.url).join(","));const r=this,i=new Array(t);for(let s=0;s<t;++s)i[s]=bx(this.sourceInfo_[s],this.sourceOptions_);Promise.all(i).then(function(s){r.configure_(s)}).catch(function(s){_n(s),r.error_=s,r.setState("error")})}getError(){return this.error_}determineProjection(e){const t=e[0];for(let r=t.length-1;r>=0;--r){const i=t[r],s=xx(i);if(s){this.projection=s;break}}}determineTransformMatrix(e){const t=e[0];for(let r=t.length-1;r>=0;--r){const s=t[r].fileDirectory.ModelTransformation;if(s){const[o,a,l,u,f,c,d,g]=s,p=dn(dn([1/Math.sqrt(o*o+f*f),0,0,-1/Math.sqrt(a*a+c*c),u,g],[o,f,a,c,0,0]),[1,0,0,1,-u,-g]);this.transformMatrix=p,this.addAlpha_=!0;break}}}configure_(e){let t,r,i,s,o;const a=new Array(e.length),l=new Array(e.length),u=new Array(e.length);let f=0;const c=e.length;for(let x=0;x<c;++x){const T=[],E=[];e[x].forEach(k=>{dx(k)?E.push(k):T.push(k)});const w=T.length;if(E.length>0&&E.length!==w)throw new Error(`Expected one mask per image found ${E.length} masks and ${w} images`);let A,P;const C=new Array(w),N=new Array(w),U=new Array(w);l[x]=new Array(w),u[x]=new Array(w);for(let k=0;k<w;++k){const D=T[k],j=D.getGDALNoData();u[x][k]=D.getGDALMetadata(0),l[x][k]=j;const X=this.sourceInfo_[x].bands;a[x]=X?X.length:D.getSamplesPerPixel();const h=w-(k+1);A||(A=mx(D)),P||(P=_x(D));const m=yx(D,T[0]);U[h]=m[0];const y=[D.getTileWidth(),D.getTileHeight()];y[0]!==y[1]&&y[1]<ls&&(y[0]=ls,y[1]=ls),C[h]=y;const b=m[0]/Math.abs(m[1]);N[h]=[y[0],y[1]/b]}if(t?Pt(t,A,t):t=A,!r)r=P;else{const k=`Origin mismatch for source ${x}, got [${P}] but expected [${r}]`;rn(r,P,0,k,this.viewRejector)}if(!o)o=U,this.resolutionFactors_[x]=1;else{o.length-f>U.length&&(f=o.length-U.length);const k=o[o.length-1]/U[U.length-1];this.resolutionFactors_[x]=k;const D=U.map(X=>X*=k),j=`Resolution mismatch for source ${x}, got [${D}] but expected [${o}]`;rn(o.slice(f,o.length),D,.02,j,this.viewRejector)}i?rn(i.slice(f,i.length),N,.01,`Tile size mismatch for source ${x}`,this.viewRejector):i=N,s?rn(s.slice(f,s.length),C,0,`Tile size mismatch for source ${x}`,this.viewRejector):s=C,this.sourceImagery_[x]=T.reverse(),this.sourceMasks_[x]=E.reverse()}for(let x=0,T=this.sourceImagery_.length;x<T;++x){const E=this.sourceImagery_[x];for(;E.length<o.length;)E.unshift(void 0)}this.getProjection()||this.determineProjection(e),this.determineTransformMatrix(e),this.samplesPerPixel_=a,this.nodataValues_=l,this.metadata_=u;e:for(let x=0;x<c;++x){if(this.sourceInfo_[x].nodata!==void 0){this.addAlpha_=!0;break}if(this.sourceMasks_[x].length){this.addAlpha_=!0;break}const T=l[x],E=this.sourceInfo_[x].bands;if(E){for(let w=0;w<E.length;++w)if(T[E[w]-1]!==null){this.addAlpha_=!0;break e}continue}for(let w=0;w<T.length;++w)if(T[w]!==null){this.addAlpha_=!0;break e}}let d=this.addAlpha_?1:0;for(let x=0;x<c;++x)d+=a[x];this.bandCount=d;const g=new Mi({extent:t,minZoom:f,origin:r,resolutions:o,tileSizes:i});this.tileGrid=g,this.setTileSizes(s),this.setLoader(this.loadTile_.bind(this)),this.setState("ready");const p=1;o.length===2?o=[o[0],o[1],o[1]/2]:o.length===1&&(o=[o[0]*2,o[0],o[0]/2]);let _=t;if(this.transformMatrix){const x=mn($e(),this.transformMatrix.slice()),T=wf(E=>kt(x,E));_=Mr(t,T)}this.viewResolver({showFullExtent:!0,projection:this.projection,resolutions:o,center:Sf(Yt(_),this.projection),extent:vf(_,this.projection),zoom:p})}loadTile_(e,t,r,i){const s=this.getTileSize(e),o=this.sourceImagery_.length,a=new Array(o*2),l=this.nodataValues_,u=this.sourceInfo_,f=gx();for(let c=0;c<o;++c){const d=u[c],g=this.resolutionFactors_[c],p=[Math.round(t*(s[0]*g)),Math.round(r*(s[1]*g)),Math.round((t+1)*(s[0]*g)),Math.round((r+1)*(s[1]*g))],_=this.sourceImagery_[c][e];let x;d.bands&&(x=d.bands.map(function(P){return P-1}));let T;"nodata"in d&&d.nodata!==null?T=d.nodata:x?T=x.map(function(P){return l[c][P]}):T=l[c];const E={window:p,width:s[0],height:s[1],samples:x,fillValue:T,pool:f,interleave:!1,signal:i.signal};px(this.convertToRGB_,_)?a[c]=_.readRGB(E):a[c]=_.readRasters(E);const w=o+c,A=this.sourceMasks_[c][e];if(!A){a[w]=Promise.resolve(null);continue}a[w]=A.readRasters({window:p,width:s[0],height:s[1],samples:[0],pool:f,interleave:!1})}return Promise.all(a).then(this.composeTile_.bind(this,s)).catch(function(c){throw _n(c),c})}composeTile_(e,t){const r=this.metadata_,i=this.sourceInfo_,s=this.sourceImagery_.length,o=this.bandCount,a=this.samplesPerPixel_,l=this.nodataValues_,u=this.normalize_,f=this.addAlpha_,c=e[0]*e[1],d=c*o;let g;u?g=new Uint8Array(d):g=new Float32Array(d);let p=0;for(let _=0;_<c;++_){let x=f;for(let T=0;T<s;++T){const E=i[T];let w=E.min,A=E.max,P,C;if(u){const N=r[T][0];w===void 0&&(N&&_l in N?w=parseFloat(N[_l]):w=Tx(t[T][0])),A===void 0&&(N&&ml in N?A=parseFloat(N[ml]):A=wx(t[T][0])),P=255/(A-w),C=-w*P}for(let N=0;N<a[T];++N){const U=t[T][N][_];let k;if(u?k=Le(P*U+C,0,255):k=U,!f)g[p]=k;else{let D=E.nodata;if(D===void 0){let X;E.bands?X=E.bands[N]-1:X=N,D=l[T][X]}const j=isNaN(D);(!j&&U!==D||j&&!isNaN(U))&&(x=!1,g[p]=k)}p++}if(!x){const N=s+T,U=t[N];U&&!U[0][_]&&(x=!0)}}f&&(x||(g[p]=255),p++)}return g}}ea.prototype.getView;class Se{constructor(e){this.name=e}toString(){return this.name}}Se.GeoTIFF=new Se("GeoTIFF");Se.ImageStatic=new Se("ImageStatic");Se.PMTilesRaster=new Se("PMTilesRaster");Se.PMTilesVector=new Se("PMTilesVector");Se.TileJSON=new Se("TileJSON");Se.TileWMS=new Se("TileWMS");Se.WMTS=new Se("WMTS");Se.XYZ=new Se("XYZ");function vx(n){const e=n.load||$r,t=n.imageExtent,r=n.crossOrigin??null;return()=>{const i=new Image;return i.crossOrigin=r,e(i,n.url).then(s=>{const o=Ve(t)/s.width,a=_t(t)/s.height;return{image:s,extent:t,resolution:o!==a?[o,a]:a,pixelRatio:1}})}}class Gc extends _r{constructor(e){const t=e.crossOrigin!==void 0?e.crossOrigin:null,r=e.imageLoadFunction!==void 0?e.imageLoadFunction:no;super({attributions:e.attributions,interpolate:e.interpolate,projection:ye(e.projection)}),this.url_=e.url,this.imageExtent_=e.imageExtent,this.image=null,this.image=new tu(this.imageExtent_,void 0,1,vx({url:e.url,imageExtent:e.imageExtent,crossOrigin:t,load:(i,s)=>(this.image.setImage(i),r(this.image,s),$r(i))})),this.image.addEventListener(Ke.CHANGE,this.handleImageChange.bind(this))}getImageExtent(){return this.imageExtent_}getImageInternal(e,t,r,i){return Or(e,this.image.getExtent())?this.image:null}getUrl(){return this.url_}}function ta(n,e,t,r){const i=document.createElement("script"),s="olc_"+_e(e);function o(){delete window[s],i.parentNode.removeChild(i)}i.async=!0,i.src=n+(n.includes("?")?"&":"?")+"callback="+s;const a=setTimeout(function(){o(),t&&t()},1e4);window[s]=function(l){clearTimeout(a),o(),e(l)},document.head.appendChild(i)}class Sx extends Error{constructor(e){const t="Unexpected response status: "+e.status;super(t),this.name="ResponseError",this.response=e}}class Rx extends Error{constructor(e){super("Failed to issue request"),this.name="ClientError",this.client=e}}function kc(n){return new Promise(function(e,t){function r(o){const a=o.target;if(!a.status||a.status>=200&&a.status<300){let l;try{l=JSON.parse(a.responseText)}catch(u){const f="Error parsing response text as JSON: "+u.message;t(new Error(f));return}e(l);return}t(new Sx(a))}function i(o){t(new Rx(o.target))}const s=new XMLHttpRequest;s.addEventListener("load",r),s.addEventListener("error",i),s.open("GET",n),s.setRequestHeader("Accept","application/json"),s.send()})}function zc(n,e){return e.includes("://")?e:new URL(e,n).href}class $c extends $t{constructor(e){if(super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:ye("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.tileJSON_=null,this.tileSize_=e.tileSize,e.url)if(e.jsonp)ta(e.url,this.handleTileJSONResponse.bind(this),this.handleTileJSONError.bind(this));else{const t=new XMLHttpRequest;t.addEventListener("load",this.onXHRLoad_.bind(this)),t.addEventListener("error",this.onXHRError_.bind(this)),t.open("GET",e.url),t.send()}else if(e.tileJSON)this.handleTileJSONResponse(e.tileJSON);else throw new Error("Either `url` or `tileJSON` options must be provided")}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleTileJSONError();return}this.handleTileJSONResponse(r)}else this.handleTileJSONError()}onXHRError_(e){this.handleTileJSONError()}getTileJSON(){return this.tileJSON_}handleTileJSONResponse(e){const t=ye("EPSG:4326"),r=this.getProjection();let i;if(e.bounds!==void 0){const u=io(t,r);i=Mr(e.bounds,u)}const s=mr(r),o=e.minzoom||0,a=e.maxzoom||22,l=gr({extent:s,maxZoom:a,minZoom:o,tileSize:this.tileSize_});if(this.tileGrid=l,this.tileUrlFunction=iu(e.tiles,l),e.attribution&&!this.getAttributions()){const u=i!==void 0?i:s;this.setAttributions(function(f){return Or(u,f.extent)?[e.attribution]:null})}this.tileJSON_=e,this.setState("ready")}handleTileJSONError(){this.setState("error")}}var Vc={exports:{}};(function(n,e){(function(t,r){n.exports=r()})(lr,function(){var t=/^v?(?:\d+)(\.(?:[x*]|\d+)(\.(?:[x*]|\d+)(\.(?:[x*]|\d+))?(?:-[\da-z\-]+(?:\.[\da-z\-]+)*)?(?:\+[\da-z\-]+(?:\.[\da-z\-]+)*)?)?)?$/i;function r(c,d){return c.indexOf(d)===-1?c.length:c.indexOf(d)}function i(c){var d=c.replace(/^v/,"").replace(/\+.*$/,""),g=r(d,"-"),p=d.substring(0,g).split(".");return p.push(d.substring(g+1)),p}function s(c){return isNaN(Number(c))?c:Number(c)}function o(c){if(typeof c!="string")throw new TypeError("Invalid argument expected string");if(!t.test(c))throw new Error("Invalid argument not valid semver ('"+c+"' received)")}function a(c,d){[c,d].forEach(o);for(var g=i(c),p=i(d),_=0;_<Math.max(g.length-1,p.length-1);_++){var x=parseInt(g[_]||0,10),T=parseInt(p[_]||0,10);if(x>T)return 1;if(T>x)return-1}var E=g[g.length-1],w=p[p.length-1];if(E&&w){var A=E.split(".").map(s),P=w.split(".").map(s);for(_=0;_<Math.max(A.length,P.length);_++){if(A[_]===void 0||typeof P[_]=="string"&&typeof A[_]=="number")return-1;if(P[_]===void 0||typeof A[_]=="string"&&typeof P[_]=="number"||A[_]>P[_])return 1;if(P[_]>A[_])return-1}}else if(E||w)return E?-1:1;return 0}var l=[">",">=","=","<","<="],u={">":[1],">=":[0,1],"=":[0],"<=":[-1,0],"<":[-1]};function f(c){if(typeof c!="string")throw new TypeError("Invalid operator type, expected string but got "+typeof c);if(l.indexOf(c)===-1)throw new TypeError("Invalid operator, expected one of "+l.join("|"))}return a.validate=function(c){return typeof c=="string"&&t.test(c)},a.compare=function(c,d,g){f(g);var p=a(c,d);return u[g].indexOf(p)>-1},a})})(Vc);var Ax=Vc.exports,Us=Ax;const ra="1.1.0",B=!0,q={classification:"https://stac-extensions.github.io/classification/v2.0.0/schema.json",datacube:"https://stac-extensions.github.io/datacube/v2.2.0/schema.json",eo:"https://stac-extensions.github.io/eo/v2.0.0/schema.json",file:"https://stac-extensions.github.io/file/v2.1.0/schema.json","item-assets":"https://stac-extensions.github.io/item-assets/v1.0.0/schema.json",label:"https://stac-extensions.github.io/label/v1.0.1/schema.json",pointcloud:"https://stac-extensions.github.io/pointcloud/v1.0.0/schema.json",processing:"https://stac-extensions.github.io/processing/v1.2.0/schema.json",projection:"https://stac-extensions.github.io/projection/v2.0.0/schema.json",raster:"https://stac-extensions.github.io/raster/v2.0.0/schema.json",sar:"https://stac-extensions.github.io/sar/v1.0.0/schema.json",sat:"https://stac-extensions.github.io/sat/v1.0.0/schema.json",scientific:"https://stac-extensions.github.io/scientific/v1.0.0/schema.json",table:"https://stac-extensions.github.io/table/v1.2.0/schema.json",timestamps:"https://stac-extensions.github.io/timestamps/v1.1.0/schema.json",version:"https://stac-extensions.github.io/version/v1.2.0/schema.json",view:"https://stac-extensions.github.io/view/v1.0.0/schema.json"},ur={itemAndCollection:{"classification:":q.classification,"cube:":q.datacube,"eo:":q.eo,"file:":q.file,"label:":q.label,"pc:":q.pointcloud,"processing:":q.processing,"proj:":q.projection,"raster:":q.raster,"sar:":q.sar,"sat:":q.sat,"sci:":q.scientific,"view:":q.view,version:q.version,deprecated:q.version,published:q.timestamps,expires:q.timestamps,unpublished:q.timestamps},catalog:{},collection:{},item:{}};ur.collection=Object.assign(ur.collection,ur.itemAndCollection);ur.item=Object.assign(ur.item,ur.itemAndCollection);var nn={parseExtension(n){let e=n.match(/^https?:\/\/stac-extensions.github.io\/([^\/]+)\/v([^\/]+)\/[^.]+.json$/i);if(e)return{id:e[1],version:e[2]};let t=n.match(/(\d+\.\d+(\.\d+)([a-z_.-][\w.-]+)?)/i);if(t)return{id:n,version:t[1]};if(n in q)return{id:n,version:"0.0.0"}}},ae={version:ra,extensions:{},set(n){if(typeof n.stac_version!="string"?ae.version="0.6.0":ae.version=n.stac_version,Array.isArray(n.stac_extensions))for(let e of n.stac_extensions){let t=nn.parseExtension(e);t&&(ae.extensions[t.id]=t.version)}},before(n,e=null){return ae.compare("<",n,e)},compare(n,e,t=null){let r=t?ae.extensions[t]:ae.version;return typeof r>"u"?!1:Us.compare(r,e,n)}},v={type(n){let e=typeof n;if(e==="object"){if(n===null)return"null";if(Array.isArray(n))return"array"}return e},is(n,e){return Array.isArray(e)?e.includes(v.type(n)):v.type(n)===e},isDefined(n){return typeof n<"u"},isObject(n){return typeof n=="object"&&n===Object(n)&&!Array.isArray(n)},rename(n,e,t){return typeof n[e]<"u"&&typeof n[t]>"u"?(n[t]=n[e],delete n[e],!0):!1},copy(n,e,t){return typeof n[e]<"u"&&typeof n[t]>"u"?(n[t]=n[e],!0):!1},forAll(n,e,t){if(n[e]&&typeof n[e]=="object")for(let r in n[e])t(n[e][r])},toArray(n,e){return typeof n[e]<"u"&&!Array.isArray(n[e])?(n[e]=[n[e]],!0):!1},flattenArray(n,e,t,r=!1){if(Array.isArray(n[e])){for(let i in n[e])if(typeof t[i]=="string"){let s=n[e][i];n[t[i]]=r?[s]:s}return delete n[e],!0}return!1},flattenOneElementArray(n,e,t=!1){return!t&&Array.isArray(n[e])?n[e].length===1?(n[e]=n[e][0],!0):!1:!0},removeFromArray(n,e,t){if(Array.isArray(n[e])){let r=n[e].indexOf(t);return r>-1&&n[e].splice(r,1),!0}return!1},pickFirst(n,e){return Array.isArray(n[e])&&n[e].length>0?(n[e]=n[e][0],!0):(delete n[e],!1)},ensure(n,e,t){return v.type(t)!==v.type(n[e])&&(n[e]=t),!0},upgradeExtension(n,e){let{id:t,version:r}=nn.parseExtension(e),i=n.stac_extensions.findIndex(s=>{let o=nn.parseExtension(s);return o&&o.id===t&&Us.compare(o.version,r,"<")});return i!==-1?(n.stac_extensions[i]=e,!0):!1},addExtension(n,e){let{id:t,version:r}=nn.parseExtension(e),i=n.stac_extensions.findIndex(s=>{if(s===e)return!0;let o=nn.parseExtension(s);return!!(o&&o.id===t&&Us.compare(o.version,r,"<"))});return i===-1?n.stac_extensions.push(e):n.stac_extensions[i]=e,n.stac_extensions.sort(),!0},removeExtension(n,e){return v.removeFromArray(n,"stac_extensions",e)},migrateExtensionShortnames(n){let e=Object.keys(q),t=Object.values(q);return v.mapValues(n,"stac_extensions",e,t)},populateExtensions(n,e){let t=[];(e=="catalog"||e=="collection")&&t.push(n),(e=="item"||e=="collection")&&v.isObject(n.assets)&&(t=t.concat(Object.values(n.assets))),e=="collection"&&v.isObject(n.item_assets)&&(t=t.concat(Object.values(n.item_assets))),e=="collection"&&v.isObject(n.summaries)&&t.push(n.summaries),e=="item"&&v.isObject(n.properties)&&t.push(n.properties),t.push(n.links);let r;for(;r=t.pop();)Object.keys(r).forEach(i=>{Array.isArray(r.bands)&&(t=t.concat(r.bands));let s=i.match(/^(\w+:|[^:]+$)/i);if(Array.isArray(s)){let o=ur[e][s[0]];v.is(o,"string")&&v.addExtension(n,o)}})},mapValues(n,e,t,r){let i=s=>{let o=t.indexOf(s);return o>=0?r[o]:s};return Array.isArray(n[e])?n[e]=n[e].map(i):typeof n[e]<"u"&&(n[e]=i(n[e])),!0},mapObject(n,e){for(let t in n)n[t]=e(n[t],t)},moveTo(n,e,t,r=!1,i=!1){let s;return r?i?s=o=>Array.isArray(o):s=o=>Array.isArray(o)&&o.length===1:s=v.isDefined,s(n[e])?(t[e]=r&&!i?n[e][0]:n[e],delete n[e],!0):!1},runAll(n,e,t,r){for(let i in n)i.startsWith("migrate")||n[i](e,t,r)},toUTC(n,e){if(v.is(n[e],"string"))try{return n[e]=this.toISOString(n[e]),!0}catch{}return delete n[e],!1},toISOString(n){return n instanceof Date||(n=new Date(n)),n.toISOString().replace(/\.0+(?=[-\+Z])/,"")},formatString(n,e,t){const r=i=>v.is(i,["string","number"])?t.replaceAll("{}",i):i;Array.isArray(n[e])?n[e]=n[e].map(r):n[e]=r(n[e])}},At={multihash:null,hexToUint8(n){if(n.length===0||n.length%2!==0)throw new Error(`The string "${n}" is not valid hex.`);return new Uint8Array(n.match(/.{1,2}/g).map(e=>parseInt(e,16)))},uint8ToHex(n){return n.reduce((e,t)=>e+t.toString(16).padStart(2,"0"),"")},toMultihash(n,e,t){if(!At.multihash||!v.is(n[e],"string"))return!1;try{const r=At.multihash.encode(At.hexToUint8(n[e]),t);return n[e]=At.uint8ToHex(r),!0}catch(r){return console.warn(r),!1}}},na={migrate(n,e=!0){return ae.set(n),e&&(n.stac_version=ra),n.type="Catalog",v.ensure(n,"stac_extensions",[]),ae.before("1.0.0-rc.1")&&v.migrateExtensionShortnames(n),v.ensure(n,"id",""),v.ensure(n,"description",""),v.ensure(n,"links",[]),v.runAll(na,n,n),ae.before("0.8.0")&&v.populateExtensions(n,"catalog"),n}},ia={migrate(n,e=!0){return na.migrate(n,e),n.type="Collection",ae.before("1.0.0-rc.1")&&v.migrateExtensionShortnames(n),v.ensure(n,"license","other"),v.ensure(n,"extent",{spatial:{bbox:[]},temporal:{interval:[]}}),v.runAll(ia,n,n),v.isObject(n.properties)&&(v.removeFromArray(n,"stac_extensions","commons"),delete n.properties),ae.before("0.8.0")&&v.populateExtensions(n,"collection"),ae.before("1.0.0-beta.1")&&v.mapValues(n,"stac_extensions",["assets"],["item-assets"]),n},extent(n){if(v.ensure(n,"extent",{}),ae.before("0.8.0")&&(Array.isArray(n.extent.spatial)&&(n.extent.spatial={bbox:[n.extent.spatial]}),Array.isArray(n.extent.temporal)&&(n.extent.temporal={interval:[n.extent.temporal]})),v.ensure(n.extent,"spatial",{}),v.ensure(n.extent.spatial,"bbox",[]),v.ensure(n.extent,"temporal",{}),v.ensure(n.extent.temporal,"interval",[]),ae.before("1.0.0-rc.3")){if(n.extent.temporal.interval.length>1){let e,t;for(let r of n.extent.temporal.interval){if(r[0]===null)e=null;else if(typeof r[0]=="string"&&e!==null)try{let i=new Date(r[0]);(typeof e>"u"||i<e)&&(e=i)}catch{}if(r[1]===null)t=null;else if(typeof r[1]=="string"&&t!==null)try{let i=new Date(r[1]);(typeof t>"u"||i>t)&&(t=i)}catch{}}n.extent.temporal.interval.unshift([e?v.toISOString(e):null,t?v.toISOString(t):null])}if(n.extent.spatial.bbox.length>1){let e=n.extent.spatial.bbox.reduce((t,r)=>Array.isArray(r)?Math.max(r.length,t):t,4);if(e>=4){let t=new Array(e).fill(null),r=e/2;for(let i of n.extent.spatial.bbox){if(!Array.isArray(i)||i.length<4)break;for(let s in i){let o=i[s];t[s]===null?t[s]=o:s<r?t[s]=Math.min(o,t[s]):t[s]=Math.max(o,t[s])}}t.findIndex(i=>i===null)===-1&&n.extent.spatial.bbox.unshift(t)}}}},collectionAssets(n){ae.before("1.0.0-rc.1")&&v.removeExtension(n,"collection-assets"),En.migrateAll(n)},itemAsset(n){ae.before("1.0.0-beta.2")&&v.rename(n,"item_assets","assets"),v.removeExtension(n,q["item-assets"]),En.migrateAll(n,"item_assets")},summaries(n){if(v.ensure(n,"summaries",{}),ae.before("0.8.0")&&v.isObject(n.other_properties)){for(let e in n.other_properties){let t=n.other_properties[e];Array.isArray(t.extent)&&t.extent.length===2?n.summaries[e]={minimum:t.extent[0],maximum:t.extent[1]}:Array.isArray(t.values)&&(t.values.filter(r=>Array.isArray(r)).length===t.values.length?n.summaries[e]=t.values.reduce((r,i)=>r.concat(i),[]):n.summaries[e]=t.values)}delete n.other_properties}if(ae.before("1.0.0-beta.1")&&v.isObject(n.properties)&&!n.links.find(e=>["child","item"].includes(e.rel)))for(let e in n.properties){let t=n.properties[e];Array.isArray(t)||(t=[t]),n.summaries[e]=t}ae.before("1.0.0-rc.1")&&v.mapObject(n.summaries,e=>(v.rename(e,"min","minimum"),v.rename(e,"max","maximum"),e)),Mn.migrate(n.summaries,n,!0),v.moveTo(n.summaries,"sci:doi",n,!0)&&v.addExtension(n,q.scientific),v.moveTo(n.summaries,"sci:publications",n,!0,!0)&&v.addExtension(n,q.scientific),v.moveTo(n.summaries,"sci:citation",n,!0)&&v.addExtension(n,q.scientific),v.moveTo(n.summaries,"cube:dimensions",n,!0)&&v.addExtension(n,q.datacube),Object.keys(n.summaries).length===0&&delete n.summaries}},sa={migrate(n,e=null,t=!0){ae.set(n),t&&(n.stac_version=ra),v.ensure(n,"stac_extensions",[]),ae.before("1.0.0-rc.1")&&v.migrateExtensionShortnames(n),v.ensure(n,"id",""),v.ensure(n,"type","Feature"),v.isObject(n.geometry)||(n.geometry=null),n.geometry!==null&&v.ensure(n,"bbox",[]),v.ensure(n,"properties",{}),v.ensure(n,"links",[]),v.ensure(n,"assets",{});let r=!1;return v.isObject(e)&&v.isObject(e.properties)&&(v.removeFromArray(n,"stac_extensions","commons"),n.properties=Object.assign({},e.properties,n.properties),r=!0),v.runAll(sa,n,n),Mn.migrate(n.properties,n),En.migrateAll(n),(ae.before("0.8.0")||r)&&v.populateExtensions(n,"item"),n}},jc={migrate(n,e=!0){return v.ensure(n,"collections",[]),v.ensure(n,"links",[]),v.runAll(jc,n,n),n.collections=n.collections.map(t=>ia.migrate(t,e)),n}},Xc={migrate(n,e=!0){return v.ensure(n,"type","FeatureCollection"),v.ensure(n,"features",[]),v.ensure(n,"links",[]),v.runAll(Xc,n,n),n.features=n.features.map(t=>sa.migrate(t,null,e)),n}},En={migrateAll(n,e="assets"){for(let t in n[e])En.migrate(n[e][t],n)},migrate(n,e){return v.runAll(En,n,e),Mn.migrate(n,e),n},mediaTypes(n){v.is(n.type,"string")&&v.mapValues(n,"type",["image/vnd.stac.geotiff","image/vnd.stac.geotiff; cloud-optimized=true"],["image/tiff; application=geotiff","image/tiff; application=geotiff; profile=cloud-optimized"])}},Bs={migrateAll(n,e){if(ae.before("1.0.0")){const t=v.isObject(e.properties)&&Array.isArray(e.properties.bands)?e.properties.bands:[];if(Array.isArray(n["eo:bands"]))for(let r in n["eo:bands"]){let i=n["eo:bands"][r];v.is(i,"number")&&v.isObject(t[i])&&(i=t[i]),v.isObject(i)||(i={}),n["eo:bands"][r]=i}}if(ae.before("1.1.0-beta.1")&&(Array.isArray(n["raster:bands"])||Array.isArray(n["eo:bands"]))){v.ensure(n,"bands",[]);const t=n["raster:bands"]||[],r=n["eo:bands"]||[],i=Math.max(t.length,r.length);for(let s=0;s<i;s++)v.ensure(n.bands,s,{}),Object.assign(n.bands[s],t[s],r[s]),n.bands[s]=Bs.migrate(n.bands[s],e);delete n["raster:bands"],delete n["eo:bands"]}},migrate(n,e){return v.runAll(Bs,n,e),Mn.migrate(n,e),n},eo(n){ae.before("2.0.0-beta.1","eo")&&(v.rename(n,"common_name","eo:common_name"),v.rename(n,"center_wavelength","eo:center_wavelength"),v.rename(n,"full_width_half_max","eo:full_width_half_max"),v.rename(n,"solar_illumination","eo:solar_illumination"))},raster(n){ae.before("2.0.0-beta.1","raster")&&(v.rename(n,"sampling","raster:sampling"),v.rename(n,"bits_per_sample","raster:bits_per_sample"),v.rename(n,"spatial_resolution","raster:spatial_resolution"),v.rename(n,"scale","raster:scale"),v.rename(n,"offset","raster:offset"),v.rename(n,"histogram","raster:histogram"))}},Mn={migrate(n,e,t=!1){return v.runAll(Mn,n,e,t),n},_commonMetadata(n,e){ae.before("1.0.0-rc.3")&&(v.toUTC(n,"created"),v.toUTC(n,"updated")),Bs.migrateAll(n,e)},_timestamps(n,e){v.toUTC(n,"published"),v.toUTC(n,"expires"),v.toUTC(n,"unpublished"),v.upgradeExtension(e,q.timestamps)},_versioningIndicator(n,e){v.upgradeExtension(e,q.version)},checksum(n,e){ae.before("0.9.0")&&At.multihash&&(v.rename(n,"checksum:md5","checksum:multihash")&&At.toMultihash(n,"checksum:multihash","md5"),v.rename(n,"checksum:sha1","checksum:multihash")&&At.toMultihash(n,"checksum:multihash","sha1"),v.rename(n,"checksum:sha2","checksum:multihash")&&At.toMultihash(n,"checksum:multihash","sha2-256"),v.rename(n,"checksum:sha3","checksum:multihash")&&At.toMultihash(n,"checksum:multihash","sha3-256")),ae.before("1.0.0-rc.1")&&v.rename(n,"checksum:multihash","file:checksum")&&v.addExtension(e,q.file),v.removeExtension(e,"checksum")},classification(n,e){ae.before("1.1.0","classification")&&v.forAll(n,"classification:classes",t=>v.rename(t,"color-hint","color_hint")),ae.before("2.0.0","classification")&&v.forAll(n,"classification:classes",t=>v.ensure(t,"name",t.description)),v.upgradeExtension(e,q.classification)},cube(n,e){v.upgradeExtension(e,q.datacube)},dtr(n,e){ae.before("0.9.0")&&(v.rename(n,"dtr:start_datetime","start_datetime"),v.rename(n,"dtr:end_datetime","end_datetime"),v.removeExtension(e,"datetime-range"))},eo(n,e){ae.before("0.9.0")&&(v.rename(n,"eo:epsg","proj:epsg")&&v.addExtension(e,q.projection),v.rename(n,"eo:platform","platform"),v.rename(n,"eo:instrument","instruments")&&v.toArray(n,"instruments"),v.rename(n,"eo:constellation","constellation"),v.rename(n,"eo:off_nadir","view:off_nadir")&&v.addExtension(e,q.view),v.rename(n,"eo:azimuth","view:azimuth")&&v.addExtension(e,q.view),v.rename(n,"eo:incidence_angle","view:incidence_angle")&&v.addExtension(e,q.view),v.rename(n,"eo:sun_azimuth","view:sun_azimuth")&&v.addExtension(e,q.view),v.rename(n,"eo:sun_elevation","view:sun_elevation")&&v.addExtension(e,q.view)),ae.before("1.0.0-beta.1")&&v.rename(n,"eo:gsd","gsd"),v.upgradeExtension(e,q.eo)},file(n,e,t){v.rename(n,"file:bits_per_sample","raster:bits_per_sample")&&v.addExtension(e,q.raster),v.rename(n,"file:data_type","data_type"),v.rename(n,"file:unit","unit"),Array.isArray(n["file:nodata"])&&n["file:nodata"].length>1&&v.copy(n,"file:nodata","nodata:values"),v.rename(n,"file:nodata","nodata")&&!t&&v.pickFirst(n,"nodata"),v.upgradeExtension(e,q.file)},label(n,e){ae.before("0.8.0")&&(v.rename(n,"label:property","label:properties"),v.rename(n,"label:task","label:tasks"),v.rename(n,"label:overview","label:overviews")&&v.toArray(n,"label:overviews"),v.rename(n,"label:method","label:methods"),v.toArray(n,"label:classes")),v.upgradeExtension(e,q.label)},pc(n,e){ae.before("0.8.0")&&v.rename(n,"pc:schema","pc:schemas"),v.upgradeExtension(e,q.pointcloud)},processing(n,e){v.upgradeExtension(e,q.processing)},proj(n,e){v.rename(n,"proj:epsg","proj:code")&&v.formatString(n,"proj:code","EPSG:{}"),v.upgradeExtension(e,q.projection)},raster(n,e){v.upgradeExtension(e,q.raster)},sar(n,e,t){v.rename(n,"sar:incidence_angle","view:incidence_angle")&&v.addExtension(e,q.view),v.rename(n,"sar:pass_direction","sat:orbit_state")&&v.mapValues(n,"sat:orbit_state",[null],["geostationary"])&&v.addExtension(e,q.sat),ae.before("0.7.0")&&(v.flattenArray(n,"sar:resolution",["sar:resolution_range","sar:resolution_azimuth"],t),v.flattenArray(n,"sar:pixel_spacing",["sar:pixel_spacing_range","sar:pixel_spacing_azimuth"],t),v.flattenArray(n,"sar:looks",["sar:looks_range","sar:looks_azimuth","sar:looks_equivalent_number"],t),v.rename(n,"sar:off_nadir","view:off_nadir")&&v.addExtension(e,q.view)),ae.before("0.9.0")&&(v.rename(n,"sar:platform","platform"),v.rename(n,"sar:instrument","instruments")&&v.toArray(n,"instruments"),v.rename(n,"sar:constellation","constellation"),v.rename(n,"sar:type","sar:product_type"),v.rename(n,"sar:polarization","sar:polarizations"),v.flattenOneElementArray(n,"sar:absolute_orbit",t)&&v.rename(n,"sar:absolute_orbit","sat:absolute_orbit")&&v.addExtension(e,q.sat),v.flattenOneElementArray(n,"sar:relative_orbit",t)&&v.rename(n,"sar:relative_orbit","sat:relative_orbit")&&v.addExtension(e,q.sat)),v.upgradeExtension(e,q.sar)},sat(n,e){ae.before("0.9.0")&&(v.rename(n,"sat:off_nadir_angle","sat:off_nadir"),v.rename(n,"sat:azimuth_angle","sat:azimuth"),v.rename(n,"sat:sun_azimuth_angle","sat:sun_azimuth"),v.rename(n,"sat:sun_elevation_angle","sat:sun_elevation")),v.upgradeExtension(e,q.sat)},sci(n,e){v.upgradeExtension(e,q.scientific)},item(n){ae.before("0.8.0")&&(v.rename(n,"item:license","license"),v.rename(n,"item:providers","providers"))},table(n,e){v.upgradeExtension(e,q.table)},view(n,e){v.upgradeExtension(e,q.view)}},Ar={item(n,e=null,t=!0){return sa.migrate(n,e,t)},catalog(n,e=!0){return na.migrate(n,e)},collection(n,e=!0){return ia.migrate(n,e)},collectionCollection(n,e=!0){return jc.migrate(n,e)},itemCollection(n,e=!0){return Xc.migrate(n,e)},stac(n,e=!0){return n.type==="Feature"?Ar.item(n,null,e):n.type==="FeatureCollection"?Ar.itemCollection(n,e):n.type==="Collection"||!n.type&&v.isDefined(n.extent)&&v.isDefined(n.license)?Ar.collection(n,e):!n.type&&Array.isArray(n.collections)?Ar.collectionCollection(n,e):Ar.catalog(n,e)},enableMultihash(n){At.multihash=n}},Px=Ar;const Lx=Ni(Px);function qe(n){return typeof n=="string"&&n.length>0}function Ir(n,e,t,r=1e-8){if(typeof n!="number")return null;const i=e-r,s=t+r;return n<i||n>s?null:Math.min(Math.max(n,e),t)}function Ze(n){return typeof n=="object"&&n===Object(n)&&!Array.isArray(n)}function Ix(n){switch(n){case"int8":return-128;case"int16":return-32768;case"int32":return-2147483648}return n.startsWith("u")?0:null}function Cx(n){switch(n){case"int8":return 127;case"uint8":return 255;case"int16":return 32767;case"uint16":return 65535;case"int32":return 2147483647;case"uint32":return 4294967295}return null}function Hc(n){const e={minimum:null,maximum:null},t=l=>l.minimum!==null&&l.maximum!==null,r=n.getMetadata("statistics");if(Ze(r)&&(typeof r.minimum=="number"&&(e.minimum=r.minimum),typeof r.maximum=="number"&&(e.maximum=r.maximum),t(e)))return e;const i=n.getMetadata("raster:histogram");if(Ze(i)&&(typeof i.min=="number"&&(e.minimum=i.min),typeof i.max=="number"&&(e.maximum=i.max),t(e)))return e;const s=n.getMetadata("classification:classes");if(Array.isArray(s)&&(s.reduce((l,u)=>(l.minimum=Math.min(l.minimum,u.value),l.maximum=Math.max(l.maximum,u.value),l),e),t(e)))return e;const o=n.getMetadata("file:values");if(Array.isArray(o)&&(o.reduce((l,u)=>(l.minimum=Math.min(l.minimum,...u.values),l.maximum=Math.max(l.maximum,...u.values),l),e),t(e)))return e;const a=n.getMetadata("data_type");return a&&(e.minimum=Ix(a),e.maximum=Cx(a)),e}function Wc(n){let e=[];const t=n.getMetadata("nodata");if(typeof t<"u")e.push(t);else{const r=n.getMetadata("file:nodata");if(typeof r<"u")e=r;else{const i=n.getMetadata("classification:classes");Array.isArray(i)&&(e=i.filter(s=>!!s.nodata).map(s=>s.value))}}return e.map(r=>r==="nan"?NaN:r==="+inf"?1/0:r==="-inf"?-1/0:r)}function Yr(n){let e=n.length>=6,t=n[0],r=n[e?3:2],i=n[1],s=n[e?4:3],o={west:t,east:r,south:i,north:s};return e&&(o.base=n[2],o.height=n[5]),o}function cs(n){let{west:e,east:t,south:r,north:i}=Yr(n);return[[[e,i],[e,r],[t,r],[t,i],[e,i]]]}function Fx(n){if(n=Lt(n,!0),!n)return null;let e=Yr(n),t=[];if(qc(n)){let r=(e.west+360+e.east)/2;r>180&&(r-=360),t.push(r)}else t.push((e.west+e.east)/2);return t.push((e.south+e.north)/2),typeof e.base<"u"&&t.push((e.base+e.height)/2),t}function Zc(n){if(Array.isArray(n[0]))return n.map(Zc);const[e,t]=n;return[Ir(e,-180,180),Ir(t,-90,90)]}function Qn(n){return Ze(n)&&(n.bbox&&(n.bbox=Lt(n.bbox)),n.type==="FeatureCollection"?n.features.forEach(e=>Qn(e)):n.type==="Feature"?n.geometry=Qn(n.geometry):n.type==="GeometryCollection"?n.geometries.forEach(e=>Qn(e)):n.coordinates&&(n.coordinates=Zc(n.coordinates))),n}function Yc(n){if(n.every(r=>typeof r=="number")&&(n=[n]),n=n.map(r=>Lt(r)).filter(r=>r!==null),!Array.isArray(n)||n.length===0)return null;let e=n.reduce((r,i)=>{if(qc(i)){let{west:s,east:o,south:a,north:l}=Yr(i);r.push(cs([-180,a,o,l])),r.push(cs([s,a,180,l]))}else r.push(cs(i));return r},[]),t=null;if(e.length===1?t={type:"Polygon",coordinates:e[0]}:e.length>1&&(t={type:"MultiPolygon",coordinates:e}),t)return{type:"Feature",geometry:t,properties:{}}}function Lt(n,e=!1){if(!Array.isArray(n)||![4,6].includes(n.length))return null;let{west:t,east:r,south:i,north:s,base:o,height:a}=Yr(n);return t=Ir(t,-180,180),i=Ir(i,-90,90),r=Ir(r,-180,180),s=Ir(s,-90,90),e&&n.length===6?n=[t,i,o,r,s,a]:n=[t,i,r,s],n.some(l=>l===null)?null:n}function qc(n){if(n=Lt(n),!n)return!1;let{west:e,east:t}=Yr(n);return e>t}function oa(n){if(!Array.isArray(n)||n.length===0)return null;let e={west:180,south:90,east:-180,north:-90};n.forEach(r=>{if(r=Lt(r),!r)return;let i=Yr(r),s=["west","south"];for(let o in i){let a=s.includes(o)?Math.min:Math.max;e[o]=a(e[o],i[o])}});let t=[e.west,e.south,e.east,e.north];return Lt(t)}class Nn{constructor(e,t={},r=[]){if(!Ze(e))throw new Error("Given data is not an object");if(e instanceof Nn){for(let i of r)this[i]=e[i];e=e.toJSON()}this._keyMap=t,this._privateKeys=["_keyMap","_privateKeys"].concat(r);for(let i in e)typeof this[i]>"u"&&(i in t?this[i]=t[i](e[i],this):this[i]=e[i])}isItem(){return this.type==="Feature"}isCatalog(){return this.type==="Catalog"}isCatalogLike(){return this.isCatalog()||this.isCollection()}isCollection(){return this.type==="Collection"}isItemCollection(){return this.type==="FeatureCollection"}isCollectionCollection(){return!1}isAsset(){return!1}isLink(){return!1}isBand(){return!1}getObjectType(){}getAbsoluteUrl(){return null}getMetadata(e){return this[e]}toGeoJSON(){return null}getBoundingBox(){return null}getCenter(){return Fx(this.getBoundingBox())}getBoundingBoxes(){return[]}toJSON(){let e={};return Object.keys(this).forEach(t=>{if(typeof this[t]=="function"||this._privateKeys.includes(t))return;let r=this[t];if(t in this._keyMap){let i=Array.isArray(r)?[]:{};for(let s in r)typeof r[s].toJSON=="function"?i[s]=r[s].toJSON():i[s]=r[s];r=i}e[t]=r}),e}}var Kc={exports:{}},sn={exports:{}};/*! https://mths.be/punycode v1.4.0 by @mathias */sn.exports;var yl;function Ox(){return yl||(yl=1,function(n,e){(function(t){var r=e&&!e.nodeType&&e,i=n&&!n.nodeType&&n,s=typeof lr=="object"&&lr;(s.global===s||s.window===s||s.self===s)&&(t=s);var o,a=2147483647,l=36,u=1,f=26,c=38,d=700,g=72,p=128,_="-",x=/^xn--/,T=/[^\x20-\x7E]/,E=/[\x2E\u3002\uFF0E\uFF61]/g,w={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},A=l-u,P=Math.floor,C=String.fromCharCode,N;function U(M){throw new RangeError(w[M])}function k(M,z){for(var W=M.length,Y=[];W--;)Y[W]=z(M[W]);return Y}function D(M,z){var W=M.split("@"),Y="";W.length>1&&(Y=W[0]+"@",M=W[1]),M=M.replace(E,".");var ee=M.split("."),te=k(ee,z).join(".");return Y+te}function j(M){for(var z=[],W=0,Y=M.length,ee,te;W<Y;)ee=M.charCodeAt(W++),ee>=55296&&ee<=56319&&W<Y?(te=M.charCodeAt(W++),(te&64512)==56320?z.push(((ee&1023)<<10)+(te&1023)+65536):(z.push(ee),W--)):z.push(ee);return z}function X(M){return k(M,function(z){var W="";return z>65535&&(z-=65536,W+=C(z>>>10&1023|55296),z=56320|z&1023),W+=C(z),W}).join("")}function h(M){return M-48<10?M-22:M-65<26?M-65:M-97<26?M-97:l}function m(M,z){return M+22+75*(M<26)-((z!=0)<<5)}function y(M,z,W){var Y=0;for(M=W?P(M/d):M>>1,M+=P(M/z);M>A*f>>1;Y+=l)M=P(M/A);return P(Y+(A+1)*M/(M+c))}function b(M){var z=[],W=M.length,Y,ee=0,te=p,re=g,de,Oe,Pe,De,Ce,ke,Xe,xt,Ft;for(de=M.lastIndexOf(_),de<0&&(de=0),Oe=0;Oe<de;++Oe)M.charCodeAt(Oe)>=128&&U("not-basic"),z.push(M.charCodeAt(Oe));for(Pe=de>0?de+1:0;Pe<W;){for(De=ee,Ce=1,ke=l;Pe>=W&&U("invalid-input"),Xe=h(M.charCodeAt(Pe++)),(Xe>=l||Xe>P((a-ee)/Ce))&&U("overflow"),ee+=Xe*Ce,xt=ke<=re?u:ke>=re+f?f:ke-re,!(Xe<xt);ke+=l)Ft=l-xt,Ce>P(a/Ft)&&U("overflow"),Ce*=Ft;Y=z.length+1,re=y(ee-De,Y,De==0),P(ee/Y)>a-te&&U("overflow"),te+=P(ee/Y),ee%=Y,z.splice(ee++,0,te)}return X(z)}function R(M){var z,W,Y,ee,te,re,de,Oe,Pe,De,Ce,ke=[],Xe,xt,Ft,Kr;for(M=j(M),Xe=M.length,z=p,W=0,te=g,re=0;re<Xe;++re)Ce=M[re],Ce<128&&ke.push(C(Ce));for(Y=ee=ke.length,ee&&ke.push(_);Y<Xe;){for(de=a,re=0;re<Xe;++re)Ce=M[re],Ce>=z&&Ce<de&&(de=Ce);for(xt=Y+1,de-z>P((a-W)/xt)&&U("overflow"),W+=(de-z)*xt,z=de,re=0;re<Xe;++re)if(Ce=M[re],Ce<z&&++W>a&&U("overflow"),Ce==z){for(Oe=W,Pe=l;De=Pe<=te?u:Pe>=te+f?f:Pe-te,!(Oe<De);Pe+=l)Kr=Oe-De,Ft=l-De,ke.push(C(m(De+Kr%Ft,0))),Oe=P(Kr/Ft);ke.push(C(m(Oe,0))),te=y(W,xt,Y==ee),W=0,++Y}++W,++z}return ke.join("")}function O(M){return D(M,function(z){return x.test(z)?b(z.slice(4).toLowerCase()):z})}function F(M){return D(M,function(z){return T.test(z)?"xn--"+R(z):z})}if(o={version:"1.3.2",ucs2:{decode:j,encode:X},decode:b,encode:R,toASCII:F,toUnicode:O},r&&i)if(n.exports==r)i.exports=o;else for(N in o)o.hasOwnProperty(N)&&(r[N]=o[N]);else t.punycode=o})(lr)}(sn,sn.exports)),sn.exports}var hs={exports:{}};/*!
 * URI.js - Mutating URLs
 * IPv6 Support
 *
 * Version: 1.19.11
 *
 * Author: Rodney Rehm
 * Web: http://medialize.github.io/URI.js/
 *
 * Licensed under
 *   MIT License http://www.opensource.org/licenses/mit-license
 *
 */var xl;function Mx(){return xl||(xl=1,function(n){(function(e,t){n.exports?n.exports=t():e.IPv6=t(e)})(lr,function(e){var t=e&&e.IPv6;function r(s){var o=s.toLowerCase(),a=o.split(":"),l=a.length,u=8;a[0]===""&&a[1]===""&&a[2]===""?(a.shift(),a.shift()):a[0]===""&&a[1]===""?a.shift():a[l-1]===""&&a[l-2]===""&&a.pop(),l=a.length,a[l-1].indexOf(".")!==-1&&(u=7);var f;for(f=0;f<l&&a[f]!=="";f++);if(f<u)for(a.splice(f,1,"0000");a.length<u;)a.splice(f,0,"0000");for(var c,d=0;d<u;d++){c=a[d].split("");for(var g=0;g<3&&(c[0]==="0"&&c.length>1);g++)c.splice(0,1);a[d]=c.join("")}var p=-1,_=0,x=0,T=-1,E=!1;for(d=0;d<u;d++)E?a[d]==="0"?x+=1:(E=!1,x>_&&(p=T,_=x)):a[d]==="0"&&(E=!0,T=d,x=1);x>_&&(p=T,_=x),_>1&&a.splice(p,_,""),l=a.length;var w="";for(a[0]===""&&(w=":"),d=0;d<l&&(w+=a[d],d!==l-1);d++)w+=":";return a[l-1]===""&&(w+=":"),w}function i(){return e.IPv6===this&&(e.IPv6=t),this}return{best:r,noConflict:i}})}(hs)),hs.exports}var fs={exports:{}};/*!
 * URI.js - Mutating URLs
 * Second Level Domain (SLD) Support
 *
 * Version: 1.19.11
 *
 * Author: Rodney Rehm
 * Web: http://medialize.github.io/URI.js/
 *
 * Licensed under
 *   MIT License http://www.opensource.org/licenses/mit-license
 *
 */var El;function Nx(){return El||(El=1,function(n){(function(e,t){n.exports?n.exports=t():e.SecondLevelDomains=t(e)})(lr,function(e){var t=e&&e.SecondLevelDomains,r={list:{ac:" com gov mil net org ",ae:" ac co gov mil name net org pro sch ",af:" com edu gov net org ",al:" com edu gov mil net org ",ao:" co ed gv it og pb ",ar:" com edu gob gov int mil net org tur ",at:" ac co gv or ",au:" asn com csiro edu gov id net org ",ba:" co com edu gov mil net org rs unbi unmo unsa untz unze ",bb:" biz co com edu gov info net org store tv ",bh:" biz cc com edu gov info net org ",bn:" com edu gov net org ",bo:" com edu gob gov int mil net org tv ",br:" adm adv agr am arq art ato b bio blog bmd cim cng cnt com coop ecn edu eng esp etc eti far flog fm fnd fot fst g12 ggf gov imb ind inf jor jus lel mat med mil mus net nom not ntr odo org ppg pro psc psi qsl rec slg srv tmp trd tur tv vet vlog wiki zlg ",bs:" com edu gov net org ",bz:" du et om ov rg ",ca:" ab bc mb nb nf nl ns nt nu on pe qc sk yk ",ck:" biz co edu gen gov info net org ",cn:" ac ah bj com cq edu fj gd gov gs gx gz ha hb he hi hl hn jl js jx ln mil net nm nx org qh sc sd sh sn sx tj tw xj xz yn zj ",co:" com edu gov mil net nom org ",cr:" ac c co ed fi go or sa ",cy:" ac biz com ekloges gov ltd name net org parliament press pro tm ",do:" art com edu gob gov mil net org sld web ",dz:" art asso com edu gov net org pol ",ec:" com edu fin gov info med mil net org pro ",eg:" com edu eun gov mil name net org sci ",er:" com edu gov ind mil net org rochest w ",es:" com edu gob nom org ",et:" biz com edu gov info name net org ",fj:" ac biz com info mil name net org pro ",fk:" ac co gov net nom org ",fr:" asso com f gouv nom prd presse tm ",gg:" co net org ",gh:" com edu gov mil org ",gn:" ac com gov net org ",gr:" com edu gov mil net org ",gt:" com edu gob ind mil net org ",gu:" com edu gov net org ",hk:" com edu gov idv net org ",hu:" 2000 agrar bolt casino city co erotica erotika film forum games hotel info ingatlan jogasz konyvelo lakas media news org priv reklam sex shop sport suli szex tm tozsde utazas video ",id:" ac co go mil net or sch web ",il:" ac co gov idf k12 muni net org ",in:" ac co edu ernet firm gen gov i ind mil net nic org res ",iq:" com edu gov i mil net org ",ir:" ac co dnssec gov i id net org sch ",it:" edu gov ",je:" co net org ",jo:" com edu gov mil name net org sch ",jp:" ac ad co ed go gr lg ne or ",ke:" ac co go info me mobi ne or sc ",kh:" com edu gov mil net org per ",ki:" biz com de edu gov info mob net org tel ",km:" asso com coop edu gouv k medecin mil nom notaires pharmaciens presse tm veterinaire ",kn:" edu gov net org ",kr:" ac busan chungbuk chungnam co daegu daejeon es gangwon go gwangju gyeongbuk gyeonggi gyeongnam hs incheon jeju jeonbuk jeonnam k kg mil ms ne or pe re sc seoul ulsan ",kw:" com edu gov net org ",ky:" com edu gov net org ",kz:" com edu gov mil net org ",lb:" com edu gov net org ",lk:" assn com edu gov grp hotel int ltd net ngo org sch soc web ",lr:" com edu gov net org ",lv:" asn com conf edu gov id mil net org ",ly:" com edu gov id med net org plc sch ",ma:" ac co gov m net org press ",mc:" asso tm ",me:" ac co edu gov its net org priv ",mg:" com edu gov mil nom org prd tm ",mk:" com edu gov inf name net org pro ",ml:" com edu gov net org presse ",mn:" edu gov org ",mo:" com edu gov net org ",mt:" com edu gov net org ",mv:" aero biz com coop edu gov info int mil museum name net org pro ",mw:" ac co com coop edu gov int museum net org ",mx:" com edu gob net org ",my:" com edu gov mil name net org sch ",nf:" arts com firm info net other per rec store web ",ng:" biz com edu gov mil mobi name net org sch ",ni:" ac co com edu gob mil net nom org ",np:" com edu gov mil net org ",nr:" biz com edu gov info net org ",om:" ac biz co com edu gov med mil museum net org pro sch ",pe:" com edu gob mil net nom org sld ",ph:" com edu gov i mil net ngo org ",pk:" biz com edu fam gob gok gon gop gos gov net org web ",pl:" art bialystok biz com edu gda gdansk gorzow gov info katowice krakow lodz lublin mil net ngo olsztyn org poznan pwr radom slupsk szczecin torun warszawa waw wroc wroclaw zgora ",pr:" ac biz com edu est gov info isla name net org pro prof ",ps:" com edu gov net org plo sec ",pw:" belau co ed go ne or ",ro:" arts com firm info nom nt org rec store tm www ",rs:" ac co edu gov in org ",sb:" com edu gov net org ",sc:" com edu gov net org ",sh:" co com edu gov net nom org ",sl:" com edu gov net org ",st:" co com consulado edu embaixada gov mil net org principe saotome store ",sv:" com edu gob org red ",sz:" ac co org ",tr:" av bbs bel biz com dr edu gen gov info k12 name net org pol tel tsk tv web ",tt:" aero biz cat co com coop edu gov info int jobs mil mobi museum name net org pro tel travel ",tw:" club com ebiz edu game gov idv mil net org ",mu:" ac co com gov net or org ",mz:" ac co edu gov org ",na:" co com ",nz:" ac co cri geek gen govt health iwi maori mil net org parliament school ",pa:" abo ac com edu gob ing med net nom org sld ",pt:" com edu gov int net nome org publ ",py:" com edu gov mil net org ",qa:" com edu gov mil net org ",re:" asso com nom ",ru:" ac adygeya altai amur arkhangelsk astrakhan bashkiria belgorod bir bryansk buryatia cbg chel chelyabinsk chita chukotka chuvashia com dagestan e-burg edu gov grozny int irkutsk ivanovo izhevsk jar joshkar-ola kalmykia kaluga kamchatka karelia kazan kchr kemerovo khabarovsk khakassia khv kirov koenig komi kostroma kranoyarsk kuban kurgan kursk lipetsk magadan mari mari-el marine mil mordovia mosreg msk murmansk nalchik net nnov nov novosibirsk nsk omsk orenburg org oryol penza perm pp pskov ptz rnd ryazan sakhalin samara saratov simbirsk smolensk spb stavropol stv surgut tambov tatarstan tom tomsk tsaritsyn tsk tula tuva tver tyumen udm udmurtia ulan-ude vladikavkaz vladimir vladivostok volgograd vologda voronezh vrn vyatka yakutia yamal yekaterinburg yuzhno-sakhalinsk ",rw:" ac co com edu gouv gov int mil net ",sa:" com edu gov med net org pub sch ",sd:" com edu gov info med net org tv ",se:" a ac b bd c d e f g h i k l m n o org p parti pp press r s t tm u w x y z ",sg:" com edu gov idn net org per ",sn:" art com edu gouv org perso univ ",sy:" com edu gov mil net news org ",th:" ac co go in mi net or ",tj:" ac biz co com edu go gov info int mil name net nic org test web ",tn:" agrinet com defense edunet ens fin gov ind info intl mincom nat net org perso rnrt rns rnu tourism ",tz:" ac co go ne or ",ua:" biz cherkassy chernigov chernovtsy ck cn co com crimea cv dn dnepropetrovsk donetsk dp edu gov if in ivano-frankivsk kh kharkov kherson khmelnitskiy kiev kirovograd km kr ks kv lg lugansk lutsk lviv me mk net nikolaev od odessa org pl poltava pp rovno rv sebastopol sumy te ternopil uzhgorod vinnica vn zaporizhzhe zhitomir zp zt ",ug:" ac co go ne or org sc ",uk:" ac bl british-library co cym gov govt icnet jet lea ltd me mil mod national-library-scotland nel net nhs nic nls org orgn parliament plc police sch scot soc ",us:" dni fed isa kids nsn ",uy:" com edu gub mil net org ",ve:" co com edu gob info mil net org web ",vi:" co com k12 net org ",vn:" ac biz com edu gov health info int name net org pro ",ye:" co com gov ltd me net org plc ",yu:" ac co edu gov org ",za:" ac agric alt bourse city co cybernet db edu gov grondar iaccess imt inca landesign law mil net ngo nis nom olivetti org pix school tm web ",zm:" ac co com edu gov net org sch ",com:"ar br cn de eu gb gr hu jpn kr no qc ru sa se uk us uy za ",net:"gb jp se uk ",org:"ae",de:"com "},has:function(i){var s=i.lastIndexOf(".");if(s<=0||s>=i.length-1)return!1;var o=i.lastIndexOf(".",s-1);if(o<=0||o>=s-1)return!1;var a=r.list[i.slice(s+1)];return a?a.indexOf(" "+i.slice(o+1,s)+" ")>=0:!1},is:function(i){var s=i.lastIndexOf(".");if(s<=0||s>=i.length-1)return!1;var o=i.lastIndexOf(".",s-1);if(o>=0)return!1;var a=r.list[i.slice(s+1)];return a?a.indexOf(" "+i.slice(0,s)+" ")>=0:!1},get:function(i){var s=i.lastIndexOf(".");if(s<=0||s>=i.length-1)return null;var o=i.lastIndexOf(".",s-1);if(o<=0||o>=s-1)return null;var a=r.list[i.slice(s+1)];return!a||a.indexOf(" "+i.slice(o+1,s)+" ")<0?null:i.slice(o+1)},noConflict:function(){return e.SecondLevelDomains===this&&(e.SecondLevelDomains=t),this}};return r})}(fs)),fs.exports}/*!
 * URI.js - Mutating URLs
 *
 * Version: 1.19.11
 *
 * Author: Rodney Rehm
 * Web: http://medialize.github.io/URI.js/
 *
 * Licensed under
 *   MIT License http://www.opensource.org/licenses/mit-license
 *
 */(function(n){(function(e,t){n.exports?n.exports=t(Ox(),Mx(),Nx()):e.URI=t(e.punycode,e.IPv6,e.SecondLevelDomains,e)})(lr,function(e,t,r,i){var s=i&&i.URI;function o(h,m){var y=arguments.length>=1,b=arguments.length>=2;if(!(this instanceof o))return y?b?new o(h,m):new o(h):new o;if(h===void 0){if(y)throw new TypeError("undefined is not a valid argument for URI");typeof location<"u"?h=location.href+"":h=""}if(h===null&&y)throw new TypeError("null is not a valid argument for URI");return this.href(h),m!==void 0?this.absoluteTo(m):this}function a(h){return/^[0-9]+$/.test(h)}o.version="1.19.11";var l=o.prototype,u=Object.prototype.hasOwnProperty;function f(h){return h.replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1")}function c(h){return h===void 0?"Undefined":String(Object.prototype.toString.call(h)).slice(8,-1)}function d(h){return c(h)==="Array"}function g(h,m){var y={},b,R;if(c(m)==="RegExp")y=null;else if(d(m))for(b=0,R=m.length;b<R;b++)y[m[b]]=!0;else y[m]=!0;for(b=0,R=h.length;b<R;b++){var O=y&&y[h[b]]!==void 0||!y&&m.test(h[b]);O&&(h.splice(b,1),R--,b--)}return h}function p(h,m){var y,b;if(d(m)){for(y=0,b=m.length;y<b;y++)if(!p(h,m[y]))return!1;return!0}var R=c(m);for(y=0,b=h.length;y<b;y++)if(R==="RegExp"){if(typeof h[y]=="string"&&h[y].match(m))return!0}else if(h[y]===m)return!0;return!1}function _(h,m){if(!d(h)||!d(m)||h.length!==m.length)return!1;h.sort(),m.sort();for(var y=0,b=h.length;y<b;y++)if(h[y]!==m[y])return!1;return!0}function x(h){var m=/^\/+|\/+$/g;return h.replace(m,"")}o._parts=function(){return{protocol:null,username:null,password:null,hostname:null,urn:null,port:null,path:null,query:null,fragment:null,preventInvalidHostname:o.preventInvalidHostname,duplicateQueryParameters:o.duplicateQueryParameters,escapeQuerySpace:o.escapeQuerySpace}},o.preventInvalidHostname=!1,o.duplicateQueryParameters=!1,o.escapeQuerySpace=!0,o.protocol_expression=/^[a-z][a-z0-9.+-]*$/i,o.idn_expression=/[^a-z0-9\._-]/i,o.punycode_expression=/(xn--)/i,o.ip4_expression=/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/,o.ip6_expression=/^\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?\s*$/,o.find_uri_expression=/\b((?:[a-z][\w-]+:(?:\/{1,3}|[a-z0-9%])|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?]))/ig,o.findUri={start:/\b(?:([a-z][a-z0-9.+-]*:\/\/)|www\.)/gi,end:/[\s\r\n]|$/,trim:/[`!()\[\]{};:'".,<>?]+$/,parens:/(\([^\)]*\)|\[[^\]]*\]|\{[^}]*\}|<[^>]*>)/g},o.leading_whitespace_expression=/^[\x00-\x20\u00a0\u1680\u2000-\u200a\u2028\u2029\u202f\u205f\u3000\ufeff]+/,o.ascii_tab_whitespace=/[\u0009\u000A\u000D]+/g,o.defaultPorts={http:"80",https:"443",ftp:"21",gopher:"70",ws:"80",wss:"443"},o.hostProtocols=["http","https"],o.invalid_hostname_characters=/[^a-zA-Z0-9\.\-:_]/,o.domAttributes={a:"href",blockquote:"cite",link:"href",base:"href",script:"src",form:"action",img:"src",area:"href",iframe:"src",embed:"src",source:"src",track:"src",input:"src",audio:"src",video:"src"},o.getDomAttribute=function(h){if(!(!h||!h.nodeName)){var m=h.nodeName.toLowerCase();if(!(m==="input"&&h.type!=="image"))return o.domAttributes[m]}};function T(h){return escape(h)}function E(h){return encodeURIComponent(h).replace(/[!'()*]/g,T).replace(/\*/g,"%2A")}o.encode=E,o.decode=decodeURIComponent,o.iso8859=function(){o.encode=escape,o.decode=unescape},o.unicode=function(){o.encode=E,o.decode=decodeURIComponent},o.characters={pathname:{encode:{expression:/%(24|26|2B|2C|3B|3D|3A|40)/ig,map:{"%24":"$","%26":"&","%2B":"+","%2C":",","%3B":";","%3D":"=","%3A":":","%40":"@"}},decode:{expression:/[\/\?#]/g,map:{"/":"%2F","?":"%3F","#":"%23"}}},reserved:{encode:{expression:/%(21|23|24|26|27|28|29|2A|2B|2C|2F|3A|3B|3D|3F|40|5B|5D)/ig,map:{"%3A":":","%2F":"/","%3F":"?","%23":"#","%5B":"[","%5D":"]","%40":"@","%21":"!","%24":"$","%26":"&","%27":"'","%28":"(","%29":")","%2A":"*","%2B":"+","%2C":",","%3B":";","%3D":"="}}},urnpath:{encode:{expression:/%(21|24|27|28|29|2A|2B|2C|3B|3D|40)/ig,map:{"%21":"!","%24":"$","%27":"'","%28":"(","%29":")","%2A":"*","%2B":"+","%2C":",","%3B":";","%3D":"=","%40":"@"}},decode:{expression:/[\/\?#:]/g,map:{"/":"%2F","?":"%3F","#":"%23",":":"%3A"}}}},o.encodeQuery=function(h,m){var y=o.encode(h+"");return m===void 0&&(m=o.escapeQuerySpace),m?y.replace(/%20/g,"+"):y},o.decodeQuery=function(h,m){h+="",m===void 0&&(m=o.escapeQuerySpace);try{return o.decode(m?h.replace(/\+/g,"%20"):h)}catch{return h}};var w={encode:"encode",decode:"decode"},A,P=function(h,m){return function(y){try{return o[m](y+"").replace(o.characters[h][m].expression,function(b){return o.characters[h][m].map[b]})}catch{return y}}};for(A in w)o[A+"PathSegment"]=P("pathname",w[A]),o[A+"UrnPathSegment"]=P("urnpath",w[A]);var C=function(h,m,y){return function(b){var R;y?R=function(z){return o[m](o[y](z))}:R=o[m];for(var O=(b+"").split(h),F=0,M=O.length;F<M;F++)O[F]=R(O[F]);return O.join(h)}};o.decodePath=C("/","decodePathSegment"),o.decodeUrnPath=C(":","decodeUrnPathSegment"),o.recodePath=C("/","encodePathSegment","decode"),o.recodeUrnPath=C(":","encodeUrnPathSegment","decode"),o.encodeReserved=P("reserved","encode"),o.parse=function(h,m){var y;return m||(m={preventInvalidHostname:o.preventInvalidHostname}),h=h.replace(o.leading_whitespace_expression,""),h=h.replace(o.ascii_tab_whitespace,""),y=h.indexOf("#"),y>-1&&(m.fragment=h.substring(y+1)||null,h=h.substring(0,y)),y=h.indexOf("?"),y>-1&&(m.query=h.substring(y+1)||null,h=h.substring(0,y)),h=h.replace(/^(https?|ftp|wss?)?:+[/\\]*/i,"$1://"),h=h.replace(/^[/\\]{2,}/i,"//"),h.substring(0,2)==="//"?(m.protocol=null,h=h.substring(2),h=o.parseAuthority(h,m)):(y=h.indexOf(":"),y>-1&&(m.protocol=h.substring(0,y)||null,m.protocol&&!m.protocol.match(o.protocol_expression)?m.protocol=void 0:h.substring(y+1,y+3).replace(/\\/g,"/")==="//"?(h=h.substring(y+3),h=o.parseAuthority(h,m)):(h=h.substring(y+1),m.urn=!0))),m.path=h,m},o.parseHost=function(h,m){h||(h=""),h=h.replace(/\\/g,"/");var y=h.indexOf("/"),b,R;if(y===-1&&(y=h.length),h.charAt(0)==="[")b=h.indexOf("]"),m.hostname=h.substring(1,b)||null,m.port=h.substring(b+2,y)||null,m.port==="/"&&(m.port=null);else{var O=h.indexOf(":"),F=h.indexOf("/"),M=h.indexOf(":",O+1);M!==-1&&(F===-1||M<F)?(m.hostname=h.substring(0,y)||null,m.port=null):(R=h.substring(0,y).split(":"),m.hostname=R[0]||null,m.port=R[1]||null)}return m.hostname&&h.substring(y).charAt(0)!=="/"&&(y++,h="/"+h),m.preventInvalidHostname&&o.ensureValidHostname(m.hostname,m.protocol),m.port&&o.ensureValidPort(m.port),h.substring(y)||"/"},o.parseAuthority=function(h,m){return h=o.parseUserinfo(h,m),o.parseHost(h,m)},o.parseUserinfo=function(h,m){var y=h,b=h.indexOf("\\");b!==-1&&(h=h.replace(/\\/g,"/"));var R=h.indexOf("/"),O=h.lastIndexOf("@",R>-1?R:h.length-1),F;return O>-1&&(R===-1||O<R)?(F=h.substring(0,O).split(":"),m.username=F[0]?o.decode(F[0]):null,F.shift(),m.password=F[0]?o.decode(F.join(":")):null,h=y.substring(O+1)):(m.username=null,m.password=null),h},o.parseQuery=function(h,m){if(!h)return{};if(h=h.replace(/&+/g,"&").replace(/^\?*&*|&+$/g,""),!h)return{};for(var y={},b=h.split("&"),R=b.length,O,F,M,z=0;z<R;z++)O=b[z].split("="),F=o.decodeQuery(O.shift(),m),M=O.length?o.decodeQuery(O.join("="),m):null,F!=="__proto__"&&(u.call(y,F)?((typeof y[F]=="string"||y[F]===null)&&(y[F]=[y[F]]),y[F].push(M)):y[F]=M);return y},o.build=function(h){var m="",y=!1;return h.protocol&&(m+=h.protocol+":"),!h.urn&&(m||h.hostname)&&(m+="//",y=!0),m+=o.buildAuthority(h)||"",typeof h.path=="string"&&(h.path.charAt(0)!=="/"&&y&&(m+="/"),m+=h.path),typeof h.query=="string"&&h.query&&(m+="?"+h.query),typeof h.fragment=="string"&&h.fragment&&(m+="#"+h.fragment),m},o.buildHost=function(h){var m="";if(h.hostname)o.ip6_expression.test(h.hostname)?m+="["+h.hostname+"]":m+=h.hostname;else return"";return h.port&&(m+=":"+h.port),m},o.buildAuthority=function(h){return o.buildUserinfo(h)+o.buildHost(h)},o.buildUserinfo=function(h){var m="";return h.username&&(m+=o.encode(h.username)),h.password&&(m+=":"+o.encode(h.password)),m&&(m+="@"),m},o.buildQuery=function(h,m,y){var b="",R,O,F,M;for(O in h)if(O!=="__proto__"&&u.call(h,O))if(d(h[O]))for(R={},F=0,M=h[O].length;F<M;F++)h[O][F]!==void 0&&R[h[O][F]+""]===void 0&&(b+="&"+o.buildQueryParameter(O,h[O][F],y),m!==!0&&(R[h[O][F]+""]=!0));else h[O]!==void 0&&(b+="&"+o.buildQueryParameter(O,h[O],y));return b.substring(1)},o.buildQueryParameter=function(h,m,y){return o.encodeQuery(h,y)+(m!==null?"="+o.encodeQuery(m,y):"")},o.addQuery=function(h,m,y){if(typeof m=="object")for(var b in m)u.call(m,b)&&o.addQuery(h,b,m[b]);else if(typeof m=="string"){if(h[m]===void 0){h[m]=y;return}else typeof h[m]=="string"&&(h[m]=[h[m]]);d(y)||(y=[y]),h[m]=(h[m]||[]).concat(y)}else throw new TypeError("URI.addQuery() accepts an object, string as the name parameter")},o.setQuery=function(h,m,y){if(typeof m=="object")for(var b in m)u.call(m,b)&&o.setQuery(h,b,m[b]);else if(typeof m=="string")h[m]=y===void 0?null:y;else throw new TypeError("URI.setQuery() accepts an object, string as the name parameter")},o.removeQuery=function(h,m,y){var b,R,O;if(d(m))for(b=0,R=m.length;b<R;b++)h[m[b]]=void 0;else if(c(m)==="RegExp")for(O in h)m.test(O)&&(h[O]=void 0);else if(typeof m=="object")for(O in m)u.call(m,O)&&o.removeQuery(h,O,m[O]);else if(typeof m=="string")y!==void 0?c(y)==="RegExp"?!d(h[m])&&y.test(h[m])?h[m]=void 0:h[m]=g(h[m],y):h[m]===String(y)&&(!d(y)||y.length===1)?h[m]=void 0:d(h[m])&&(h[m]=g(h[m],y)):h[m]=void 0;else throw new TypeError("URI.removeQuery() accepts an object, string, RegExp as the first parameter")},o.hasQuery=function(h,m,y,b){switch(c(m)){case"String":break;case"RegExp":for(var R in h)if(u.call(h,R)&&m.test(R)&&(y===void 0||o.hasQuery(h,R,y)))return!0;return!1;case"Object":for(var O in m)if(u.call(m,O)&&!o.hasQuery(h,O,m[O]))return!1;return!0;default:throw new TypeError("URI.hasQuery() accepts a string, regular expression or object as the name parameter")}switch(c(y)){case"Undefined":return m in h;case"Boolean":var F=!!(d(h[m])?h[m].length:h[m]);return y===F;case"Function":return!!y(h[m],m,h);case"Array":if(!d(h[m]))return!1;var M=b?p:_;return M(h[m],y);case"RegExp":return d(h[m])?b?p(h[m],y):!1:!!(h[m]&&h[m].match(y));case"Number":y=String(y);case"String":return d(h[m])?b?p(h[m],y):!1:h[m]===y;default:throw new TypeError("URI.hasQuery() accepts undefined, boolean, string, number, RegExp, Function as the value parameter")}},o.joinPaths=function(){for(var h=[],m=[],y=0,b=0;b<arguments.length;b++){var R=new o(arguments[b]);h.push(R);for(var O=R.segment(),F=0;F<O.length;F++)typeof O[F]=="string"&&m.push(O[F]),O[F]&&y++}if(!m.length||!y)return new o("");var M=new o("").segment(m);return(h[0].path()===""||h[0].path().slice(0,1)==="/")&&M.path("/"+M.path()),M.normalize()},o.commonPath=function(h,m){var y=Math.min(h.length,m.length),b;for(b=0;b<y;b++)if(h.charAt(b)!==m.charAt(b)){b--;break}return b<1?h.charAt(0)===m.charAt(0)&&h.charAt(0)==="/"?"/":"":((h.charAt(b)!=="/"||m.charAt(b)!=="/")&&(b=h.substring(0,b).lastIndexOf("/")),h.substring(0,b+1))},o.withinString=function(h,m,y){y||(y={});var b=y.start||o.findUri.start,R=y.end||o.findUri.end,O=y.trim||o.findUri.trim,F=y.parens||o.findUri.parens,M=/[a-z0-9-]=["']?$/i;for(b.lastIndex=0;;){var z=b.exec(h);if(!z)break;var W=z.index;if(y.ignoreHtml){var Y=h.slice(Math.max(W-3,0),W);if(Y&&M.test(Y))continue}for(var ee=W+h.slice(W).search(R),te=h.slice(W,ee),re=-1;;){var de=F.exec(te);if(!de)break;var Oe=de.index+de[0].length;re=Math.max(re,Oe)}if(re>-1?te=te.slice(0,re)+te.slice(re).replace(O,""):te=te.replace(O,""),!(te.length<=z[0].length)&&!(y.ignore&&y.ignore.test(te))){ee=W+te.length;var Pe=m(te,W,ee,h);if(Pe===void 0){b.lastIndex=ee;continue}Pe=String(Pe),h=h.slice(0,W)+Pe+h.slice(ee),b.lastIndex=W+Pe.length}}return b.lastIndex=0,h},o.ensureValidHostname=function(h,m){var y=!!h,b=!!m,R=!1;if(b&&(R=p(o.hostProtocols,m)),R&&!y)throw new TypeError("Hostname cannot be empty, if protocol is "+m);if(h&&h.match(o.invalid_hostname_characters)){if(!e)throw new TypeError('Hostname "'+h+'" contains characters other than [A-Z0-9.-:_] and Punycode.js is not available');if(e.toASCII(h).match(o.invalid_hostname_characters))throw new TypeError('Hostname "'+h+'" contains characters other than [A-Z0-9.-:_]')}},o.ensureValidPort=function(h){if(h){var m=Number(h);if(!(a(m)&&m>0&&m<65536))throw new TypeError('Port "'+h+'" is not a valid port')}},o.noConflict=function(h){if(h){var m={URI:this.noConflict()};return i.URITemplate&&typeof i.URITemplate.noConflict=="function"&&(m.URITemplate=i.URITemplate.noConflict()),i.IPv6&&typeof i.IPv6.noConflict=="function"&&(m.IPv6=i.IPv6.noConflict()),i.SecondLevelDomains&&typeof i.SecondLevelDomains.noConflict=="function"&&(m.SecondLevelDomains=i.SecondLevelDomains.noConflict()),m}else i.URI===this&&(i.URI=s);return this},l.build=function(h){return h===!0?this._deferred_build=!0:(h===void 0||this._deferred_build)&&(this._string=o.build(this._parts),this._deferred_build=!1),this},l.clone=function(){return new o(this)},l.valueOf=l.toString=function(){return this.build(!1)._string};function N(h){return function(m,y){return m===void 0?this._parts[h]||"":(this._parts[h]=m||null,this.build(!y),this)}}function U(h,m){return function(y,b){return y===void 0?this._parts[h]||"":(y!==null&&(y=y+"",y.charAt(0)===m&&(y=y.substring(1))),this._parts[h]=y,this.build(!b),this)}}l.protocol=N("protocol"),l.username=N("username"),l.password=N("password"),l.hostname=N("hostname"),l.port=N("port"),l.query=U("query","?"),l.fragment=U("fragment","#"),l.search=function(h,m){var y=this.query(h,m);return typeof y=="string"&&y.length?"?"+y:y},l.hash=function(h,m){var y=this.fragment(h,m);return typeof y=="string"&&y.length?"#"+y:y},l.pathname=function(h,m){if(h===void 0||h===!0){var y=this._parts.path||(this._parts.hostname?"/":"");return h?(this._parts.urn?o.decodeUrnPath:o.decodePath)(y):y}else return this._parts.urn?this._parts.path=h?o.recodeUrnPath(h):"":this._parts.path=h?o.recodePath(h):"/",this.build(!m),this},l.path=l.pathname,l.href=function(h,m){var y;if(h===void 0)return this.toString();this._string="",this._parts=o._parts();var b=h instanceof o,R=typeof h=="object"&&(h.hostname||h.path||h.pathname);if(h.nodeName){var O=o.getDomAttribute(h);h=h[O]||"",R=!1}if(!b&&R&&h.pathname!==void 0&&(h=h.toString()),typeof h=="string"||h instanceof String)this._parts=o.parse(String(h),this._parts);else if(b||R){var F=b?h._parts:h;for(y in F)y!=="query"&&u.call(this._parts,y)&&(this._parts[y]=F[y]);F.query&&this.query(F.query,!1)}else throw new TypeError("invalid input");return this.build(!m),this},l.is=function(h){var m=!1,y=!1,b=!1,R=!1,O=!1,F=!1,M=!1,z=!this._parts.urn;switch(this._parts.hostname&&(z=!1,y=o.ip4_expression.test(this._parts.hostname),b=o.ip6_expression.test(this._parts.hostname),m=y||b,R=!m,O=R&&r&&r.has(this._parts.hostname),F=R&&o.idn_expression.test(this._parts.hostname),M=R&&o.punycode_expression.test(this._parts.hostname)),h.toLowerCase()){case"relative":return z;case"absolute":return!z;case"domain":case"name":return R;case"sld":return O;case"ip":return m;case"ip4":case"ipv4":case"inet4":return y;case"ip6":case"ipv6":case"inet6":return b;case"idn":return F;case"url":return!this._parts.urn;case"urn":return!!this._parts.urn;case"punycode":return M}return null};var k=l.protocol,D=l.port,j=l.hostname;l.protocol=function(h,m){if(h&&(h=h.replace(/:(\/\/)?$/,""),!h.match(o.protocol_expression)))throw new TypeError('Protocol "'+h+`" contains characters other than [A-Z0-9.+-] or doesn't start with [A-Z]`);return k.call(this,h,m)},l.scheme=l.protocol,l.port=function(h,m){return this._parts.urn?h===void 0?"":this:(h!==void 0&&(h===0&&(h=null),h&&(h+="",h.charAt(0)===":"&&(h=h.substring(1)),o.ensureValidPort(h))),D.call(this,h,m))},l.hostname=function(h,m){if(this._parts.urn)return h===void 0?"":this;if(h!==void 0){var y={preventInvalidHostname:this._parts.preventInvalidHostname},b=o.parseHost(h,y);if(b!=="/")throw new TypeError('Hostname "'+h+'" contains characters other than [A-Z0-9.-]');h=y.hostname,this._parts.preventInvalidHostname&&o.ensureValidHostname(h,this._parts.protocol)}return j.call(this,h,m)},l.origin=function(h,m){if(this._parts.urn)return h===void 0?"":this;if(h===void 0){var y=this.protocol(),b=this.authority();return b?(y?y+"://":"")+this.authority():""}else{var R=o(h);return this.protocol(R.protocol()).authority(R.authority()).build(!m),this}},l.host=function(h,m){if(this._parts.urn)return h===void 0?"":this;if(h===void 0)return this._parts.hostname?o.buildHost(this._parts):"";var y=o.parseHost(h,this._parts);if(y!=="/")throw new TypeError('Hostname "'+h+'" contains characters other than [A-Z0-9.-]');return this.build(!m),this},l.authority=function(h,m){if(this._parts.urn)return h===void 0?"":this;if(h===void 0)return this._parts.hostname?o.buildAuthority(this._parts):"";var y=o.parseAuthority(h,this._parts);if(y!=="/")throw new TypeError('Hostname "'+h+'" contains characters other than [A-Z0-9.-]');return this.build(!m),this},l.userinfo=function(h,m){if(this._parts.urn)return h===void 0?"":this;if(h===void 0){var y=o.buildUserinfo(this._parts);return y&&y.substring(0,y.length-1)}else return h[h.length-1]!=="@"&&(h+="@"),o.parseUserinfo(h,this._parts),this.build(!m),this},l.resource=function(h,m){var y;return h===void 0?this.path()+this.search()+this.hash():(y=o.parse(h),this._parts.path=y.path,this._parts.query=y.query,this._parts.fragment=y.fragment,this.build(!m),this)},l.subdomain=function(h,m){if(this._parts.urn)return h===void 0?"":this;if(h===void 0){if(!this._parts.hostname||this.is("IP"))return"";var y=this._parts.hostname.length-this.domain().length-1;return this._parts.hostname.substring(0,y)||""}else{var b=this._parts.hostname.length-this.domain().length,R=this._parts.hostname.substring(0,b),O=new RegExp("^"+f(R));if(h&&h.charAt(h.length-1)!=="."&&(h+="."),h.indexOf(":")!==-1)throw new TypeError("Domains cannot contain colons");return h&&o.ensureValidHostname(h,this._parts.protocol),this._parts.hostname=this._parts.hostname.replace(O,h),this.build(!m),this}},l.domain=function(h,m){if(this._parts.urn)return h===void 0?"":this;if(typeof h=="boolean"&&(m=h,h=void 0),h===void 0){if(!this._parts.hostname||this.is("IP"))return"";var y=this._parts.hostname.match(/\./g);if(y&&y.length<2)return this._parts.hostname;var b=this._parts.hostname.length-this.tld(m).length-1;return b=this._parts.hostname.lastIndexOf(".",b-1)+1,this._parts.hostname.substring(b)||""}else{if(!h)throw new TypeError("cannot set domain empty");if(h.indexOf(":")!==-1)throw new TypeError("Domains cannot contain colons");if(o.ensureValidHostname(h,this._parts.protocol),!this._parts.hostname||this.is("IP"))this._parts.hostname=h;else{var R=new RegExp(f(this.domain())+"$");this._parts.hostname=this._parts.hostname.replace(R,h)}return this.build(!m),this}},l.tld=function(h,m){if(this._parts.urn)return h===void 0?"":this;if(typeof h=="boolean"&&(m=h,h=void 0),h===void 0){if(!this._parts.hostname||this.is("IP"))return"";var y=this._parts.hostname.lastIndexOf("."),b=this._parts.hostname.substring(y+1);return m!==!0&&r&&r.list[b.toLowerCase()]&&r.get(this._parts.hostname)||b}else{var R;if(h)if(h.match(/[^a-zA-Z0-9-]/))if(r&&r.is(h))R=new RegExp(f(this.tld())+"$"),this._parts.hostname=this._parts.hostname.replace(R,h);else throw new TypeError('TLD "'+h+'" contains characters other than [A-Z0-9]');else{if(!this._parts.hostname||this.is("IP"))throw new ReferenceError("cannot set TLD on non-domain host");R=new RegExp(f(this.tld())+"$"),this._parts.hostname=this._parts.hostname.replace(R,h)}else throw new TypeError("cannot set TLD empty");return this.build(!m),this}},l.directory=function(h,m){if(this._parts.urn)return h===void 0?"":this;if(h===void 0||h===!0){if(!this._parts.path&&!this._parts.hostname)return"";if(this._parts.path==="/")return"/";var y=this._parts.path.length-this.filename().length-1,b=this._parts.path.substring(0,y)||(this._parts.hostname?"/":"");return h?o.decodePath(b):b}else{var R=this._parts.path.length-this.filename().length,O=this._parts.path.substring(0,R),F=new RegExp("^"+f(O));return this.is("relative")||(h||(h="/"),h.charAt(0)!=="/"&&(h="/"+h)),h&&h.charAt(h.length-1)!=="/"&&(h+="/"),h=o.recodePath(h),this._parts.path=this._parts.path.replace(F,h),this.build(!m),this}},l.filename=function(h,m){if(this._parts.urn)return h===void 0?"":this;if(typeof h!="string"){if(!this._parts.path||this._parts.path==="/")return"";var y=this._parts.path.lastIndexOf("/"),b=this._parts.path.substring(y+1);return h?o.decodePathSegment(b):b}else{var R=!1;h.charAt(0)==="/"&&(h=h.substring(1)),h.match(/\.?\//)&&(R=!0);var O=new RegExp(f(this.filename())+"$");return h=o.recodePath(h),this._parts.path=this._parts.path.replace(O,h),R?this.normalizePath(m):this.build(!m),this}},l.suffix=function(h,m){if(this._parts.urn)return h===void 0?"":this;if(h===void 0||h===!0){if(!this._parts.path||this._parts.path==="/")return"";var y=this.filename(),b=y.lastIndexOf("."),R,O;return b===-1?"":(R=y.substring(b+1),O=/^[a-z0-9%]+$/i.test(R)?R:"",h?o.decodePathSegment(O):O)}else{h.charAt(0)==="."&&(h=h.substring(1));var F=this.suffix(),M;if(F)h?M=new RegExp(f(F)+"$"):M=new RegExp(f("."+F)+"$");else{if(!h)return this;this._parts.path+="."+o.recodePath(h)}return M&&(h=o.recodePath(h),this._parts.path=this._parts.path.replace(M,h)),this.build(!m),this}},l.segment=function(h,m,y){var b=this._parts.urn?":":"/",R=this.path(),O=R.substring(0,1)==="/",F=R.split(b);if(h!==void 0&&typeof h!="number"&&(y=m,m=h,h=void 0),h!==void 0&&typeof h!="number")throw new Error('Bad segment "'+h+'", must be 0-based integer');if(O&&F.shift(),h<0&&(h=Math.max(F.length+h,0)),m===void 0)return h===void 0?F:F[h];if(h===null||F[h]===void 0)if(d(m)){F=[];for(var M=0,z=m.length;M<z;M++)!m[M].length&&(!F.length||!F[F.length-1].length)||(F.length&&!F[F.length-1].length&&F.pop(),F.push(x(m[M])))}else(m||typeof m=="string")&&(m=x(m),F[F.length-1]===""?F[F.length-1]=m:F.push(m));else m?F[h]=x(m):F.splice(h,1);return O&&F.unshift(""),this.path(F.join(b),y)},l.segmentCoded=function(h,m,y){var b,R,O;if(typeof h!="number"&&(y=m,m=h,h=void 0),m===void 0){if(b=this.segment(h,m,y),!d(b))b=b!==void 0?o.decode(b):void 0;else for(R=0,O=b.length;R<O;R++)b[R]=o.decode(b[R]);return b}if(!d(m))m=typeof m=="string"||m instanceof String?o.encode(m):m;else for(R=0,O=m.length;R<O;R++)m[R]=o.encode(m[R]);return this.segment(h,m,y)};var X=l.query;return l.query=function(h,m){if(h===!0)return o.parseQuery(this._parts.query,this._parts.escapeQuerySpace);if(typeof h=="function"){var y=o.parseQuery(this._parts.query,this._parts.escapeQuerySpace),b=h.call(this,y);return this._parts.query=o.buildQuery(b||y,this._parts.duplicateQueryParameters,this._parts.escapeQuerySpace),this.build(!m),this}else return h!==void 0&&typeof h!="string"?(this._parts.query=o.buildQuery(h,this._parts.duplicateQueryParameters,this._parts.escapeQuerySpace),this.build(!m),this):X.call(this,h,m)},l.setQuery=function(h,m,y){var b=o.parseQuery(this._parts.query,this._parts.escapeQuerySpace);if(typeof h=="string"||h instanceof String)b[h]=m!==void 0?m:null;else if(typeof h=="object")for(var R in h)u.call(h,R)&&(b[R]=h[R]);else throw new TypeError("URI.addQuery() accepts an object, string as the name parameter");return this._parts.query=o.buildQuery(b,this._parts.duplicateQueryParameters,this._parts.escapeQuerySpace),typeof h!="string"&&(y=m),this.build(!y),this},l.addQuery=function(h,m,y){var b=o.parseQuery(this._parts.query,this._parts.escapeQuerySpace);return o.addQuery(b,h,m===void 0?null:m),this._parts.query=o.buildQuery(b,this._parts.duplicateQueryParameters,this._parts.escapeQuerySpace),typeof h!="string"&&(y=m),this.build(!y),this},l.removeQuery=function(h,m,y){var b=o.parseQuery(this._parts.query,this._parts.escapeQuerySpace);return o.removeQuery(b,h,m),this._parts.query=o.buildQuery(b,this._parts.duplicateQueryParameters,this._parts.escapeQuerySpace),typeof h!="string"&&(y=m),this.build(!y),this},l.hasQuery=function(h,m,y){var b=o.parseQuery(this._parts.query,this._parts.escapeQuerySpace);return o.hasQuery(b,h,m,y)},l.setSearch=l.setQuery,l.addSearch=l.addQuery,l.removeSearch=l.removeQuery,l.hasSearch=l.hasQuery,l.normalize=function(){return this._parts.urn?this.normalizeProtocol(!1).normalizePath(!1).normalizeQuery(!1).normalizeFragment(!1).build():this.normalizeProtocol(!1).normalizeHostname(!1).normalizePort(!1).normalizePath(!1).normalizeQuery(!1).normalizeFragment(!1).build()},l.normalizeProtocol=function(h){return typeof this._parts.protocol=="string"&&(this._parts.protocol=this._parts.protocol.toLowerCase(),this.build(!h)),this},l.normalizeHostname=function(h){return this._parts.hostname&&(this.is("IDN")&&e?this._parts.hostname=e.toASCII(this._parts.hostname):this.is("IPv6")&&t&&(this._parts.hostname=t.best(this._parts.hostname)),this._parts.hostname=this._parts.hostname.toLowerCase(),this.build(!h)),this},l.normalizePort=function(h){return typeof this._parts.protocol=="string"&&this._parts.port===o.defaultPorts[this._parts.protocol]&&(this._parts.port=null,this.build(!h)),this},l.normalizePath=function(h){var m=this._parts.path;if(!m)return this;if(this._parts.urn)return this._parts.path=o.recodeUrnPath(this._parts.path),this.build(!h),this;if(this._parts.path==="/")return this;m=o.recodePath(m);var y,b="",R,O;for(m.charAt(0)!=="/"&&(y=!0,m="/"+m),(m.slice(-3)==="/.."||m.slice(-2)==="/.")&&(m+="/"),m=m.replace(/(\/(\.\/)+)|(\/\.$)/g,"/").replace(/\/{2,}/g,"/"),y&&(b=m.substring(1).match(/^(\.\.\/)+/)||"",b&&(b=b[0]));R=m.search(/\/\.\.(\/|$)/),R!==-1;){if(R===0){m=m.substring(3);continue}O=m.substring(0,R).lastIndexOf("/"),O===-1&&(O=R),m=m.substring(0,O)+m.substring(R+3)}return y&&this.is("relative")&&(m=b+m.substring(1)),this._parts.path=m,this.build(!h),this},l.normalizePathname=l.normalizePath,l.normalizeQuery=function(h){return typeof this._parts.query=="string"&&(this._parts.query.length?this.query(o.parseQuery(this._parts.query,this._parts.escapeQuerySpace)):this._parts.query=null,this.build(!h)),this},l.normalizeFragment=function(h){return this._parts.fragment||(this._parts.fragment=null,this.build(!h)),this},l.normalizeSearch=l.normalizeQuery,l.normalizeHash=l.normalizeFragment,l.iso8859=function(){var h=o.encode,m=o.decode;o.encode=escape,o.decode=decodeURIComponent;try{this.normalize()}finally{o.encode=h,o.decode=m}return this},l.unicode=function(){var h=o.encode,m=o.decode;o.encode=E,o.decode=unescape;try{this.normalize()}finally{o.encode=h,o.decode=m}return this},l.readable=function(){var h=this.clone();h.username("").password("").normalize();var m="";if(h._parts.protocol&&(m+=h._parts.protocol+"://"),h._parts.hostname&&(h.is("punycode")&&e?(m+=e.toUnicode(h._parts.hostname),h._parts.port&&(m+=":"+h._parts.port)):m+=h.host()),h._parts.hostname&&h._parts.path&&h._parts.path.charAt(0)!=="/"&&(m+="/"),m+=h.path(!0),h._parts.query){for(var y="",b=0,R=h._parts.query.split("&"),O=R.length;b<O;b++){var F=(R[b]||"").split("=");y+="&"+o.decodeQuery(F[0],this._parts.escapeQuerySpace).replace(/&/g,"%26"),F[1]!==void 0&&(y+="="+o.decodeQuery(F[1],this._parts.escapeQuerySpace).replace(/&/g,"%26"))}m+="?"+y.substring(1)}return m+=o.decodeQuery(h.hash(),!0),m},l.absoluteTo=function(h){var m=this.clone(),y=["protocol","username","password","hostname","port"],b,R,O;if(this._parts.urn)throw new Error("URNs do not have any generally defined hierarchical components");if(h instanceof o||(h=new o(h)),m._parts.protocol||(m._parts.protocol=h._parts.protocol,this._parts.hostname))return m;for(R=0;O=y[R];R++)m._parts[O]=h._parts[O];return m._parts.path?(m._parts.path.substring(-2)===".."&&(m._parts.path+="/"),m.path().charAt(0)!=="/"&&(b=h.directory(),b=b||(h.path().indexOf("/")===0?"/":""),m._parts.path=(b?b+"/":"")+m._parts.path,m.normalizePath())):(m._parts.path=h._parts.path,m._parts.query||(m._parts.query=h._parts.query)),m.build(),m},l.relativeTo=function(h){var m=this.clone().normalize(),y,b,R,O,F;if(m._parts.urn)throw new Error("URNs do not have any generally defined hierarchical components");if(h=new o(h).normalize(),y=m._parts,b=h._parts,O=m.path(),F=h.path(),O.charAt(0)!=="/")throw new Error("URI is already relative");if(F.charAt(0)!=="/")throw new Error("Cannot calculate a URI relative to another relative URI");if(y.protocol===b.protocol&&(y.protocol=null),y.username!==b.username||y.password!==b.password||y.protocol!==null||y.username!==null||y.password!==null)return m.build();if(y.hostname===b.hostname&&y.port===b.port)y.hostname=null,y.port=null;else return m.build();if(O===F)return y.path="",m.build();if(R=o.commonPath(O,F),!R)return m.build();var M=b.path.substring(R.length).replace(/[^\/]*$/,"").replace(/.*?\//g,"../");return y.path=M+y.path.substring(R.length)||"./",m.build()},l.equals=function(h){var m=this.clone(),y=new o(h),b={},R={},O={},F,M,z;if(m.normalize(),y.normalize(),m.toString()===y.toString())return!0;if(F=m.query(),M=y.query(),m.query(""),y.query(""),m.toString()!==y.toString()||F.length!==M.length)return!1;b=o.parseQuery(F,this._parts.escapeQuerySpace),R=o.parseQuery(M,this._parts.escapeQuerySpace);for(z in b)if(u.call(b,z)){if(d(b[z])){if(!_(b[z],R[z]))return!1}else if(b[z]!==R[z])return!1;O[z]=!0}for(z in R)if(u.call(R,z)&&!O[z])return!1;return!0},l.preventInvalidHostname=function(h){return this._parts.preventInvalidHostname=!!h,this},l.duplicateQueryParameters=function(h){return this._parts.duplicateQueryParameters=!!h,this},l.escapeQuerySpace=function(h){return this._parts.escapeQuerySpace=!!h,this},o})})(Kc);var Dx=Kc.exports;const Gs=Ni(Dx),bl=["http","https"];function Ux(n,e,t=!0){return Bx(n,e,!1,t)}function Bx(n,e=null,t=!1,r=!0){let i=Gs(n);if(e&&i.is("relative")){let s=Gs(e),o=s.path();!o.endsWith("/")&&!o.endsWith(".json")&&s.path(o+"/"),i=i.absoluteTo(s)}return i.normalize(),t&&(i.query(""),i.fragment("")),r?i.toString():i}const ks="application/geo+json",Gx=["application/json",ks,"text/json"],Tl=["image/gif","image/jpeg","image/apng","image/png","image/webp"],Qc=["image/tiff; application=geotiff; profile=cloud-optimized","image/vnd.stac.geotiff; cloud-optimized=true"],Jc=["application/geotiff","image/tiff; application=geotiff","image/vnd.stac.geotiff"].concat(Qc);function aa(n,e,t=!1){return Array.isArray(e)||(e=[e]),t&&typeof n>"u"?!0:typeof n!="string"?!1:(e=e.map(r=>r.toLowerCase()),e.includes(n.toLowerCase()))}function kx(n,e=!1){return aa(n,Gx,e)}class eh extends Nn{constructor(e,t=null,r={},i=[]){super(e,r,["_context"].concat(i)),this._context||(this._context=t)}getAbsoluteUrl(e=!0){return this._context?Ux(this.href,this._context.getAbsoluteUrl(),e):this.href.includes("://")?this.href:null}getContext(){return this._context}canBrowserDisplayImage(e=!1){if(typeof this.href!="string")return!1;if(!e&&typeof this.type>"u")return!1;let t=new Gs(this.href),r=t.protocol().toLowerCase(),i=t.suffix().toLowerCase();return qe(r)&&!bl.includes(r)?!1:qe(this.type)&&Tl.includes(this.type.toLowerCase())?!0:!!(typeof this.type>"u"&&qe(i)&&(i==="jpg"||Tl.includes("image/"+i)))}isType(e){return qe(this.type)&&aa(this.type,e)}isGeoTIFF(){return this.isType(Jc)}isCOG(){return this.isType(Qc)}isHTTP(){let t=this.getAbsoluteUrl(!1).protocol().toLowerCase();return qe(t)&&bl.includes(t)}isPreview(){return!1}}class la extends eh{constructor(e,t=null){super(e,t)}isLink(){return!0}getObjectType(){return"Link"}isPreview(){return this.rel==="preview"}static fromLinks(e,t=null){return Array.isArray(e)?e.map(r=>Ze(r)?new la(r,t):r):[]}}class th extends Nn{constructor(e,t=null,r={},i=[]){if(super(e,Object.assign({links:la.fromLinks},r),["_url"].concat(i)),!this._url&&(this._url=t,!this._url)){let s=this.getSelfLink();s&&(this._url=s.href)}}getAbsoluteUrl(){return this._url}setAbsoluteUrl(e){this._url=e}getStacLinksWithRel(e,t=!0){return this.getLinksWithRels([e]).filter(r=>kx(r.type,t))}getStacLinkWithRel(e,t=!0){const r=this.getStacLinksWithRel(e,t);return r.length>0?r[0]:null}getLinks(){return Array.isArray(this.links)?this.links.filter(e=>Ze(e)&&qe(e.href)):[]}getLinkWithRel(e){return this.getLinks().find(t=>t.rel===e)||null}getLinksWithRels(e){return this.getLinks().filter(t=>e.includes(t.rel))}getLinksWithOtherRels(e){return this.getLinks().filter(t=>!e.includes(t.rel))}getSelfLink(){return this.getStacLinkWithRel("self")}getRootLink(){return this.getStacLinkWithRel("root")}getParentLink(){return this.getStacLinkWithRel("parent")}}class ua extends th{constructor(e,t=null,r={},i=[]){super(e,t,r,i)}getAll(){return[]}}class Dn extends Nn{constructor(e,t=null,r=null){super(e,{},["_index","_context"]),typeof this._index!="number"&&(this._index=typeof t=="string"?parseInt(t,10):t),this._context||(this._context=r)}getContext(){return this._context}getObjectType(){return"Band"}isBand(){return!0}getIndex(){return this._index}getMetadata(e){if(typeof this[e]<"u")return this[e];if(this._context)return this._context.getMetadata(e)}getMinMaxValues(){return Hc(this)}getNoDataValues(){return Wc(this)}static fromBands(e,t=null){let r=[];if(Array.isArray(e))for(let i in e)r[i]=new Dn(e[i],i,t);return r}}const zx=["created","updated","published","expires","unpublished","bands"];class gt extends eh{constructor(e,t=null,r=null){const i={bands:Dn.fromBands,alternate:gt.fromAssets};super(e,r,i,["_key"]),this._key||(this._key=t)}getObjectType(){return"Asset"}isAsset(){return!0}getAbsoluteUrl(e=!0){return this.isDefinition()?null:super.getAbsoluteUrl(e)}getKey(){return this._key}getMetadata(e){if(typeof this[e]<"u")return this[e];if(this._context instanceof gt)return this._context.getMetadata(e);if(this._context&&!zx.includes(e))return this._context.getMetadata(e)}getBands(){return this.bands||[]}findVisualBands(){const e={red:null,green:null,blue:null},t=this.getBands();for(const i in t){const s=parseInt(i,10),o=t[s];Ze(o)&&qe(o["eo:common_name"])&&o["eo:common_name"]in e&&(e[o["eo:common_name"]]=o)}return Object.values(e).every(i=>i!==null)?e:null}findBand(e,t="name"){Array.isArray(e)||(e=[e]);const r=this.getBands(),i=r.findIndex(s=>Ze(s)&&e.includes(s[t]));return i>=0?r[i]:null}getBand(e){return Ze(e)||e===null?e:this.getBands()[e]||null}getMinMaxValues(){return Hc(this)}getNoDataValues(){return Wc(this)}isDefinition(){return!qe(this.href)}isHTTP(){return this.isDefinition()?null:super.isHTTP()}isPreview(){const e=["thumbnail","overview"];return e.includes(this.getKey())?!0:Array.isArray(this.roles)&&this.roles.some(t=>e.includes(t))}hasRole(e,t=!1){return Array.isArray(e)||(e=[e]),t&&e.includes(this.getKey())?!0:Array.isArray(this.roles)&&!!this.roles.find(r=>e.includes(r))}static fromAssets(e,t=null){let r={};if(Ze(e))for(let i in e)r[i]=new gt(e[i],i,t);return r}}function rh(n){if(!n)return;const e=String(n),t=e.indexOf("@"),r=t!==-1?e.substr(t+1):void 0,i=t!==-1?e.substr(0,t):e,s=String(i).replace(/-/g,"_").split("_");if(!s.length||s.length>4)return;const o=s.shift();if(!o)return;const a={keyword:r,language:o.toLowerCase()};if(!s.length)return a;if(s.length===3){const f=s.pop();f&&(a.variant=f.toUpperCase())}let l=s.pop();if(l.length>3&&(a.keyword=l,l=s.pop()),l&&(a.country=l.toUpperCase()),!s.length)return a;const u=s.pop();return typeof u=="string"&&u.length>=1&&(a.script=u[0].toUpperCase()+u.substring(1).toLowerCase()),a}function $x(n){const e={};return n.forEach(t=>{const{language:r,country:i}=rh(t);if(!r)throw new Error(`Locale ${t} is not parsable`);e[r]||(e[r]={countries:{},firstCountry:void 0,main:void 0});const s=e[r];i?(s.countries[i]=t,s.firstCountry||(s.firstCountry=t)):s.main=t}),e}function zs(n,e,t,r){const i=Array.isArray(n)?$x(n):n;if(!e&&t)return zs(n,t,void 0);if(!e)return;const{language:s,country:o}=rh(e);if(!s)return t;if(!i[s])return e===t?void 0:zs(n,t,null);const{countries:a,main:l=t,firstCountry:u}=i[s];return!a||!o?l:a[o]?a[o]:l}class Dt extends th{constructor(e,t=null,r={},i=[]){super(e,t,r,i)}getTemporalExtent(){return null}getTemporalExtents(){return[]}getLocaleLink(e,t=null){let r=this.getStacLinksWithRel("alternate").filter(o=>qe(o.hreflang)),i;Array.isArray(this.languages)?i=this.languages.map(o=>o.code):i=r.map(o=>o.hreflang);let s=zs(i,e,t);return r.find(o=>o.hreflang===s)||null}getIcons(e=!0){return this.getLinksWithRels(["icon"]).filter(t=>t.canBrowserDisplayImage(e))}getThumbnails(e=!0,t=null){let r=this.getAssets().filter(i=>i.isPreview());if(r.length===0&&(r=this.getLinks().filter(i=>i.isPreview())),e&&(r=r.filter(i=>i.canBrowserDisplayImage())),r.length===0){const i=this.getAsset("thumbnail");i&&r.push(i)}if(t&&r.length>1){let i=s=>Array.isArray(s.roles)&&s.roles.includes(t)||s.getKey()===t;r=r.filter(i).concat(r.filter(s=>!i(s)))}return r}getDefaultGeoTIFF(e=!0,t=!1){var i;return(i=this.rankGeoTIFFs(e,t)[0])==null?void 0:i.asset}rankGeoTIFFs(e=!0,t=!1,r=null,i=null){Ze(r)||(r={data:1,visual:2,thumbnail:2,overview:3});let s=[],o=this.getAssetsByTypes(Jc);e&&(o=o.filter(l=>l.isHTTP()&&(!t||l.isCOG())));let a=Object.entries(r);for(let l of o){let u=0;if(a.length>0){let f=a.filter(([c])=>l.hasRole(c,!0)).map(([,c])=>c);f.length>0&&(u+=Math.max(...f))}!t&&l.isCOG()&&(u+=2),l.findVisualBands()&&(u+=1),typeof i=="function"&&(u+=i(l)),s.push({asset:l,score:u})}return s.sort((l,u)=>u.score-l.score),s}findVisualAssets(){let e={red:null,green:null,blue:null},t=Object.keys(e),r=this.getAssets();for(let s of r){let o=s.findBand(t,"eo:common_name");o&&(e[o["eo:common_name"]]=s)}return Object.values(e).every(s=>s!==null)?e:null}getAsset(e){return Ze(this.assets)&&this.assets[e]||null}getAssets(){return Ze(this.assets)?Object.values(this.assets):[]}getAssetsWithRoles(e,t=!1){return this.getAssets().filter(r=>r.hasRole(e,t))}getAssetWithRole(e,t=!1){return this.getAssetsWithRoles([e],t)[0]||null}getAssetsByTypes(e){return this.getAssets().filter(t=>aa(t.type,e))}equals(e){return this===e?!0:!(e instanceof Dt)||this.getObjectType()!==e.getObjectType()?!1:!!(this.id&&this.id===e.id)}supportsExtension(e){if(!Array.isArray(this.stac_extensions))return!1;let t=new RegExp("^"+e.replaceAll("*","[^/]+")+"$");return this.stac_extensions.some(r=>t.test(r))}}class nh extends Dt{constructor(e,t=null,r={},i=[]){super(e,t,r,i)}getObjectType(){return this.type}getSearchLink(e=null){let t=this.getStacLinksWithRel("search");return e?t[0]||null:t.find(r=>r.method===e||!e&&!r.method)||null}getApiCollectionsLink(){return this.getStacLinkWithRel("data")}getApiItemsLink(){return this.getStacLinkWithRel("items")}getChildLinks(){return this.getStacLinksWithRel("child")}getItemLinks(){return this.getStacLinksWithRel("item")}}class Vx extends nh{constructor(e,t=null){super(e,t)}}function on(n){if(qe(n)&&n.length>=10)try{let t=n.match(/^(-?\d{1,})-(\d\d)-(\d\d)[T ](\d\d):(\d\d):(\d\d)(?:\.(\d*))?(?:Z|[+-]00:00)?$/i).slice(1).map(r=>parseInt(r,10));return new Date(Date.UTC(t[0],t[1]-1,t[2],t[3],t[4],t[5],t[6]||0))}catch{return null}return null}function jx(n,e){return new Date(n.valueOf()+(e-n)/2)}function ih(n){if(!Array.isArray(n)||n.length===0)return null;let e,t;const r=(i,s,o)=>typeof i>"u"?s:i===null||s===null?null:o(i,s);return n.forEach(([i,s])=>{e=r(e,i,Math.min),t=r(t,s,Math.max)}),[e===null?null:new Date(e),t===null?null:new Date(t)]}class sh extends nh{constructor(e,t=null){const r={assets:gt.fromAssets,item_assets:gt.fromAssets};super(e,t,r)}toGeoJSON(){let e=Yc(this.getBoundingBoxes());return e&&(e.id=this.id),e}getBoundingBox(){let e=this.getRawBoundingBoxes();return e.length>0?Lt(e[0]):null}getBoundingBoxes(){let e=this.getRawBoundingBoxes();return e.length===1?[Lt(e[0])]:e.length>1?e.slice(1).map(Lt):null}getRawBoundingBoxes(){var t,r;let e=(r=(t=this.extent)==null?void 0:t.spatial)==null?void 0:r.bbox;return Array.isArray(e)&&e.length>0?e:[]}getTemporalExtent(){return this.getTemporalExtents()[0]||null}getTemporalExtents(){var t,r;let e=(r=(t=this.extent)==null?void 0:t.temporal)==null?void 0:r.interval;return Array.isArray(e)&&e.length>0?e.filter(i=>Array.isArray(i)&&(qe(i[0])||qe(i[1]))).map(i=>i.map(s=>on(s))):[]}getSummary(e){if(Ze(this.summaries))return this.summaries[e]}getBands(){let e=this.getMetadata("bands");return Array.isArray(e)||(e=this.getSummary("bands")),Array.isArray(e)?Dn.fromBands(e,this):[]}}class Xx extends ua{constructor(e,t=null){const r={collections:i=>i.map(s=>new sh(s))};super(e,t,r)}getObjectType(){return"CollectionCollection"}getAll(){return this.collections}isCollectionCollection(){return!0}toGeoJSON(){return{type:"FeatureCollection",features:this.collections.map(t=>t.toGeoJSON()).filter(t=>t!==null)}}getBoundingBox(){return oa(this.getBoundingBoxes())}getBoundingBoxes(){return this.collections.map(e=>e.getBoundingBox())}getTemporalExtent(){return ih(this.getTemporalExtents())}getTemporalExtents(){return this.collections.map(e=>e.getTemporalExtent())}}class ca extends Dt{constructor(e,t=null){super(e,t,{assets:gt.fromAssets})}getObjectType(){return"Item"}toGeoJSON(){return this.toJSON()}getBoundingBox(){return Lt(this.bbox)}getBoundingBoxes(){const e=this.getBoundingBox();return e?[e]:[]}getDateTime(){let e=on(this.properties.datetime);if(!e){let t=on(this.properties.start_datetime),r=on(this.properties.end_datetime);return t&&r?jx(t,r):t||r}return e}getTemporalExtent(){return this.getTemporalExtents()[0]||null}getTemporalExtents(){let e=[];return qe(this.properties.start_datetime)||qe(this.properties.end_datetime)?e=[[this.properties.start_datetime||null,this.properties.end_datetime||null]]:qe(this.properties.datetime)&&(e=[[this.properties.datetime,this.properties.datetime]]),e.map(t=>t.map(r=>on(r)))}getMetadata(e){return this.properties[e]}getBands(){const e=this.getMetadata("bands");return Array.isArray(e)?Dn.fromBands(e,this):[]}getCollectionLink(){return this.getStacLinkWithRel("collection")}}class oh extends ua{constructor(e,t=null){const r={features:i=>i.map(s=>new ca(s))};super(e,t,r)}getObjectType(){return"ItemCollection"}getAll(){return this.features}toGeoJSON(){return this.toJSON()}getBoundingBox(){return oa(this.getBoundingBoxes())}getBoundingBoxes(){return this.features.map(e=>e.getBoundingBox())}getTemporalExtent(){return ih(this.getTemporalExtents())}getTemporalExtents(){return this.features.map(e=>e.getTemporalExtent())}}function Xn(n,e=!0,t=!1){return e&&(n=Lx.stac(n,t)),n.type==="Feature"?new ca(n):n.type==="FeatureCollection"?new oh(n):n.type==="Collection"||!n.type&&typeof n.extent<"u"&&typeof n.license<"u"?new sh(n):!n.type&&Array.isArray(n.collections)?new Xx(n):new Vx(n)}const Hx="https://stac-extensions.github.io/label/v1.*/schema.json",ah=new ai({color:"rgba(0,0,0,0)"});function lh(n,e,t="rgba(255,255,255,0.4)",r=5){let i=ah;t&&(i=new ai({color:t}));const s=new oi({color:n,width:e});return new Zn({image:new Rf({fill:i,stroke:s,radius:r}),fill:i,stroke:s})}const Wx=lh("#3399CC",3),wl=lh("#ff9933",2,null);function Zx(n,e){const t={url:n.getAbsoluteUrl()};let r=n;n.getBands().length===1&&(r=n.getBand(0));const{minimum:i,maximum:s}=r.getMinMaxValues();typeof i=="number"&&(t.min=i),typeof s=="number"&&(t.max=s);const o=r.getNoDataValues();return o.length>0&&(t.nodata=o[0]),e.length>0&&(t.bands=e),t}async function vl(n,e=void 0){let t=e;if(Af()){const r=n.getMetadata("proj:code");if(r)try{if(r.startsWith("EPSG:")){const i=parseInt(r.replace("EPSG:",""),10);t=await Pf(i)}}catch{}}return t}function Sl(n,e){const t=n.clone();return e.hasOnlyBounds()||t.setFill(ah),t}function Yx(n){let e=n.href;if(e.includes("{s}"))if(Array.isArray(n["href:servers"])&&n["href:servers"].length>0){const t=Math.random()*n["href:servers"].length|0;e=e.replace("{s}",n["href:servers"][t])}else return null;return e}var uh=Object.defineProperty,Rl=Object.getOwnPropertySymbols,qx=Object.prototype.hasOwnProperty,Kx=Object.prototype.propertyIsEnumerable,Al=(n,e,t)=>e in n?uh(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,xi=(n,e)=>{for(var t in e||(e={}))qx.call(e,t)&&Al(n,t,e[t]);if(Rl)for(var t of Rl(e))Kx.call(e,t)&&Al(n,t,e[t]);return n},Xi=(n,e)=>uh(n,"name",{value:e,configurable:!0}),Qx=(n,e,t)=>new Promise((r,i)=>{var s=l=>{try{a(t.next(l))}catch(u){i(u)}},o=l=>{try{a(t.throw(l))}catch(u){i(u)}},a=l=>l.done?r(l.value):Promise.resolve(l.value).then(s,o);a((t=t.apply(n,e)).next())}),ch=class extends On{constructor(e){super(xi(xi({},e),{state:"loading"})),this.loadImage=Xi(r=>new Promise((i,s)=>{const o=new Image;o.addEventListener("load",()=>i(o)),o.addEventListener("error",()=>s(new Error("load failed"))),o.src=r}),"loadImage");const t=new yn(e.url);t.getHeader().then(r=>{const i=e.projection===void 0?"EPSG:3857":e.projection;this.tileGrid=e.tileGrid||gr({extent:mr(i),maxResolution:e.maxResolution,minZoom:r.minZoom,maxZoom:r.maxZoom,tileSize:e.tileSize}),this.setLoader((s,o,a)=>Qx(this,null,function*(){const l=yield t.getZxy(s,o,a);if(!l)return new Uint8Array;const u=URL.createObjectURL(new Blob([l.data])),f=yield this.loadImage(u);return URL.revokeObjectURL(u),f})),this.setState("ready")})}};Xi(ch,"PMTilesRasterSource");var Pl=ch,hh=class extends so{constructor(e){super(xi(xi({},e),{state:"loading",url:"pmtiles://{z}/{x}/{y}",format:e.format||new Lf})),this.tileLoadFunction=Xi((t,r)=>{const i=t,s=new RegExp(/pmtiles:\/\/(\d+)\/(\d+)\/(\d+)/),o=r.match(s);if(!(o&&o.length>=4))throw Error("Could not parse tile URL");const a=+o[1],l=+o[2],u=+o[3];i.setLoader((f,c,d)=>{this.pmtiles_.getZxy(a,l,u).then(g=>{if(g){const p=i.getFormat();i.setFeatures(p.readFeatures(g.data,{extent:f,featureProjection:d})),i.setState(ue.LOADED)}else i.setFeatures([]),i.setState(ue.EMPTY)}).catch(g=>{i.setFeatures([]),i.setState(ue.ERROR)})})},"tileLoadFunction"),this.pmtiles_=new yn(e.url),this.pmtiles_.getHeader().then(t=>{const r=e.projection||"EPSG:3857",i=e.extent||mr(r);this.tileGrid=e.tileGrid||gr({extent:i,maxResolution:e.maxResolution,maxZoom:e.maxZoom!==void 0?e.maxZoom:t.maxZoom,minZoom:t.minZoom,tileSize:e.tileSize||512}),this.setTileLoadFunction(this.tileLoadFunction),this.setState("ready")})}};Xi(hh,"PMTilesVectorSource");var Jx=hh;class ha extends If{constructor(e){const t={};if(["opacity","visible","zIndex","minResolution","maxResolution","minZoom","maxZoom","properties"].forEach(r=>t[r]=e[r]),super(t),this.getSourceOptions_=e.getSourceOptions,this.children_=null,this.childrenOptions_=e.childrenOptions||{},this.assets_=null,this.bands_=[],this.crossOrigin_=e.crossOrigin||null,this.displayFootprint_=e.displayFootprint!==!1,this.displayGeoTiffByDefault_=!!e.displayGeoTiffByDefault,this.displayPreview_=!!e.displayPreview,this.displayOverview_=e.displayOverview!==!1,this.displayWebMapLink_=e.displayWebMapLink||!1,this.buildTileUrlTemplate_=e.buildTileUrlTemplate||null,this.useTileLayerAsFallback_=e.useTileLayerAsFallback||!1,this.boundsStyle_=e.boundsStyle||Wx,this.collectionStyle_=e.collectionStyle||wl,this.boundsLayer_=null,this.disableMigration_=e.disableMigration||!1,this.map_=null,this.eventQueue_=[],e.httpRequestFn&&(this.fetch_=e.httpRequestFn),e.data){try{this.configure_(e.data,e.url,e.children,e.assets,e.bands)}catch(r){this.handleError_(r)}return}if(!e.url)throw new Error("Either url or data must be provided");this.fetch_(e.url).then(r=>this.configure_(r,e.url,e.children,e.assets,e.bands)).catch(r=>this.handleError_(r))}async fetch_(e,t="json"){const r=await fetch(e);if(!r.ok)throw new Error(`Unexpected response from ${e}: ${r.status}`);return t==="json"?await r.json():t==="text"?await r.text():null}getBoundsLayer(){return this.boundsLayer_}isEmpty(){var e;if(this.getLayers().getLength()>1)return!1;const r=(e=this.getData())===null||e===void 0?void 0:e.getBoundingBox();return!r||Ci(r)?!0:!this.boundsLayer_||!this.displayFootprint_}handleError_(e){this.dispatch_(new Sy(e))}configure_(e,t=null,r=null,i=null,s=[]){let o;e instanceof gt||e instanceof Dt?o=e:(o=Xn(e,!this.disableMigration_),t&&t.includes("://")&&o.setAbsoluteUrl(t)),this.set("stac",o),this.bands_=s,this.boundsLayer_=this.addFootprint_();const a=()=>{this.boundsLayer_&&this.boundsLayer_.setStyle(Sl(this.boundsStyle_,this))};this.getLayers().on("add",a),this.getLayers().on("remove",a);const l=c=>this.handleError_(c),u=this.setChildren(r).catch(l),f=this.setAssets(i).catch(l);Promise.all([u,f]).then(()=>this.dispatch_("layersready")),this.dispatch_("sourceready")}dispatch_(e){this.eventQueue_.push(e),this.flush_()}flush_(){if(this.map_){for(const e of this.eventQueue_)this.dispatchEvent(e);this.eventQueue_=[]}}setMap_(e){this.map_!==e&&(this.map_=e,this.flush_())}async addChildren_(e,t={}){const r=e.map(i=>{const s={data:i,crossOrigin:this.crossOrigin_,boundsStyle:this.collectionStyle_,displayGeoTiffByDefault:this.displayGeoTiffByDefault_,displayOverview:this.displayOverview_,displayPreview:this.displayPreview_,displayFootprint:this.displayFootprint_,useTileLayerAsFallback:this.useTileLayerAsFallback_,buildTileUrlTemplate:this.buildTileUrlTemplate_},o=new ha(Object.assign(s,t));return o.on("sourceready",()=>{o.map_&&this.setMap_(o.map_)}),this.addLayer_(o,null),o});return await Promise.all(r)}async addPreviewImage_(e){const t=await vl(e,"EPSG:4326"),r=e.getContext().getBoundingBoxes();if(r.length!==1)return;const i=r[0];let s={url:e.getAbsoluteUrl(),projection:t,imageExtent:bs(i,"EPSG:4326",t),crossOrigin:this.crossOrigin_};this.getSourceOptions_&&(s=await this.getSourceOptions_(Se.ImageStatic,s,e));const o=new su({source:new Gc(s)});return this.addLayer_(o,e),o}async addLayerForLink(e){const t=Yx(e);if(!t)return;const r={attributions:e.getMetadata("attribution")||this.getData().getMetadata("attribution"),crossOrigin:this.crossOrigin_,url:t},i=async(o,a)=>(this.getSourceOptions_&&(a=await this.getSourceOptions_(o,a,e)),a),s=[];switch(e.rel){case"pmtiles":const a=await new yn(r.url).getHeader();let l;switch(a.tileType){case Rr.Mvt:l=new Jx(await i(Se.PMTilesVector,r));break;case Rr.Avif:case Rr.Jpeg:case Rr.Png:case Rr.Webp:l=new Pl(await i(Se.PMTilesRaster,r));break;default:return}s.push(l);break;case"tilejson":s.push(new $c(await i(Se.TileJSON,r)));break;case"wms":if(!Array.isArray(e["wms:layers"]))break;for(const c in e["wms:layers"]){const d=e["wms:layers"][c]||"";let g="";Array.isArray(e["wms:styles"])&&typeof e["wms:styles"][c]=="string"&&(g=e["wms:styles"][c]);const p=Object.assign({LAYERS:d,STYLES:g},e["wms:dimensions"]);typeof e["wms:transparent"]=="boolean"&&(p.TRANSPARENT=String(e["wms:transparent"])),typeof e.type=="string"&&e.type.startsWith("image/")&&(p.FORMAT=e.type);const _=await i(Se.TileWMS,Object.assign({},r,{params:p}));s.push(new Ff(_))}break;case"wmts":const u=await this.getWmtsCapabilities_(t);if(!u)return;const f=Array.isArray(e["wmts:layer"])?e["wmts:layer"]:[e["wmts:layer"]];for(const c of f){let d=Object.assign({},r,{layer:c});typeof e.type=="string"&&e.type.startsWith("image/")&&(d.format=e.type),d=await i(Se.WMTS,d),s.push(new Cf(ou(u,d)))}break;case"xyz":s.push(new ui(await i(Se.XYZ,r)));break;default:return}return s.map(o=>{let a;return o instanceof so?a=new Of({source:o,declutter:!0}):o instanceof Pl?a=new yi({source:o}):a=new Ts({source:o}),this.addLayer_(a,e),a})}async addGeoTiff_(e){if(this.buildTileUrlTemplate_&&!this.useTileLayerAsFallback_)return await this.addTileLayerForImagery_(e);let r={sources:[Zx(e,this.bands_)],convertToRGB:"auto"};const i=await vl(e);i&&(r.projection=i),this.getSourceOptions_&&(r=await this.getSourceOptions_(Se.GeoTIFF,r,e));const s=new ea(r),o=new Promise((a,l)=>{s.on("error",l),s.on("change",()=>{s.getState()==="error"?l(s.getError()):a()})});try{await o;const a=new yi({source:s});return this.addLayer_(a,e),a}catch(a){if(this.useTileLayerAsFallback_)return await this.addTileLayerForImagery_(e);this.handleError_(a)}}async addTileLayerForImagery_(e){let t=this.buildTileUrlTemplate_(e);t instanceof Promise&&(t=await t);let r={crossOrigin:this.crossOrigin_,url:t};this.getSourceOptions_&&(r=await this.getSourceOptions_(Se.XYZ,r,e));const i=new Ts({source:new ui(r)});return this.addLayer_(i,e),i}addLayer_(e,t=null,r=0){t&&e.set("stac",t),e.setZIndex(r),this.getLayers().push(e)}addFootprint_(){let e=null;const t=this.getData();if(t.isItemCollection()||t.isCollectionCollection()?e=Yc(t.getBoundingBox()):e=t.toGeoJSON(),e){const r=this.createGeoJsonLayer_(e,Sl(this.boundsStyle_,this),this.displayFootprint_);return r.set("bounds",!0),r.on("change",()=>this.setMap_(r.getMapInternal())),this.addLayer_(r,t,1),r}return null}async addGeoJson_(e){try{const t=await this.fetch_(e.getAbsoluteUrl()),r=this.createGeoJsonLayer_(t);return this.addLayer_(r,e),r}catch(t){this.handleError_(t)}}createGeoJsonLayer_(e,t=null,r=!0){const i=new au,s=new Ii({format:i,loader:(o,a,l)=>{e=Qn(e);const u=i.readFeatures(e,{featureProjection:l});s.addFeatures(u)}});return t||(t=wl),new Zl({source:s,style:t,visible:r})}async addLabelExtension_(){const e=this.getData();if(!(e instanceof ca))return;let t=e.getAssetsWithRoles(["labels","labels-vector"],!0),r;t.length>1&&(r=t.find(s=>s.roles.includes("labels-vector"))),r||(r=e.getAsset("vector_labels")),r||(t=e.getAssets().filter(s=>s.type===ks&&!s.roles),t.length===1&&(r=t[0]));const i=e.getLinksWithRels(["source"]);if(r&&i.length>0){const s=i.map(async a=>{try{const l=await this.fetch_(a.getAbsoluteUrl());return Xn(l)}catch(l){return this.handleError_(l),null}}),o=(await Promise.all(s)).filter(a=>a instanceof Dt);await this.addChildren_(o,{displayFootprint:!1})}try{await this.addGeoJson_(r)}catch(s){this.handleError_(s)}}async updateLayers_(){const e=this.getLayers();for(let i=e.getLength()-1;i>=0;i--){const s=e.item(i);s.get("stac")&&!s.get("bounds")&&e.removeAt(i)}const t=this.getData();if(Array.isArray(this.displayWebMapLink_)){const i=this.getWebMapLinks().map(async s=>await this.addLayerForLink(s));await Promise.all(i)}this.children_&&await this.addChildren_(this.children_,this.childrenOptions_);const r=this.getAssets();if(r){const i=r.map(async s=>{if(s){if(s.type===ks)return await this.addGeoJson_(s);if(s.isGeoTIFF())return await this.addGeoTiff_(s);if(s.canBrowserDisplayImage())return await this.addPreviewImage_(s)}});await Promise.all(i)}if(this.hasOnlyBounds()){if(t instanceof ua)await this.addChildren_(t.getAll(),this.childrenOptions_);else if(t instanceof Dt){if(t.isItem()&&t.supportsExtension(Hx)&&t.getMetadata("label:type")==="vector"){await this.addLabelExtension_();return}const i=this.getWebMapLinks();if(i.length>0)await this.addLayerForLink(i[0]);else{const s=t.getDefaultGeoTIFF(!0,!this.displayGeoTiffByDefault_);let o;if(s&&this.displayOverview_&&(o=await this.addGeoTiff_(s)),this.displayPreview_&&(!s||!o)){const a=t.getThumbnails(!0,"overview");a.length>0&&await this.addPreviewImage_(a[0])}}}}}hasOnlyBounds(){const e=this.getBoundsLayer();return typeof this.getLayersArray().find(r=>r!==e)>"u"}getWebMapLinks(){const e=this.getData();if(e instanceof gt)return[];let t=["xyz","tilejson","pmtiles","wmts","wms"];typeof this.displayWebMapLink_=="string"&&(t=[this.displayWebMapLink_]);let r=e.getLinksWithRels(t);return Array.isArray(this.displayWebMapLink_)?r=this.displayWebMapLink_.map(i=>{if(typeof i=="string"){const s=r.find(o=>o.id===i);return s||null}return i}).filter(i=>!!i):r.sort((i,s)=>{const o=t.indexOf(i.rel),a=t.indexOf(s.rel);return o-a}),r}async setAssets(e){if(Array.isArray(e)){const t=this.getData();this.assets_=e.map(r=>t instanceof Dt&&typeof r=="string"?t.getAsset(r):r instanceof gt?r:new gt(r))}else this.assets_=null;await this.updateLayers_()}async setChildren(e,t=null){e instanceof oh?this.children_=e.getAll():Ze(e)&&e.type==="FeatureCollection"?this.children_=Xn(e,!this.disableMigration_).getAll():Array.isArray(e)?this.children_=e.map(r=>r instanceof Dt?r:Xn(r,!this.disableMigration_)):this.children_=null,this.children_&&this.children_.length===0&&(this.children_=null),this.children_&&Ze(t)&&(this.childrenOptions_=t),await this.updateLayers_()}getData(){return this.get("stac")}getChildren(){return this.children_}getAssets(){return this.assets_}getExtent(){if(!this.map_)return;const e=this.map_.getView();if(!e)return;let t;const r=this.getData();r&&(t=r.getBoundingBox());const i=this.getChildren();if(i){const s=i.map(o=>o.getBoundingBox());t=oa(s)}if(t)return bs(t,"EPSG:4326",e.getProjection())}getLayerState(){const e=super.getLayerState();return e.extent=void 0,e}getAttributions(){const e=[],t=this.getData();if(t){const r=t.getMetadata("attribution");r&&r.push(r)}return e}getSource(){return null}async getWmtsCapabilities_(e){try{const t=new URL(e);t.searchParams.set("service","wmts"),t.searchParams.set("request","GetCapabilities");const r=await this.fetch_(t.toString(),"text");return new To().read(r)}catch{return null}}}Mf(Nf);window.eoxMapAdvancedOlLayers={Graticule:Hm,Heatmap:z_,Image,Layer:to,VectorImage:j_,WebGLPoints:H_,WebGLTile:yi,WebGLVector:W_,STAC:ha};function eE(n){const e=n[0],t=new Array(e);let r=1<<e-1,i,s;for(i=0;i<e;++i)s=48,n[1]&r&&(s+=1),n[2]&r&&(s+=2),t[i]=String.fromCharCode(s),r>>=1;return t.join("")}const tE='<a class="ol-attribution-bing-tos" href="https://www.microsoft.com/maps/product/terms.html" target="_blank">Terms of Use</a>';class rE extends $t{constructor(e){const t=e.hidpi!==void 0?e.hidpi:!1;super({cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,projection:ye("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,tilePixelRatio:t?2:1,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.hidpi_=t,this.culture_=e.culture!==void 0?e.culture:"en-us",this.maxZoom_=e.maxZoom!==void 0?e.maxZoom:-1,this.apiKey_=e.key,this.imagerySet_=e.imagerySet,this.placeholderTiles_=e.placeholderTiles;const r="https://dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this.imagerySet_+"?uriScheme=https&include=ImageryProviders&key="+this.apiKey_+"&c="+this.culture_;fetch(r).then(i=>i.json()).then(i=>this.handleImageryMetadataResponse(i))}getApiKey(){return this.apiKey_}getImagerySet(){return this.imagerySet_}handleImageryMetadataResponse(e){if(e.statusCode!=200||e.statusDescription!="OK"||e.authenticationResultCode!="ValidCredentials"||e.resourceSets.length!=1||e.resourceSets[0].resources.length!=1){this.setState("error");return}const t=e.resourceSets[0].resources[0],r=this.maxZoom_==-1?t.zoomMax:this.maxZoom_,i=this.getProjection(),s=mr(i),o=this.hidpi_?2:1,a=t.imageWidth==t.imageHeight?t.imageWidth/o:[t.imageWidth/o,t.imageHeight/o],l=gr({extent:s,minZoom:t.zoomMin,maxZoom:r,tileSize:a});this.tileGrid=l;const u=this.culture_,f=this.hidpi_,c=this.placeholderTiles_;if(this.tileUrlFunction=oo(t.imageUrlSubdomains.map(function(d){const g=[0,0,0],p=t.imageUrl.replace("{subdomain}",d).replace("{culture}",u);return function(_,x,T){if(!_)return;xs(_[0],_[1],_[2],g);const E=new URL(p.replace("{quadkey}",eE(g))),w=E.searchParams;return f&&(w.set("dpi","d1"),w.set("device","mobile")),c===!0?w.delete("n"):c===!1&&w.set("n","z"),E.toString()}})),t.imageryProviders){const d=io(ye("EPSG:4326"),this.getProjection());this.setAttributions(g=>{const p=[],_=g.viewState,x=this.getTileGrid(),T=x.getZForResolution(_.resolution,this.zDirection),w=x.getTileCoordForCoordAndZ(_.center,T)[0];return t.imageryProviders.map(function(A){let P=!1;const C=A.coverageAreas;for(let N=0,U=C.length;N<U;++N){const k=C[N];if(w>=k.zoomMin&&w<=k.zoomMax){const D=k.bbox,j=[D[1],D[0],D[3],D[2]],X=Mr(j,d);if(Or(X,g.extent)){P=!0;break}}}P&&p.push(A.attribution)}),p.push(tE),p})}this.setState("ready")}}class nE extends ui{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,maxZoom:e.maxZoom!==void 0?e.maxZoom:18,minZoom:e.minZoom,projection:e.projection,transition:e.transition,wrapX:e.wrapX,zDirection:e.zDirection}),this.account_=e.account,this.mapId_=e.map||"",this.config_=e.config||{},this.templateCache_={},this.initializeMap_()}getConfig(){return this.config_}updateConfig(e){Object.assign(this.config_,e),this.initializeMap_()}setConfig(e){this.config_=e||{},this.initializeMap_()}initializeMap_(){const e=JSON.stringify(this.config_);if(this.templateCache_[e]){this.applyTemplate_(this.templateCache_[e]);return}let t="https://"+this.account_+".carto.com/api/v1/map";this.mapId_&&(t+="/named/"+this.mapId_);const r=new XMLHttpRequest;r.addEventListener("load",this.handleInitResponse_.bind(this,e)),r.addEventListener("error",this.handleInitError_.bind(this)),r.open("POST",t),r.setRequestHeader("Content-type","application/json"),r.send(JSON.stringify(this.config_))}handleInitResponse_(e,t){const r=t.target;if(!r.status||r.status>=200&&r.status<300){let i;try{i=JSON.parse(r.responseText)}catch{this.setState("error");return}this.applyTemplate_(i),this.templateCache_[e]=i,this.setState("ready")}else this.setState("error")}handleInitError_(e){this.setState("error")}applyTemplate_(e){const t="https://"+e.cdn_url.https+"/"+this.account_+"/api/v1/map/"+e.layergroupid+"/{z}/{x}/{y}.png";this.setUrl(t)}}const iE="https://tile.googleapis.com/v1/createSession",sE="https://tile.googleapis.com/v1/2dtiles",oE="https://tile.googleapis.com/tile/v1/viewport",aE=22;class lE extends $t{constructor(e){const t=!!e.highDpi;super({attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,projection:"EPSG:3857",reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,tilePixelRatio:t?2:1,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.apiKey_=e.key,this.error_=null;const r={mapType:e.mapType||"roadmap",language:e.language||"en-US",region:e.region||"US"};e.imageFormat&&(r.imageFormat=e.imageFormat),e.scale&&(r.scale=e.scale),t&&(r.highDpi=!0),e.layerTypes&&(r.layerTypes=e.layerTypes),e.styles&&(r.styles=e.styles),e.overlay===!0&&(r.overlay=!0),e.apiOptions&&(r.apiOptions=e.apiOptions),this.sessionTokenRequest_=r,this.sessionTokenValue_,this.sessionRefreshId_,this.previousViewportAttribution_,this.previousViewportExtent_,this.createSession_()}getError(){return this.error_}fetchSessionToken(e,t){return fetch(e,t)}async createSession_(){const e=iE+"?key="+this.apiKey_,t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.sessionTokenRequest_)},r=await this.fetchSessionToken(e,t);if(!r.ok){try{const c=await r.json();this.error_=new Error(c.error.message)}catch{this.error_=new Error("Error fetching session token")}this.setState("error");return}const i=await r.json(),s=this.getTilePixelRatio(1),o=[i.tileWidth/s,i.tileHeight/s];this.tileGrid=gr({extent:mr(this.getProjection()),maxZoom:aE,tileSize:o});const a=i.session;this.sessionTokenValue_=a;const l=this.apiKey_;this.tileUrlFunction=function(c,d,g){const p=c[0],_=c[1],x=c[2];return`${sE}/${p}/${_}/${x}?session=${a}&key=${l}`};const u=parseInt(i.expiry,10)*1e3,f=Math.max(u-Date.now()-60*1e3,1);this.sessionRefreshId_=setTimeout(()=>this.createSession_(),f),this.setAttributions(this.fetchAttributions_.bind(this)),this.setState("ready")}async fetchAttributions_(e){if(e.viewHints[Jt.ANIMATING]||e.viewHints[Jt.INTERACTING]||e.animate)return this.previousViewportAttribution_;const[t,r]=va(Df(e.extent),e.viewState.projection),[i,s]=va(Uf(e.extent),e.viewState.projection),l=`zoom=${this.getTileGrid().getZForResolution(e.viewState.resolution,this.zDirection)}&north=${s}&south=${r}&east=${i}&west=${t}`;if(this.previousViewportExtent_==l)return this.previousViewportAttribution_;this.previousViewportExtent_=l;const u=this.sessionTokenValue_,f=this.apiKey_,c=`${oE}?session=${u}&key=${f}&${l}`;return this.previousViewportAttribution_=await fetch(c).then(d=>d.json()).then(d=>d.copyright),this.previousViewportAttribution_}disposeInternal(){clearTimeout(this.sessionRefreshId_),super.disposeInternal()}}let fh=class extends Ks{constructor(e,t,r,i,s,o,a){super(t,r,i,s,o,a),this.zoomifyImage_=null,this.tileSize_=e}getImage(){if(this.zoomifyImage_)return this.zoomifyImage_;const e=super.getImage();if(this.state==ue.LOADED){const t=this.tileSize_;if(e.width==t[0]&&e.height==t[1])return this.zoomifyImage_=e,e;const r=Qt(t[0],t[1]);return r.drawImage(e,0,0),this.zoomifyImage_=r.canvas,r.canvas}return e}};class uE extends $t{constructor(e){const t=e.size,r=e.tierSizeCalculation!==void 0?e.tierSizeCalculation:"default",i=e.tilePixelRatio||1,s=t[0],o=t[1],a=[],l=e.tileSize||ws;let u=l*i;switch(r){case"default":for(;s>u||o>u;)a.push([Math.ceil(s/u),Math.ceil(o/u)]),u+=u;break;case"truncated":let C=s,N=o;for(;C>u||N>u;)a.push([Math.ceil(C/u),Math.ceil(N/u)]),C>>=1,N>>=1;break;default:throw new Error("Unknown `tierSizeCalculation` configured")}a.push([1,1]),a.reverse();const f=[i],c=[0];for(let C=1,N=a.length;C<N;C++)f.push(i<<C),c.push(a[C-1][0]*a[C-1][1]+c[C-1]);f.reverse();const d=new Mi({tileSize:l,extent:e.extent||[0,-o,s,0],resolutions:f});let g=e.url;g&&!g.includes("{TileGroup}")&&!g.includes("{tileIndex}")&&(g+="{TileGroup}/{z}-{x}-{y}.jpg");const p=lu(g);let _=l*i;function x(C){return function(N,U,k){if(!N)return;const D=N[0],j=N[1],X=N[2],h=j+X*a[D][0],m=(h+c[D])/_|0,y={z:D,x:j,y:X,tileIndex:h,TileGroup:"TileGroup"+m};return C.replace(/\{(\w+?)\}/g,function(b,R){return y[R]})}}const T=oo(p.map(x)),E=fh.bind(null,mt(l*i));super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,tilePixelRatio:i,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileClass:E,tileGrid:d,tileUrlFunction:T,transition:e.transition}),this.zDirection=e.zDirection;const w=d.getTileCoordForCoordAndResolution(Yt(d.getExtent()),f[f.length-1]),A=T(w,1,null),P=new Image;P.addEventListener("error",()=>{_=l,this.changed()}),P.src=A}}function Jr(n){return n.toLocaleString("en",{maximumFractionDigits:10})}class cE extends $t{constructor(e){const t=e||{};let r=t.url||"";r=r+(r.lastIndexOf("/")===r.length-1||r===""?"":"/");const i=t.version||Me.VERSION2,s=t.sizes||[],o=t.size;dt(o!=null&&Array.isArray(o)&&o.length==2&&!isNaN(o[0])&&o[0]>0&&!isNaN(o[1])&&o[1]>0,"Missing or invalid `size`");const a=o[0],l=o[1],u=t.tileSize,f=t.tilePixelRatio||1,c=t.format||"jpg",d=t.quality||(t.version==Me.VERSION1?"native":"default");let g=t.resolutions||[];const p=t.supports||[],_=t.extent||[0,-l,a,0],x=s!=null&&Array.isArray(s)&&s.length>0,T=u!==void 0&&(typeof u=="number"&&Number.isInteger(u)&&u>0||Array.isArray(u)&&u.length>0),E=p!=null&&Array.isArray(p)&&(p.includes("regionByPx")||p.includes("regionByPct"))&&(p.includes("sizeByWh")||p.includes("sizeByH")||p.includes("sizeByW")||p.includes("sizeByPct"));let w,A,P;if(g.sort(function(k,D){return D-k}),T||E)if(u!=null&&(typeof u=="number"&&Number.isInteger(u)&&u>0?(w=u,A=u):Array.isArray(u)&&u.length>0&&((u.length==1||u[1]==null&&Number.isInteger(u[0]))&&(w=u[0],A=u[0]),u.length==2&&(Number.isInteger(u[0])&&Number.isInteger(u[1])?(w=u[0],A=u[1]):u[0]==null&&Number.isInteger(u[1])&&(w=u[1],A=u[1])))),(w===void 0||A===void 0)&&(w=ws,A=ws),g.length==0){P=Math.max(Math.ceil(Math.log(a/w)/Math.LN2),Math.ceil(Math.log(l/A)/Math.LN2));for(let k=P;k>=0;k--)g.push(Math.pow(2,k))}else{const k=Math.max(...g);P=Math.round(Math.log(k)/Math.LN2)}else if(w=a,A=l,g=[],x){s.sort(function(D,j){return D[0]-j[0]}),P=-1;const k=[];for(let D=0;D<s.length;D++){const j=a/s[D][0];if(g.length>0&&g[g.length-1]==j){k.push(D);continue}g.push(j),P++}if(k.length>0)for(let D=0;D<k.length;D++)s.splice(k[D]-D,1)}else g.push(1),s.push([a,l]),P=0;const C=new Mi({tileSize:[w,A],extent:_,origin:Es(_),resolutions:g}),N=function(k,D,j){let X,h;const m=k[0];if(m>P)return;const y=k[1],b=k[2],R=g[m];if(!(y===void 0||b===void 0||R===void 0||y<0||Math.ceil(a/R/w)<=y||b<0||Math.ceil(l/R/A)<=b)){if(E||T){const O=y*w*R,F=b*A*R;let M=w*R,z=A*R,W=w,Y=A;if(O+M>a&&(M=a-O),F+z>l&&(z=l-F),O+w*R>a&&(W=Math.floor((a-O+R-1)/R)),F+A*R>l&&(Y=Math.floor((l-F+R-1)/R)),O==0&&M==a&&F==0&&z==l)X="full";else if(!E||p.includes("regionByPx"))X=O+","+F+","+M+","+z;else if(p.includes("regionByPct")){const ee=Jr(O/a*100),te=Jr(F/l*100),re=Jr(M/a*100),de=Jr(z/l*100);X="pct:"+ee+","+te+","+re+","+de}i==Me.VERSION3&&(!E||p.includes("sizeByWh"))?h=W+","+Y:!E||p.includes("sizeByW")?h=W+",":p.includes("sizeByH")?h=","+Y:p.includes("sizeByWh")?h=W+","+Y:p.includes("sizeByPct")&&(h="pct:"+Jr(100/R))}else if(X="full",x){const O=s[m][0],F=s[m][1];i==Me.VERSION3?O==a&&F==l?h="max":h=O+","+F:O==a?h="full":h=O+","}else h=i==Me.VERSION3?"max":"full";return r+X+"/"+h+"/0/"+d+"."+c}},U=fh.bind(null,mt(u||256).map(function(k){return k*f}));super({attributions:t.attributions,attributionsCollapsible:t.attributionsCollapsible,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,interpolate:t.interpolate,projection:t.projection,reprojectionErrorThreshold:t.reprojectionErrorThreshold,state:t.state,tileClass:U,tileGrid:C,tilePixelRatio:t.tilePixelRatio,tileUrlFunction:N,transition:t.transition}),this.zDirection=t.zDirection}}function dh(n,e,t,r,i,s){const o=i.getCode().split(/:(?=\d+$)/).pop(),a=t/r,l=[Sa(Ve(e)/a,Ra),Sa(_t(e)/a,Ra)];s.SIZE=l[0]+","+l[1],s.BBOX=e.join(","),s.BBOXSR=o,s.IMAGESR=o,s.DPI=Math.round(s.DPI?s.DPI*r:90*r);const u=n.replace(/MapServer\/?$/,"MapServer/export").replace(/ImageServer\/?$/,"ImageServer/exportImage");return ci(u,s)}function hE(n){const e=n.load?n.load:$r,t=ye(n.projection||"EPSG:3857"),r=n.ratio??1.5,i=n.crossOrigin??null;return function(s,o,a){a=n.hidpi?a:1;const l={F:"image",FORMAT:"PNG32",TRANSPARENT:!0};Object.assign(l,n.params),s=uu(s,o,a,r);const u=dh(n.url,s,o,a,t,l),f=new Image;return f.crossOrigin=i,e(f,u).then(c=>{const d=Ve(s)/c.width*a;return{image:c,extent:s,resolution:d,pixelRatio:a}})}}class fE extends _r{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions}),this.crossOrigin_=e.crossOrigin!==void 0?e.crossOrigin:null,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.url_=e.url,this.imageLoadFunction_=e.imageLoadFunction!==void 0?e.imageLoadFunction:no,this.params_=Object.assign({},e.params),this.imageSize_=[0,0],this.renderedRevision_=0,this.ratio_=e.ratio!==void 0?e.ratio:1.5,this.loaderProjection_=null}getParams(){return this.params_}getImageInternal(e,t,r,i){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==i)&&(this.loaderProjection_=i,this.loader=hE({crossOrigin:this.crossOrigin_,params:this.params_,projection:i,hidpi:this.hidpi_,url:this.url_,ratio:this.ratio_,load:(s,o)=>(this.image.setImage(s),this.imageLoadFunction_(this.image,o),$r(s))})),super.getImageInternal(e,t,r,i))}getImageLoadFunction(){return this.imageLoadFunction_}getUrl(){return this.url_}setImageLoadFunction(e){this.imageLoadFunction_=e,this.changed()}setUrl(e){e!=this.url_&&(this.url_=e,this.loader=null,this.changed())}setParams(e){this.params_=Object.assign({},e),this.changed()}updateParams(e){Object.assign(this.params_,e),this.changed()}changed(){this.image=null,super.changed()}}class dE extends _r{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions,state:e.state}),this.canvasFunction_=e.canvasFunction,this.canvas_=null,this.renderedRevision_=0,this.ratio_=e.ratio!==void 0?e.ratio:1.5}getImageInternal(e,t,r,i){t=this.findNearestResolution(t);let s=this.canvas_;if(s&&this.renderedRevision_==this.getRevision()&&s.getResolution()==t&&s.getPixelRatio()==r&&Jn(s.getExtent(),e))return s;e=e.slice(),ru(e,this.ratio_);const o=Ve(e)/t,a=_t(e)/t,l=[o*r,a*r],u=this.canvasFunction_.call(this,e,t,r,l,i);return u&&(s=new Fo(e,t,r,u)),this.canvas_=s,this.renderedRevision_=this.getRevision(),s}}function pE(n,e,t,r){const i=Ve(n),s=_t(n),o=e[0],a=e[1],l=.0254/r;return a*i>o*s?i*t/(o*l):s*t/(a*l)}function gE(n,e,t,r,i,s,o){const a=pE(t,r,s,o),l=Yt(t),u={OPERATION:i?"GETDYNAMICMAPOVERLAYIMAGE":"GETMAPIMAGE",VERSION:"2.0.0",LOCALE:"en",CLIENTAGENT:"ol/source/ImageMapGuide source",CLIP:"1",SETDISPLAYDPI:o,SETDISPLAYWIDTH:Math.round(r[0]),SETDISPLAYHEIGHT:Math.round(r[1]),SETVIEWSCALE:a,SETVIEWCENTERX:l[0],SETVIEWCENTERY:l[1]};return Object.assign(u,e),ci(n,u)}function mE(n){const e=n.load||$r,t=n.useOverlay??!1,r=n.metersPerUnit||1,i=n.displayDpi||96,s=n.ratio??1,o=n.crossOrigin??null;return function(a,l,u){const f=new Image;f.crossOrigin=o,a=uu(a,l,u,s);const c=Ve(a)/l,d=_t(a)/l,g=[c*u,d*u],p=gE(n.url,n.params,a,g,t,r,i);return e(f,p).then(_=>({image:_,extent:a,pixelRatio:u}))}}class _E extends _r{constructor(e){super({interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions}),this.crossOrigin_=e.crossOrigin!==void 0?e.crossOrigin:null,this.displayDpi_=e.displayDpi!==void 0?e.displayDpi:96,this.params_=Object.assign({},e.params),this.url_=e.url,this.imageLoadFunction_=e.imageLoadFunction!==void 0?e.imageLoadFunction:no,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.metersPerUnit_=e.metersPerUnit!==void 0?e.metersPerUnit:1,this.ratio_=e.ratio!==void 0?e.ratio:1,this.useOverlay_=e.useOverlay!==void 0?e.useOverlay:!1,this.renderedRevision_=0,this.loaderProjection_=null}getParams(){return this.params_}getImageInternal(e,t,r,i){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==i)&&(this.loaderProjection_=i,this.loader=mE({crossOrigin:this.crossOrigin_,params:this.params_,hidpi:this.hidpi_,metersPerUnit:this.metersPerUnit_,url:this.url_,useOverlay:this.useOverlay_,ratio:this.ratio_,load:(s,o)=>(this.image.setImage(s),this.imageLoadFunction_(this.image,o),$r(s))})),super.getImageInternal(e,t,r,i))}getImageLoadFunction(){return this.imageLoadFunction_}setParams(e){this.params_=Object.assign({},e),this.changed()}updateParams(e){Object.assign(this.params_,e),this.changed()}setImageLoadFunction(e){this.imageLoadFunction_=e,this.changed()}changed(){this.image=null,super.changed()}}const yE=new Error("Image failed to load");function ph(n,e,t,r,i){return new Promise((s,o)=>{const a=new Image;a.crossOrigin=i.crossOrigin??null,a.addEventListener("load",()=>s(a)),a.addEventListener("error",()=>o(yE)),a.src=cu(n,e,t,r,i.maxY)})}function Ll(n){return function(e,t,r,i){const s=Bf(n,e,t,r);return ph(s,e,t,r,i)}}function xE(n){return function(e,t,r,i){const s=n(e,t,r,i);return ph(s,e,t,r,i)}}function Il(n){let e;if(Array.isArray(n))e=Ll(n);else if(typeof n=="string"){const t=lu(n);e=Ll(t)}else if(typeof n=="function")e=xE(n);else throw new Error("The url option must be a single template, an array of templates, or a function for getting a URL");return e}let Cl=0;function Fl(n){return Array.isArray(n)?n.join(`
`):typeof n=="string"?n:(++Cl,"url-function-key-"+Cl)}class gh extends On{constructor(e){e=e||{};let t=e.loader,r;e.url&&(t=Il(e.url),r=Fl(e.url));const i=t?e.state:"loading",s=e.wrapX===void 0?!0:e.wrapX;super({loader:t,key:r,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize,gutter:e.gutter,maxResolution:e.maxResolution,projection:e.projection,tileGrid:e.tileGrid,state:i,wrapX:s,transition:e.transition,interpolate:e.interpolate!==!1,crossOrigin:e.crossOrigin,zDirection:e.zDirection})}setUrl(e){const t=Il(e);this.setLoader(t),this.setKey(Fl(e)),this.getState()!=="ready"&&this.setState("ready")}}const EE={"image/png":!0,"image/jpeg":!0,"image/gif":!0,"image/webp":!0},bE={"application/vnd.mapbox-vector-tile":!0,"application/geo+json":!0};function mh(n,e){if(!e.length)return n;const t=new URL(n,"file:/");if(t.pathname.split("/").includes("collections"))return _n('The "collections" query parameter cannot be added to collection endpoints'),n;const r=e.map(o=>encodeURIComponent(o)).join(",");t.searchParams.append("collections",r);const i=n.split("?")[0],s=decodeURIComponent(t.searchParams.toString());return`${i}?${s}`}function TE(n,e,t){let r,i;for(let s=0;s<n.length;++s){const o=n[s];if(o.rel==="item"){if(o.type===e){r=o.href;break}(EE[o.type]||!i&&o.type.startsWith("image/"))&&(i=o.href)}}if(!r)if(i)r=i;else throw new Error('Could not find "item" link');return t&&(r=mh(r,t)),r}function wE(n,e,t,r){let i,s;const o={};for(let a=0;a<n.length;++a){const l=n[a];if(o[l.type]=l.href,l.rel==="item"){if(l.type===e){i=l.href;break}bE[l.type]&&(s=l.href)}}if(!i&&t)for(let a=0;a<t.length;++a){const l=t[a];if(o[l]){i=o[l];break}}if(!i)if(s)i=s;else throw new Error('Could not find "item" link');return r&&(i=mh(i,r)),i}function Ol(n,e,t,r){let i=n.projection;if(!i&&(typeof e.crs=="string"?i=ye(e.crs):"uri"in e.crs&&(i=ye(e.crs.uri)),!i))throw new Error(`Unsupported CRS: ${JSON.stringify(e.crs)}`);const s=e.orderedAxes,a=!(s?s.slice(0,2).map(C=>C.replace(/E|X|Lon/i,"e").replace(/N|Y|Lat/i,"n")).join(""):i.getAxisOrientation()).startsWith("en"),l=e.tileMatrices,u={};for(let C=0;C<l.length;++C){const N=l[C];u[N.id]=N}const f={},c=[];if(r)for(let C=0;C<r.length;++C){const N=r[C],U=N.tileMatrix;c.push(U),f[U]=N}else for(let C=0;C<l.length;++C){const N=l[C].id;c.push(N)}const d=c.length,g=new Array(d),p=new Array(d),_=new Array(d),x=new Array(d),T=[-1/0,-1/0,1/0,1/0];for(let C=0;C<d;++C){const N=c[C],U=u[N],k=U.pointOfOrigin;a?g[C]=[k[1],k[0]]:g[C]=k,p[C]=U.cellSize,_[C]=[U.matrixWidth,U.matrixHeight],x[C]=[U.tileWidth,U.tileHeight];const D=f[N];if(D){const j=U.cellSize*U.tileWidth,X=g[C][0]+D.minTileCol*j,h=g[C][0]+(D.maxTileCol+1)*j,m=U.cellSize*U.tileHeight,y=U.cornerOfOrigin==="bottomLeft";let b,R;y?(b=g[C][1]+D.minTileRow*m,R=g[C][1]+(D.maxTileRow+1)*m):(b=g[C][1]-(D.maxTileRow+1)*m,R=g[C][1]-D.minTileRow*m),Pt(T,[X,b,h,R],T)}}const E=new Mi({origins:g,resolutions:p,sizes:_,tileSizes:x,extent:r?T:void 0}),w=n.context,A=n.url;function P(C,N,U){if(!C)return;const k=c[C[0]],D=u[k],j=D.cornerOfOrigin==="bottomLeft",X={tileMatrix:k,tileCol:C[1],tileRow:j?-C[2]-1:C[2]};if(r){const m=f[D.id];if(X.tileCol<m.minTileCol||X.tileCol>m.maxTileCol||X.tileRow<m.minTileRow||X.tileRow>m.maxTileRow)return}Object.assign(X,w);const h=t.replace(/\{(\w+?)\}/g,function(m,y){return X[y]});return zc(A,h)}return{grid:E,projection:i,urlTemplate:t,urlFunction:P}}function vE(n,e){const t=e.tileMatrixSetLimits;let r;if(e.dataType==="map")r=TE(e.links,n.mediaType,n.collections);else if(e.dataType==="vector")r=wE(e.links,n.mediaType,n.supportedMediaTypes,n.collections);else throw new Error('Expected tileset data type to be "map" or "vector"');if(e.tileMatrixSet)return Ol(n,e.tileMatrixSet,r,t);const i=e.links.find(a=>a.rel==="http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme");if(!i)throw new Error("Expected http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme link or tileMatrixSet");const s=i.href,o=zc(n.url,s);return kc(o).then(function(a){return Ol(n,a,r,t)})}function _h(n){return kc(n.url).then(function(e){return vE(n,e)})}class SE extends $t{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition});const t={url:e.url,projection:this.getProjection(),mediaType:e.mediaType,context:e.context||null,collections:e.collections};_h(t).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(e){this.tileGrid=e.grid,this.projection=e.projection,this.setTileUrlFunction(e.urlFunction,e.urlTemplate),this.setState("ready")}handleError_(e){_n(e),this.setState("error")}}class RE extends so{constructor(e){super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,format:e.format,overlaps:e.overlaps,projection:e.projection,tileClass:e.tileClass,transition:e.transition,wrapX:e.wrapX,zDirection:e.zDirection,state:"loading"});const t={url:e.url,projection:this.getProjection(),mediaType:e.mediaType,supportedMediaTypes:e.format.supportedMediaTypes,context:e.context||null,collections:e.collections};_h(t).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(e){this.tileGrid=e.grid,this.projection=e.projection,this.setTileUrlFunction(e.urlFunction,e.urlTemplate),this.setState("ready")}handleError_(e){_n(e),this.setState("error")}}function yh(n){return function(e){const t=e.buffers,r=e.meta,i=e.imageOps,s=e.width,o=e.height,a=t.length,l=t[0].byteLength;if(i){const d=new Array(a);for(let p=0;p<a;++p)d[p]=new ImageData(new Uint8ClampedArray(t[p]),s,o);return n(d,r).data.buffer}const u=new Uint8ClampedArray(l),f=new Array(a),c=new Array(a);for(let d=0;d<a;++d)f[d]=new Uint8ClampedArray(t[d]),c[d]=[0,0,0,0];for(let d=0;d<l;d+=4){for(let p=0;p<a;++p){const _=f[p];c[p][0]=_[d],c[p][1]=_[d+1],c[p][2]=_[d+2],c[p][3]=_[d+3]}const g=n(c,r);u[d]=g[0],u[d+1]=g[1],u[d+2]=g[2],u[d+3]=g[3]}return u.buffer}}function AE(n,e){const r=Object.keys(n.lib||{}).map(function(s){return"const "+s+" = "+n.lib[s].toString()+";"}).concat(["const __minion__ = ("+yh.toString()+")(",n.operation.toString(),");",'self.addEventListener("message", function(event) {',"  const buffer = __minion__(event.data);","  self.postMessage({buffer: buffer, meta: event.data.meta}, [buffer]);","});"]),i=new Worker(typeof Blob>"u"?"data:text/javascript;base64,"+Buffer.from(r.join(`
`),"binary").toString("base64"):URL.createObjectURL(new Blob(r,{type:"text/javascript"})));return i.addEventListener("message",e),i}function PE(n,e){const t=yh(n.operation);let r=!1;return{postMessage:function(i){setTimeout(function(){r||e({data:{buffer:t(i),meta:i.meta}})},0)},terminate:function(){r=!0}}}class LE extends Yl{constructor(e){super(),this.imageOps_=!!e.imageOps;let t;e.threads===0?t=0:this.imageOps_?t=1:t=e.threads||1;const r=new Array(t);if(t)for(let i=0;i<t;++i)r[i]=AE(e,this.onWorkerMessage_.bind(this,i));else r[0]=PE(e,this.onWorkerMessage_.bind(this,0));this.workers_=r,this.queue_=[],this.maxQueueLength_=e.queue||1/0,this.running_=0,this.dataLookup_={},this.job_=null}process(e,t,r){this.enqueue_({inputs:e,meta:t,callback:r}),this.dispatch_()}enqueue_(e){for(this.queue_.push(e);this.queue_.length>this.maxQueueLength_;)this.queue_.shift().callback(null,null)}dispatch_(){if(this.running_||this.queue_.length===0)return;const e=this.queue_.shift();this.job_=e;const t=e.inputs[0].width,r=e.inputs[0].height,i=e.inputs.map(function(l){return l.data.buffer}),s=this.workers_.length;if(this.running_=s,s===1){this.workers_[0].postMessage({buffers:i,meta:e.meta,imageOps:this.imageOps_,width:t,height:r},i);return}const o=e.inputs[0].data.length,a=4*Math.ceil(o/4/s);for(let l=0;l<s;++l){const u=l*a,f=[];for(let c=0,d=i.length;c<d;++c)f.push(i[c].slice(u,u+a));this.workers_[l].postMessage({buffers:f,meta:e.meta,imageOps:this.imageOps_,width:t,height:r},f)}}onWorkerMessage_(e,t){this.disposed||(this.dataLookup_[e]=t.data,--this.running_,this.running_===0&&this.resolveJob_())}resolveJob_(){const e=this.job_,t=this.workers_.length;let r,i;if(t===1)r=new Uint8ClampedArray(this.dataLookup_[0].buffer),i=this.dataLookup_[0].meta;else{const s=e.inputs[0].data.length;r=new Uint8ClampedArray(s),i=new Array(t);const o=4*Math.ceil(s/4/t);for(let a=0;a<t;++a){const l=this.dataLookup_[a].buffer,u=a*o;r.set(new Uint8ClampedArray(l),u),i[a]=this.dataLookup_[a].meta}}this.job_=null,this.dataLookup_={},e.callback(null,new ImageData(r,e.inputs[0].width,e.inputs[0].height),i),this.dispatch_()}disposeInternal(){for(let e=0;e<this.workers_.length;++e)this.workers_[e].terminate();this.workers_.length=0}}const Ml={BEFOREOPERATIONS:"beforeoperations",AFTEROPERATIONS:"afteroperations"};class Nl extends nu{constructor(e,t,r){super(e),this.extent=t.extent,this.resolution=t.viewState.resolution/t.pixelRatio,this.data=r}}class xh extends _r{constructor(e){super({projection:null}),this.on,this.once,this.un,this.processor_=null,this.operationType_=e.operationType!==void 0?e.operationType:"pixel",this.threads_=e.threads!==void 0?e.threads:1,this.layers_=FE(e.sources);const t=this.changed.bind(this);for(let r=0,i=this.layers_.length;r<i;++r)this.layers_[r].addEventListener(Ke.CHANGE,t);this.useResolutions_=e.resolutions!==null,this.tileQueue_=new Gf(function(){return 1},this.processSources_.bind(this)),this.requestedFrameState_,this.renderedImageCanvas_=null,this.renderedRevision_,this.frameState_={animate:!1,coordinateToPixelTransform:$e(),declutter:null,extent:null,index:0,layerIndex:0,layerStatesArray:CE(this.layers_),pixelRatio:1,pixelToCoordinateTransform:$e(),postRenderFunctions:[],size:[0,0],tileQueue:this.tileQueue_,time:Date.now(),usedTiles:{},viewState:{rotation:0},viewHints:[],wantedTiles:{},mapId:_e(this),renderTargets:{}},this.setAttributions(function(r){var s;const i=[];for(let o=0,a=e.sources.length;o<a;++o){const l=e.sources[o],u=l instanceof ao?l:l.getSource();if(!u)continue;const f=(s=u.getAttributions())==null?void 0:s(r);typeof f=="string"?i.push(f):f!==void 0&&i.push(...f)}return i}),e.operation!==void 0&&this.setOperation(e.operation,e.lib)}setOperation(e,t){this.processor_&&this.processor_.dispose(),this.processor_=new LE({operation:e,imageOps:this.operationType_==="image",queue:1,lib:t,threads:this.threads_}),this.changed()}updateFrameState_(e,t,r){const i=Object.assign({},this.frameState_);i.viewState=Object.assign({},i.viewState);const s=Yt(e);i.size[0]=Math.ceil(Ve(e)/t),i.size[1]=Math.ceil(_t(e)/t),i.extent=[s[0]-i.size[0]*t/2,s[1]-i.size[1]*t/2,s[0]+i.size[0]*t/2,s[1]+i.size[1]*t/2],i.time=Date.now();const o=i.viewState;return o.center=s,o.projection=r,o.resolution=t,i}allSourcesReady_(){let e=!0,t;for(let r=0,i=this.layers_.length;r<i;++r)if(t=this.layers_[r].getSource(),!t||t.getState()!=="ready"){e=!1;break}return e}getImage(e,t,r,i){if(!this.allSourcesReady_())return null;this.tileQueue_.loadMoreTiles(16,16),t=this.findNearestResolution(t);const s=this.updateFrameState_(e,t,i);if(this.requestedFrameState_=s,this.renderedImageCanvas_){const o=this.renderedImageCanvas_.getResolution(),a=this.renderedImageCanvas_.getExtent();(t!==o||!pn(s.extent,a))&&(this.renderedImageCanvas_=null)}return(!this.renderedImageCanvas_||this.getRevision()!==this.renderedRevision_)&&this.processSources_(),s.animate&&requestAnimationFrame(this.changed.bind(this)),this.renderedImageCanvas_}processSources_(){const e=this.requestedFrameState_,t=this.layers_.length,r=new Array(t);for(let s=0;s<t;++s){e.layerIndex=s,e.renderTargets={};const o=IE(this.layers_[s],e);if(o)r[s]=o;else return}const i={};this.dispatchEvent(new Nl(Ml.BEFOREOPERATIONS,e,i)),this.processor_.process(r,i,this.onWorkerComplete_.bind(this,e))}onWorkerComplete_(e,t,r,i){if(t||!r)return;const s=e.extent,o=e.viewState.resolution;if(o!==this.requestedFrameState_.viewState.resolution||!pn(s,this.requestedFrameState_.extent))return;let a;if(this.renderedImageCanvas_)a=this.renderedImageCanvas_.getImage().getContext("2d");else{const l=Math.round(Ve(s)/o),u=Math.round(_t(s)/o);a=Qt(l,u),this.renderedImageCanvas_=new Fo(s,o,1,a.canvas)}a.putImageData(r,0,0),e.animate?requestAnimationFrame(this.changed.bind(this)):this.changed(),this.renderedRevision_=this.getRevision(),this.dispatchEvent(new Nl(Ml.AFTEROPERATIONS,e,i))}getResolutions(e){if(!this.useResolutions_)return null;let t=super.getResolutions();if(!t)for(let r=0,i=this.layers_.length;r<i&&(t=this.layers_[r].getSource().getResolutions(e),!t);++r);return t}disposeInternal(){this.processor_&&this.processor_.dispose(),super.disposeInternal()}}xh.prototype.dispose;let ir=null;function IE(n,e){const t=n.getRenderer();if(!t)throw new Error("Unsupported layer type: "+n);if(!t.prepareFrame(e))return null;const r=e.size[0],i=e.size[1];if(r===0||i===0)return null;const s=t.renderFrame(e,null);let o;if(s instanceof HTMLCanvasElement)o=s;else{if(s&&(o=s.firstElementChild),!(o instanceof HTMLCanvasElement))throw new Error("Unsupported rendered element: "+o);if(o.width===r&&o.height===i)return o.getContext("2d").getImageData(0,0,r,i)}if(!ir)ir=Qt(r,i,void 0,{willReadFrequently:!0});else{const a=ir.canvas;a.width!==r||a.height!==i?ir=Qt(r,i,void 0,{willReadFrequently:!0}):ir.clearRect(0,0,r,i)}return ir.drawImage(o,0,0,r,i),ir.getImageData(0,0,r,i)}function CE(n){return n.map(function(e){return e.getLayerState()})}function FE(n){const e=n.length,t=new Array(e);for(let r=0;r<e;++r)t[r]=OE(n[r]);return t}function OE(n){let e;return n instanceof ao?n instanceof ro?e=new Ts({source:n}):n instanceof _r&&(e=new su({source:n})):e=n,e}const ME='&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a>',NE='&copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a>',DE='&copy; <a href="https://stamen.com/" target="_blank">Stamen Design</a>',UE={stamen_terrain:{extension:"png"},stamen_terrain_background:{extension:"png"},stamen_terrain_labels:{extension:"png"},stamen_terrain_lines:{extension:"png"},stamen_toner_background:{extension:"png"},stamen_toner:{extension:"png"},stamen_toner_labels:{extension:"png"},stamen_toner_lines:{extension:"png"},stamen_toner_lite:{extension:"png"},stamen_watercolor:{extension:"jpg"},alidade_smooth:{extension:"png"},alidade_smooth_dark:{extension:"png"},alidade_satellite:{extension:"png"},outdoors:{extension:"png"},osm_bright:{extension:"png"}},BE={stamen_terrain:{minZoom:0,maxZoom:18,retina:!0},stamen_toner:{minZoom:0,maxZoom:20,retina:!0},stamen_watercolor:{minZoom:1,maxZoom:18,retina:!1}};class GE extends ui{constructor(e){const t=e.layer.indexOf("-"),r=t==-1?e.layer:e.layer.slice(0,t),i=BE[r]||{minZoom:0,maxZoom:20,retina:!0},s=UE[e.layer],o=e.apiKey?"?api_key="+e.apiKey:"",a=i.retina&&e.retina?"@2x":"",l=e.url!==void 0?e.url:"https://tiles.stadiamaps.com/tiles/"+e.layer+"/{z}/{x}/{y}"+a+"."+s.extension+o,u=[ME,NE,kf];e.layer.startsWith("stamen_")&&u.splice(1,0,DE),super({attributions:u,cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,maxZoom:e.maxZoom!==void 0?e.maxZoom:i.maxZoom,minZoom:e.minZoom!==void 0?e.minZoom:i.minZoom,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileLoadFunction:e.tileLoadFunction,transition:e.transition,url:l,tilePixelRatio:a?2:1,wrapX:e.wrapX,zDirection:e.zDirection})}}class kE extends $t{constructor(e){e=e||{},super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileGrid:e.tileGrid,tileLoadFunction:e.tileLoadFunction,url:e.url,urls:e.urls,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.params_=Object.assign({},e.params),this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.tmpExtent_=vn(),this.setKey(this.getKeyForParams_())}getKeyForParams_(){let e=0;const t=[];for(const r in this.params_)t[e++]=r+"-"+this.params_[r];return t.join("/")}getParams(){return this.params_}getRequestUrl_(e,t,r,i,s,o){const a=this.urls;if(!a)return;let l;if(a.length==1)l=a[0];else{const u=zf($f(e),a.length);l=a[u]}return dh(l,r,(this.tileGrid||this.getTileGridForProjection(s)).getResolution(e[0]),i,s,o)}getTilePixelRatio(e){return this.hidpi_?e:1}setParams(e){this.params_=Object.assign({},e),this.setKey(this.getKeyForParams_())}updateParams(e){Object.assign(this.params_,e),this.setKey(this.getKeyForParams_())}tileUrlFunction(e,t,r){let i=this.getTileGrid();if(i||(i=this.getTileGridForProjection(r)),i.getResolutions().length<=e[0])return;t!=1&&!this.hidpi_&&(t=1);const s=i.getTileCoordExtent(e,this.tmpExtent_);let o=mt(i.getTileSize(e[0]),this.tmpSize);t!=1&&(o=Vf(o,t,this.tmpSize));const a={F:"image",FORMAT:"PNG32",TRANSPARENT:!0};return Object.assign(a,this.params_),this.getRequestUrl_(e,o,s,t,r,a)}}class zE extends gh{constructor(e){e=e||{};const t=e.template||"z:{z} x:{x} y:{y}",r=e.source,i=e.color||"grey";super({transition:0,wrapX:e.wrapX!==void 0?e.wrapX:r!==void 0?r.getWrapX():void 0});const s=()=>{var a;this.projection=e.projection!==void 0?ye(e.projection):r!==void 0?r.getProjection():this.projection,this.tileGrid=e.tileGrid!==void 0?e.tileGrid:r!==void 0?r.getTileGrid():this.tileGrid,this.zDirection=e.zDirection!==void 0?e.zDirection:r!==void 0?r.zDirection:this.zDirection,r instanceof On&&(this.transformMatrix=((a=r.transformMatrix)==null?void 0:a.slice())||null);const o=this.tileGrid;o&&this.setTileSizes(o.getResolutions().map((l,u)=>mt(o.getTileSize(u)).map(f=>Math.max(Math.floor(f),1)))),this.setLoader((l,u,f,c)=>{const d=cu(t,l,u,f,c.maxY),[g,p]=this.getTileSize(l),_=Qt(g,p);return _.strokeStyle=i,_.strokeRect(.5,.5,g+.5,p+.5),_.fillStyle=i,_.strokeStyle="white",_.textAlign="center",_.textBaseline="middle",_.font="24px sans-serif",_.lineWidth=4,_.strokeText(d,g/2,p/2,g),_.fillText(d,g/2,p/2,g),Promise.resolve(_.canvas)}),this.setState("ready")};if(r===void 0||r.getState()==="ready")s();else{const o=()=>{r.getState()==="ready"&&(r.removeEventListener(Ke.CHANGE,o),s())};r.addEventListener(Ke.CHANGE,o)}}}class $E extends Hf{constructor(e,t,r,i,s,o){super(e,t),this.src_=r,this.extent_=i,this.preemptive_=s,this.grid_=null,this.keys_=null,this.data_=null,this.jsonp_=o}getImage(){return null}getData(e){if(!this.grid_||!this.keys_)return null;const t=(e[0]-this.extent_[0])/(this.extent_[2]-this.extent_[0]),r=(e[1]-this.extent_[1])/(this.extent_[3]-this.extent_[1]),i=this.grid_[Math.floor((1-r)*this.grid_.length)];if(typeof i!="string")return null;let s=i.charCodeAt(Math.floor(t*i.length));s>=93&&s--,s>=35&&s--,s-=32;let o=null;if(s in this.keys_){const a=this.keys_[s];this.data_&&a in this.data_?o=this.data_[a]:o=a}return o}forDataAtCoordinate(e,t,r){this.state==ue.EMPTY&&r===!0?(this.state=ue.IDLE,Wf(this,Ke.CHANGE,i=>{t(this.getData(e))}),this.loadInternal_()):r===!0?setTimeout(()=>{t(this.getData(e))},0):t(this.getData(e))}getKey(){return this.src_}handleError_(){this.state=ue.ERROR,this.changed()}handleLoad_(e){this.grid_=e.grid,this.keys_=e.keys,this.data_=e.data,this.state=ue.LOADED,this.changed()}loadInternal_(){if(this.state==ue.IDLE)if(this.state=ue.LOADING,this.jsonp_)ta(this.src_,this.handleLoad_.bind(this),this.handleError_.bind(this));else{const e=new XMLHttpRequest;e.addEventListener("load",this.onXHRLoad_.bind(this)),e.addEventListener("error",this.onXHRError_.bind(this)),e.open("GET",this.src_),e.send()}}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleError_();return}this.handleLoad_(r)}else this.handleError_()}onXHRError_(e){this.handleError_()}load(){this.preemptive_?this.loadInternal_():this.setState(ue.EMPTY)}}class VE extends ro{constructor(e){if(super({projection:ye("EPSG:3857"),state:"loading",wrapX:e.wrapX!==void 0?e.wrapX:!0,zDirection:e.zDirection}),this.preemptive_=e.preemptive!==void 0?e.preemptive:!0,this.tileUrlFunction_=jf,this.template_=void 0,this.jsonp_=e.jsonp||!1,this.tileCache_=new ql(512),e.url)if(this.jsonp_)ta(e.url,this.handleTileJSONResponse.bind(this),this.handleTileJSONError.bind(this));else{const t=new XMLHttpRequest;t.addEventListener("load",this.onXHRLoad_.bind(this)),t.addEventListener("error",this.onXHRError_.bind(this)),t.open("GET",e.url),t.send()}else if(e.tileJSON)this.handleTileJSONResponse(e.tileJSON);else throw new Error("Either `url` or `tileJSON` options must be provided")}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleTileJSONError();return}this.handleTileJSONResponse(r)}else this.handleTileJSONError()}onXHRError_(e){this.handleTileJSONError()}getTemplate(){return this.template_}forDataAtCoordinateAndResolution(e,t,r,i){if(this.tileGrid){const s=this.tileGrid.getZForResolution(t,this.zDirection),o=this.tileGrid.getTileCoordForCoordAndZ(e,s),a=this.getTile(o[0],o[1],o[2],1,this.getProjection());a.getState()==ue.IDLE&&a.load(),a.forDataAtCoordinate(e,r,i)}else i===!0?setTimeout(function(){r(null)},0):r(null)}handleTileJSONError(){this.setState("error")}handleTileJSONResponse(e){const t=ye("EPSG:4326"),r=this.getProjection();let i;if(e.bounds!==void 0){const f=io(t,r);i=Mr(e.bounds,f)}const s=mr(r),o=e.minzoom||0,a=e.maxzoom||22,l=gr({extent:s,maxZoom:a,minZoom:o});this.tileGrid=l,this.template_=e.template;const u=e.grids;if(!u){this.setState("error");return}if(this.tileUrlFunction_=iu(u,l),e.attribution){const f=i!==void 0?i:s;this.setAttributions(function(c){return Or(f,c.extent)?[e.attribution]:null})}this.setState("ready")}getTile(e,t,r,i,s){const o=[e,t,r],a=this.getTileCoordForTileUrlFunction(o,s),l=this.tileUrlFunction_(a,i,s),u=`${this.getKey()},${Xf(e,t,r)}`;if(this.tileCache_.containsKey(u))return this.tileCache_.get(u);this.tileCache_.expireCache();const f=new $E(o,l!==void 0?ue.IDLE:ue.EMPTY,l!==void 0?l:"",this.tileGrid.getTileCoordExtent(o),this.preemptive_,this.jsonp_);return this.tileCache_.set(u,f),f}}class jE extends Ii{constructor(e){e=e||{},super({attributions:e.attributions,wrapX:e.wrapX}),this.resolution=void 0,this.distance=e.distance!==void 0?e.distance:20,this.minDistance=e.minDistance||0,this.interpolationRatio=0,this.features=[],this.geometryFunction=e.geometryFunction||function(t){const r=t.getGeometry();return dt(!r||r.getType()==="Point","The default `geometryFunction` can only handle `Point` or null geometries"),r},this.createCustomCluster_=e.createCluster,this.source=null,this.boundRefresh_=this.refresh.bind(this),this.updateDistance(this.distance,this.minDistance),this.setSource(e.source||null)}clear(e){this.features.length=0,super.clear(e)}getDistance(){return this.distance}getSource(){return this.source}loadFeatures(e,t,r){var i;(i=this.source)==null||i.loadFeatures(e,t,r),t!==this.resolution&&(this.resolution=t,this.refresh())}setDistance(e){this.updateDistance(e,this.minDistance)}setMinDistance(e){this.updateDistance(this.distance,e)}getMinDistance(){return this.minDistance}setSource(e){this.source&&this.source.removeEventListener(Ke.CHANGE,this.boundRefresh_),this.source=e,e&&e.addEventListener(Ke.CHANGE,this.boundRefresh_),this.refresh()}refresh(){this.clear(),this.cluster(),this.addFeatures(this.features)}updateDistance(e,t){const r=e===0?0:Math.min(t,e)/e,i=e!==this.distance||this.interpolationRatio!==r;this.distance=e,this.minDistance=t,this.interpolationRatio=r,i&&this.refresh()}cluster(){if(this.resolution===void 0||!this.source)return;const e=vn(),t=this.distance*this.resolution,r=this.source.getFeatures(),i={};for(let s=0,o=r.length;s<o;s++){const a=r[s];if(!(_e(a)in i)){const l=this.geometryFunction(a);if(l){const u=l.getCoordinates();Zf(u,e),eo(e,t,e);const f=this.source.getFeaturesInExtent(e).filter(function(c){const d=_e(c);return d in i?!1:(i[d]=!0,!0)});this.features.push(this.createCluster(f,e))}}}}createCluster(e,t){const r=[0,0];for(let a=e.length-1;a>=0;--a){const l=this.geometryFunction(e[a]);l?Yf(r,l.getCoordinates()):e.splice(a,1)}qf(r,1/e.length);const i=Yt(t),s=this.interpolationRatio,o=new ft([r[0]*(1-s)+i[0]*s,r[1]*(1-s)+i[1]*s]);return this.createCustomCluster_?this.createCustomCluster_(o,e):new et({geometry:o,features:e})}}class Ei extends jE{constructor(e={}){super({...e,createCluster:Ei.defaultCreateCluster,geometryFunction:Ei.defaultGeometryFunction})}static defaultCreateCluster(e,t){const r=t.length===1&&t[0].getGeometry()instanceof cr?t[0].getGeometry():e,i=new et({geometry:r,features:t});if(t.length===1){const s=t[0];for(const o in s.getProperties())o!=="geometry"&&i.set(o,s.get(o))}return i}static defaultGeometryFunction(e){const t=e&&e.getGeometry();return t instanceof ft?t:t instanceof cr?t.getInteriorPoint():null}}class XE extends $t{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,tilePixelRatio:e.tilePixelRatio,transition:e.transition,interpolate:e.interpolate!==void 0?e.interpolate:!0,key:e.key,attributionsCollapsible:e.attributionsCollapsible,zDirection:e.zDirection,wrapX:e.wrapX}),this.version_=e.version!==void 0?e.version:"1.0.0",this.dimensions_=e.dimensions!==void 0?e.dimensions:{},this.layer_=e.layer,fetch(e.url).then(t=>t.text()).then(t=>new window.DOMParser().parseFromString(t,"application/xml")).then(t=>{this.handleCapabilitiesResponse(t,e)})}handleCapabilitiesResponse(e,t){const i=new To().read(e),s=ou(i,t);this.crossOrigin=s.crossOrigin,this.projection=s.projection,this.tileGrid=s.tileGrid,this.requestEncoding_=s.requestEncoding,this.matrixSet_=s.matrixSet,this.style_=s.style,this.format_=s.format,this.dimensions_=s.dimensions,this.setUrls(s.urls),this.urls&&this.urls.length>0&&(this.tileUrlFunction=oo(this.urls.map(this.createFromWMTSTemplate.bind(this)))),this.setState("ready")}createFromWMTSTemplate(e){const t=this.requestEncoding_,r={layer:this.layer_,style:this.style_,tilematrixset:this.matrixSet_};t==="KVP"&&Object.assign(r,{Service:"WMTS",Request:"GetTile",Version:this.version_,Format:this.format_}),e=t==="KVP"?ci(e,r):e.replace(/\{(\w+?)\}/g,(o,a)=>a.toLowerCase()in r?r[a.toLowerCase()]:o);const i=this.tileGrid,s=this.dimensions_;return function(o){if(!o)return;const a={TileMatrix:i.getMatrixId(o[0]),TileCol:o[1],TileRow:o[2]};Object.assign(a,s);let l=e;return t==="KVP"?l=ci(l,a):l=l.replace(/\{(\w+?)\}/g,(u,f)=>a[f]),l}}}const Bt=new Uint8Array([102,103,98,3,102,103,98,0]),ot=4,en=4,tn=4,Un=4,Xt=new Int32Array(2),Dl=new Float32Array(Xt.buffer),Ul=new Float64Array(Xt.buffer),Hn=new Uint16Array(new Uint8Array([1,0]).buffer)[0]===1;var $s;(function(n){n[n.UTF8_BYTES=1]="UTF8_BYTES",n[n.UTF16_STRING=2]="UTF16_STRING"})($s||($s={}));class yt{constructor(e){this.bytes_=e,this.position_=0,this.text_decoder_=new TextDecoder}static allocate(e){return new yt(new Uint8Array(e))}clear(){this.position_=0}bytes(){return this.bytes_}position(){return this.position_}setPosition(e){this.position_=e}capacity(){return this.bytes_.length}readInt8(e){return this.readUint8(e)<<24>>24}readUint8(e){return this.bytes_[e]}readInt16(e){return this.readUint16(e)<<16>>16}readUint16(e){return this.bytes_[e]|this.bytes_[e+1]<<8}readInt32(e){return this.bytes_[e]|this.bytes_[e+1]<<8|this.bytes_[e+2]<<16|this.bytes_[e+3]<<24}readUint32(e){return this.readInt32(e)>>>0}readInt64(e){return BigInt.asIntN(64,BigInt(this.readUint32(e))+(BigInt(this.readUint32(e+4))<<BigInt(32)))}readUint64(e){return BigInt.asUintN(64,BigInt(this.readUint32(e))+(BigInt(this.readUint32(e+4))<<BigInt(32)))}readFloat32(e){return Xt[0]=this.readInt32(e),Dl[0]}readFloat64(e){return Xt[Hn?0:1]=this.readInt32(e),Xt[Hn?1:0]=this.readInt32(e+4),Ul[0]}writeInt8(e,t){this.bytes_[e]=t}writeUint8(e,t){this.bytes_[e]=t}writeInt16(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8}writeUint16(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8}writeInt32(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8,this.bytes_[e+2]=t>>16,this.bytes_[e+3]=t>>24}writeUint32(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8,this.bytes_[e+2]=t>>16,this.bytes_[e+3]=t>>24}writeInt64(e,t){this.writeInt32(e,Number(BigInt.asIntN(32,t))),this.writeInt32(e+4,Number(BigInt.asIntN(32,t>>BigInt(32))))}writeUint64(e,t){this.writeUint32(e,Number(BigInt.asUintN(32,t))),this.writeUint32(e+4,Number(BigInt.asUintN(32,t>>BigInt(32))))}writeFloat32(e,t){Dl[0]=t,this.writeInt32(e,Xt[0])}writeFloat64(e,t){Ul[0]=t,this.writeInt32(e,Xt[Hn?0:1]),this.writeInt32(e+4,Xt[Hn?1:0])}getBufferIdentifier(){if(this.bytes_.length<this.position_+en+tn)throw new Error("FlatBuffers: ByteBuffer is too short to contain an identifier.");let e="";for(let t=0;t<tn;t++)e+=String.fromCharCode(this.readInt8(this.position_+en+t));return e}__offset(e,t){const r=e-this.readInt32(e);return t<this.readInt16(r)?this.readInt16(r+t):0}__union(e,t){return e.bb_pos=t+this.readInt32(t),e.bb=this,e}__string(e,t){e+=this.readInt32(e);const r=this.readInt32(e);e+=en;const i=this.bytes_.subarray(e,e+r);return t===$s.UTF8_BYTES?i:this.text_decoder_.decode(i)}__union_with_string(e,t){return typeof e=="string"?this.__string(t):this.__union(e,t)}__indirect(e){return e+this.readInt32(e)}__vector(e){return e+this.readInt32(e)+en}__vector_len(e){return this.readInt32(e+this.readInt32(e))}__has_identifier(e){if(e.length!=tn)throw new Error("FlatBuffers: file identifier must be length "+tn);for(let t=0;t<tn;t++)if(e.charCodeAt(t)!=this.readInt8(this.position()+en+t))return!1;return!0}createScalarList(e,t){const r=[];for(let i=0;i<t;++i){const s=e(i);s!==null&&r.push(s)}return r}createObjList(e,t){const r=[];for(let i=0;i<t;++i){const s=e(i);s!==null&&r.push(s.unpack())}return r}}var xe,ze=((xe={})[xe.Byte=0]="Byte",xe[xe.UByte=1]="UByte",xe[xe.Bool=2]="Bool",xe[xe.Short=3]="Short",xe[xe.UShort=4]="UShort",xe[xe.Int=5]="Int",xe[xe.UInt=6]="UInt",xe[xe.Long=7]="Long",xe[xe.ULong=8]="ULong",xe[xe.Float=9]="Float",xe[xe.Double=10]="Double",xe[xe.String=11]="String",xe[xe.Json=12]="Json",xe[xe.DateTime=13]="DateTime",xe[xe.Binary=14]="Binary",xe);class Ue{constructor(){fe(this,"bb",null);fe(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsColumn(e,t){return(t||new Ue).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsColumn(e,t){return e.setPosition(e.position()+Un),(t||new Ue).__init(e.readInt32(e.position())+e.position(),e)}name(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}type(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.readUint8(this.bb_pos+e):ze.Byte}title(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.__string(this.bb_pos+t,e):null}width(){let e=this.bb.__offset(this.bb_pos,12);return e?this.bb.readInt32(this.bb_pos+e):-1}precision(){let e=this.bb.__offset(this.bb_pos,14);return e?this.bb.readInt32(this.bb_pos+e):-1}scale(){let e=this.bb.__offset(this.bb_pos,16);return e?this.bb.readInt32(this.bb_pos+e):-1}nullable(){let e=this.bb.__offset(this.bb_pos,18);return!e||!!this.bb.readInt8(this.bb_pos+e)}unique(){let e=this.bb.__offset(this.bb_pos,20);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}primaryKey(){let e=this.bb.__offset(this.bb_pos,22);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}metadata(e){let t=this.bb.__offset(this.bb_pos,24);return t?this.bb.__string(this.bb_pos+t,e):null}static startColumn(e){e.startObject(11)}static addName(e,t){e.addFieldOffset(0,t,0)}static addType(e,t){e.addFieldInt8(1,t,ze.Byte)}static addTitle(e,t){e.addFieldOffset(2,t,0)}static addDescription(e,t){e.addFieldOffset(3,t,0)}static addWidth(e,t){e.addFieldInt32(4,t,-1)}static addPrecision(e,t){e.addFieldInt32(5,t,-1)}static addScale(e,t){e.addFieldInt32(6,t,-1)}static addNullable(e,t){e.addFieldInt8(7,+t,1)}static addUnique(e,t){e.addFieldInt8(8,+t,0)}static addPrimaryKey(e,t){e.addFieldInt8(9,+t,0)}static addMetadata(e,t){e.addFieldOffset(10,t,0)}static endColumn(e){let t=e.endObject();return e.requiredField(t,4),t}static createColumn(e,t,r,i,s,o,a,l,u,f,c,d){return Ue.startColumn(e),Ue.addName(e,t),Ue.addType(e,r),Ue.addTitle(e,i),Ue.addDescription(e,s),Ue.addWidth(e,o),Ue.addPrecision(e,a),Ue.addScale(e,l),Ue.addNullable(e,u),Ue.addUnique(e,f),Ue.addPrimaryKey(e,c),Ue.addMetadata(e,d),Ue.endColumn(e)}}var he,He=((he={})[he.Unknown=0]="Unknown",he[he.Point=1]="Point",he[he.LineString=2]="LineString",he[he.Polygon=3]="Polygon",he[he.MultiPoint=4]="MultiPoint",he[he.MultiLineString=5]="MultiLineString",he[he.MultiPolygon=6]="MultiPolygon",he[he.GeometryCollection=7]="GeometryCollection",he[he.CircularString=8]="CircularString",he[he.CompoundCurve=9]="CompoundCurve",he[he.CurvePolygon=10]="CurvePolygon",he[he.MultiCurve=11]="MultiCurve",he[he.MultiSurface=12]="MultiSurface",he[he.Curve=13]="Curve",he[he.Surface=14]="Surface",he[he.PolyhedralSurface=15]="PolyhedralSurface",he[he.TIN=16]="TIN",he[he.Triangle=17]="Triangle",he);class Ye{constructor(){fe(this,"bb",null);fe(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsGeometry(e,t){return(t||new Ye).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsGeometry(e,t){return e.setPosition(e.position()+Un),(t||new Ye).__init(e.readInt32(e.position())+e.position(),e)}ends(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.readUint32(this.bb.__vector(this.bb_pos+t)+4*e):0}endsLength(){let e=this.bb.__offset(this.bb_pos,4);return e?this.bb.__vector_len(this.bb_pos+e):0}endsArray(){let e=this.bb.__offset(this.bb_pos,4);return e?new Uint32Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}xy(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}xyLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}xyArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}z(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}zLength(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.__vector_len(this.bb_pos+e):0}zArray(){let e=this.bb.__offset(this.bb_pos,8);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}m(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}mLength(){let e=this.bb.__offset(this.bb_pos,10);return e?this.bb.__vector_len(this.bb_pos+e):0}mArray(){let e=this.bb.__offset(this.bb_pos,10);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}t(e){let t=this.bb.__offset(this.bb_pos,12);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}tLength(){let e=this.bb.__offset(this.bb_pos,12);return e?this.bb.__vector_len(this.bb_pos+e):0}tArray(){let e=this.bb.__offset(this.bb_pos,12);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}tm(e){let t=this.bb.__offset(this.bb_pos,14);return t?this.bb.readUint64(this.bb.__vector(this.bb_pos+t)+8*e):BigInt(0)}tmLength(){let e=this.bb.__offset(this.bb_pos,14);return e?this.bb.__vector_len(this.bb_pos+e):0}type(){let e=this.bb.__offset(this.bb_pos,16);return e?this.bb.readUint8(this.bb_pos+e):He.Unknown}parts(e,t){let r=this.bb.__offset(this.bb_pos,18);return r?(t||new Ye).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+r)+4*e),this.bb):null}partsLength(){let e=this.bb.__offset(this.bb_pos,18);return e?this.bb.__vector_len(this.bb_pos+e):0}static startGeometry(e){e.startObject(8)}static addEnds(e,t){e.addFieldOffset(0,t,0)}static createEndsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addInt32(t[r]);return e.endVector()}static startEndsVector(e,t){e.startVector(4,t,4)}static addXy(e,t){e.addFieldOffset(1,t,0)}static createXyVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startXyVector(e,t){e.startVector(8,t,8)}static addZ(e,t){e.addFieldOffset(2,t,0)}static createZVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startZVector(e,t){e.startVector(8,t,8)}static addM(e,t){e.addFieldOffset(3,t,0)}static createMVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startMVector(e,t){e.startVector(8,t,8)}static addT(e,t){e.addFieldOffset(4,t,0)}static createTVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startTVector(e,t){e.startVector(8,t,8)}static addTm(e,t){e.addFieldOffset(5,t,0)}static createTmVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addInt64(t[r]);return e.endVector()}static startTmVector(e,t){e.startVector(8,t,8)}static addType(e,t){e.addFieldInt8(6,t,He.Unknown)}static addParts(e,t){e.addFieldOffset(7,t,0)}static createPartsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addOffset(t[r]);return e.endVector()}static startPartsVector(e,t){e.startVector(4,t,4)}static endGeometry(e){return e.endObject()}static createGeometry(e,t,r,i,s,o,a,l,u){return Ye.startGeometry(e),Ye.addEnds(e,t),Ye.addXy(e,r),Ye.addZ(e,i),Ye.addM(e,s),Ye.addT(e,o),Ye.addTm(e,a),Ye.addType(e,l),Ye.addParts(e,u),Ye.endGeometry(e)}}class ht{constructor(){fe(this,"bb",null);fe(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsFeature(e,t){return(t||new ht).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsFeature(e,t){return e.setPosition(e.position()+Un),(t||new ht).__init(e.readInt32(e.position())+e.position(),e)}geometry(e){let t=this.bb.__offset(this.bb_pos,4);return t?(e||new Ye).__init(this.bb.__indirect(this.bb_pos+t),this.bb):null}properties(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readUint8(this.bb.__vector(this.bb_pos+t)+e):0}propertiesLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}propertiesArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Uint8Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}columns(e,t){let r=this.bb.__offset(this.bb_pos,8);return r?(t||new Ue).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+r)+4*e),this.bb):null}columnsLength(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.__vector_len(this.bb_pos+e):0}static startFeature(e){e.startObject(3)}static addGeometry(e,t){e.addFieldOffset(0,t,0)}static addProperties(e,t){e.addFieldOffset(1,t,0)}static createPropertiesVector(e,t){e.startVector(1,t.length,1);for(let r=t.length-1;r>=0;r--)e.addInt8(t[r]);return e.endVector()}static startPropertiesVector(e,t){e.startVector(1,t,1)}static addColumns(e,t){e.addFieldOffset(2,t,0)}static createColumnsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addOffset(t[r]);return e.endVector()}static startColumnsVector(e,t){e.startVector(4,t,4)}static endFeature(e){return e.endObject()}static finishFeatureBuffer(e,t){e.finish(t)}static finishSizePrefixedFeatureBuffer(e,t){e.finish(t,void 0,!0)}static createFeature(e,t,r,i){return ht.startFeature(e),ht.addGeometry(e,t),ht.addProperties(e,r),ht.addColumns(e,i),ht.endFeature(e)}}function ds(n,e){let t=[];for(let r=0;r<n.length;r+=2){let i=[n[r],n[r+1]];e&&i.push(e[r>>1]),t.push(i)}return t}new TextEncoder;let Bl=new TextDecoder;function HE(n,e){let t={};if(!e||e.length===0)return t;let r=n.propertiesArray();if(!r)return t;let i=new DataView(r.buffer,r.byteOffset),s=n.propertiesLength(),o=0;for(;o<s;){let a=i.getUint16(o,!0);o+=2;let l=e[a],u=l.name;switch(l.type){case ze.Bool:t[u]=!!i.getUint8(o),o+=1;break;case ze.Byte:t[u]=i.getInt8(o),o+=1;break;case ze.UByte:t[u]=i.getUint8(o),o+=1;break;case ze.Short:t[u]=i.getInt16(o,!0),o+=2;break;case ze.UShort:t[u]=i.getUint16(o,!0),o+=2;break;case ze.Int:t[u]=i.getInt32(o,!0),o+=4;break;case ze.UInt:t[u]=i.getUint32(o,!0),o+=4;break;case ze.Long:t[u]=Number(i.getBigInt64(o,!0)),o+=8;break;case ze.ULong:t[u]=Number(i.getBigUint64(o,!0)),o+=8;break;case ze.Float:t[u]=i.getFloat32(o,!0),o+=4;break;case ze.Double:t[u]=i.getFloat64(o,!0),o+=8;break;case ze.DateTime:case ze.String:{let f=i.getUint32(o,!0);o+=4,t[u]=Bl.decode(r.subarray(o,o+f)),o+=f;break}case ze.Json:{let f=i.getUint32(o,!0);o+=4;let c=Bl.decode(r.subarray(o,o+f));t[u]=JSON.parse(c),o+=f;break}case ze.Binary:{let f=i.getUint32(o,!0);o+=4,t[u]=r.subarray(o,o+f),o+=f;break}default:throw Error(`Unknown type ${l.type}`)}}return t}const fa=new Uint8Array(0);function WE(){return this._source.cancel()}function ZE(n,e){if(!n.length)return e;if(!e.length)return n;var t=new Uint8Array(n.length+e.length);return t.set(n),t.set(e,n.length),t}function YE(){var n=this,e=n._array.subarray(n._index);return n._source.read().then(function(t){return n._array=fa,n._index=0,t.done?e.length>0?{done:!1,value:e}:{done:!0,value:void 0}:{done:!1,value:ZE(e,t.value)}})}function qE(n){if((n|=0)<0)throw new Error("invalid length");var e=this,t=this._array.length-this._index;if(this._index+n<=this._array.length)return Promise.resolve(this._array.subarray(this._index,this._index+=n));var r=new Uint8Array(n);return r.set(this._array.subarray(this._index)),function i(){return e._source.read().then(function(s){return s.done?(e._array=fa,e._index=0,t>0?r.subarray(0,t):null):t+s.value.length>=n?(e._array=s.value,e._index=n-t,r.set(s.value.subarray(0,n-t),t),r):(r.set(s.value,t),t+=s.value.length,i())})}()}function KE(n){return typeof n.slice=="function"?n:new Hi(typeof n.read=="function"?n:n.getReader())}function Hi(n){this._source=n,this._array=fa,this._index=0}Hi.prototype.read=YE;Hi.prototype.slice=qE;Hi.prototype.cancel=WE;class ct{constructor(){fe(this,"bb",null);fe(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsCrs(e,t){return(t||new ct).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsCrs(e,t){return e.setPosition(e.position()+Un),(t||new ct).__init(e.readInt32(e.position())+e.position(),e)}org(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}code(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.readInt32(this.bb_pos+e):0}name(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.__string(this.bb_pos+t,e):null}wkt(e){let t=this.bb.__offset(this.bb_pos,12);return t?this.bb.__string(this.bb_pos+t,e):null}codeString(e){let t=this.bb.__offset(this.bb_pos,14);return t?this.bb.__string(this.bb_pos+t,e):null}static startCrs(e){e.startObject(6)}static addOrg(e,t){e.addFieldOffset(0,t,0)}static addCode(e,t){e.addFieldInt32(1,t,0)}static addName(e,t){e.addFieldOffset(2,t,0)}static addDescription(e,t){e.addFieldOffset(3,t,0)}static addWkt(e,t){e.addFieldOffset(4,t,0)}static addCodeString(e,t){e.addFieldOffset(5,t,0)}static endCrs(e){return e.endObject()}static createCrs(e,t,r,i,s,o,a){return ct.startCrs(e),ct.addOrg(e,t),ct.addCode(e,r),ct.addName(e,i),ct.addDescription(e,s),ct.addWkt(e,o),ct.addCodeString(e,a),ct.endCrs(e)}}class bi{constructor(){fe(this,"bb",null);fe(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsHeader(e,t){return(t||new bi).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsHeader(e,t){return e.setPosition(e.position()+Un),(t||new bi).__init(e.readInt32(e.position())+e.position(),e)}name(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}envelope(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}envelopeLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}envelopeArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}geometryType(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.readUint8(this.bb_pos+e):He.Unknown}hasZ(){let e=this.bb.__offset(this.bb_pos,10);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasM(){let e=this.bb.__offset(this.bb_pos,12);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasT(){let e=this.bb.__offset(this.bb_pos,14);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasTm(){let e=this.bb.__offset(this.bb_pos,16);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}columns(e,t){let r=this.bb.__offset(this.bb_pos,18);return r?(t||new Ue).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+r)+4*e),this.bb):null}columnsLength(){let e=this.bb.__offset(this.bb_pos,18);return e?this.bb.__vector_len(this.bb_pos+e):0}featuresCount(){let e=this.bb.__offset(this.bb_pos,20);return e?this.bb.readUint64(this.bb_pos+e):BigInt("0")}indexNodeSize(){let e=this.bb.__offset(this.bb_pos,22);return e?this.bb.readUint16(this.bb_pos+e):16}crs(e){let t=this.bb.__offset(this.bb_pos,24);return t?(e||new ct).__init(this.bb.__indirect(this.bb_pos+t),this.bb):null}title(e){let t=this.bb.__offset(this.bb_pos,26);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,28);return t?this.bb.__string(this.bb_pos+t,e):null}metadata(e){let t=this.bb.__offset(this.bb_pos,30);return t?this.bb.__string(this.bb_pos+t,e):null}static startHeader(e){e.startObject(14)}static addName(e,t){e.addFieldOffset(0,t,0)}static addEnvelope(e,t){e.addFieldOffset(1,t,0)}static createEnvelopeVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startEnvelopeVector(e,t){e.startVector(8,t,8)}static addGeometryType(e,t){e.addFieldInt8(2,t,He.Unknown)}static addHasZ(e,t){e.addFieldInt8(3,+t,0)}static addHasM(e,t){e.addFieldInt8(4,+t,0)}static addHasT(e,t){e.addFieldInt8(5,+t,0)}static addHasTm(e,t){e.addFieldInt8(6,+t,0)}static addColumns(e,t){e.addFieldOffset(7,t,0)}static createColumnsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addOffset(t[r]);return e.endVector()}static startColumnsVector(e,t){e.startVector(4,t,4)}static addFeaturesCount(e,t){e.addFieldInt64(8,t,BigInt("0"))}static addIndexNodeSize(e,t){e.addFieldInt16(9,t,16)}static addCrs(e,t){e.addFieldOffset(10,t,0)}static addTitle(e,t){e.addFieldOffset(11,t,0)}static addDescription(e,t){e.addFieldOffset(12,t,0)}static addMetadata(e,t){e.addFieldOffset(13,t,0)}static endHeader(e){return e.endObject()}static finishHeaderBuffer(e,t){e.finish(t)}static finishSizePrefixedHeaderBuffer(e,t){e.finish(t,void 0,!0)}}function Wi(n){let e=bi.getRootAsHeader(n),t=e.featuresCount(),r=e.indexNodeSize(),i=[];for(let a=0;a<e.columnsLength();a++){let l=e.columns(a);if(!l)throw Error("Column unexpectedly missing");if(!l.name())throw Error("Column name unexpectedly missing");i.push({name:l.name(),type:l.type(),title:l.title(),description:l.description(),width:l.width(),precision:l.precision(),scale:l.scale(),nullable:l.nullable(),unique:l.unique(),primary_key:l.primaryKey()})}let s=e.crs(),o=s?{org:s.org(),code:s.code(),name:s.name(),description:s.description(),wkt:s.wkt(),code_string:s.codeString()}:null;return{geometryType:e.geometryType(),columns:i,envelope:null,featuresCount:Number(t),indexNodeSize:r,crs:o,title:e.title(),description:e.description(),metadata:e.metadata()}}const Ri=class Ri{constructor(){fe(this,"_extraRequestThreshold",262144)}extraRequestThreshold(){return this._extraRequestThreshold}setExtraRequestThreshold(e){if(e<0)throw Error("extraRequestThreshold cannot be negative");this._extraRequestThreshold=e}};fe(Ri,"global",new Ri);let Ti=Ri;const QE=40,JE=16;function Zi(n,e){e=Math.min(Math.max(+e,2),65535);let t=n,r=t;do r+=t=Math.ceil(t/e);while(t!==1);return 40*r}function eb(n,e){if(e<2)throw Error("Node size must be at least 2");if(n===0)throw Error("Number of items must be greater than 0");let t=n,r=t,i=[t];do r+=t=Math.ceil(t/e),i.push(t);while(t!==1);let s=[];for(let a of(t=r,i))s.push(t-a),t-=a;let o=[];for(let a=0;a<i.length;a++)o.push([s[a],s[a]+i[a]]);return o}async function*Eh(n,e,t,r){class i{constructor(g,p){fe(this,"_level");fe(this,"nodes");this._level=p,this.nodes=g}level(){return this._level}startNodeIdx(){return this.nodes[0]}endNodeIdx(){return this.nodes[1]}extendEndNodeIdx(g){this.nodes[1]=g}toString(){return`[NodeRange level: ${this._level}, nodes: ${this.nodes[0]}-${this.nodes[1]}]`}}let{minX:s,minY:o,maxX:a,maxY:l}=t,u=eb(n,e),f=u[0][0],c=[new i([0,1],u.length-1)];for(;c.length!==0;){let d=c.shift(),g=d.startNodeIdx(),p=g>=f,_=(()=>{let[,E]=u[d.level()],w=Math.min(d.endNodeIdx()+e,E);return p&&w<E?w+1:w})(),x=_-g,T=new DataView(await r(40*g,40*x));for(let E=g;E<_;E++){let w=E-g,A=40*w;if(a<T.getFloat64(A+0,!0)||l<T.getFloat64(A+8,!0)||s>T.getFloat64(A+16,!0)||o>T.getFloat64(A+24,!0))continue;let P=T.getBigUint64(A+32,!0);if(p){let k=(()=>{if(E<n-1){let j=(w+1)*40;return T.getBigUint64(j+32,!0)-P}return null})(),D=E-f;yield[Number(P),D,Number(k)];continue}let C=Ti.global.extraRequestThreshold()/40,N=c[c.length-1];if(N!==void 0&&N.level()===d.level()-1&&P<N.endNodeIdx()+C){N.extendEndNodeIdx(Number(P));continue}let U=(()=>{let k=d.level()-1;return new i([Number(P),Number(P)+1],k)})();N!==void 0&&(N.level(),U.level()),c.push(U)}}}class da{constructor(e,t,r,i){fe(this,"bytes");fe(this,"header");fe(this,"headerLength");fe(this,"indexLength");this.bytes=e,this.header=t,this.headerLength=r,this.indexLength=i}static open(e){if(!e.subarray(0,3).every((o,a)=>Bt[a]===o))throw Error("Not a FlatGeobuf file");let t=new DataView(e.buffer).getUint32(8,!0);if(t>10485760||t<8)throw Error("Invalid header size");let r=e.subarray(12,12+t),i=Wi(new yt(r)),s=Zi(i.featuresCount,i.indexNodeSize);return new da(e,i,t,s)}async*selectBbox(e){let t=this.lengthBeforeTree(),r=async(i,s)=>{let o=t+i;return this.bytes.slice(o,o+s).buffer};for await(let i of Eh(this.header.featuresCount,this.header.indexNodeSize,e,r)){let[s,o]=i,a=this.readFeature(s);yield{id:o,feature:a}}}lengthBeforeTree(){return Bt.length+ot+this.headerLength}lengthBeforeFeatures(){return this.lengthBeforeTree()+this.indexLength}readFeature(e){let t=e+this.lengthBeforeFeatures(),r=new DataView(this.bytes.buffer).getUint32(t,!0),i=this.bytes.subarray(t+4,t+4+r),s=new Uint8Array(r+ot);s.set(i,ot);let o=new yt(s);return o.setPosition(ot),ht.getRootAsFeature(o)}}/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var Vs=function(n,e){return Vs=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var i in r)r.hasOwnProperty(i)&&(t[i]=r[i])},Vs(n,e)};function tb(n,e){Vs(n,e);function t(){this.constructor=n}n.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function Gr(n,e,t,r){function i(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function a(f){try{u(r.next(f))}catch(c){o(c)}}function l(f){try{u(r.throw(f))}catch(c){o(c)}}function u(f){f.done?s(f.value):i(f.value).then(a,l)}u((r=r.apply(n,[])).next())})}function er(n,e){var t={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},r,i,s,o;return o={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function a(u){return function(f){return l([u,f])}}function l(u){if(r)throw new TypeError("Generator is already executing.");for(;t;)try{if(r=1,i&&(s=u[0]&2?i.return:u[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,u[1])).done)return s;switch(i=0,s&&(u=[u[0]&2,s.value]),u[0]){case 0:case 1:s=u;break;case 4:return t.label++,{value:u[1],done:!1};case 5:t.label++,i=u[1],u=[0];continue;case 7:u=t.ops.pop(),t.trys.pop();continue;default:if(s=t.trys,!(s=s.length>0&&s[s.length-1])&&(u[0]===6||u[0]===2)){t=0;continue}if(u[0]===3&&(!s||u[1]>s[0]&&u[1]<s[3])){t.label=u[1];break}if(u[0]===6&&t.label<s[1]){t.label=s[1],s=u;break}if(s&&t.label<s[2]){t.label=s[2],t.ops.push(u);break}s[2]&&t.ops.pop(),t.trys.pop();continue}u=e.call(n,t)}catch(f){u=[6,f],i=0}finally{r=s=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}}function qr(n){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&n[e],r=0;if(t)return t.call(n);if(n&&typeof n.length=="number")return{next:function(){return n&&r>=n.length&&(n=void 0),{value:n&&n[r++],done:!n}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function bn(n){return this instanceof bn?(this.v=n,this):new bn(n)}function rb(n,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=t.apply(n,e||[]),i,s=[];return i={},o("next"),o("throw"),o("return"),i[Symbol.asyncIterator]=function(){return this},i;function o(d){r[d]&&(i[d]=function(g){return new Promise(function(p,_){s.push([d,g,p,_])>1||a(d,g)})})}function a(d,g){try{l(r[d](g))}catch(p){c(s[0][3],p)}}function l(d){d.value instanceof bn?Promise.resolve(d.value.v).then(u,f):c(s[0][2],d)}function u(d){a("next",d)}function f(d){a("throw",d)}function c(d,g){d(g),s.shift(),s.length&&a(s[0][0],s[0][1])}}var bh=function(n){tb(e,n);function e(t){var r=n.call(this,t)||this;return Object.defineProperty(r,"name",{value:"RepeaterOverflowError",enumerable:!1}),typeof Object.setPrototypeOf=="function"?Object.setPrototypeOf(r,r.constructor.prototype):r.__proto__=r.constructor.prototype,typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(r,r.constructor),r}return e}(Error);(function(){function n(e){if(e<0)throw new RangeError("Capacity may not be less than 0");this._c=e,this._q=[]}return Object.defineProperty(n.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"full",{get:function(){return this._q.length>=this._c},enumerable:!1,configurable:!0}),n.prototype.add=function(e){if(this.full)throw new Error("Buffer full");this._q.push(e)},n.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},n})();(function(){function n(e){if(e<1)throw new RangeError("Capacity may not be less than 1");this._c=e,this._q=[]}return Object.defineProperty(n.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"full",{get:function(){return!1},enumerable:!1,configurable:!0}),n.prototype.add=function(e){for(;this._q.length>=this._c;)this._q.shift();this._q.push(e)},n.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},n})();(function(){function n(e){if(e<1)throw new RangeError("Capacity may not be less than 1");this._c=e,this._q=[]}return Object.defineProperty(n.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"full",{get:function(){return!1},enumerable:!1,configurable:!0}),n.prototype.add=function(e){this._q.length<this._c&&this._q.push(e)},n.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},n})();function js(n){n!=null&&typeof n.then=="function"&&n.then(Si,Si)}var ps=0,Gl=1,dr=2,wi=3,Xs=4,vi=1024,Si=function(){};function Fr(n){var e=n.err,t=Promise.resolve(n.execution).then(function(r){if(e!=null)throw e;return r});return n.err=void 0,n.execution=t.then(function(){},function(){}),n.pending===void 0?t:n.pending.then(function(){return t})}function ar(n,e){var t=n.state>=wi;return Promise.resolve(e).then(function(r){return!t&&n.state>=Xs?Fr(n).then(function(i){return{value:i,done:!0}}):{value:r,done:t}})}function pa(n,e){var t,r;if(!(n.state>=dr))if(n.state=dr,n.onnext(),n.onstop(),n.err==null&&(n.err=e),n.pushes.length===0&&(typeof n.buffer>"u"||n.buffer.empty))hn(n);else try{for(var i=qr(n.pushes),s=i.next();!s.done;s=i.next()){var o=s.value;o.resolve()}}catch(a){t={error:a}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(t)throw t.error}}}function hn(n){var e,t;if(!(n.state>=wi)){n.state<dr&&pa(n),n.state=wi,n.buffer=void 0;try{for(var r=qr(n.nexts),i=r.next();!i.done;i=r.next()){var s=i.value,o=n.pending===void 0?Fr(n):n.pending.then(function(){return Fr(n)});s.resolve(ar(n,o))}}catch(a){e={error:a}}finally{try{i&&!i.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}n.pushes=[],n.nexts=[]}}function kl(n){n.state>=Xs||(n.state<wi&&hn(n),n.state=Xs)}function nb(n,e){if(js(e),n.pushes.length>=vi)throw new bh("No more than "+vi+" pending calls to push are allowed on a single repeater.");if(n.state>=dr)return Promise.resolve(void 0);var t=n.pending===void 0?Promise.resolve(e):n.pending.then(function(){return e});t=t.catch(function(l){n.state<dr&&(n.err=l),kl(n)});var r;if(n.nexts.length){var i=n.nexts.shift();i.resolve(ar(n,t)),n.nexts.length?r=Promise.resolve(n.nexts[0].value):typeof n.buffer<"u"&&!n.buffer.full?r=Promise.resolve(void 0):r=new Promise(function(l){return n.onnext=l})}else typeof n.buffer<"u"&&!n.buffer.full?(n.buffer.add(t),r=Promise.resolve(void 0)):r=new Promise(function(l){return n.pushes.push({resolve:l,value:t})});var s=!0,o={},a=r.catch(function(l){if(s)throw l});return o.then=function(l,u){return s=!1,Promise.prototype.then.call(r,l,u)},o.catch=function(l){return s=!1,Promise.prototype.catch.call(r,l)},o.finally=r.finally.bind(r),n.pending=t.then(function(){return a}).catch(function(l){n.err=l,kl(n)}),o}function ib(n){var e=pa.bind(null,n),t=new Promise(function(r){return n.onstop=r});return e.then=t.then.bind(t),e.catch=t.catch.bind(t),e.finally=t.finally.bind(t),e}function sb(n){if(!(n.state>=Gl)){n.state=Gl;var e=nb.bind(null,n),t=ib(n);n.execution=new Promise(function(r){return r(n.executor(e,t))}),n.execution.catch(function(){return pa(n)})}}var Wn=new WeakMap,Bn=function(){function n(e,t){Wn.set(this,{executor:e,buffer:t,err:void 0,state:ps,pushes:[],nexts:[],pending:void 0,execution:void 0,onnext:Si,onstop:Si})}return n.prototype.next=function(e){js(e);var t=Wn.get(this);if(t===void 0)throw new Error("WeakMap error");if(t.nexts.length>=vi)throw new bh("No more than "+vi+" pending calls to next are allowed on a single repeater.");if(t.state<=ps&&sb(t),t.onnext(e),typeof t.buffer<"u"&&!t.buffer.empty){var r=ar(t,t.buffer.remove());if(t.pushes.length){var i=t.pushes.shift();t.buffer.add(i.value),t.onnext=i.resolve}return r}else if(t.pushes.length){var s=t.pushes.shift();return t.onnext=s.resolve,ar(t,s.value)}else if(t.state>=dr)return hn(t),ar(t,Fr(t));return new Promise(function(o){return t.nexts.push({resolve:o,value:e})})},n.prototype.return=function(e){js(e);var t=Wn.get(this);if(t===void 0)throw new Error("WeakMap error");return hn(t),t.execution=Promise.resolve(t.execution).then(function(){return e}),ar(t,Fr(t))},n.prototype.throw=function(e){var t=Wn.get(this);if(t===void 0)throw new Error("WeakMap error");return t.state<=ps||t.state>=dr||typeof t.buffer<"u"&&!t.buffer.empty?(hn(t),t.err==null&&(t.err=e),ar(t,Fr(t))):this.next(Promise.reject(e))},n.prototype[Symbol.asyncIterator]=function(){return this},n.race=ob,n.merge=ab,n.zip=lb,n.latest=ub,n}();function Yi(n,e){var t,r,i=[],s=function(u){u!=null&&typeof u[Symbol.asyncIterator]=="function"?i.push(u[Symbol.asyncIterator]()):u!=null&&typeof u[Symbol.iterator]=="function"?i.push(u[Symbol.iterator]()):i.push(function(){return rb(this,arguments,function(){return er(this,function(d){switch(d.label){case 0:return e.yieldValues?[4,bn(u)]:[3,3];case 1:return[4,d.sent()];case 2:d.sent(),d.label=3;case 3:return e.returnValues?[4,bn(u)]:[3,5];case 4:return[2,d.sent()];case 5:return[2]}})})}())};try{for(var o=qr(n),a=o.next();!a.done;a=o.next()){var l=a.value;s(l)}}catch(u){t={error:u}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}return i}function ob(n){var e=this,t=Yi(n,{returnValues:!0});return new Bn(function(r,i){return Gr(e,void 0,void 0,function(){var s,o,a,l,u,f;return er(this,function(c){switch(c.label){case 0:if(!t.length)return i(),[2];o=!1,i.then(function(){s(),o=!0}),c.label=1;case 1:c.trys.push([1,,5,7]),l=void 0,u=0,f=function(){var d,g,p,_,x,T;return er(this,function(E){switch(E.label){case 0:d=u;try{for(g=(x=void 0,qr(t)),p=g.next();!p.done;p=g.next())_=p.value,Promise.resolve(_.next()).then(function(w){w.done?(i(),a===void 0&&(a=w)):u===d&&(u++,s(w))},function(w){return i(w)})}catch(w){x={error:w}}finally{try{p&&!p.done&&(T=g.return)&&T.call(g)}finally{if(x)throw x.error}}return[4,new Promise(function(w){return s=w})];case 1:return l=E.sent(),l===void 0?[3,3]:[4,r(l.value)];case 2:E.sent(),E.label=3;case 3:return[2]}})},c.label=2;case 2:return o?[3,4]:[5,f()];case 3:return c.sent(),[3,2];case 4:return[2,a&&a.value];case 5:return i(),[4,Promise.race(t.map(function(d){return d.return&&d.return()}))];case 6:return c.sent(),[7];case 7:return[2]}})})})}function ab(n){var e=this,t=Yi(n,{yieldValues:!0});return new Bn(function(r,i){return Gr(e,void 0,void 0,function(){var s,o,a,l=this;return er(this,function(u){switch(u.label){case 0:if(!t.length)return i(),[2];s=[],o=!1,i.then(function(){var f,c;o=!0;try{for(var d=qr(s),g=d.next();!g.done;g=d.next()){var p=g.value;p()}}catch(_){f={error:_}}finally{try{g&&!g.done&&(c=d.return)&&c.call(d)}finally{if(f)throw f.error}}}),u.label=1;case 1:return u.trys.push([1,,3,4]),[4,Promise.all(t.map(function(f,c){return Gr(l,void 0,void 0,function(){var d,g;return er(this,function(p){switch(p.label){case 0:p.trys.push([0,,6,9]),p.label=1;case 1:return o?[3,5]:(Promise.resolve(f.next()).then(function(_){return s[c](_)},function(_){return i(_)}),[4,new Promise(function(_){s[c]=_})]);case 2:return d=p.sent(),d===void 0?[3,4]:d.done?(a=d,[2]):[4,r(d.value)];case 3:p.sent(),p.label=4;case 4:return[3,1];case 5:return[3,9];case 6:return g=f.return,g?[4,f.return()]:[3,8];case 7:g=p.sent(),p.label=8;case 8:return[7];case 9:return[2]}})})}))];case 2:return u.sent(),[2,a&&a.value];case 3:return i(),[7];case 4:return[2]}})})})}function lb(n){var e=this,t=Yi(n,{returnValues:!0});return new Bn(function(r,i){return Gr(e,void 0,void 0,function(){var s,o,a,l;return er(this,function(u){switch(u.label){case 0:if(!t.length)return i(),[2,[]];o=!1,i.then(function(){s(),o=!0}),u.label=1;case 1:u.trys.push([1,,6,8]),u.label=2;case 2:return o?[3,5]:(Promise.all(t.map(function(f){return f.next()})).then(function(f){return s(f)},function(f){return i(f)}),[4,new Promise(function(f){return s=f})]);case 3:return a=u.sent(),a===void 0?[2]:(l=a.map(function(f){return f.value}),a.some(function(f){return f.done})?[2,l]:[4,r(l)]);case 4:return u.sent(),[3,2];case 5:return[3,8];case 6:return i(),[4,Promise.all(t.map(function(f){return f.return&&f.return()}))];case 7:return u.sent(),[7];case 8:return[2]}})})})}function ub(n){var e=this,t=Yi(n,{yieldValues:!0,returnValues:!0});return new Bn(function(r,i){return Gr(e,void 0,void 0,function(){var s,o,a,l,u,f=this;return er(this,function(c){switch(c.label){case 0:if(!t.length)return i(),[2,[]];o=[],a=!1,i.then(function(){var d,g;s();try{for(var p=qr(o),_=p.next();!_.done;_=p.next()){var x=_.value;x()}}catch(T){d={error:T}}finally{try{_&&!_.done&&(g=p.return)&&g.call(p)}finally{if(d)throw d.error}}a=!0}),c.label=1;case 1:return c.trys.push([1,,5,7]),Promise.all(t.map(function(d){return d.next()})).then(function(d){return s(d)},function(d){return i(d)}),[4,new Promise(function(d){return s=d})];case 2:return l=c.sent(),l===void 0?[2]:(u=l.map(function(d){return d.value}),l.every(function(d){return d.done})?[2,u]:[4,r(u.slice())]);case 3:return c.sent(),[4,Promise.all(t.map(function(d,g){return Gr(f,void 0,void 0,function(){var p;return er(this,function(_){switch(_.label){case 0:if(l[g].done)return[2,l[g].value];_.label=1;case 1:return a?[3,4]:(Promise.resolve(d.next()).then(function(x){return o[g](x)},function(x){return i(x)}),[4,new Promise(function(x){return o[g]=x})]);case 2:return p=_.sent(),p===void 0?[2,l[g].value]:p.done?[2,p.value]:(u[g]=p.value,[4,r(u.slice())]);case 3:return _.sent(),[3,1];case 4:return[2]}})})}))];case 4:return[2,c.sent()];case 5:return i(),[4,Promise.all(t.map(function(d){return d.return&&d.return()}))];case 6:return c.sent(),[7];case 7:return[2]}})})})}class ga{constructor(e,t,r,i,s,o={}){fe(this,"headerClient");fe(this,"header");fe(this,"headerLength");fe(this,"indexLength");fe(this,"nocache");fe(this,"headers");this.headerClient=e,this.header=t,this.headerLength=r,this.indexLength=i,this.nocache=s,this.headers=o}static async open(e,t,r={}){let i,s=new zl(e,t,r),o=2024+(()=>{let f,c=0;for(f=0;f<3;f++)c+=JE**f*QE;return c})();if(!new Uint8Array(await s.getRange(0,8,o,"header")).subarray(0,3).every((f,c)=>Bt[c]===f))throw Error("Not a FlatGeobuf file");if((i=new DataView(await s.getRange(8,4,o,"header")).getUint32(0,!0))>10485760||i<8)throw Error("Invalid header size");let a=await s.getRange(12,i,o,"header"),l=Wi(new yt(new Uint8Array(a)));if(l.indexNodeSize===0)throw Error("No index found, cannot read features filtered by bbox");let u=Zi(l.featuresCount,l.indexNodeSize);return new ga(s,l,i,u,t,r)}async*selectBbox(e){let t=this.lengthBeforeTree(),r=this.headerClient,i=async(l,u)=>r.getRange(t+l,u,0,"index"),s=[],o=[];for await(let l of Eh(this.header.featuresCount,this.header.indexNodeSize,e,i)){let[u,f]=l,[,,c]=l;if(c||(c=4),o.length===0){o.push([u,c,f]);continue}let d=o[o.length-1];u-(d[0]+d[1])>Ti.global.extraRequestThreshold()&&(s.push(o),o=[]),o.push([u,c,f])}this.headerClient.logUsage("header+index"),o.length>0&&s.push(o);let a=s.flatMap(l=>this.readFeatureBatch(l,this.nocache));yield*Bn.merge(a)}lengthBeforeTree(){return Bt.length+ot+this.headerLength}lengthBeforeFeatures(){return this.lengthBeforeTree()+this.indexLength}buildFeatureClient(e){return new zl(this.headerClient.httpClient,e,this.headers)}async*readFeatureBatch(e,t){let[r]=e[0],[i,s]=e[e.length-1],o=this.buildFeatureClient(t),a=i+s-r;for(let[l,,u]of e){let f=await this.readFeature(o,l,a);yield{id:u,feature:f},a=0}o.logUsage("feature")}async readFeature(e,t,r){let i,s=t+this.lengthBeforeFeatures();i=new DataView(await e.getRange(s,4,r,"feature length")).getUint32(0,!0);let o=new Uint8Array(await e.getRange(s+4,i,r,"feature data")),a=new Uint8Array(i+ot);a.set(o,ot);let l=new yt(a);return l.setPosition(ot),ht.getRootAsFeature(l)}}class zl{constructor(e,t,r={}){fe(this,"httpClient");fe(this,"bytesEverUsed",0);fe(this,"bytesEverFetched",0);fe(this,"buffer",new ArrayBuffer(0));fe(this,"head",0);if(typeof e=="string")this.httpClient=new $l(e,t,r);else if(e instanceof $l)this.httpClient=e;else throw Error("Unknown source")}async getRange(e,t,r,i){this.bytesEverUsed+=t;let s=e-this.head,o=s+t;if(s>=0&&o<=this.buffer.byteLength)return this.buffer.slice(s,o);let a=Math.max(t,r);return this.bytesEverFetched+=a,this.buffer=await this.httpClient.getRange(e,a,i),this.head=e,this.buffer.slice(0,t)}logUsage(e){e.split(" ")[0],(100*this.bytesEverUsed/this.bytesEverFetched).toFixed(2)}}class $l{constructor(e,t,r={}){fe(this,"url");fe(this,"nocache");fe(this,"headers");fe(this,"requestsEverMade",0);fe(this,"bytesEverRequested",0);this.url=e,this.nocache=t,this.headers=r}async getRange(e,t,r){this.requestsEverMade+=1,this.bytesEverRequested+=t;let i=`bytes=${e}-${e+t-1}`,s=new Headers(this.headers);return s.set("Range",i),this.nocache&&s.set("Cache-Control","no-cache, no-store"),await(await fetch(this.url,{headers:s})).arrayBuffer()}}async function*cb(n,e,t,r){if(!n.subarray(0,3).every((c,d)=>Bt[d]===c))throw Error("Not a FlatGeobuf file");if(t){let c=da.open(n);for await(let d of c.selectBbox(t))yield e(d.id,d.feature,c.header);return}let i=new yt(n),s=i.readUint32(Bt.length);i.setPosition(Bt.length+ot);let o=Wi(i),a=Bt.length+ot+s,{indexNodeSize:l,featuresCount:u}=o;l>0&&(a+=Zi(u,l));let f=0;for(;a<i.capacity();){let c=i.readUint32(a);i.setPosition(a+ot);let d=ht.getRootAsFeature(i);yield e(f++,d,o),a+=ot+c}}async function*hb(n,e,t){let r,i=KE(n),s=async g=>await i.slice(g),o=new Uint8Array(await s(8));if(!o.subarray(0,3).every((g,p)=>Bt[p]===g))throw Error("Not a FlatGeobuf file");o=new Uint8Array(await s(4));let a=new yt(o),l=a.readUint32(0);o=new Uint8Array(await s(l));let u=Wi(a=new yt(o)),{indexNodeSize:f,featuresCount:c}=u;if(f>0){let g=Zi(c,f);await s(g)}let d=0;for(;r=await db(s,u,e,d++);)yield r}async function*fb(n,e,t,r,i=!1,s={}){let o=await ga.open(n,i,s);for await(let a of o.selectBbox(e))yield t(a.id,a.feature,o.header)}async function db(n,e,t,r){let i=new Uint8Array(await n(4,"feature length"));if(i.byteLength===0)return;let s=new yt(i),o=s.readUint32(0);i=new Uint8Array(await n(o,"feature data"));let a=new Uint8Array(o+4);return a.set(i,4),(s=new yt(a)).setPosition(ot),t(r,ht.getRootAsFeature(s),e)}function Hs(n,e){let t=e;if(t===He.Unknown&&(t=n.type()),t===He.GeometryCollection){let i=[];for(let s=0;s<n.partsLength();s++){let o=n.parts(s),a=o.type();i.push(Hs(o,a))}return{type:He[t],geometries:i}}if(t===He.MultiPolygon){let i=[];for(let s=0;s<n.partsLength();s++)i.push(Hs(n.parts(s),He.Polygon));return{type:He[t],coordinates:i.map(s=>s.coordinates)}}let r=function(i,s){let o=i.xyArray(),a=i.zArray();switch(s){case He.Point:{let l=Array.from(o);return a&&l.push(a[0]),l}case He.MultiPoint:case He.LineString:return ds(o,a);case He.MultiLineString:case He.Polygon:return function(l,u,f){let c;if(!f||f.length===0)return[ds(l,u)];let d=0,g=Array.from(f).map(p=>l.slice(d,d=p<<1));return u&&(d=0,c=Array.from(f).map(p=>u.slice(d,d=p))),g.map((p,_)=>ds(p,c?c[_]:void 0))}(o,a,i.endsArray())}}(n,t);return{type:He[t],coordinates:r}}function ma(n,e,t){let r=t.columns;return{type:"Feature",id:n,geometry:Hs(e.geometry(),t.geometryType),properties:HE(e,r)}}async function*pb(n,e,t){yield*cb(n,ma,e)}function gb(n,e){return hb(n,ma)}function mb(n,e,t,r=!1,i={}){return fb(n,e,ma,t,r,i)}function _b(n,e,t,r=!1,i={}){return n instanceof Uint8Array?pb(n,e):n instanceof ReadableStream?gb(n):mb(n,e,t,r,i)}const Vl=new au({featureProjection:"EPSG:3857"});class yb extends Ii{constructor(e){super({url:e.url,attributions:e.attributions,wrapX:e.wrapX,format:Vl,strategy:Kf}),this.ressourceURL=e.url,super.setLoader(this.loader)}fgbBoundingBox(e,t){const r=bs(e,t.getCode(),"EPSG:4326");return{minX:r[0],minY:r[1],maxX:r[2],maxY:r[3]}}async loader(e,t,r,i,s){const o=this.fgbBoundingBox(e,r);try{if(o.minX!==-1/0){const a=[],l=_b(this.ressourceURL,o);for await(const u of l){const f=Vl.readFeature(u);a.push(f)}super.clear(),super.addFeatures(a),i(a)}}catch{s()}}}window.eoxMapAdvancedOlSources={BingMaps:rE,CartoDB:nE,Cluster:Ei,DataTile:On,GeoTIFF:ea,Google:lE,IIIF:cE,Image:_r,ImageArcGISRest:fE,ImageCanvas:dE,ImageMapGuide:_E,ImageStatic:Gc,ImageTile:gh,OGCMapTile:SE,OGCVectorTile:RE,Raster:xh,Source:ao,StadiaMaps:GE,TileArcGISRest:kE,TileDebug:zE,TileImage:$t,TileJSON:$c,UrlTile:Qf,UTFGrid:VE,Zoomify:uE,WMTSCapabilities:XE,FlatGeoBuf:yb};const Db=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));export{Cb as L,Fb as a,Db as i};
